% -*- TeX-master: "sbml-level-3-version-1-core"; fill-column: 66 -*-
% $Id: best-practice.tex $
% $HeadURL: https://sbml.svn.sourceforge.net/svnroot/sbml/trunk/specifications/sbml-level-3/version-1/core/spec/best-practice.tex $
% ----------------------------------------------------------------

\section{Best practices}
\label{sec:best-practices}

This section gives further information regarding intended use and
best practice for application of the specification to systems
biological modelling. The information provided here is somewhat
distinct from the formal technical specification, but nevertheless
strongly advocated.  The sections below mirror the order of the
components presented in Section~\ref{sec:elements}.


\subsection{Identifiers and names}
\label{sec:bp:names}

The \token{id} attribute is available on most (but not all)
objects in SBML, and all objects that have \token{id} attributes
also have an optional \token{name} attribute.  How should models
treat identifiers and names?

The recommended practice for handling \token{name} is as follows.
If a software tool has the capability for displaying the content
of \token{name} attributes, it should display this content to the user
as a component's label instead of the component's \token{id}.
If the user interface does not have this capability (e.g.,
because it cannot display or use special characters in symbol
names), or if the \token{name} attribute is missing on a given
component, then the user interface should display the value of the
\token{id} attribute instead.  (Script language interpreters are
especially likely to display \token{id} instead of
\token{name}.)

As a consequence of the above, authors of systems that
automatically generate the values of \token{id} attributes should be
aware some systems may display the \token{id}'s to the user.
Authors therefore may wish to take some care to have their
software create \token{id} values that are: (a) reasonably easy
for humans to type and read; and (b) likely to be meaningful, \eg
the \token{id} attribute is an abbreviated form of the name attribute value.

\subsection{Initial Values}
\label{sec:bp:initialvalues}
SBML allows for the specification of \Compartment{}s, \Species, 
\Parameter{}s and \LocalParameter{}s without the specification of 
initial values, i.e.\ a \Compartment{}'s \token{size}, a \Species{}'s 
\token{initialConcentration} or \token{initialAmount} or a 
\Parameter{}'s/\LocalParameter{}'s \token{value}. In all these cases 
a missing value implies that the value either is unknown, or to be 
obtained from an external source, or determined by an \InitialAssignment. 
However in all cases where 
there is no \InitialAssignment present to determine the initial value
of these elements it is considered best practice to specify the 
initial values.

\subsection{The \token{constant} flag}
\label{sec:bp:constant}
SBML provides a mandatory boolean flag \token{constant} on \Compartment{}s, 
\Species and \Parameter{}s. Wherever the \token{constant} attribute appears with a \val{true}
it has the implication that its SBML element cannot be changed by other constructs 
in SBML (with the exception of an \InitialAssignment ). A value of \val{false} indicates
that the element is likely to be changed as a result of a \Rule, \Reaction or \Event. 

It is considered good practice to mark all elements, that are not intended to be 
modified by other SBML constructs with \token{constant}=\val{true}. The only exception
to this practice is the \Species element, which usually \emph{is} a part of the reaction 
system and thus will often have 

\subsection{Annotations}
\label{sec:bp:annotations}

Here are examples of the kinds of data that may be appropriately
stored in \token{annotation}: (a) information about the graphical
layout of model components; (b) application-specific processing
instructions that do not change the essential meaning of a model;
(c) identification information for cross-referencing components in
a model with items in a data resource such as a database;
  and (d) information about the model that cannot be
  readily encoded in existing SBML elements.



\subsection{The SBML Container}
\label{sec:bp:sbml}

\subsection{Model}
\label{sec:bp:model}


\subsection{Function definitions}
\label{sec:bp:functions}

\subsection{Unit definitions}
\label{sec:bp:unitdefinitions}

\subsubsection{Recomended units}
\label{sec:bp:unitdefinitions:recommendedunits}

We advise modelers and software tools to declare the units of all
quantities in a model, insofar as this is possible, using the
various mechanisms provided for this in SBML.  Fully declared
units can allow software tools to perform dimensional analysis on
the units of mathematical expressions, and such analysis can be
valuable in helping modelers produce correct models.  In addition,
it can allow model-wide operations such as conversion or rescaling
of units.


\paragraph{Substance units}
\label{sec:bp:unitdefinitions:recommendedunits:substanceUnits}
The units chosen for the attribute \token{substanceUnits} should be
be \token{mole}, \token{item}, \token{avogadro},
\token{dimensionless}, \token{kilogram}, \token{gram}, or units
derived from these.  

\paragraph{Time units}
\label{sec:bp:unitdefinitions:recommendedunits:timeUnits}
The units chosen for the attribute \token{timeUnits} should be
be \token{second}, \token{dimensionless}, or units derived from
these.   

\paragraph{Compartment size units}
\label{sec:bp:unitdefinitions:recommendedunits:sizeUnits}
For compartments the recommended units depend on the value of for
the attribute \token{spatialDimensions} 
\begin{table}[h]
  \small
  \centering
  \vspace*{-1ex}
  \begin{edtable}{tabular}{cl}
    \toprule
    \textbf{Value of attribute} & \textbf{Recomended values} \\[-2pt]
    \texttt{spatialDimensions}  &  \\
    \midrule
    \val{3}                     & Volume units
    \ref{sec:bp:unitdefinitions:recommendedunits:volumeUnits} \\
    \val{2}                     & Area units
    \ref{sec:bp:unitdefinitions:recommendedunits:areaUnits} \\
    \val{1}                     & Length units
    \ref{sec:bp:unitdefinitions:recommendedunits:lengthUnits} \\
    else                        & none \\
    \bottomrule
  \end{edtable}
  \vspace*{-0.5ex}
  \caption{Recomended units for compartment sizes dependent on the
    value of  \token{spatialDimensions}.}
  \label{tab:bp:unitdefinitions:recommendedunits:sizeUnits}
\end{table}

\paragraph{Volume units}
\label{sec:bp:unitdefinitions:recommendedunits:volumeUnits}
The units chosen for the attribute \token{volumeUnits} should be
be \token{litre}, \token{cubic metre}, \token{dimensionless}, or
units derived from these.  

\paragraph{Area units}
\label{sec:bp:unitdefinitions:recommendedunits:areaUnits}
The units chosen for the attribute \token{areaUnits} should be be
\token{square metre}, \token{dimensionless}, or units derived from
these. 

\paragraph{Length units}
\label{sec:bp:unitdefinitions:recommendedunits:lengthUnits}
The units chosen for the attribute \token{lengthUnits} should be
be \token{metre}, \token{dimensionless}, or units derived from these.  

\paragraph{Extent units}
\label{sec:bp:unitdefinitions:recommendedunits:extentUnits}
The units chosen for the attribute \token{extentUnits} should be
be \token{mole}, \token{item}, \token{avogadro},
\token{dimensionless}, or units derived from these.  

\subsubsection{Handling units requiring the use of offsets}
\label{sec:bp:unitdefinitions:offset}

As mentioned in Section~\ref{sec:unit-structure} Unit definitions
and conversions requiring offsets cannot be done using the simple
approach described in \ref{sec:unit-simple-approach}.  In fact
SBML does not included Celsius as a predefined unit, since this by
default has an offset. Cases involving Celsius or offsets require
a completely different approach.

We first address the question of how to handle units that
\emph{do} require offsets:
\begin{itemize}

\item \emph{Handling Celsius}.  A model in which certain
  quantities are temperatures measured in degrees Celsius can be
  converted straightforwardly to a model in which those
  temperatures are in kelvin.  A software tool could do this by
  performing a straightforward substitution using the following
  relationship:
  \begin{linenomath}
    \begin{equation*}
      T_\emph{kelvin} = T_\emph{Celsius} + 273.15
    \end{equation*}
  \end{linenomath}
  In every mathematical formula of the model where a quantity
  (call it $x$) in degrees Celsius appears, replace $x$ with $x_k
  + 273.15$ where $x_k$ is now in kelvin.  An alternative approach
  would be to use a \FunctionDefinition to define a function
  encapsulating this relationship above and then using that in the
  rest of the model as needed.  Since Celsius is a commonly-used
  unit, software tools could help users by providing users with
  the ability to express temperatures in Celsius in the tools'
  interfaces, and making substitutions automatically when writing
  out the SBML.

\item \emph{Handling other units requiring offsets}.  The only
  other units requiring offsets in SBML's domain of common
  applications are other temperature units such as Fahrenheit.
  Few modern scientists employ Fahrenheit degrees; therefore, this
  is an unusual situation.  The complication inherent in
  converting between degrees Fahrenheit and kelvin is that both a
  multiplier and an offset are required:
  \begin{linenomath}
    \begin{equation*}
      T_\emph{kelvin} = \frac{T_\emph{F} + 459.67}{1.8}
      \label{eq:fah-kelvin}
    \end{equation*}
  \end{linenomath}

  One approach to handling this is to use a \FunctionDefinition to
  define a function encapsulating the relationship above, then to
  substitute a call to this function wherever the original
  temperature in Fahrenheit appears in the model's mathematical
  formulas.  Here is a candidate definition as an example:
  \begin{example}
<functionDefinition id="Fahrenheit_to_kelvin">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
        <lambda>
            <bvar><ci> temp_in_fahrenheit </ci></bvar>
            <apply>
                <divide/>
                <apply>
                    <plus/>
                    <ci> temp_in_fahrenheit </ci>
                    <cn> 459.67 </cn>
                </apply>
                <cn> 1.8 </cn>
            </apply>
        </lambda>
    </math>
</functionDefinition>
  \end{example}
  
  An alternative approach not requiring the use of function
  definitions is to use an \AssignmentRule for each variable in
  Fahrenheit units.  The \AssignmentRule could compute the
  conversion from Fahrenheit to (say) kelvin, assign its value to
  a variable (in Kelvin units), and then that variable could be
  used elsewhere in the model.  Still another approach is to
  rewrite the mathematical formulas of a model to directly
  incorporate the conversion above wherever
  the quantity appears.

  All of these approaches provide general solutions to the problem
  of supporting any units requiring offsets in the unit system of
  SBML Level~3.  It can be used for other temperature units
  requiring an offset (\eg degrees Rankine, degrees R\'{e}aumur),
  although the likelihood of a real-life model requiring such
  other temperature units seems exceedingly small.

\end{itemize}

%In summary, the removal of \token{offset} does not
In summary, the fact that SBML units do not support specifying an offset 
does  not impede the creation of models using alternative units.  If
conversions are needed, then converting between temperature in
degrees Celsius and thermodynamic temperature can be handled
rather easily by the simple substitution described above.  For the
rarer case of Fahrenheit and other units requiring combinations of
multipliers and offsets, users are encouraged to employ the power
of \FunctionDefinition, \AssignmentRule, or other constructs in
SBML.



\subsection{Compartments}
\label{sec:bp:compartment}


\subsubsection{Setting the \token{size} attribute on a \token{compartment}}
\label{sec:bp:size}

As mentioned in Section~\ref{sec:size}, it is highly recommended
that a \token{size} is specified for each \token{compartment}
declared in a model. There are three major technical reasons for
this.  First, if the model contains any species whose initial
amounts are given in terms of concentrations, and there is at
least one reaction in the model referencing such a species, then
the model is numerically incomplete if it lacks a value for the
size of the compartment in which the species is located.  The
reason is simply that SBML
\Reaction{}s are defined in units of
\quantity{substance}/\quantity{time} (see
Section~\ref{subsec:kinetic-law}), not concentration per time, and
thus the compartment size must at some point be used to convert
from species concentration to substance units.  Second, models
ideally should be instantiable in a variety of simulation
frameworks.  A commonly-used one is the discrete stochastic
framework~\citep{gillespie:1977,wilkinson_2006} in which species
are represented as item counts (\eg molecule counts).  If species'
initial quantities are given in terms of concentrations or
densities, it is impossible to convert the values to item counts
without knowing compartment sizes.  Third,
if a model contains multiple compartments whose sizes are not all
identical to each other, it is impossible to quantify the reaction
rate expressions without knowing the compartment volumes.  The
reason for the latter is again that reaction rates in SBML are defined
in terms of \quantity{substance}/\quantity{time}, and when species quantities are
given in terms of concentrations or densities, the compartment
sizes become factors in the reaction rate expressions.



\subsection{Species}
\label{sec:bp:species}


\subsection{Parameters}
\label{sec:bp:parameters}


\subsection{Initial assignments}
\label{sec:bp:init-assign}


\subsection{Rules}
\label{sec:bp:rules}

Section~\ref{sec:ruleconstraints} establishes the fact that when 
algebraicRules are used it is possible to produce a model that is overdetermined.
When a model includes both events and reactions it is necessary to analyze
the set of equations produced from rules and reactions and the set of equations
produces from rules and the eventAssignments of each event.  Each set of equations 
must not be overdetermined.  Additionally each set of equations must be fully
determined, if accurate simulation is to be performed.

The following example illustrates a case where the set of equations is fully determined:

\sbmlexample{fullydeterminedevent.xml}

There are three species in the model whose values may vary.  The first set of equations
to consider is the set produced by the reaction and the algebraicRule.
\begin{linenomath}
\begin{equation*}
  \frac{d S1}{d t} = - C \cdot k1 \cdot S1
\end{equation*}
\end{linenomath}
\begin{linenomath}
\begin{equation*}
  \frac{d S2}{d t} = C \cdot k1 \cdot S1
\end{equation*}
\end{linenomath}
\begin{linenomath}
\begin{equation*}
  S1 - S3 = 0
\end{equation*}
\end{linenomath}

This set of equations is fully determined, \ie each of the three variables S1, S2 and S3
are derived from one equation.

The second set of equations to consider is the set produced by the event and 
the algebraicRule.
\begin{linenomath}
\begin{equation*}
  S1 = 1
\end{equation*}
\end{linenomath}
\begin{linenomath}
\begin{equation*}
  S2 = 1.5
\end{equation*}
\end{linenomath}
\begin{linenomath}
\begin{equation*}
  S1 - S3 = 0
\end{equation*}
\end{linenomath}

Again the set of equations is fully determined, but had the eventAssignment for
species S1 been absent the algebraicRule would produce an ambiguity regarding
which variable should be adjusted.  

In this example, as if often the case
when an algebraicRule has been used, the algebraicRule could be replaced by an
assignmentRule.

\begin{example}
<assignmentRule variable="S3">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
        <apply>
            <ci> S1 </ci>
        </apply>
    </math>
</assignmentRule>
\end{example}

Replacing algebraicRules with assignmentRules, particularly in models that
use events, reduces the possibilities for creating either overdetermined or
ambiguous models and produces models that can be exchanged with greater ease.


 





\subsection{Constraints}
\label{sec:bp:constraints}


\subsection{Reactions}
\label{sec:bp:reactions}


\subsection{Events}
\label{sec:bp:events}

\subsubsection{Attaching time units to a \token{delay}ed event expressions}
\label{sec:bp:event:delay}

As illustrated in section in \ref{sec:event:delay:example}  specifying delays for 
event expressions is possible. 

\begin{example}
<model>
    ...
    <listOfEvents>
        <event>
            ...
            <delay>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 10 </cn>
                </math>
            </delay>
            ...
        </event>
    </listOfEvents>
    ...
</model>
\end{example}

However when using numeric values as in  the \val{<cn> 10 </cn>} within 
the mathematical formula, this value has no specified units.  The model is 
not invalid because of this, but
a recipient of the model may justifiably be concerned about what
\val{10} really means.  (Ten seconds?  What if the global units of
time on the model were changed from seconds to milliseconds?
Would the modeler remember to change \val{10} to \val{10~000}?)
As discussed elsewhere, leaving units unspecified may prevent
software tools from performing complete validation and other
useful operations such as global unit conversions.  A better
approach is to avoid literal numbers and instead use an approach
such as defining a parameter with declared units, as in the
following modified version of the example fragment:

\begin{example}
<model>
    ...
    <listOfParameters>
        <parameter id="transcriptionDelay" value="10" units="time"/>
    </listOfParameters>
    ...
    <listOfEvents>
        <event>
            ...
            <delay>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <ci> transcriptionDelay </ci>
                </math>
            </delay>
            ...
        </event>
    </listOfEvents>
    ...
</model>
\end{example}
