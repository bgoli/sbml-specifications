\documentclass[draftspec]{sbmlpkgspec}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{booktabs}

\begin{document}

\packageTitle{The Distributions Package\\for SBML Level 3}
\packageVersion{Version 0.9 (Draft)}
\packageVersionDate{9 January, 2013}
%\packageGeneralURL{http://sbml.org/Community/Wiki/SBML_Level_3_Proposals/Distributions_and_Ranges}
%\packageThisVersionURL{}

\author{%
  \begin{tabular}{c>{\hspace{20pt}}c}
    \multicolumn{2}{c}{\Large\bf{Authors}}\\\\
    \multicolumn{2}{c}{Stuart L Moodie}\\
    \multicolumn{2}{c}{\mailto{moodie@ebi.ac.uk}}\\
    \multicolumn{2}{c}{EMBL-EBI}\\
    \multicolumn{2}{c}{Hinxton, UK}\\
\\
    \multicolumn{2}{c}{\Large\bf{Contributors}}\\\\
    Nicolas Le Nov\`{e}re &Darren Wilkinson\\
    \mailto{lenov@babraham.ac.uk}&\mailto{darren.wilkinson@ncl.ac.uk}\\
   Babraham Institute& University of Newcastle\\
   Babraham, UK & Newcastle, UK\\
  \\
    Maciej Swat & Sarah Keating\\
    \mailto{mjswat@ebi.ac.uk} & \mailto{skeating@ebi.ac.uk}\\
    EMBL-EBI & EMBL-EBI\\
    Hinxton, UK & Hinxton, UK\\
\\
     \multicolumn{2}{c}{ Colin Gillespie}\\
     \multicolumn{2}{c}{\mailto{c.gillespie@ncl.ac.uk}}\\
     \multicolumn{2}{c}{University of Newcastle}\\
     \multicolumn{2}{c}{ Newcastle, UK}\\
\end{tabular}
}

\notice{Disclaimer: This is a working draft of the SBML Level 3
  ``distib'' package proposal. It is not a normative document.  Please
  send comments and other feedback to the mailing list:
  \mailto{sbml-distrib@lists.sourceforge.net.}}

\maketitlepage
\maketableofcontents

\newcommand\arrays{Arrays and Sets\xspace}
\newcommand\arraysshort{arrays\xspace}
\newcommand\distribshort{distrib\xspace}
\newcommand\distrib{Distributions\xspace}
\newcommand\uncertml{UncertML\xspace}
\newcommand\numl{NuML\xspace}
\newcommand\unidistrib{\abstractclass{IUncertainty}\xspace}
\newcommand\mlambda{\class{Lambda}\xspace}
\newcommand\mmath{\class{Math}\xspace}
\newcommand\Distribution{\defRef{Distribution}{sec:distribution}}
\newcommand\mathml{MathML\xspace}
\newcommand{\sbmlverone}{SBML Level 3 Version 1\xspace}

\reversemarginpar  % Want "\watchout" to be put on the left, not the right.
\newcommand{\watchout}{\marginpar{\hspace*{34pt}\raisebox{-0.5ex}{\Large\ding{43}}}}
\newcommand{\contraversial}{\marginpar{\hspace*{34pt}\raisebox{-0.5ex}{\Large?}}}

\section*{Revision History}

\begin{edtable}{tabularx}{\linewidth}{c c c X }\toprule
\textbf{Version} & \textbf{Date} & \textbf{Author} & \textbf{Comments} \\ \midrule
0.1 (Draft) & 15 Oct 2011 & Stuart Moodie & First draft \\ \midrule
0.2 (Draft) & 16 Oct 2011 & Stuart Moodie & Added introductory text
and background info. Other minor changes etc. \\ \midrule
0.3 (Draft) & 16 Oct 2011 & Stuart Moodie & Filled empty invocation
semantics section.\\ \midrule
0.4 (Draft) & 4 Jan 2012 & Stuart Moodie & Incorporated comments from
NlN, MS and SK. Some minor revisions and corrections.\\  \midrule
0.5 (Draft) & 6 Jan 2012 & Stuart Moodie & Incorporated addition
comments on aim of package from NlN.\\ \midrule
0.6 (Draft) & 19 Jul 2012 & Stuart Moodie & Incorporated revisions
discussed and agreed at HARMONY 2012.\\ 
0.7 (Draft) & 6 Aug 2012 & Stuart Moodie & Incorporated review
comments from Maciej Swat and Sarah Keating.\\ 
0.8 (Draft) & 21 Dec 2012 & Stuart Moodie & Incorporated changes
suggested at combine and subsequently through list discussions.\\
0.9 (Draft) & 9 Jan 2012 & Stuart Moodie & Incorporated corrections
and comments from Maciej Swat and Sarah Keating.\\
\bottomrule
\end{edtable}

\section{Introduction and motivation}

\subsection{What is it?}

The \distrib package (also affectionately known as \distribshort for
short) provides an extension to SBML Level 3 that enables it to encode
models that sample values from statistical distributions. Applications
of the package include for instance descriptions population based
models: an important subset of which are
pharmacokinetic/pharmacodynamic (PK/PD) models\footnote{for more
  information see: \url{http://www.pharmpk.com/}.}, which are used to
model the action of drugs.

Note that originally the package was called Distributions and Ranges,
but Ranges are no longer in the scope of this hence the name change.

\subsection{Scope}

The \distrib package adds support to SBML for sampling from a
probability distribution. In particular the following are in scope:

\begin{itemize}
\item Sampling from a continuous distribution.
\item Sampling from a discrete distribution.
\item Sampling from user-defined probability density function.
\item Sampling from user-defined discrete probability density function.
\end{itemize}

At one point the following were considered for inclusion in this
package but are now \textbf{out of scope}:

\begin{itemize}
\item Stochastic differential equations.
\item Other functions used to characterise a probability distribution,
  such as cumulative distribution functions (CDF) or survival functions etc.
\item The specification of descriptive statistics (mean, standard deviation, standard error etc).\footnote{It is proposed that this be provided
    descriptive statistics in a separate package.}
\end{itemize}

\subsection{This Document}

The authors' expectation is that this is close to a final draft of the
proposal with only a limited number of issues to be resolved. In its
current state this document aims to establish a consensus about what
has been agreed and what work remains to be carried out to complete
the definition of this package.

This proposal is a working document and once finalised will be the
first step towards the formal adoption of the \distribshort as a
package in SBML Level 3. After this two implementations based on this
proposal are required and then a vote on its adoption by the SBML
community. The proposal will then provide the basis for a future
package specification document. More details of the SBML package
adoption process can be found at: 
\url{http://sbml.org/Documents/SBML_Development_Process}.

Please also note that in this draft of the proposal a list of the
specific probability distributions to be supported has not been
included. This is because at present it is envisaged that
\distribshort will refer to an external definition of probability
distributions (see sections \ref{sec:externaldistdef} and
\ref{sec:unresolved}).

% \subsection{Conventions used in this document}

% As we are early in the package proposal process there will be some
% parts of this proposal where there is no clear consensus on the
% correct solution or only recent agreement or agreement by a group
% which may not be representative of the SBML community as a
% whole. These cases are indicated by the \contraversial question mark
% in the left margin (illustrated). The reader should pay particular
% attention to these points and ideally provide feedback, especially if
% they disagree with what is proposed. Similarly there will be points
% --- especially as the proposal is consolidated --- which are agreed,
% but which the reader should take note of and perhaps read again. These
% points \watchout are emphasised by the hand pointer in the left margin
% (illustrated.

\section{Background}

\subsection{Problems with current SBML approaches}

SBML Level 3 Core has no direct support for encoding random values
within a model. Currently there is no workaround within the core
language itself, although it is possible to define such information
using annotations within SBML itself. Frank Bergmann had proposed such
an semi-formalised extension for use with SBML L2 [REF?].

\subsection{Past work on this problem or similar topics}

\subsubsection{The Newcastle Proposal}
\label{sec:newcastle proposal}

In 2005 there was a proposal from Colin Gillespie and others
\footnote{\url{http://sbml.org/Community/Wiki/SBML_Level_3_Proposals/Distributions_and_Ranges}}
to introduce support for probability distributions in the SBML core specification. This
was based on their need to use such distributions to represent the
models they were creating as part of the BASIS project
\url{http://www.basis.ncl.ac.uk}).

They proposed that distributions could be referred to in SBML using
the \class{csymbol} element in the \mathml subset used by
the SBML Core specification. An example is below:

\begin{example}
<xmlns=''http://www.w3.org/1998/Math/MathML''>
  <apply>
    <csymbol encoding=''text''
        definitionURL=''http://www.sbml.org/sbml/symbols/uniformRandom''>
      uniformRandom
    </csymbol>
    <ci>mu</ci>
    <ci>sigma</ci>
  </apply>
</math>
\end{example}

This required that a library of definitions be maintained as part of
the SBML standard and in their proposal they defined an initial small
set of commonly used distributions. The proposal was never
implemented.

\subsubsection{Seattle 2010}

The ``distrib'' package was discussed at the Seattle SBML Hackathon%
\footnote{\url{http://sbml.org/Events/Hackathons/The_2010_SBML-BioModels.net_Hackathon}}. There
one of the authors (DW) presented an overview of the problem%
\footnote{Slides:
 \url{http://sbml.org/images/3/3b/Djw-sbml-hackathon-2010-05-04.pdf}}%
\footnote{Audio:
  \url{http://sbml.org/images/6/67/Wilkinson-distributions-2010-05-04.mov}},
building on the old proposal from the Newcastle group
 (see above: \ref{sec:newcastle proposal}).
There was broad support at the meeting for development of such a
package, and for the proposed feature set. Discussion following the
presentation led to a consensus on the following points:

\begin{itemize}
\item There is an urgent need for such a package.
\item It is important to make a distinction between a description of
  uncertainty regarding a model parameter and the mechanistic process
  of selecting a random number from a probability distribution, for
  applications such as parameter scans and experimental design
\item It is probably worth including the definition of PMFs, PDFs and CDFs in the package
\item It is worth including the definition of random distributions using particle representations within such a package, though some work
 still needs to be done on the precise representation
\item It could be worth exploring the use of xinclude to point at particle
representations held in a separate file
\item Random numbers must not be used in rate laws or anywhere else that
 is continuously evaluated, as then simulation behaviour is not
 defined
\item Although there is a need for a package for describing extrinsic
 noise via stochastic differential equations in SBML, such mechanisms
 should not be included in this package due to the considerable
 implications for simulator developers
\item We probably don't want to layer on top of \uncertml
 (www.uncertml.org), as this spec is fairly heavy-weight, and
 somewhat tangential to our requirements
\item A random number seed is not part of a model and should not be
 included in the package
\item The definition of truncated distributions and the specification of
 hard upper and lower bounds on random quantities should be
 considered.
\end{itemize}

It was suggested that new constructs should be introduced into SBML by
the package embedded as user-defined functions using the following
syntax:

\begin{example}
<listOfFunctionDefinitions>
  <functionDefinition id="myNormRand">
    <distrib:####>
      #### distrib binding information here ####
    </distrib:####>
    <math>
      <lambda>
        <bvar>
          <ci>mu</ci>
          <ci>sigma</ci>
        </bvar>
        <ci>mu</ci>
      </lambda>
    </math>
  </functionDefinition>
</listOfFunctionDefinitions>
\end{example}

which allows the use of a "default value" by simulators which do not
understand the package (but simulators which do will ignore the <math>
element). The package would nevertheless be "required", as it will not
be simulated correctly by software which does not understand the
package.

Informal discussions following the break-out covered topics such as:

\begin{itemize}
\item how to work with vector random quantities in the absence of the vector
element in the MathML subset used by SBML
\item how care must be taken with the semantics of random variables
  and the need to both:
\begin{itemize}
\item reference multiple independent random quantities at a given
  time
\item make multiple references to the same random quantity at a given
time.
\end{itemize}
\end{itemize}

\subsubsection{Hinxton 2011}

Detailed discussion was continued at the Statistical Models Workshop
in Hinxton in June 2011%
\footnote{\url{http://sbml.org/Events/Other_Events/statistical_models_workshop_2011}}. There
those interested in representing Statistical Models in SBML came
together to work out the details of how this package would work in
detail. Dan Cornford from the \uncertml
project\footnote{\url{http://www.uncertml.org/}} attended the meeting
and described how that resource could be used to describe uncertainty
and in particular probability distributions. Perhaps the most
significant decision at this meeting was to adopt the \uncertml
resource as a controlled vocabulary that is referenced by the \distrib package.

Much of the detail and the examples in this proposal are based on
the work of this workshop and so its outcomes are essentially
presented below. However, at the end of the meeting there remained a
number of unresolved issues that are still unresolved in this
proposal. See section \vref{sec:unresolved} for more details.


\subsubsection{HARMONY 2012: Maastricht}

Two sessions were dedicated to discussion of \distrib at HARMONY based
around the proposals described in version 0.5 of this document. In
addition there was discussion about the \arrays proposal which was
very helpful in solving the problem of multivariate distributions in
\distrib. The following were the agreed outcomes of the meeting:

\begin{itemize}
\item The original proposal included UncertML markup directly in the
  function definition. This proved unwieldy and confusing and has been
  replaced by a more elegant solution that eliminates the UncertML
  markup and integrates well with the fallback function (see details
  below).
\item Multivariate distributions can be supported using the \arrays
  package to define a covariance matrix.
\item User defined continuous distributions would define a PDF in
  \mathml.
\item Usage semantics were clarified so that invokation of a function
  definition implied a value was sampled from the specified
  distribution.
\item It was agreed from which sections of an SBML model a
  distribution could be invoked.
\item Statistical descriptors of variables (for
  example mean and standard deviation) would be separated from
  \distrib and either provided in a new package or in a later version
  of SBML L3 core.
\end{itemize}

\subsubsection{COMBINE 2012: Toronto}

The August proposal was reviewed and an improvement was agreed to
the user-defined PMF part of the proposal. In particular is was agreed
that the categories should be defined by \distribshort classes rather
than by passing in the information as an array. Questions were also raised
about whether \uncertml was suitably well defined to be used as an
external definition for probability distributions. This was resolved
subsequent to the meeting with a teleconference to Dan Cornford and
colleagues. These changes are incorporated here. Finally, there was
considerable debate about whether to keep the dependence of
\distribshort on the Arrays package in order to support multi-variate
distributions. The outcome was an agreement that we would review this
at the end of 2012, based on the results of an investigation
into how feasible it would be to implement \arrays as a package.

\section{Proposed syntax and semantics}

\subsection{Overview}

This section describes the new elements that are provided by the class
to SBML and existing SBML elements that are modified in some way by
the package. Although \distribshort, like SBML is implemented in XML,
we follow the convention of the SBML specification and describe the
package in terms of UML classes and attributes.

Throughout this document, in all UML diagrams, classes that exists in
\sbmlverone or another existing standard are displayed in
black. If those elements are extended in this proposal, those
extensions are displayed in green. Classes that are new to this
proposal are shown in blue.

\subsection{Defining Distributions}

\subsubsection{The approach}

The \distrib package has a very simple purpose. It provides a
mechanism for sampling a random value from a probability
distribution. This implies that it must achieve two tasks. It must
first define the probability distribution and next it must sample a
random value from the distribution.

There are three ways to define a probability distribution in
\distribshort. The first is to reuse an existing definition. This
definition is external to the \distribshort specification, and in
theory any definition that can be specified by a URI is permitted. However, to
promote inter-operability it is recommended that \uncertml is used as
the source of external definitions and this proposal document assumes
its use.

If not using a pre-defined definition then one must explicitly define
the probability distribution, either as a probability density function (PDF)
for a continuous distribution or a probability mass function (PMF) for
a discrete one. The \distrib package provides a mechanism to do this
by referencing an external definition.

Strictly all we need are the explicit PDF and PMF
definitions. However, the advantage of using a pre-defined
distribution is that software can easily recognise the distribution
and use an optimised built-in implementation rather than interpreting
the distribution from the PDF and PMF definitions. For some
applications such optimisations make important performance
differences.

As mentioned above the distribution must be sampled. In \distribshort
the distributions are sampled when they are invoked. To reuse a
sampled value the value must be assigned to a paramater first. The
implementation algorithm used is not specified. The package permits
the definition of truncated distributions when using externally
defined distributions and again how this is implemented is left to the
implementor.

\subsubsection{Design Overview}

SBML Core is extended by redefining the \FunctionDefinition class as
can be seen in the UML representation in figure
\vref{fig:umlmodel}. The redefined \FunctionDefinition can optionally
contain a single instance of either \class{externalDefinition},
\class{explicitPDF} or \class{explicitPMF}. These classes describe the
externally defined probability distribution, the explicitly defined
PDF or the explicitly defined PMF respectively.

Slightly anomalously the \FunctionDefinition class also contains a
\mathml block containing a standard SBML function definition. This is
required to comply with the \emph{Validity after Reduction} rule in the
package design guidelines \cite{sbmll3v1packrule} and ensures a degree
of backwards compatibility for SBML readers and validators that do not
understand the \distribshort package.

\begin{figure}[htb]
\includegraphics[width=0.75\linewidth]{DistribUMLModel.pdf}
\caption{UML class diagram for the \distrib package. This diagram
  describes the classes involved and not instances of those
  classes. The namespace of the SBML Core is not shown.}
\label{fig:umlmodel}
\end{figure}

\subsection{Package Usage}

The \distrib package is defined as a \textbf{required} package. This
means that unless the software reading the SBML document 'understands'
\distribshort the model cannot be guaranteed to be correct. The
package is targetting \sbmlverone and so complies with the package
design guidelines for that version \cite{sbmll3v1packrule}.

\subsection{\FunctionDefinition Extension}

As outlined above the \FunctionDefinition is redefined to contain the
following classes from \distribshort. It maintains it existing
associations and so must also contain a \mathml block defining a
lambda function. In normal usage it is ignored, but it has the
potential to be invoked by software that does not support \distribshort
so it should be semantically correct (see section \ref{sec:fallbackfunc}).

\begin{itemize}
  \item \class{externalDefinition}
  \item \class{explicitPDF}
  \item \class{explicitPMF}
\end{itemize}

\subsection{externalDefinition}
\label{sec:extlDefnDistn}

Defining the external definition requires the specification of a URI
that defines a probability distribution. A truncated version of the
distribution may be used, in which case the \token{truncated}
attribute is true. An overview of the class specification is shown in
figure \ref{fig:externalDefinitionUml} and the attributes of the class
are defined below.

It was discussed above that the recommended source of probability
distribution definitions is \uncertml. In some cases \uncertml permits
some flexibility in its description of some distributions and permits
the invocation of several probability distributions in one
definition. To avoid this and to provide clarity and appendix (section
\ref{sec:uncertmlusage}) is provided to this document describing the
available distributions and how they can be used by
\distribshort. It is recommended that only those distribution in the
appendix are used.

\begin{figure}[htb]
\includegraphics[width=0.75\linewidth]{externalDefinitionUML}
\caption{UML class diagram describing the \class{externalDefinition}
  class and its association with \class{functionDefinition}.}
\label{fig:externalDefinitionUml}
\end{figure}

\paragraph{\token{uri}}

This provides the external definition of the distribution to be
invoked. The value of the attribute should be a URI that
uniquely identifies a definition from an external resource. The exact
nature of this URI and the external resource to use is discussed below
(section \ref{sec:extlDefnDistn}). The attribute is mandatory.

\paragraph{\token{truncated}}
\label{sec:truncatt}

This attribute indicates that a distribution is to be truncated, if
true or not if false. How this truncation is to be implemented is tool
specific. When set to true an additional two arguments are implied
when invoking the distribution. These arguments are appended to
those already required by the distribution and are invoked in the
order they are described below. In cases where one only wants to
define and upper or lower bound to the distribution values of
$-\inf$ and $\inf$ should be used respectively.

\begin{description}
\item[lower limit] The lower boundary of the truncation.
\item[upper limit] The upper boundary of the truncation.
\end{description}

\subsection{explicitPDF}

This class describes a continuous probability distribution by explicitly
defining its probability density function (PDF). The PDF is described
mathematically using a \mathml definition contained by the
\class{explicitPDF} class. Note that this function definition is
distinct from the fallback function described in section \ref{sec:fallbackfunc}.

\subsection{explicitPMF}

A discrete probability distribution is described by
\class{explicitPMF} and its associated classes, \class{category} and
\class{probability}. Together they define a probability mass function
(PMF) where each category can have an associated probability value
(figure \ref{fig:explicitpmf}).

\begin{figure}[htb]
\includegraphics[width=0.75\linewidth]{explicitPMFUML.pdf}
\caption{UML class diagram describing the \class{explicitPMF}
  class and it's associated classes used to describe each category.}
\label{fig:explicitpmf}
\end{figure}

\subsubsection{category}

The \class{category} class is used to define a discrete category in
the PMF. It is identified by an \token{id}, which should be unique
within the PMF definition and a \token{name} that is intended
to be human readable and meaningful. It has the following attributes.

\paragraph{\token{id}}

An identifier for this category of type \token{SId}. Note that this id
is scoped by the \class{explicitPMF}. In other-words the id must be
unique within the set of categories contained by an instance of
\class{explicitPMF}.

\paragraph{\token{name}}

The name of the category that is intended to be human readable and
meaningful. It is of type \token{string}. The name is optional and does
not need to be unique.

\subsubsection{\class{probability}}

The \class{probability} class holds the mathematical definition of the
probability value associated with a category. This value is defined by
an associated \mathml definition. Using \mathml to define the
probability gives the maximum flexibility as it permits the value to
be obtained by the evaluation of a mathematical expression, as a
numerical constant or by referencing a variable, which could be a
parameter for example.

\subsection{Using the \distribshort package}

The distribution defined by a \FunctionDefinition instance can be
used by instances of the following SBML classes:

\begin{itemize}
  \item InitialAssignment
  \item EventAssignments
  \item Delays
  \item Priorities
\end{itemize}

An invocation of a distribution behaves like any other function call
in SMBL and the function is executed. For a statistical distribution
this means that one or more random values are sampled from the distribution
each time the function definition is invoked. Each invocation implies
one sampling operation. Note that\contraversial including sampling in
the event related classes (i.e.\', EventAssignments, Delays and
Priorities) may be problematic in some circumstances and may
unexpected and or unstable behaviour of the model. This has been
raised in the issues section (\ref{sec:unresolved}).

\subsection{Permitted Types}

The \distrib package will support arrays and matrices via the \arrays
package. This means that paramaters passed to a function definition
can be arrays, matrices or scalar values and that a functions return
type can be either a scalar or the above non-scalar types. Type
consistency and conversion behaviour between scalar and non-scalar
types is defined by the \arrays package. See unresolved issues
(section \ref{sec:unresolved}).

\subsection{External Definition of Distributions}
\label{sec:externaldistdef}

The external definition is a URI that should refer to a standardised
dictionary of distributions. It should unambiguously define the
following:

\begin{itemize}
\item A globally unique URI by which to refer to it.
\item The parameter arguments used by the function, including for each
 argument: its name and type (scalar or non-scalar). Note that all
 arguments are mandatory.
\item The type of the random value sampled from the probability distribution.
\item An explicit and detailed mathematical description of the statistical distribution.
\end{itemize}

The recommended external definition for distributions is \uncertml: as
discussed above (section \ref{sec:extlDefnDistn}). Appendix
\ref{sec:uncertmlusage} clarifies how the distribution definitions
should be invoked and the sampled value to expect when invoked as a
\class{functionDefinition}.

\subsection{Equivalence with Fallback Function}
\label{sec:fallbackfunc}

The \mathml definition directly contained by the
\class{functionDefinition} is not used and is provided solely to
satisfy the \emph{validity upon reduction} rule for packages
\cite{sbmll3v1packrule}. This rules states that the SBML document must
be syntactically valid if all package specific elements are removed
from it. To ensure that this is the case the fallback function used in
relation to \distribshort must satisfy the following rules:

\begin{itemize}
\item the lambda function should have the same number of arguments as
  its equivalent distribution (defined by \distribshort).
\item Each argument should match the type of the equivalent argument
  in the external function.
\item The lambda function should have the same return type as the
  \emph{sampled} distribution. For example an explicit PDF when
  sampled will return a scalar value, in which case the dummy function
  should also do so.
\end{itemize}

Clearly these rules can only be enforced by a \distribshort aware validator.

\section{Package dependencies}

This package is dependent on the \arrays package to provide array and
matrix structures. It is also dependent on \mathml \cite{mathml2} to
define distributions explicitly. It uses the the subset of \mathml set
out in the SMBL Level 3 Core Specification
\cite{l3v1c}.

\section{Use-cases and examples}

\subsubsection{Sampling from a distribution: PK/PD Model}

This is a very straightforward use of an externally defined
distribution. The key point to note is that a value is sampled from
the distribution and assigned to a variable when it is invoked. In the
initialAssignments element in this example. Later use of the variable
does not result in re-sampling from the distribution. This is
consistent with current SBML semantics.

\exampleFile{examples/pkpd.xml}

\subsection{Truncated distribution}
\label{sec: truncated-eg}

To encode a truncated distribution we rely on external
definitions. Clearly it would be cumbersome if every distribution and
multivariate distribution required a truncated equivalent definition,
but at present this is what is required\contraversial. Perhaps this
problem could be solved if optional function arguments were permitted,
but this cases problems with the fallback function (see section \ref{sec:unresolved}).

\exampleFile{examples/truncated_distn.xml}

\subsection{Multivariate distribution}

In this example two correlated parameters are sampled from a
multivariate distribution. The correlation is defined using a
covariance matrix and the sampled values are returned as a vector of 2
values, which are then assigned to the individual parameters. This
example relies heavily on the \arraysshort package, which will be a
dependency of the \distribshort package. Note that because the
\arraysshort proposal is under development this example may be
completely consistent with it.

\exampleFile{examples/mutivariate_example.xml}

\subsection{User-defined continuous distribution }

In this example an additional construct is used to indicate:
\begin{itemize}
\item that the \mathml within the function definition defines a PDF and so is not a
fallback.
\item that when invoked a value should be sampled from this PDF.
\end{itemize}

\exampleFile{examples/user-defined.xml}


\subsection{User-defined discrete distribution}
\label{sec:userDefinedDiscrete}

In this example we don't use any special distrib features, by invoke
an externally defined function that constructs a PMF from a matrix of
values and their associated probabilities. The example is not
biologically meaningful, but illustrates that the matrix contains the
values and probabilities possible when throwing two dice. These values
are encoded in a matrix, which is passed as a parameter in a function,
however, it may be that this information is defined using
\numl\contraversial or by referring to an external file.

There has been very little discussion\contraversial{} about how to treat user-defined
PMFs so this example should be regarded as a starting point for
discussion rather than a final proposal.

\exampleFile{examples/user-defined-pmf.xml}

\section{Prototype implementations}

None as yet.

\section{Unresolved issues}
\label{sec:unresolved}

\begin{enumerate}
\item Should the \class{explicitPDF} class have a truncation
  attribute. This would allow one to define a truncated distribution
  without defining the truncated PDF in the \mathml definition. Is
  this desirable or not?
\item Currently the proposal provides and appendix that clarifies the
  parameters that should be specified for each \uncertml distribution and their
  type. It also defines whether one or more values are sampled from a
  given distribution. There was some argument on the list about
  whether this appendix is required. An alternative would be to use
  \uncertml definitions as-is, and live with any inherent
  ambiguity. We should make a decision about the approach we want to
  take for the final version of this proposal.
\item The use of arrays. The package and examples have been written
  that some distribution definitions will require the use of vector or
  matrix types that can be provided by the Arrays package. While
  relying on such types enables us to describe a wide range of
  probability distributions this will come at the cost of delaying
  this package's approval until Arrays has been developed and
  approved. There are two alternative strategies. One is to only
  support distributions that do not require array types (see appendix
  \ref{sec:uncertmlusage}). The other would be to define workarounds
  within \distribshort to provide array structures without using the
  arrays package. The decision at COMBINE was to wait. Do we want to
  revisit this decision?
\item Currently sampling of distributions in permitted in the event
  related elements of SBML: EventAssignments, Delays and
Priorities. The reason for prohibiting sampling in a rate law (or other
circumstances where the model is being continuously evaluated) was
because this can make the simulation unstable\footnote{See slide entitled Extrinsic
  noise:
  \url{http://sbml.org/images/3/3b/Djw-sbml-hackathon-2010-05-04.pdf}.}. It
is unclear whether a similar situation could arise while sampling from
events. The author feels this need to be looked into further by 'who know'.
\item During the review of this proposal the use of PMF and discrete
  distribution was queried. In particular should we distinguish
  between a user-defined PMF and a Categorical Distribution in this
  proposal and even have different classes to represent them. The
  distinction being that a PMF describes a multinomial distribution
  and can be defined by a piecewise function, while a categorical
  distribution has multiple categories that are not necessarily
  numeric. Advise on the correct nomenclature here would be
  appreciated.
\item Limiting the use of \class{FunctionDefinition}. In review it was
  pointed out that the restriction on sampling to InitialAssignent,
  EventAssignment etc affects MathML validity rules in SBML. Currently
  a function definition can be 'called' from any \mathml block in an
  SBML document. However, \distribshort imposes an additional special
  case. \emph{A function definition that defines a distribution can
    only be called from \mathml, where sampling is permitted.} It is
  not absolutely clear what the technical implications of this are,
  but it would appear that to implement \distribshort support any
  implementation would be required to modify the \mathml validation
  rules in libSBML. Given, that these rules are not designed to
  interact with packages this may be technically challenging to
  implement. The author feels that it would be desirable to find an
  alternative design that avoids the need to modify the \mathml
  validation rules.
\end{enumerate}

\section{Acknowledgements}
\label{sec:uncertmlusage}

Much of the initial concrete work leading to this proposal document
was carried out at the Statistical Models Workshop in Hinxton in 2011,
which was organised by Nicolas le Nov\`{e}re. A list of participants
and recordings of the discussion is available from
\url{http://sbml.org/Events/Other_Events/statistical_models_workshop_2011}.
Before that a lot of the ground work was carried out by Darren
Wilkinson who led the discussion on \distribshort at the Seattle SBML
Hackathon and before that Colin Gillespie who wrote an initial
proposal back in 2005. The author would also like to thank the
participants of the \distribshort sessions during HARMONY 2012 and
COMBINE 2012 for their excellent contributions in helping revising
this proposal; Sarah Keating, Maciej Swat and Nicolas le Nov\`{e}re
for useful discussions, corrections and review comments; and Mike
Hucka for \LaTeX{} advice and the beautiful template upon which this
document is based.

\appendix
\section{Distributions incorporated from \uncertml}

The distributions described by \uncertml \footnote{These
  distributions are defined here:
  \url{http://www.uncertml.org/distributions}} will provide the
standard external definition of distributions used by \distrib. The
definitions are comprehensive, but have multiple implicit definitions
in some cases. For example the mean and variance parameters of the
Normal distribution can be each be described as a vector of $k$
values, where each mean, variance pair describes a different
probability distribution. However, in \distribshort we want to define
one probability density and so it in necessary to disambiguate
definitions where more than one is possible.

The table below describes, for each probability distribution defined in
\uncertml: the arguments (referred to as parameters in \uncertml) it
takes, the type of each argument and type of the result obtained when
a random value (or values) is sampled from the distribution. The type
can be either a scalar (in effect a double because this is the only
scalar type supported by SBML), or an array (again of doubles), which
can have one or more dimensions.

%\begin{center}
\begin{longtable}[c]{ l l l l }
\toprule
\textbf{\uncertml Name} & \multicolumn{2}{c}{\textbf{Argument}} & \textbf{Sampled Result} \\
\cmidrule(r){2-3}
& \textbf{Name} & \textbf{Type} & \\
\toprule 
\endhead
\cmidrule(r){3-4}
\multicolumn{4}{r}{Continued on next page...}\\
\endfoot
\bottomrule
\endlastfoot
 BernouliDistribution & probability & scalar & scalar \\\midrule
BetaDistribution & alpha & scalar & scalar \\
                          & beta & scalar & \\\midrule
BinomialDistribution & numberOfTrials & scalar & scalar\\
                                 & probabilityOfSuccess & &\\\midrule
CauchyDistribution & location & scalar & scalar \\
                                 & scale & scalar & \\\midrule
ChiSquaredDistribution & degreesOfFreedom & scalar & scalar \\\midrule
DirichletDistribution & concentration & array[k], $k \ge 2$ & array[k] \\\midrule
ExponentialDistribution & rate & scalar & scalar \\\midrule
FDistribution & numerator & scalar & scalar \\
                       & denominator & scalar & \\\midrule
GammaDistribution & shape & scalar & scalar \\
                                & scale & scalar &  \\\midrule
GeometricDistribution & probability & scalar & scalar \\\midrule
HypergeometricDistribution & populationSize & scalar & scalar \\
                                             & numberOfTrials & scalar &\\
                                             & numberOfSuccesses & scalar &\\\midrule
InverseGammaDistribution & shape & scalar & scalar \\
                                & scale & scalar &  \\\midrule
LaplaceDistribution & location & scalar & scalar\\
                                  & scale & scalar & \\\midrule
LogNormalDistribution & logScale & scalar & scalar \\
                                     & shape & scalar & \\\midrule
LogisticDistribution & location & scalar & scalar \\
                                & scale & scalar & \\\midrule
MixtureModel & weight & ? & ? \\\midrule
MultinomialDistribution & numberofTrials & scalar & array[k]\\
                                       & probabiltyOfSuccess &
                                       array[k]\\\midrule
MultivariateNormalDistribution & mean & array[k] & array[k] \\
                                                  & covarianceMatrix & array[k][k] & \\\midrule
MultivariateStudentTDistribution & mean & array[k] & array[k] \\
                                                         & covarianceMatrix & array[k][k]\\
                                                         &
                                                         degreesOfFreedom
                                                         & scalar
                                                         \\\midrule
NegativeBinomialDistribution & numberOfFailures & scalar & scalar \\
                                               & probability & scalar
                                               & \\\midrule
NormalDistribution & mean & scalar & scalar \\
                                & variance & scalar & \\\midrule
NormalInverseGammaDistribution & mean & scalar & scalar\\
                                                       &
                                                       varianceScaling
                                                       & \\
                                                       & shape &\\
                                                       & scale & \\\midrule
ParetoDistribution & scale & scalar & scalar \\
                                & shape & scalar & \\\midrule
PoissionDistribution & rate & scalar & scalar \\\midrule
StudentTDistribution & location & scalar & scalar \\
                                    & scale & scalar & \\
                                    & degreesOfFreedom & scalar &
                                    \\\midrule
WeibullDistribution  & scale & scalar & scalar \\
                                     & shape & scalar & \\\midrule
WishartDistribution & scaleMatrix & scalar & scalar \\
                                  & degreesOfFreedom & scalar & \\
%\bottomrule
\end{longtable}
%\end{center}

\bibliography{sbml-level-3-distrib-package-proposal}


\end{document}

