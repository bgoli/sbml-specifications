\documentclass[draftspec]{sbmlpkgspec}
\usepackage{tabularx}
\usepackage{tabu}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{microtype}

%macros:
\newcommand{\fixttspace}{\hspace*{1pt}}

\newcommand{\sbmlthreecore}{SBML Level~3 Core\xspace}
\newcommand{\threeone}{SBML Level~3 Version~1\xspace}
\newcommand{\threetwo}{SBML Level~3 Version~2\xspace}
\newcommand{\sbmlthreedistrib}{SBML Level~3 Package Specification for Distributions, Version~1\xspace}
\newcommand{\DistributionsPackage}{\textsf{Distributions} package\xspace}
\newcommand{\TODO}[1]{\colorbox{blue}{\textcolor{white}{TODO: #1}}}

\newcommand{\DistribBase}{\defRef{DistribBase}{DistribBase-class}}
\newcommand{\Distribution}{\defRef{Distribution}{Distribution-class}}
\newcommand{\ListOfExternalParameters}{\defRef{ListOfExternalParameters}{ListOfExternalParameters-class}}
\newcommand{\ExternalParameter}{\defRef{ExternalParameter}{ExternalParameter-class}}
\newcommand{\UncertStatisticSpan}{\defRef{UncertStatisticSpan}{UncertStatisticSpan-class}}
\newcommand{\UncertValue}{\defRef{UncertValue}{UncertValue-class}}
\newcommand{\Uncertainty}{\defRef{Uncertainty}{Uncertainty-class}}



\newcommand{\FluxBound}{\textbf{\class{FluxBound}}\xspace}
\newcommand{\FunctionTerm}{\textbf{\class{FunctionTerm}}\xspace}
\newcommand{\LambdaClass}{\textbf{\class{Lambda}}\xspace}
%\newcommand{\ListOf}{\textbf{\class{ListOf__}}\xspace}
\newcommand{\ChangedMath}{\textbf{\class{ChangedMath}}\xspace}
\newcommand{\Math}{\textbf{\class{Math}}\xspace}

\newcommand{\arraysshort}{arrays\xspace}
\newcommand{\arrays}{Arrays\xspace}
\newcommand{\distribshort}{\emph{distrib}\xspace}
\newcommand{\distrib}{Distributions\xspace}
\newcommand{\mathml}{MathML\xspace}
\newcommand{\uncertml}{UncertML\xspace}

\reversemarginpar  % Want "\watchout" to be put on the left, not the right.
\newcommand{\watchout}{\marginpar{\hspace*{34pt}\raisebox{-0.5ex}{\Large\ding{43}}}}
\newcommand{\controversial}{\marginpar{\hspace*{34pt}\raisebox{-0.5ex}{\Large?}}}

\begin{document}

\packageTitle{The Distributions Package\\for SBML Level 3}
\packageVersion{Version \changed{0.24} (Draft)}
\packageVersionDate{\changed{March, 2019}}
%\packageGeneralURL{http://sbml.org/Community/Wiki/SBML_Level_3_Proposals/Distributions_and_Ranges}
%\packageThisVersionURL{}

\author{%
  \begin{tabular}{c>{\hspace{20pt}}c}
  \multicolumn{2}{c}{\Large\bf{Authors}}\\\\ Stuart L Moodie & Lucian
  P Smith\\ \mailto{moodie@ebi.ac.uk} & \mailto{lpsmith@uw.edu}\\
  EMBL-EBI & University of Washington\\ Hinxton, UK &
  Seattle, WA, USA\\ \\
  \multicolumn{2}{c}{\Large\bf{Contributors}}\\\\ Nicolas Le
  Nov\`{e}re & Darren Wilkinson\\ \mailto{lenov@babraham.ac.uk} &
  \mailto{darren.wilkinson@ncl.ac.uk}\\ Babraham Institute &
  University of Newcastle\\ Babraham, UK & Newcastle, UK\\
\\ Maciej J  Swat & Sarah Keating\\
\mailto{maciej.swat@certara.com} &  \mailto{skeating@ebi.ac.uk}
\\ QSP Simcyp & EMBL-EBI
\\ Certara, Sheffield, UK &  Hinxton, UK\\
\\
     \multicolumn{2}{c}{ Colin Gillespie}\\
     \multicolumn{2}{c}{\mailto{c.gillespie@ncl.ac.uk}}\\
     \multicolumn{2}{c}{University of Newcastle}\\
     \multicolumn{2}{c}{ Newcastle, UK}\\
\end{tabular}
}

\frontNotice{Disclaimer: This is a working draft of the SBML Level 3
  ``distrib'' package specification. It is not a normative document.  Please
  send comments and other feedback to the mailing list:
  \mailto{sbml-distrib@lists.sourceforge.net.}}

\maketitlepage
\maketableofcontents


\section*{Revision History}

The following table summarizes the history of revisions to this document and the development of the Distributions package for SBML Level~3.

\tightspacing
\begin{table}[bh]
  \centering
  \begin{edtable}{tabularx}{\linewidth}{cccX}
    \toprule
    \textbf{Version} & \textbf{Date} & \textbf{Author} & \textbf{Comments}\\
    \midrule
0.1 (Draft) & 15 Oct 2011 & Stuart Moodie & First draft \\ \midrule
0.2 (Draft) & 16 Oct 2011 & Stuart Moodie & Added introductory text
and background info. Other minor changes etc. \\ \midrule
0.3 (Draft) & 16 Oct 2011 & Stuart Moodie & Filled empty invocation
semantics section.\\ \midrule
0.4 (Draft) & 4 Jan 2012 & Stuart Moodie & Incorporated comments from
NlN, MS and SK. Some minor revisions and corrections.\\  \midrule
0.5 (Draft) & 6 Jan 2012 & Stuart Moodie & Incorporated addition
comments on aim of package from NlN.\\ \midrule
0.6 (Draft) & 19 Jul 2012 & Stuart Moodie & Incorporated revisions
discussed and agreed at HARMONY 2012.\\ \midrule
0.7 (Draft) & 6 Aug 2012 & Stuart Moodie & Incorporated review
comments from Maciej Swat and Sarah Keating.\\ \midrule
0.8 (Draft) & 21 Dec 2012 & Stuart Moodie & Incorporated changes
suggested at combine and subsequently through list discussions.\\ \midrule
0.9 (Draft) & 9 Jan 2013 & Stuart Moodie & Incorporated corrections
and comments from Maciej Swat and Sarah Keating.\\ \midrule
0.10 (Draft) & 10 Jan 2013 & Stuart Moodie & Modified based on comments
from MS.\\ \midrule
0.11 (Draft) & 17 May 2013 & Lucian Smith & Modified based on Stuart's proposals and PWG discussion.\\ \midrule
0.12 (Draft) & June 2013 & Lucian Smith and Stuart Moodie & Modified based on HARMONY 2013 discussion.\\ \midrule
0.13 (Draft) & July 2013 & Lucian Smith and Stuart Moodie & Modified based PWG discussion, particularly with respect to UncertML.\\ \midrule
0.14 (Draft) & March 2015 & Lucian Smith  & Modified to match UncertML 3.0.\\\midrule
0.15 (Draft) & March 2015 & Lucian Smith and Sarah Keating & Modified to match UncertML 3.0 for real this time.\\ \midrule
0.16 (Draft) & March 2015 & Lucian Smith & Added information about UncertML 3.0 distributions, and the distributions custom annotations.\\\midrule
0.17 (Draft) & June 2017 & Lucian Smith & Extensive update to reflect demise of UncertML 3.0, and appearance of ProbOnto.\\
\midrule
0.18 (Draft) & June 2017 & Lucian Smith & Fixes to reflect feedback on version 0.17.\\
\midrule
0.19 (Draft) & June 2018 & Lucian Smith & Resolved id/name issues with SBML Core L3V1 vs.\ L3V2.\\
\midrule
0.20 (Draft) & December 2018 & Lucian Smith & Updates to allow distributions as new MathML csymbols.\\
\midrule
0.21 (Draft) & January 2018 & Lucian Smith & Revisions based on suggestions from sbml-distrib, including extensive edits from Matthias.  Also removed the extended function definitions entirely.\\
\midrule
0.22 (Draft) & February 2018 & Lucian Smith & Addition of \token{sampleSize}, mean values of distributions for fallback.\\
\midrule
0.23 (Draft) & February 2018 & Lucian Smith and Michael Hucka & Removal of \Distribution and all subclasses; replaced with a \Math element instead; collapsed UncertStatistics into Uncertainty; some other edits from Michael Hucka.\\
\midrule
0.24 (Draft) & March 2018 & Lucian Smith & \changed{Removal of second distrib namespace, as it's no longer necessary. [[ANYTHING ELSE?]]}\\
\bottomrule
\end{edtable}
\end{table}
\regularspacing

\clearpage


\section{Introduction and motivation}

\subsection{What is it?}

The \distrib package (also known as \distribshort) provides an extension to SBML Level 3 that enables a model to encode and sample from
both discrete and continuous probability distributions, and provides
the ability to annotate elements with information about the distribution their
values were drawn from. 
Uses of the package include, for instance, descriptions of
population-based models, an important subset of which are
pharmacokinetic/pharmacodynamic (PK/PD) models\footnote{For more
  information see: \url{http://www.pharmpk.com/}.}, which are used to
model the action of drugs.

\subsection{Scope}

The \distrib package adds support to SBML for sampling from a
probability distribution. In particular the following are in scope:

\begin{itemize}
\item Sampling from a continuous distribution
\item Sampling from a discrete distribution
\item Sampling from a user-defined discrete probability density function
\item Specification of descriptive statistics (mean, standard
  deviation, standard error, etc.)
\end{itemize}

At one point the following were considered for inclusion in this
package but are now \textbf{out of scope}:

\begin{itemize}
\item Definitions of ranges (the original name of the package was 'Distributions and Ranges')
\item Sampling from user-defined probability density function
\item Stochastic differential equations
\item Other functions used to characterise a probability distribution,
  such as cumulative distribution functions (CDF) or survival functions, etc.
\end{itemize}

\subsection{This document}

This draft specification describes the consensus view of workshop participants and subscribers to the sbml-distrib mailing list. Although it was written by the listed authors, it does not solely reflect their views nor is it their proposal \changed{alone}. Rather, it is their understanding of the consensus view of what the \distrib package should do and how it should do it. The contributors listed have made significant contributions to the development and writing of this specification and are credited accordingly, but a more comprehensive attribution is provided in the acknowledgements (\sec{sec:acknowledgements}).

\subsection{Conventions used in this document}

There are some
parts of this draft specification where there is no clear consensus on the
correct solution, or only recent agreement, or agreement by a group
that may not be representative of the SBML community as a
whole. These cases are indicated by the \controversial question mark
in the left margin (illustrated here). The reader should pay particular
attention to these points and ideally provide feedback, especially if
they disagree with what is proposed. Similarly there will be points---especially as the proposal is consolidated---which are agreed,
but which the reader should take note of and perhaps read again. These
points \watchout are emphasized by the hand pointer in the left margin
(illustrated).

\section{Background}

\subsection{Problems with current SBML approaches}

SBML Level 3 Core has no direct support for encoding values sampled from distributions. Currently there is no workaround within the core SBML
language itself, although it is possible to define the necessary information
using annotations on SBML elements. Frank Bergmann proposed such an annotation scheme for use with SBML Levels 2~and~3 (see \sec{sec:annotation-scheme}).

\subsection{Past work on this problem or similar topics}

\subsubsection{The Newcastle Proposal}
\label{sec:newcastle proposal}

In 2005, Colin Gillespie and others put forward a proposal
\footnote{\url{http://sbml.org/Community/Wiki/SBML\_Leve\l_3\_Proposals/Distributions\_and\_Ranges}}
to introduce support for probability distributions in the SBML core specification. This
was based on their need to use such distributions to represent the
models they were creating as part of the BASIS project
(\url{http://www.basis.ncl.ac.uk}).
They proposed that distributions be referred to in SBML using
the \class{csymbol} element in the \mathml subset used by
the SBML Core specification. An example is below:

\begin{example}
<math xmlns=''http://www.w3.org/1998/Math/MathML''>
  <apply>
    <csymbol encoding=''text''
        definitionURL=''http://www.sbml.org/sbml/symbols/uniformRandom''>
      uniformRandom
    </csymbol>
    <ci>mu</ci>
    <ci>sigma</ci>
  </apply>
</math>
\end{example}

This required that a library of definitions be maintained as part of
the SBML standard and in their proposal they defined an initial small
set of commonly used distributions. The proposal was never
implemented.

\subsubsection{Seattle 2010}

The ``distrib'' package was discussed at the Seattle SBML Hackathon%
\footnote{\url{http://sbml.org/Events/Hackathons/The_2010_SBML-BioModels.net_Hackathon}}
and this section is an almost verbatim reproduction of Darren
Wilkinson's report on the
meeting\footnote{\url{http://sbml.org/Forums/index.php?t=tree\&goto=6141\&rid=0}}. In the meeting,
Darren presented an overview of the problem%
\footnote{Slides: \url{http://sbml.org/images/3/3b/Djw-sbml-hackathon-2010-05-04.pdf}}%
\footnote{Audio: \url{http://sbml.org/images/6/67/Wilkinson-distributions-2010-05-04.mov}},
building on the old proposal from the Newcastle group (see above:
\ref{sec:newcastle proposal}).  There was broad support at the meeting
for development of such a package, and for the proposed feature
set. Discussion following the presentation led to consensus on the
following points:

\begin{itemize}
\item There is an urgent need for such a package.
\item It is important to make a distinction between a description of
  uncertainty regarding a model parameter and the mechanistic process
  of selecting a random number from a probability distribution, for
  applications such as parameter scans and experimental design
\item It is probably worth including the definition of PMFs, PDFs and CDFs in the package
\item It is worth including the definition of random distributions using particle representations within such a package, though some work
 still needs to be done on the precise representation
\item It could be worth exploring the use of XML's \texttt{xinclude} construct to point at particle
representations held in a separate file
\item Random numbers must not be used in rate laws or anywhere else that
 is continuously evaluated, as then simulation behaviour is not
 defined
\item Although there is a need for a package for describing extrinsic
 noise via stochastic differential equations in SBML, such mechanisms
 should not be included in this package due to the considerable
 implications for simulator developers
\item We probably don't want to layer on top of \uncertml
 (\url{www.uncertml.org}), as this spec is fairly heavy-weight, and
 somewhat tangential to our requirements
\item A random number seed is not part of a model and should not be
 included in the package
\item The definition of truncated distributions and the specification of
 hard upper and lower bounds on random quantities should be
 considered.
\end{itemize}

It was suggested that new constructs could be introduced into SBML via user-defined functions by embedding ``distrib'' constructs in a manner illustrated by the following example:

\begin{example}
<listOfFunctionDefinitions>
  <functionDefinition id="myNormRand">
    <distrib:####>
      #### distrib binding information here ####
    </distrib:####>
    <math>
      <lambda>
        <bvar>
          <ci>mu</ci>
          <ci>sigma</ci>
        </bvar>
        <ci>mu</ci>
      </lambda>
    </math>
  </functionDefinition>
</listOfFunctionDefinitions>
\end{example}

This approach allows the use of a ``default value'' by simulators which do not
understand the package (but simulators which do will ignore the \token{<math>}
element). The package would nevertheless be ``required'', as it will not
be simulated correctly by software which does not understand the
package.

Informal discussions following the break-out covered topics such as:

\begin{itemize}
\item how to work with vector random quantities despite that SBML does not use the vector element from MathML
\item how care must be taken with the semantics of random variables
  and the need to both:
\begin{itemize}
\item reference multiple independent random quantities at a given
  time
\item make multiple references to the same random quantity at a given
time
\end{itemize}
\end{itemize}

\subsubsection{Hinxton 2011}

Detailed discussion was continued at the Statistical Models Workshop
in Hinxton in June 2011%
\footnote{\url{http://sbml.org/Events/Other_Events/statistical_models_workshop_2011}}. There,
people interested in representing statistical models in SBML came
together to work out the details of how this package would work in
detail. Dan Cornford from the \uncertml
project\footnote{\url{http://www.uncertml.org/}} attended the meeting
and described how that resource could be used to describe uncertainty
and in particular probability distributions. Perhaps the most
significant decision at this meeting was to adopt the \uncertml
resource as a controlled vocabulary that is referenced by the \distrib package.

Much has changed since this meeting, but the output from this meeting
was the basis for the first version of the ``distrib'' draft specification.


\subsubsection{HARMONY 2012: Maastricht}

Two sessions were dedicated to discussion of \distrib at HARMONY based
around the proposals described in version~0.5 of this document. In
addition there was discussion about the \arrays proposal which was
very helpful in solving the problem of multivariate distributions in
\distrib. The following were the agreed outcomes of the meeting:

\begin{itemize}
\item The original ``distrib'' draft included UncertML markup directly in the
  function definition. This proved unwieldy and confusing and has been
  replaced by a more elegant solution that eliminates the UncertML
  markup and integrates well with the fallback function (see details
  below).
\item Multivariate distributions can be supported using the \arrays
  package to define a covariance matrix.
\item User defined continuous distributions would define a PDF in
  \mathml.
\item Usage semantics were clarified so that invokation of a function
  definition implied a value was sampled from the specified
  distribution.
\item It was agreed from which sections of an SBML model a
  distribution could be invoked.
\item Statistical descriptors of variables (for
  example mean and standard deviation) would be separated from
  \distrib and either provided in a new package or in a later version
  of SBML L3 core.
\end{itemize}

\subsubsection{COMBINE 2012: Toronto}

The August draft of ``distrib'' was reviewed, and an improvement was agreed upon in
the user-defined PMF part of the proposal. In particular, is was agreed
that the categories should be defined by \distribshort classes rather
than by passing in the information as an array. Questions were also raised
about whether \uncertml was suitably well defined to be used as an
external definition for probability distributions. This was resolved
subsequent to the meeting with a teleconference to Dan Cornford and
colleagues. These changes are incorporated here. Finally, there was
considerable debate about whether to keep the dependence of
\distribshort on the Arrays package in order to support multi-variate
distributions. The outcome was an agreement that we would review this
at the end of 2012, based on the results of an investigation
into how feasible it would be to implement \arrays as a package.

\subsubsection{2013 Package Working Group discussions}

Early 2013 saw a good amount of discussion on the \distribshort Package Working Group mailing list, spurred by proposals by Stuart Moodie\footnote{\url{http://thestupott.wordpress.com/2013/03/12/an-improved-distrib-proposal/}}.  While not all of his suggestions ended up being fully accepted by the group, several changes were accepted, including:

\begin{itemize}
\item To use UncertML as actual XML, instead of as a set of reference definitions.
\item To use UncertML to encode descriptive statistics of SBML elements such as mean, standard deviation, standard error, etc.)\ bringing this capability back in scope for this package.
\end{itemize}


\subsubsection{HARMONY 2013: Connecticut}

At the HARMONY held at the University of Connecticut Health Center, further discussions revealed the importance of distinguishing the ability to describe an element as a distributed variable vs.\ a function call within the model performing a draw from a distribution.

We also decided to discard the encoding of explicit PDFs for now, as
support for it is remarkably complicated, and there no demand for
it. The current design could be extended to support this feature so if
there is demand for it in the future support for explicit PDFs could
be reintroduced.

\subsubsection{Early 2017 and HARMONY: Seattle}

In early 2017, it became clear that UncertML was no longer being worked on; the web page had lapsed, and its authors had moved on to other things.  At the same time, the ProbOnto ontology (\citealt{swat:2016}; \url{http://probonto.org/}) was developed that included all the distributions from UncertML as well as a huge number of other distributions.  On the ``distrib'' mailing list, there was discussion about whether to create essentially our own version of UncertML, or to implement a generic ``reference'' format that used ProbOnto.  The~v0.17 draft specification was developed as a compromise 'hybrid' system that did parts of both, so that basic distributions would be hard-coded, but the ability to reference any ProbOnto ontology would also be present.  The hope is that with working examples of both approaches, either the hybrid approach will be approved, or if one is preferred, the other approach may be removed.  This version of the specification was created for presentation at HARMONY 2017 in Seattle.

\subsubsection{Early 2018 and HARMONY: Oxford}

At the HARMONY held at the University of Oxford, for the first time since the change from UncertML, a libSBML implementation of the specification was available.  This let people experiment with the package, and conclude that a simpler method of defining calls to distributions was desired.  It was proposed to define new MathML \texttt{csymbol} definitions for the common distributions.  Eventually, these new \token{csymbols} were used instead of the old Distribution class, greatly simplifying the proposal.


\section{Proposed syntax and semantics}

\subsection{Overview}

Drawing on and extending the precedent set by the SBML Level~3 Core specification
document, we use UML~1.0 (Unified Modeling Language;
\citealt{eriksson:1998, oestereich:1999}) class diagram notation to
define the constructs provided by this package.  We also use color in
the diagrams to carry additional information for the benefit of those
viewing the document on media that can display color.  The following are
the colors we use and what they represent:

\begin{itemize}

\item[\raisebox{2.75pt}{\colorbox{black}{\rule{0.8pt}{0.8pt}}}]
  \emph{Black}: Items colored black in the UML diagrams are components
  taken unchanged from their definition in the SBML Level~3 Core
  specification document.

\item[\raisebox{2.75pt}{\colorbox{mediumgreen}{\rule{0.8pt}{0.8pt}}}]
  \emph{\textcolor{mediumgreen}{Green}}: Items colored green are
  components that exist in SBML Level~3 Core, but are extended by this
  package.  Class boxes are also drawn with dashed lines to further
  distinguish them.

\item[\raisebox{2.75pt}{\colorbox{darkblue}{\rule{0.8pt}{0.8pt}}}]
  \emph{\textcolor{darkblue}{Blue}}: Items colored blue are new
  components introduced in this package specification.  They have no
  equivalent in the SBML Level~3 Core specification.

\item[\raisebox{2.75pt}{\colorbox{red}{\rule{0.8pt}{0.8pt}}}]
  \emph{\textcolor{red}{Red lines}}: Classes with red lines in the corner are fully defined in a different figure.

\end{itemize}

We also use the following typographical conventions to distinguish the
names of objects and data types from other entities; these conventions
are identical to the conventions used in the SBML Level~3 Core specification
document:

\begin{description}
  
\item \abstractclass{AbstractClass}: Abstract classes are never
  instantiated directly, but rather serve as parents of other classes.
  Their names begin with a capital letter and they are printed in a
  slanted, bold, sans-serif typeface.  In electronic document formats,
  the class names defined within this document are also hyperlinked to
  their definitions; clicking on these items will, given appropriate
  software, switch the view to the section in this document containing
  the definition of that class.  (However, for classes that are
  unchanged from their definitions in SBML Level~3 Core, the class names
  are not hyperlinked because they are not defined within this
  document.)
  
\item \class{Class}: Names of ordinary (concrete) classes begin with a
  capital letter and are printed in an upright, bold, sans-serif
  typeface.  In electronic document formats, the class names are also
  hyperlinked to their definitions in this specification document.
  (However, as in the previous case, class names are not hyperlinked if
  they are for classes that are unchanged from their definitions in the
  SBML Level~3 Core specification.)

\item \token{SomeThing}, \token{otherThing}: Attributes of classes, data
  type names, literal XML, and tokens \emph{other} than SBML class
  names, are printed in an upright typewriter typeface.  Primitive types
  defined by SBML begin with a capital letter; SBML also makes use of
  primitive types defined by XML
  Schema~1.0~\citep{biron:2000,fallside:2000,thompson:2000}, but
  unfortunately, XML~Schema does not follow any capitalization
  convention and primitive types drawn from the XML~Schema language may
  or may not start with a capital letter.

\item \token{[elementName]}:  In some cases, an element may contain a child of any class inheriting from an abstract base class.  In this case, the name of the element is indicated by giving the abstract base class name in brackets, meaning that the actual name of the element depends on whichever subclass is used. The capitalization follows the capitalization of the name in brackets.

\end{description}

For other matters involving the use of UML and XML, we follow the
conventions used in the SBML Level~3 Core specification document.  


\subsection{Namespace URI and other declarations necessary for using this package}
\label{xml-namespace}

Every SBML Level~3 package is identified uniquely by an XML namespace URI.  For an SBML document to be able to use a given Level~3 package, it must declare the use of that package by referencing its URI.  This version of the \distrib package uses the URI:
\begin{center}
\uri{http://www.sbml.org/sbml/level3/version1/distrib/version1}
\end{center}

Note that the \distrib package may be used with both \threeone and \threetwo documents, with the no semantic changes between the two in any \distribshort element, due to the addition of \token{id} and \token{name} to the \DistribBase class.

In addition, SBML documents using a given package must indicate whether the package may be used to change the mathematical meaning of \sbmlthreecore elements.  This is done using the attribute \token{required} on the \token{<sbml>} element in the SBML document.  For the \distrib package, the value of this attribute must be \val{true}, as it defined new csymbols that may be used in any MathML.  Note that the value of this attribute must \emph{always} be set to \val{true}, even if the particular model does not contain any of these csymbols.

The following fragment illustrates the beginning of a typical SBML model using \threeone and this version of the \distrib package:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version1/core" level="3" version="1"
      xmlns:distrib="http://www.sbml.org/sbml/level3/version1/distrib/version1"
      distrib:required="true">
\end{example}


The following fragment illustrates the beginning of a typical SBML model using \threetwo and this version of the \distrib package:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version2/core" level="3" version="2"
      xmlns:distrib="http://www.sbml.org/sbml/level3/version1/distrib/version1"
      distrib:required="true">
\end{example}

There is no difference between these two namespaces, and all package semantics are identical.

\paragraph{XML Namespace use}

For element names, XML has clear rules about how to declare and use namespaces.  In typical SBML documents, the \distrib namespace will be defined as above, and elements will therefore need to be prefixed with \val{distrib:}.

In contrast to element names, XML \emph{attribute} names are completely defined by the element in which they appear, and never have a ``default'' namespace defined. The element itself declares whether any attributes should be defined with a namespace prefix.

Following the typical convention used by SBML packages, any attribute that appears in a UML diagram in this specification may \emph{either} be defined with no namespace prefix, \emph{or} be defined with the \emph{distrib} namespace as a prefix.  (No attributes are defined here as extentions of existing core SBML elements, and thus none of them are required to have the \emph{distrib} namespace as a prefix.)


\subsection{Primitive data types}
\label{new-primitive-types}

The \distrib package uses data types described in Section~3.1 of the \sbmlthreecore specification, and adds the additional primitive types described below.

\subsubsection{Type \fixttspace\primtypeNC{ExternalRef}}
\label{sec:primtype-externalref}

The type \primtype{ExternalRef} is derived from the type \primtype{string} with the additional requirement that it be a valid URI.  An \primtype{ExternalRef} is used in the \distrib package to point to ontologies such as ProbOnto~\citep{swat:2016}, which contain the definitions of distributions and parameters. 


%\subsubsection{Type \fixttspace\primtypeNC{UncertId}}
%\label{sec:primtype-uncertid}

%The type \primtype{UncertId} is derived from \primtype{SId} (\sbmlthreecore specification Section~3.1.7) and has identical syntax.  The \primtype{UncertId} type is used to create local ids that can be used in the extended \FunctionDefinition objects to refer to the arguments of the function, in much the same way that the identities of the \token{bvar} elements are used in MathML \token{lambda} elements.  Each \primtype{UncertId} has a scope local to the \DrawFromDistribution in which it is found.  The
%equality of \primtype{UncertId} values is determined by an exact
%character sequence match; i.e., comparisons of these identifiers must be
%performed in a case-sensitive manner.


%\subsubsection{Type \fixttspace\primtypeNC{UncertIdRef}}
%\label{sec:primtype-uncertidref}

%Type \primtype{UncertIdRef} is used to reference different elements in different contexts.  Inside a \FunctionDefinition, an \primtype{UncertIdRef} may only reference an \primtype{UncertId} from a \DistribInput from that same \FunctionDefinition.  Outside a \FunctionDefinition, an \primtype{UncertIdRef} may reference any element with an \primtype{SId} that has mathematical meaning: even elements from other packages, and not in \sbmlthreecore.  In the context of an \threeone document, this still holds true.  Even though \threeone elements with \primtype{SIdRef} attributes cannot reference package elements, this does not preclude \distrib elements from doing so.

%If a referenced \primtype{SId} is from a package that is not understood by the software reading the model, the meaning of the \primtype{UncertIdRef} is undefined.   If an interpreter does not understand an id and cannot tell whether that id came from a not-understood package, it may issue a warning.


%As with \primtype{UncertId}, the equality of
%\primtype{UncertIdRef} values is determined by exact character sequence
%match; i.e., comparisons of these identifiers must be performed in a
%case-sensitive manner.


\subsection{Defining Distributions}

\subsubsection{The approach}

The \distrib package has two simple purposes. First, it provides a mechanism for sampling a random value from a probability distribution. This implies that it must define the probability distribution and then must sample a random value from that distribution.  Second, it provides a mechanism for describing elements with information about their uncertainty.  One common use case for this is to provide the standard deviation for a value.  Another is describing a parameter's distribution so that a better search can be performed in parameter scan experiments.

The first purpose is achieved by allowing new \mathml elements, and the second by extending \SBase, which in turn uses the \Uncertainty class.  Several distributions and statistics are defined explicitly in this specification, but more can be defined by referencing an external ontology such as ProbOnto through the \ExternalParameter class.

%It is hoped that with this approach, modelers may use the extensions defined in this specification with a reasonable expectation that most other software packages will also recognize them.  However, if another distribution is required, those distributions may still be encoded through reference to an external ontology, even if this makes the model less exchangeable.

When a call to a distribution is defined in the extended \Math, it is sampled when it is invoked. If a particular returned value needs to be used again, that value must be assigned to a parameter first, such as through the use of an \InitialAssignment or \EventAssignment.  When a distribution is defined elsewhere, that information may be used outside of the model, using whatever methodology is appropriate to answer the question being pursued.


\subsection{Extended \Math}

To allow quick access to a variety of common functions, the \distrib package allows the use of new types of \token{csymbol} elements anywhere that \Math is used.  These \token{csymbol}s are functions, and therefore must be the first child of an \token{apply} element, and their arguments are predefined: you cannot call \textit{normal(mean, variance)}, because the definition of the \token{normal} \token{csymbol} is \textit{normal(mean, stdev)}.

The newly-allowed \token{csymbol} elements are defined in the following table:

\begin{table}[bh]
  \centering
  \begin{edtable}{tabularx}{\linewidth}{@{}>{\ttfamily}l>{\normalfont\itshape}l@{}}
\toprule
\textbf{URI} & \textbf{\textsf{\textup{Possible arguments}}} \\
\midrule
http://www.sbml.org/sbml/symbols/distrib/normal             & normal(mean, stdev) \\
                                                            & normal(mean, stdev, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/uniform            & uniform(min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/bernoulli   & bernoulli(prob)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/binomial    & binomial(nTrials, probabilityOfSuccess) \\
                                                            & binomial(nTrials, probabilityOfSuccess, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/cauchy      & cauchy(location, scale) \\
                                                            & cauchy(location, scale, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/chi-square  & chisquare(degreesOfFreedom) \\
                                                            & chisquare(degreesOfFreedom, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/exponential & exponential(rate)\\
                                                            & exponential(rate, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/gamma       & gamma(shape, scale) \\
                                                            & gamma(shape, scale, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/laplace     & laplace(location, scale) \\
                                                            & laplace(location, scale, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/log-normal  & lognormal(shape, scale) \\
                                                            & lognormal(shape, scale, min, max
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/poisson     & poisson(rate) or poisson(rate, min, max)
\\ \midrule
http://www.sbml.org/sbml/symbols/distrib/normal/rayleigh    & rayleigh(scale) or rayleigh(scale, min, max)
\\
\bottomrule
\end{edtable}
\end{table}

Many of the distributions take exactly two or four arguments (or exactly one or three arguments).  For those functions, the optional last two arguments are \textit{min} and \textit{max}, for when the draw from the distribution is constrained to be between those two values.  For all functions, the \textit{min} boundary is inclusive; that is, a value of \textit{min} may be returned by the function (though this may be very unlikely for draws from a continuous distribution).  For all continuous distributions, the \textit{max} boundary is \emph{not} inclusive; that is, a value of \textit{max} will never be returned.  The continuous distributions are \token{normal}, \token{cauchy}, \token{chisquare}, \token{exponential}, \token{gamma}, \token{laplace}, \token{lognormal}, and \token{rayleigh}.  For the discrete distributions, the \textit{max} boundary is inclusive: that is, a value of \textit{max} may indeed be returned.  The discrete distributions are \token{binomial} and \token{poisson}.

\paragraph{Fallback functions}

If an SBML interpreter is unable to calculate one or more of the above extended \mathml functions, it may simply fail, or it might choose to return the mean of the given function instead.  In either case, it is a good idea to inform the user that the model cannot be interpreted by the software as intended.

The following mean values may be used as a fallback for software that cannot perform draws from a distribution.  Note that truncated versions of these functions will have different means.  Note also that the \token{cauchy} distribution has no mean, by definition.

\begin{table}[bh]
  \centering
  \begin{edtable}{tabularx}{4.5in}{>{\normalfont\itshape}r>{\normalfont\itshape}l}
\toprule
\textbf{\textsf{\textup{Function}}}                       & \textbf{\textsf{\textup{Fallback (mean)}}} \\ \midrule
normal(mean, stdev)                     & mean
\\ \midrule
uniform(min, max)                       & $\dfrac{\text{min}+\text{max}}{2}$
\\ \midrule
bernoulli(prob)                         & prob
\\ \midrule
binomial(nTrials, probabilityOfSuccess) & $\text{nTrials}\, \times \text{probabilityOfSuccess}$
\\ \midrule
cauchy(location, scale)                 & \textup{undefined}
\\ \midrule
chisquare(degreesOfFreedom)             & degreesOfFreedom
\\ \midrule
exponential(rate)                       & $\text{rate}^{-1}$
\\ \midrule
gamma(shape, scale)                     & $\text{shape}\, \times \text{scale}$
\\ \midrule
laplace(location, scale)                & location
\\ \midrule
lognormal(shape, scale)                 & $\text{exp}(\text{scale} + \text{shape}/2)$
\\ \midrule
poisson(rate)                           & rate
\\ \midrule
rayleigh(scale)                         & scale $\sqrt{\pi/2}$
\\
\bottomrule
\end{edtable}
\end{table}
\vspace*{-3ex}

\subsection{Discrete vs. continuous sampling}
\label{discrete-continuous}

\mathml csymbols may be used in \sbmlthreecore in both discrete and continuous contexts:  \InitialAssignment, \EventAssignment, \Priority, and \Delay elements are all discrete, while \Rule, \KineticLaw, and \Trigger elements are all continuous in time.  For discrete contexts, the behavior of \distribshort-extended \FunctionDefinition elements is well-defined:  a single random value is sampled from the distribution each time the function definition is invoked. Each invocation implies one sampling operation.  In continuous contexts, however, their behavior is ill-defined.  More information than is defined in this package (such as autocorrelation values or full conditional probabilities) would be required to make random sampling tractable in continuous contexts, and is beyond the scope of this version of the package.  If some package is defined in the future that adds this information, or if custom annotations are provided that add this information, such models may become simulatable.  However, this package does not define how to handle sampling in continuous contexts, and recommends against it: a warning may be produced by any software encountering the use of a \distribshort-extended \mathml in a continuous context.  Assuming such models are desirable, and the information is not provided in a separate package, this information may be incorporated into a future version of this specification.

Any other package that defines new contexts for MathML will also be either discrete or continuous.  Discrete situations (such as those defined in the SBML Level~3 Qualitative Models package) are, as above, well-defined.  Continuous situations (as might arise within the Spatial Processes package, over space instead of over time) will most likely be ill-defined.  Those packages must therefore either define for themselves how to handle \distribshort-extended \mathml elements, or leave it to some other package/annotation scheme to define how to handle the situation.



\subsection{Examples using the extended \tokenNC{csymbol} element}
\label{sec:cs-examples}

Several examples are given below that illustrate various uses of the new \token{csymbol} elements introduced by \distribshort.

\subsubsection{Using a normal distribution}

In this example, the initial value of \token{y} is set as a draw from a normal distribution:

\begin{example}
...
  <initialAssignment symbol="y">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
      <apply>
        <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/normal"
                 encoding="text"> normal </csymbol>
        <ci> z </ci>
        <cn> 10 </cn>
      </apply>
    </math>
  </initialAssignment>
...
\end{example}

This use would apply a draw from a normal distribution with mean \token{z} and standard deviation \token{10} to the symbol \token{y}.

\subsubsection{Defining a truncated normal distribution}

When used with four arguments instead of two, the normal distribution is truncated:

\begin{example}
...
  <initialAssignment symbol="y">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
      <apply>
        <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/normal"
                 encoding="text"> normal </csymbol>
        <ci> z </ci>
        <cn type="integer"> 10 </cn>
        <apply>
          <minus/>
          <ci> z </ci>
          <cn type="integer"> 2 </cn>
        </apply>
        <apply>
          <plus/>
          <ci> z </ci>
          <cn type="integer"> 2 </cn>
        </apply>
      </apply>
    </math>
  </initialAssignment>
...
\end{example}

This use would apply a draw from a normal distribution with mean \token{z}, standard deviation \token{10}, lower bound \token{z $-$ 2} (inclusive) and upper bound \token{z $+$ 2} (not inclusive) to the SBML symbol \token{y}.

\subsubsection{Defining conditional events}

Simultaneous events in SBML are ordered based on their \Priority values, with higher values being executed first, and potentially cancelling events that fire after them.  In this example, two simultaneous events have priorities set with csymbols defined in \distribshort.  The event \token{E0} has a priority of \token{uniform(0,1)}, while the event \token{E1} has a priority of \token{uniform(0,2)}.  This means that 75\% of the time, event \token{E1} will have a higher priority than \token{E0}, and will fire first, assigning a value of \token{5} to parameter \token{x}.  Because this negates the trigger condition for \token{E0}, which is set \token{persistent}=\val{false}, this means that \token{E0} never fires, and the value of \token{x} remains at \token{5}.  The remaining 25\% of the time, the reverse happens, with \token{E0} setting the value of \token{x} to \token{3} instead.


\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version2/core"
      xmlns:distrib="http://www.sbml.org/sbml/level3/version1/distrib/version1"
      level="3" version="2" distrib:required="true">
  <model metaid="__main" id="__main">
    <listOfParameters>
      <parameter metaid="__main.x" id="x" value="0" constant="false"/>
    </listOfParameters>
    <listOfEvents>
      <event id="E0" useValuesFromTriggerTime="true">
        <trigger initialValue="true" persistent="false">
          <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
              <and/>
              <apply>
                <gt/>
                <csymbol encoding="text" definitionURL="http://www.sbml.org/sbml/symbols/time">
                         time </csymbol>
                <cn type="integer"> 2 </cn>
              </apply>
              <apply>
                <lt/>
                <ci> x </ci>
                <cn type="integer"> 1 </cn>
              </apply>
            </apply>
          </math>
        </trigger>
        <priority>
          <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
              <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/uniform"
                       encoding="text"> uniform  </csymbol>
              <cn type="integer"> 0 </cn>
              <cn type="integer"> 1 </cn>
            </apply>
          </math>
        </priority>
        <listOfEventAssignments>
          <eventAssignment variable="x">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
              <cn type="integer"> 3 </cn>
            </math>
          </eventAssignment>
        </listOfEventAssignments>
      </event>
      <event id="E1" useValuesFromTriggerTime="true">
        <trigger initialValue="true" persistent="false">
          <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
              <and/>
              <apply>
                <gt/>
                <csymbol encoding="text" definitionURL="http://www.sbml.org/sbml/symbols/time">
                         time </csymbol>
                <cn type="integer"> 2 </cn>
              </apply>
              <apply>
                <lt/>
                <ci> x </ci>
                <cn type="integer"> 1 </cn>
              </apply>
            </apply>
          </math>
        </trigger>
        <priority>
          <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
              <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/uniform"
                       encoding="text"> uniform  </csymbol>
              <cn type="integer"> 0 </cn>
              <cn type="integer"> 2 </cn>
            </apply>
          </math>
        </priority>
        <listOfEventAssignments>
          <eventAssignment variable="x">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
              <cn type="integer"> 5 </cn>
            </math>
          </eventAssignment>
        </listOfEventAssignments>
      </event>
    </listOfEvents>
  </model>
</sbml>
\end{example}


\subsection{The \class{DistribBase} class}
\label{sec:DistribBase-class}
\label{DistribBase-class}
\label{distribbase-class}
\label{sec:idname}

The \DistribBase class is an abstract base class which is the parent class for every class in this \distrib package.  Its purpose is to replicate within the \distrib package an important change between \threeone and \threetwo: the addition of an optional \token{id} and \token{name} attribute to \SBase.  By adding these attributes here, \distribshort may be used completely exchangeably between Level~1 and Level~2 documents without any other modifications.

\begin{figure}[bh]
  \includegraphics{figs/distribBase.pdf}
  \caption{The definition of the \DistribBase class.  The \token{id} and \token{name} attributes defined are optional, and are identical to the ones they inherit in \threetwo documents from \SBase.}
  \label{fig:distribBase}
\end{figure}

The meaning of these attributes is identical, regardless of the Level/Version of the document in which they appear.

The \token{id} attribute is of type \primtype{SId}, and must be unique among other ids in the \primtype{SId} namespace in the parent \Model, and has no mathematical meaning, unless stated otherwise in the definition of that object.  The \token{name} attribute is of type \primtype{string}, and is provided to allow the user to define a human-readable label for the object.  It has no uniqueness restrictions.

\begin{figure}[htb]
\includegraphics[width=0.6\linewidth]{figs/uncertValue.pdf}
\caption{The definition of the \UncertValue and \ExternalParameter classes.  These classes all describe a way to define or reference an element with mathematical meaning.  The meaning of an \ExternalParameter is defined by its \token{definitionURL}, as well as its children.}
\label{fig:uncertValue}
\end{figure}


\subsection{The \class{UncertValue} class}
\label{UncertValue-class}
\label{uncertvalue-class}

The \UncertValue class provides two optional attributes, exactly one of which must be defined.  The \token{value} attribute (of type \primtype{double}) is used when the \UncertValue represents a particular number, and the \token{var} attribute (of type \primtype{UncertIdRef}) is used when the \UncertValue represents a referenced element with mathematical meaning.  %In the context of a \FunctionDefinition, this can only reference a \DistribInput, as no \primtype{SId} from the \Model may be referenced from within a \FunctionDefinition.  In other contexts, it may reference the \primtype{SId} of any element with mathematical meaning; see \sec{sec:primtype-uncertidref}.

The optional \token{units} attribute may be used to indicate the units of the \token{val} attribute.  As such, it may only be defined if the \UncertValue has a defined \token{value} attribute, and not if it has a defined \token{var} attribute.  (In the latter case, the units may be obtained from the referenced element.)

Any given \UncertValue in an \Uncertainty will have an element name specific to the parameter it represents within that \Uncertainty.  So, for example, one \Uncertainty may have a single child \UncertValue with the name \val{<mean>}, and another might have a \UncertValue child with the name \val{<standardDeviation>}.  All these parameters are defined as the same class for simplicity, since all of them merely need a way to reference a value.


\subsubsection{Attributes inherited from \SBase}

An \UncertValue always inherits the optional \token{metaid} and \token{sboTerm} attributes, and inherits optional \token{id} and \token{name} attributes as described in \sec{sec:idname}.  The \token{id} of a \UncertValue takes the mathematical value of its \token{value} attribute if that attribute is defined, and the mathematical value of the corresponding \token{var} if that attribute is defined.  This meaning may be used in other contexts, but that meaning may not be set directly by any other SBML element of any Level, Version, or package.  If setting the value is desired, the \token{var} attribute should be used, and that referenced element set as per normal SBML procedures.  The meaning is provided mostly to allow access to the \token{val} attribute, which otherwise would be undiscoverable to any other SBML element.

\subsection{The \class{ExternalParameter} class}
\label{ExternalParameter-class}
\label{externalparameter-class}

The \ExternalParameter class is provided to allow a modeler to encode externally-provided parameters not otherwise explicitly handled by this specification.  The range of possibilities is vast, so modelers should ensure that the tool they wish to use encodes support for any \ExternalParameter they define.

The \ExternalParameter inherits from \UncertValue, and adds the required attribute \token{definitionURL}, which is of type \primtype{ExternalRef}, and an optional child \ListOfExternalParameters.  The \token{definitionURL} must be a URI that defines a valid distribution-related parameter.  It is strongly recommended that modelers use distribution parameters from ProbOnto (\url{http://probonto.org/}) and other statistical parameters from STATO (\url{https://www.ebi.ac.uk/ols/ontologies/stato}), as consistently referencing a single ontology will improve exchangeability.

The child \ListOfExternalParameters is provided because some parameters may themselves need further parameterization.  For example, a mixture distribution defined as an \ExternalParameter would itself contain child \ExternalParameter objects those other base distributions that were mixed in the overall distribution.  Those base distributions would need to define their own parameterization, which could be accomplished here with child \ExternalParameter objects.  Similarly, ranges or categories might also need to be further defined with reference to child \ExternalParameter 
objects that would be considered to ``belong'' to the parent \ExternalParameter.

The referenced parameter is then the parameter defined by this \ExternalParameter, along with any further parameterization provided by its own children \ExternalParameter elements.

Some external parameters are not single-valued, but are multi-valued.  In these cases, you will either need several \ExternalParameter objects, or a way to reference an SBML element extended to be defined as an array (such as the SBML Arrays package).


\subsection{The extended \SBase class}
\label{sec:extended-sbase-class}
\label{extended-sbase-class}

As can be seen in \fig{fig:extended-sbase-uml}, the SBML base class \SBase is extended to include an optional \Uncertainty child element, which in turn contains optional child elements, any or all of which may be used to include information about the uncertainty of the parent element.  In \sbmlthreecore, one should only extend those \SBase elements with mathematical meaning (\Compartment, \Parameter, \Reaction, \Species, and \SpeciesReference), or those \SBase elements with \Math children (\Constraint, \Delay, \EventAssignment, \FunctionDefinition, \InitialAssignment, \KineticLaw, \Priority, \Rule, and \Trigger).  The \Uncertainty child is added to \SBase instead of to each SBML element so that other packages inherit the ability to extend their own elements in the same fashion:  for example, the \FluxBound class from the Flux Balance Constraints package has mathematical meaning, and could be given an \Uncertainty child containing information about the distribution or set of samples from which it was drawn.  Similarly, the \FunctionTerm class from the Qualitative Models package has a \Math child, and could be extended.


\begin{figure}[]
  \includegraphics{figs/extended-sbase.pdf}
  \caption{The definition of the extended \SBase class to include a new optional \Uncertainty child element, which has optional \UncertValue, \UncertStatisticSpan, \ExternalParameter, and \Distribution children.  Intended for use with any element with mathematical meaning, or with a \Math child element.  (The \UncertValue and \ExternalParameter classes are defined elsewhere and re-used here.)}

\label{fig:extended-sbase-uml}
\end{figure}


A few SBML elements can interact in interesting ways that can confuse the semantics here.  A \Reaction element and its \KineticLaw child, for example, both reference the same mathematical formula, so only one should be extended with an \Uncertainty child element.  Similarly, the uncertainty of an \InitialAssignment will be identical to the uncertainty of the element it assigns to, and therefore only one of those elements should be extended.

Other elements not listed above should probably not be given an \Uncertainty child, as it would normally not make sense to talk about the uncertainty of something that doesn't have a corresponding mathematical meaning.  However, because packages or annotations can theoretically give new meaning (including mathematical meaning) to elements that previously did not have them, this is not a requirement.

It is important to note that the uncertainty described is defined as being the uncertainty at the moment the element's mathematical meaning is calculated, and does not describe the uncertainty of how that element changes over time.  For a \Species, \Parameter, \Compartment, and \SpeciesReference, this means that it is the uncertainty of their initial values, and does not describe the uncertainty in how those values evolve in time.  The reason for this is that other SBML constructs all describe how (or if) the values change in time, and it is those other constructs that should be used to describe a symbol's time-based uncertainty.  For example, a \Species whose initial value had uncertainty due to instrument precision could have an \Uncertainty child describing this.  A \Species whose value was known to change over time due to unknown processes, but which had a known average and standard deviation could be given an \AssignmentRule that set that \Species amount to the known average, and the \AssignmentRule itself could be given an \Uncertainty child describing the standard deviation of the variability.

\subsection{The \class{Uncertainty} class}
\label{Uncertainty-class}
\label{uncertainty-class}

The \Uncertainty class is a collection of zero or more statistical measures related to the uncertainty of the parent SBML element.  It contains four types of children:  \UncertValue children, \UncertStatisticSpan children, a \ListOfExternalParameters child (which contains zero or more \ExternalParameter objects) and a \Distribution child.  There are ten possible \UncertValue children, and six possible \UncertStatisticSpan children, defined below.  The \Uncertainty may be annotated to provide additional information.

Note that for elements that change in value over time, the described uncertainty applies only to the element's initial state, and not to how it changes in time.  For typical simulations, this means the element's initial assignment.

\paragraph{The units of uncertainty values}

The units of uncertainty statistics and distributions are generally either dimensionless or the same as the units of the parent, according to the formula that defines the value.  A \token{mean} and a \token{standardDeviation}, for example, are always the same units as the parent, while a \token{coefficientOfVariation} is dimensionless.

\paragraph{The uncertainty of a \Species}

A \Species is a unique SBML construct in that its value is either an amount or a concentration, depending on the value of its \token{hasOnlySubstanceUnits} attribute (\val{true} for amount, or \val{false} for concentration).  The value of its uncertainty tracks with this: if the value of \changed{\token{hasOnlySubstanceUnits} on the parent \Species} is \val{true}, the uncertainty is in terms of amounts, and if \val{false}, the uncertainty is in terms of concentration.

If a \Species is being modeled in SBML in amounts, but was measured in terms of its concentration, or visa versa, an \InitialAssignment should be created that explicitly handles this conversion and assigns the appropriate value to the \Species, as in the example below.

\begin{example}
...
    <listOfCompartments>
      <compartment id="C" spatialDimensions="3" size="2" constant="true">
        <distrib:uncertainty>
          <distrib:standardDeviation distrib:value="0.15"/>
        </distrib:uncertainty>
      </compartment>
    </listOfCompartments>
    <listOfSpecies>
      <species id="S_amt" compartment="C" hasOnlySubstanceUnits="true"
               boundaryCondition="false" constant="false"/>
    </listOfSpecies>
    <listOfParameters>
      <parameter id="S_conc" value="3.4" constant="true">
        <distrib:uncertainty>
          <distrib:standardDeviation distrib:value="0.3"/>
        </distrib:uncertainty>
      </parameter>
    </listOfParameters>
    <listOfInitialAssignments>
      <initialAssignment symbol="S_amt">
        <math xmlns="http://www.w3.org/1998/Math/MathML">
          <apply>
            <times/>
            <ci> S_conc </ci>
            <ci> C </ci>
          </apply>
        </math>
      </initialAssignment>
    </listOfInitialAssignments>
...
\end{example}

Here, the uncertainty of the species \val{S\_amt} is not set explicitly, and instead can be derived from the uncertainty of the values in its initial assignment (\val{S\_conc} and \val{C}).

\paragraph{Propagation of error}

It may be possible to calculate the propagation of error for a simulation of an SBML model.  Be advised that this will be a complicated system, and may involve calculating partial derivates of equations that are not explicitly encoded.  Many simulators choose instead to estimate the error through stochastic simulations.  Either approach should be possible with a properly encoded \distribshort model.



\subsubsection{Attributes inherited from \SBase}

An \Uncertainty always inherits the optional \token{metaid} and \token{sboTerm} attributes, and inherits optional \token{id} and \token{name} attributes as described in \sec{sec:idname}.  The \token{id} of an \Uncertainty has no mathematical meaning.


\subsection{The \UncertValue children of \Uncertainty}

An \UncertValue is defined in \sec{UncertValue-class}.  The possible \UncertValue types are listed below.  Each is defined by its element name; the mean would be defined as \token{<mean>}, the standard deviation as \token{<standardDeviation>}, etc.

All the definitions below are from an archived copy of the definitions at \url{http://uncertml.org/}, with the exception of \token{standardError}, which was added here.

\begin{itemize}

\item \token{coefficientOfVariation}:  For a random variable with mean $ \mu $ and strictly positive standard deviation $ \sigma $, the coefficient of variation is defined as the ratio $ \frac{\sigma}{\mid\mu\mid} $. One benefit of using the coefficient of variation rather than the standard deviation is that it is unitless.

\item \token{kurtosis}:  The kurtosis of a distribution is a measure of how peaked the distribution is. The kurtosis is defined as $ \mu_4/\sigma^4 $ where $ \mu_4 $ is the fourth central moment of the distribution and $ \sigma $ is its standard deviation.

\item \token{mean}:  The arithmetic mean (typically just the mean) is what is commonly called the average. It is defined as $ \bar{x} = \frac{1}{n}\cdot \sum_{i=1}^n{x_i} $ where $ x_i $ represents with $ i $th observation of the quantity $ x $ in the sample set of size $ n $. It is related to the expected value of a random variable, $ \mu = E[X] $ in that the population mean, $ \mu $, which is the average of all quantities in the population and is typically not known, is replaced by its estimator, the sample mean $ \bar{x} $. Note that this statistic does not deal with issues of sample size, rather the mean is taken to refer to the population mean.

\item \token{median}:  The median is described as the numeric value separating the higher half of a sample (or population) from the lower half. The median of a finite list of numbers can be found by arranging all the observations from lowest value to highest value and picking the middle one. If there is an even number of observations, then there is no single middle value, then the average of the two middle values is used. The median is also the 0.5 quantile, or 50th percentile.

\item \token{mode}:  The mode is the value that occurs the most frequently in a data set (or a probability distribution). It need not be unique (e.g., two or more quantities occur equally often) and is typically defined for continuous valued quantities by first defining the histogram, and then giving the \changed{central} value of the bin containing the most counts.

\item \token{sampleSize}:  The sample size is a direct count of the number of observations made or the number of samples measured.  It is used in several other statistical measurements, and can be used to convert one to another.

\item \token{skewness}:  The skewness of a random variable is a measure of how asymmetric the corresponding probability distribution is. The skewness is defined as $ \mu_3/\sigma^3 $ where $ \mu_3 $ is the 3rd \changed{central} moment of the distribution and $ \sigma $ is its standard deviation.

\item \token{standardDeviation}:  The standard deviation of a distribution or population is the square root of its variance and is given by $ \sigma = \sqrt{E[(X - \mu)^2]} $ where $ \mu = E[X] $. The population standard deviation is given by $ \sigma = \sqrt{\frac{1}{n} \sum_{i=1}^n\left(x_i - \bar{x} \right)^2} $ where $ \bar{x} = \frac{1}{n}\cdot \sum_{i=1}^n{x_i} $, and $ x_i $ represents the $ i $th observation of the quantity $ x $ in the population of size $ n $. The standard deviation is a widely used measure of the variability or dispersion since it is reported in the natural units of the quantity being considered. Note that if a finite sample of a population has been used then the sample standard deviation is the appropriate unbiased estimator to use.

\item \token{standardError}:  The standard error is the standard deviation of estimates of a population value. If that population value is a mean, this statistic is called the standard error of the mean.  It is calculated as the standard deviation of a sample divided by the square root of the number of the sample size.  As the sample size increases, the sample size draws closer to the population size, and the standard error approaches zero.  $ \sigma_{\bar{x}} = \sigma/\sqrt{n} $.

\item \token{variance}:  The variance of a random quantity (or distribution) is the average value of the square of the deviation of that variable from its mean, given by $ \sigma^2 = \text{Var}[X] = E[(X - \mu)^2] $ where $ \mu = E[X] $. The complete population variance is given by $ \sigma^2 = \frac{1}{n} \sum_{i=1}^n\left(x_i - \bar{x} \right)^2 $ where $ \bar{x} = \frac{1}{n}\cdot \sum_{i=1}^n{x_i} $, and $ x_i $ represents the $ i $th observation of the quantity $ x $ in the population of size $ n $. This is the estimator of the population variance and should be replaced by the sample variance when using samples of finite size.

\end{itemize}


\subsection{The \class{UncertStatisticSpan} class}
\label{UncertStatisticSpan-class}
\label{uncertstatisticspan-class}

The \UncertStatisticSpan class defines a span of values that define an uncertainty statistic such as confidence interval or range.  It has four optional attributes, \token{varLower} and \token{varUpper}, of type \primtype{SIdRef}, and \token{valueLower} and \token{valueUpper}, of type double.  Exactly one of the attributes \token{varLower} and \token{valueLower} may be defined, and exactly one of the attributes \token{varUpper} and \token{valueUpper} may be defined.  If no attributes are defined, the parameters of the span are undefined.  If only one attribute is defined (one of the upper or lower attributes), that aspect of the span is defined, and the other end is undefined.  The span is fully defined if two attributes (one lower and one upper) are defined.

The value of the lower attribute (whichever is defined) must be lesser or equal to the value of the upper attribute (whichever is defined), at the initial conditions of the model.  The \Uncertainty element cannot affect the core mathematics of an SBML model, but if it is used in a mathematical context during simulation of the model, this restriction on the attribute values must be maintained, or the \UncertStatisticSpan object as a whole will be undefined.

Like the \token{units} attribute on an \UncertValue, the \token{units} attribute is provided if either the upper or lower end of the span is defined by value, instead of by reference (i.e., if \token{valueUpper} and/or \token{valueLower} is defined).  The units on both the upper and lower ends of the span must match each other, if defined.  The units for span ends defined by reference may be obtained from the referenced SBML element.


The possible \UncertStatisticSpan types are listed below, each defining a bounded span of values instead of a single value.  The definitions were again taken from an archived copy of \url{http://uncertml.org/}:

\begin{itemize}

\item {\token{confidenceInterval}:  For a univariate random variable $ x $, a confidence interval is a range $ [a,b] $, $ a<b $, so that $ x $ lies between $ a $ and $ b $ with given probability. For example, a 95\% confidence interval is a range in which $ x $ falls 95\% of the time (or with probability 0.95). Confidence intervals provide intuitive summaries of the statistics of the variable $ x $.

If $ x $ has a continuous probability distribution $ P $, then $ [a,b] $ is a 95\% confidence interval if $ \int_a^b P(x) = 0.95 $.

Unless specified otherwise, the confidence interval is usually chosen so that the remaining probability is split equally, that is $ P(x<a) = P(x>b) $. If $ x $ has a symmetric distribution, then the confidence intervals are usually centered around the mean. However, non-centered confidence intervals are possible and are better described by their lower and upper quantiles or levels. For example, a 50\% confidence interval would usually lie between the 25\% and 75\% quantiles, but could in theory also lie between the 10\% and 60\% quantiles, although this would be rare in practice. The \token{confidenceInterval} allows you the flexibility to specify non-symmetric confidence intervals however in practice we would expect the main usage to be for symmetric intervals.

The \token{confidenceInterval} child of a \Uncertainty is always the 95\% confidence interval.  For other confidence intervals, use an \ExternalParameter instead. }

\item {\token{credibleInterval}:  In Bayesian statistics, a credible interval is similar to a confidence interval determined from the posterior distribution of a random variable $ x $. That is, given a prior distribution $ p(x) $ and some observations $ D $, the posterior probability $ p(x\mid D) $ can be computed using Bayes theorem. A 95\% credible interval is then any interval $ [a,b] $ so that $ \int_a^b p(x\mid D) = 0.95 $, that is the variable $ x $ lies in the interval $ [a,b] $ with posterior probability 0.95. Note that the interpretation of a credible interval is not the same as a (frequentist) confidence interval.

The \token{credibleInterval} child of a \Uncertainty is always the 95\% credible interval.  For other credibility intervals, use an \ExternalParameter instead.}


\item \token{interquartileRange}:  The interquartile range is the range between the 1st and 3rd quartiles. It contains the middle 50\% of the sample realisations (or of the sample probability). It is typically used and shown in box plots.

\item \token{range}:  The range is the interval $ [a,b] $ so that $ a<b $ and contains all possible values of $ x $. This is also often called the statistical range, which is the distance from the smallest value to the largest value in a sample dataset. For a sample dataset $ X = (x_1, ..., x_N $), the range is the distance from the smallest $ x_i $ to the largest. It is often used as a first estimate of the sample dispersion.

\end{itemize}


\subsubsection{Attributes inherited from \SBase}

An \UncertStatisticSpan always inherits the optional \token{metaid} and \token{sboTerm} attributes, and inherits optional \token{id} and \token{name} attributes as described in \sec{sec:idname}.  The \token{id} of an \UncertStatisticSpan has no mathematical meaning.



\subsection{The \ExternalParameter children of \Uncertainty}

Any number of \ExternalParameter children (defined in \sec{ExternalParameter-class}) may be included, each defined by its \token{definitionURL}.

As examples, the following statistics are not defined by a single value nor by a range, and would therefore be good candidates for encoding with an \ExternalParameter.  These terms were included in the now-defunct UncertML (and the definitions were again taken from an archived copy of \url{http://uncertml.org/}), and may also be findable in other ontologies such as STATO (which has a searchable database at \url{https://www.ebi.ac.uk/ols/ontologies/stato}):

\begin{itemize}
\item \changed{\token{centralMoment}}:  For a given positive natural number $ k $, the $ k\textsuperscript{th} $ \changed{central} moment of a random variable $ x $ is defined as $ \mu_k = E[(x - E[x])^k] $. That is, it is the expected value of the deviation from the mean to the power $ k $. In particular, $ \mu_0 = 1 $, $ \mu_1 = 0 $ and $ \mu_2 $ is the variance of $ x $.

\item \token{correlation}:  The correlation between two random variables $ x_1 $ and $ x_2 $ is the extent to which these variable vary together in a linear fashion. It is characterized by the coefficient $ \rho_{1,2} = E[(x_1-\mu_1)(x_2-\mu_2)] / \sigma_1\sigma_2 $ where $ \mu_1 $ and $ \mu_2 $ are the means of $ x_1 $ and $ x_2 $ respectively, and $ \sigma_1 $ and $ \sigma_2 $ are their respective standard deviations. Note this is strictly not a description of uncertainty, but it can be useful to represent the correlation between two variables. Generally a covariance specification would be preferred since this describes the uncertainty.

\item \token{decile}:  A decile, $ d $, is any of the nine values that divide the sorted quantities into ten equal parts, so that each part represents 1/10 of the sample, population or distribution. The first decile is equivalent to the 10th percentile.

\item \token{moment}:  For a given positive natural number $ k $, the $ k\textsuperscript{th} $ moment of a random variable $ x $ is defined as $ \mu_k = E[x^k] $. In particular, $ \mu_0 = 1 $ and $ \mu_1 $ is the mean of $ x $.
The moments can be defined with respect to some point $ a $, that is $ \mu_k(a) = E[(x - a)^k] $. Moments defined about the mean are called \changed{central} moments.

\item \token{percentile}:  A percentile is the value of a quantity below which a certain percent of values fall. This can be defined for samples, populations and distributions. For finite samples there is no widely accepted method, but all methods essentially rank the quantities and then use some interpolation to compute the percentile, unless the sample size $ n $ is a multiple of 100. For probability distributions the inverse cumulative density function can be used.  The most widely used method is as follows: to estimate the value, $ x_p $, of the $ p $th percentile of an ascending ordered dataset containing $ n $ elements with values $ x_1, x_2, ... ,x_n $ first compute $ \rho = \frac{p}{100}\,({n}-1)+1 $. Now $ \rho $ is split into its integer component, $ k $, and decimal component, $ d $, such that $ \rho = k + d $. $ x_p $ is then calculated as $ x_p = x_k+d(x_{k+1}-x_k) $ where $ 1 < \rho < n $ with special cases $ x_p = x_1 \; [\rho=1]; \ x_n \; [\rho=n] $.

\item \token{probability}:  Given a random variable $ x $ with probability density function $ f(x) $, the probability that $ x $ lies in some part of its domain $ \mathcal{X} $ is defined as $ P(x \in \mathcal{X}) = \int_{x\in\mathcal{X}} f(x) $. $ \mathcal{X} $ can be defined as a lower- or upper-bounded range, e.g., $ P(x < 3.2) $, or as the intersection of several such ranges, e.g., $ P(x \geq 1.7 \cap x < 3.2) $.

\item \token{quantile}:  Given a random variable $ x $, the $ n $-quantiles are the values of $ x $ which split the domain into $ n $ regions of equal probability. For instance, the $ k\textsuperscript{th} $ $ n $-quantile is the value $ q_k $ for which $ P(x<q_k) = \frac{k}{n} $. For some common values of $ n $, the $ n $-quantiles have additional names, namely quartiles for $ n=4 $, deciles for $ n=10 $ and percentiles for $ n=100 $.
More generally, a quantile can be associated to any probability $ p $, so that $ q $ is the value of $ x $ below which a proportion $ p $ of the probability lies, i.e., $ P(x<q) = p $.
The plot on the right shows the 1st to 9th 10-quantiles (or deciles) for a normal distribution ($ \mu = 4 $, $ \sigma = 1 $) as orange dots. The blue curve is the cumulative density function of $ x $. Note how the quantiles split the probability (y-axis) into 10 equal regions.

\item \token{quartile}:  The quartiles are the 4-quantiles, that is the 4 values of $ x $ below which lies a proportion 0.25, 0.50, 0.75 and 1 of the probability. One can also think of them as the 4 values of $ x $ which split the domain into 4 regions of equal probability.
\end{itemize}


\subsection{The \class{ListOfExternalParameters} class}
\label{ListOfExternalParameters-class}
\label{listofexternalparameters-class}

The \ListOfExternalParameters class, like other \ListOf classes in \sbmlthreecore, is a container for zero or more \ExternalParameter objects.  If empty, it simply means that no child \ExternalParameter objects are defined for its parent, and is equivalent to not including the \ListOfExternalParameters object at all.  This situation might be useful if the list is annotated with the reason why it is empty, for example.


\subsection{The \class{Distribution} class}
\label{Distribution-class}
\label{distribution-class}

The \Distribution class has an optional \Math child which, if present, must contain at its base one of the \token{csymbol} distributions defined in this specification.  This distribution defines the distribution from which the parent element is drawn.  Only the predefined \token{csymbol} distributions are available for this definition; if the element is drawn from a distribution not defined in this specification, \changed{an \ExternalParameter defined to be a distribution should be used instead (see \ref{sec:external-dist-example})}.

\subsubsection{Attributes inherited from \SBase}

A \Distribution always inherits the optional \token{metaid} and \token{sboTerm} attributes, and inherits optional \token{id} and \token{name} attributes as described in \sec{sec:idname}.  The \token{id} of an \Distribution has no mathematical meaning.


\subsection{Examples using extended \SBase}
\label{extended-sbase-examples}

Several examples are given to illustrate the use of the \Uncertainty class:


\subsubsection{Basic \Uncertainty example}

In this examples, a species is given an \Uncertainty child to describe its standard deviation:

\begin{example}
...
  <species id="s1" compartment="C" initialAmount="3.22" hasOnlySubstanceUnits="true"
           boundaryCondition="false" constant="false">
    <distrib:uncertainty>
      <distrib:standardDeviation distrib:value="0.3"/>
    </distrib:uncertainty>
  </species>
...
\end{example}

Here, the species with an initial amount of 3.22 is described as having a standard deviation of 0.3, a value that might be written as \val{3.22 $\pm$ 0.3}.  This is probably the simplest way to use the package to introduce facts about the uncertainty of the measurements of the values present in the model.

It is also possible to include additional information about the species, should more be known:

\begin{example}
...
  <species id="s1" compartment="C" initialAmount="3.22" hasOnlySubstanceUnits="true"
           boundaryCondition="false" constant="false">
    <distrib:uncertainty>
      <distrib:mean distrib:value="3.2"/>
      <distrib:standardDeviation distrib:value="0.3"/>
      <distrib:variance distrib:value="0.09"/>
    </distrib:uncertainty>
  </species>
...
\end{example}

In this example, the initial amount of 3.22 is noted as having a mean of 3.2, a standard deviation of 0.3, and a variance of 0.09.  Note that the standard deviation can be calculated from the variance (or visa versa), but the modeler has chosen to include both here for convenience.  Note too that this use of the \Uncertainty element does not imply that the species amount comes from a normal distribution with a mean of 3.2 and standard deviation of 0.3, but rather that the species amount comes from an unknown distribution with those qualities.  If it is known that the value was drawn from a particular distribution, that distribution should be used, rather than the \token{Mean} and \token{StandardDeviation} statistical values.

Note also that 3.22 (the \token{initialAmount}) is different from 3.2 (the \token{Mean}):  evidently, this model was constructed as a realization of the underlying uncertainty, instead of trying to capture the single most likely model of the underlying process.


\subsubsection{Defining a random variable}

In addition to describing the uncertainty about an experimental
observation one can also use this mechanism to describe a parameter as
a random variable. In the example below the parameter, \token{Z}, is defined
as following a normal distribution, with a given mean and standard deviation. No
value is given for the parameter so it is then up the modeler to
decide how to use this random variable. For example they may choose to
simulate the model in which case they may provide values for \token{mu\_Z}
and \token{sd\_Z} and then sample a random value from the
simulation. Alternatively they may choose to carry out a parameter
estimation and use experimental observations to estimate \token{mu\_Z} and
\token{sd\_Z}.

\begin{example}
  <listOfParameters>
    <parameter id="mu_Z" value="10" constant="true"/>
    <parameter id="sd_Z" value="0.1" constant="true"/>
    <parameter id="Z" constant="true">
      <distrib:uncertainty>
        <distrib:distribution>
          <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
              <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/normal"
                       encoding="text"> normal </csymbol>
              <ci> mu_Z </ci>
              <ci> sd_Z </ci>
            </apply>
          </math>
          <distrib:mean distrib:var="mu_Z"/>
          <distrib:standardDeviation distrib:var="sd_Z"/>
        </distrib:normalDistribution>
      </distrib:uncertainty>
    </parameter>
  </listOfParameters>
\end{example}

\begin{blockChanged}
\subsubsection{Defining external distributions}
\label{sec:external-dist-example}

If an SBML value is drawn from a distribution not defined explicitly in this specification, it is necessary to use the \ExternalParameter construct to denote this.  In this example, the parameter p1 was drawn from a zeta distribution, with a shape parameter of 2.37.  An \ExternalParameter is created with the 'zeta' URI, with a child \ExternalParameter with the 'shape' URI.  For readability, 'zeta' and 'shape' were used as the names of these parameters.


\begin{example}
<parameter id="p1" constant="true">
  <uncertainty xmlns="http://www.sbml.org/sbml/level3/version1/distrib/version1">
    <listOfExternalParameters>
      <externalParameter name="zeta"
                definitionURL="http://www.probonto.org/ontology#PROB_k0001263">
        <listOfExternalParameters>
          <externalParameter name="shape" value="2.37"
                definitionURL="http://purl.obolibrary.org/obo/STATO_0000436"/>
        </listOfExternalParameters>
      </externalParameter>
    </listOfExternalParameters>
  </uncertainty>
</parameter>
\end{example}


It is also possible to create even more complex structures with the \ExternalParameter scheme.  In this example, a parameter is drawn from a categorical distribution based on data from three patients.  The parent \ExternalParameter is defined to be the 'categorical' distribution, with three 'category' children, each with two child 'value' and 'probability' parameters.  Collectively, they define a distribution where a value of 1.01 has a probability of 50\%, a value of 2.24 has a probability of 25\%, and a value of 1.72 has a probability of 25\%.  (The \token{definitionURL} examples here were made up for the purposes of this example, to be readable.  In an actual SBML document, they would point to external ontologies.)


\begin{example}
<parameter id="s1" constant="true">
  <uncertainty xmlns="http://www.sbml.org/sbml/level3/version1/distrib/version1">
    <listOfExternalParameters>
      <externalParameter definitionURL="http://dist.org/categorical">
        <listOfExternalParameters>
          <externalParameter id="patient1" definitionURL="http://dist.org/category">
            <listOfExternalParameters>
              <externalParameter value="1.01" definitionURL="http://dist.org/cat_val"/>
              <externalParameter value="0.5" definitionURL="http://dist.org/cat_prob"/>
            </listOfExternalParameters>
          </externalParameter>
          <externalParameter id="patient2" definitionURL="http://dist.org/category">
            <listOfExternalParameters>
              <externalParameter value="2.24" definitionURL="http://dist.org/cat_val"/>
              <externalParameter value="0.25" definitionURL="http://dist.org/cat_prob"/>
            </listOfExternalParameters>
          </externalParameter>
          <externalParameter id="patient3" definitionURL="http://dist.org/category">
            <listOfExternalParameters>
              <externalParameter value="1.72" definitionURL="http://dist.org/cat_val"/>
              <externalParameter value="0.25" definitionURL="http://dist.org/cat_prob"/>
            </listOfExternalParameters>
          </externalParameter>
        </listOfExternalParameters>
      </externalParameter>
    </listOfExternalParameters>
  </uncertainty>
</parameter>
\end{example}

\end{blockChanged}


\section{Interaction with other packages}

\subsection{Custom annotations for function definitions}
\label{sec:annotation-scheme}
Before this package was available, a collection of SBML simulator authors developed an \emph{ad hoc} convention for exchanging annotated \FunctionDefinition objects that represented draws from distributions.  This convention is described by Frank T. Bergmann at \url{https://docs.google.com/file/d/0B_wMqVOQLkZ3TVZHblNNRWgzNTg/}, and represents a basic starting point for any modeler interested in exchanging SBML models containing draws from distributions.

When implementing \distrib support, it would be possible to include ``backwards'' support for this annotation convention by annotating any extended \FunctionDefinition that happens to match the following distribution to also include these annotations, where appropriate.

The following table is taken from the above document by Frank Bergmann, and can be used as a template if translating from that \FunctionDefinition system to the \distrib extended \Math system.  The suggested fallback function returns the mean of the distribution.

\newcommand{\tighturl}[1]{\textls[-40]{\url{#1}}}

\begin{table}[bh]
  \centering
  \begin{edtable}{tabularx}{\linewidth}{lp{0.65in}l>{\normalfont\itshape}l}
    \toprule
    \textbf{\textsf{\textup{Id}}} & \textbf{\textsf{\textup{Distribution}}} & \textbf{\textsf{\textup{Definition URL}}} & \textbf{\textsf{\textup{Fallback}}} \\
    \midrule
uniform     & Uniform       & \tighturl{http://en.wikipedia.org/wiki/Uniform_distribution_(continuous)} & lambda(a, b, $\frac{a+b}{2}$)
\\ \midrule
normal      & Normal        & \tighturl{http://en.wikipedia.org/wiki/Normal_distribution}               & lambda(m, s, m)
\\ \midrule
exponential & Exponential   & \tighturl{http://en.wikipedia.org/wiki/Exponential_distribution}          & lambda(l, $1/l$)
\\ \midrule
gamma       & Gamma         & \tighturl{http://en.wikipedia.org/wiki/Gamma_distribution}                & lambda(a, b, $a \times b$)
\\ \midrule
poisson     & Poisson       & \tighturl{http://en.wikipedia.org/wiki/Poisson_distribution}              & lambda($\mu$, $\mu$)
\\ \midrule
lognormal   & Lognormal     & \tighturl{http://en.wikipedia.org/wiki/Log-normal_distribution}           & lambda(z, s, $e^{z+s^2/2}$)
\\ \midrule
chisq       & Chi-squared   & \tighturl{http://en.wikipedia.org/wiki/Chi-squared_distribution}          & lambda($\nu$, $\nu$)
\\ \midrule
laplace     & Laplace       & \tighturl{http://en.wikipedia.org/wiki/Laplace_distribution}              & lambda(a, 0)
\\ \midrule
cauchy      & Cauchy        & \tighturl{http://en.wikipedia.org/wiki/Cauchy_distribution}               & lambda(a, a)
\\ \midrule
rayleigh    & Rayleigh      & \tighturl{http://en.wikipedia.org/wiki/Rayleigh_distribution}             & lambda(s, $s\times\sqrt{\pi/2}$)
\\ \midrule
binomial    & Binomial      & \tighturl{http://en.wikipedia.org/wiki/Binomial_distribution}             & lambda(p, n, $p \times n$)
\\ \midrule
bernoulli   & Bernoulli     & \tighturl{http://en.wikipedia.org/wiki/Bernoulli_distribution}            & lambda(p, p)
\\
    \bottomrule
  \end{edtable}
\end{table}

% \clearpage

As an example, here is a complete (if small) model that uses the above ``custom annotation'' scheme:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version1/core"
      level="3" version="1">
  <model>
    <listOfFunctionDefinitions>
      <functionDefinition id="normal">
        <annotation>
          <distribution xmlns="http://sbml.org/annotations/distribution"
                   definition="http://en.wikipedia.org/wiki/Normal_distribution"/>
        </annotation>
        <math xmlns="http://www.w3.org/1998/Math/MathML">
          <lambda>
            <bvar>
              <ci> mean </ci>
            </bvar>
            <bvar>
              <ci> stdev </ci>
            </bvar>
            <notanumber/>
          </lambda>
        </math>
      </functionDefinition>
    </listOfFunctionDefinitions>
    <listOfParameters>
      <parameter id="x" constant="true"/>
    </listOfParameters>
    <listOfInitialAssignments>
      <initialAssignment symbol="x">
        <math xmlns="http://www.w3.org/1998/Math/MathML">
          <apply>
            <ci> normal </ci>
            <cn> 3 </cn>
            <cn> 0.2 </cn>
          </apply>
        </math>
      </initialAssignment>
    </listOfInitialAssignments>
  </model>
</sbml>

\end{example}

And here is the same model, using the \token{csymbol} defined in \distribshort:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version2/core"
      xmlns:distrib="http://www.sbml.org/sbml/level3/version1/distrib/version1"
      level="3" version="2" distrib:required="true">
  <model>
    <listOfParameters>
      <parameter id="x" constant="true"/>
    </listOfParameters>
    <listOfInitialAssignments>
      <initialAssignment symbol="x">
        <math xmlns="http://www.w3.org/1998/Math/MathML">
          <apply>
              <csymbol definitionURL="http://www.sbml.org/sbml/symbols/distrib/normal"
                       encoding="text"> normal </csymbol>
            <cn type="integer"> 3 </cn>
            <cn> 0.2 </cn>
          </apply>
        </math>
      </initialAssignment>
    </listOfInitialAssignments>
  </model>
</sbml>
\end{example}


\subsection{The \arrays package}
This package is dependent on no other package, but might rely on the \arrays package
to provide vector and matrix structures if those are desired/used.  Note that currently, the only way to need arrays is if an \ExternalParameter is defined that requires array input or output.

\begin{blockChanged}
\subsection{SBML Level~3 Version~2}
This package may be used with either SBML Level~3 Version~1 Core, or SBML Level~3 Version~2 Core, and no construct in this package changes as a result: the addition of \token{id} and \token{name} to \DistribBase means that the addition of those attributes to \SBase in SBM Level~3 Version~2 Core is redundant.

However, another change between SBML Level~3 Version~1 and Version~2 is that in Version~2, core elements and core \Math may refer to package \token{ids} with mathematical meaning.  Since \distrib \UncertValue elements do indeed have mathematical meaning, this means that their ids may appear in core \Math, while this is not allowed in Version~1.  If an \UncertValue does need to be referenced in a Version~1 document, the \token{var} attribute should be used to connect the element to a core \Parameter, instead of using the \token{value} attribute.
\end{blockChanged}


\section{Use-cases and examples}

The following examples are more fleshed out than the ones in the main text, and/or illustrate features of this package that were not previously illustrated.

\subsection{Sampling from a distribution: PK/PD Model}

This is a very straightforward use of a log normal distribution. The key point to note is that a value is sampled from
the distribution and assigned to a variable when it is invoked in the
\token{initialAssignment} elements in this example. Later use of the variable
does not result in re-sampling from the distribution. This is
consistent with current SBML semantics.

%{\color{red}Stuart:\controversial I'd like to add another example here
%  that defines the model without sampling. We can have 2 versions of
%  the same model. I'll come back to it...}

\exampleFile{examples/pkpd.xml}


%\subsection{Multivariate distribution}

%In this example two correlated parameters are sampled from a
%multivariate distribution. The correlation is defined using a
%covariance matrix and the sampled values are returned as a vector of 2
%values, and assigned to the variable \val{correlated\_params}.  This vector is then used to assign values to \val{V} and \val{C1}, thereby associating those two values with the same draw from the multivariate normal distribution.  The use of various array and matrix \mathml here is speculative:  in the absence of a finalized Arrays package, it is impossible to tell exactly what form that will take.  However, all of the functionality expressed here will need to be incorported in some form into the Arrays package, and much if not all of it may take the form illustrated here.

%\exampleFile{examples/mutivariate_example.xml}


\subsection{Multiple uses of distributions }

In this example, a \token{normal} csymbol is used in an initial assignment, and \token{mean} and \token{standardDeviation} elements are used to denote the uncertainty in the parameter \token{V}, and the uncertainty in the initial assignment to \token{V}.  Note that strictly speaking, one could assume that the uncertainty in the parameter itself was identical to the uncertainty in its initial assignment; both are given here by way of illustration.

\exampleFile{examples/user-defined.xml}


\subsection{Defining confidence intervals }

In this example, several \Parameter elements are given confidence intervals, and several species are given standard deviations.  Each indicates the modeler's assessment of the precision of the estimated given values for those elements.  

\exampleFile{examples/confidence-intervals.xml}


%\subsection{User-defined discrete distribution}
%\label{sec:userDefinedDiscrete}

%In this example, a \Distribution is used where the weights themselves are the arguments to the function instead of the values.

%\exampleFile{examples/user-defined-pmf.xml}


\section{Prototype implementations}

As of this writing (February 2019), libSBML has full support for all elements defined in this version of the specification, with the exception of \token{standardError} and \token{sampleSize}.  Antimony (\url{http://antimony.sf.net/}) has support for a the new csymbols for model creation only (no simulation), but does not support the \token{uncertainty} child of \SBase.  Libroadrunner supports a limited number of distributions from a previous version of this spec.

%\section{Unresolved issues}
%\label{sec:unresolved}


\section{Acknowledgements}
\label{sec:acknowledgements}

Much of the initial concrete work leading to this proposal document
was carried out at the Statistical Models Workshop in Hinxton in 2011,
which was organized by Nicolas Le~Nov\`{e}re. A list of participants
and recordings of the discussion is available from
\url{http://sbml.org/Events/Other_Events/statistical_models_workshop_2011}.
Before that a lot of the ground work was carried out by Darren
Wilkinson who led the discussion on \distribshort at the Seattle SBML
Hackathon and before that Colin Gillespie who wrote an initial
proposal back in 2005. The authors would also like to thank the
participants of the \distribshort sessions during various HARMONY and
COMBINE meetings for their excellent contributions in helping revising
this proposal; Sarah Keating, Maciej Swat, Nicolas Le~Nov\`{e}re, and Matthias K\"{o}nig
for useful discussions, corrections and review comments; and Mike
Hucka for \LaTeX{} advice, text editing, and the template upon which this
document is based.

\appendix



%\input{apdx-distributions}
\input{apdx-validation}




\bibliography{strings,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}

\end{document}

