<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3/version1/core" level="3" version="1"
      xmlns:distrib="http://www.sbml.org/sbml/level3/version1/distrib/version1" 
      distrib:required="true"
      xmlns:arrays="http://www.sbml.org/sbml/level3/version1/arrays/version1" 
      arrays:required="true">
  <!-- NOTE: This requires the arrays package! -->
  <model id="MultivariateExample" name="Multivariate Example">
    <listOfFunctionDefinitions>
      <functionDefinition id="multivariateNormal">
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/core">
          <lambda>
            <bvar><ci>meanVector</ci></bvar>
            <bvar><ci>covarianceMatrix</ci></bvar>
            <ci>meanVector</ci>
          </lambda>
        </math>
        <drawFromDistribution xmlns="http://www.sbml.org/sbml/level3/version1/distrib/version1">
          <listOfDistribInputs>
            <distribInput distrib:id="meanVector" distrib:index="0"/>
            <distribInput distrib:id="covarianceMatrix" distrib:index="1"/>
          </listOfDistribInputs>
           <Distribution xmlns="http://uncertml.org/3.0">
             <MultivariateNormalDistribution xmlns:un="http://www.uncertml.org/2.0">
               <mean> meanVector </mean>
               <covarianceMatrix dimension="2">
                 <values> covarianceMatrix </values>
               </covarianceMatrix>
             </MultivariateNormalDistribution>
           </Distribution>
        </drawFromDistribution>
      </functionDefinition>
    </listOfFunctionDefinitions>
    <listOfParameters>
      <parameter id="V" constant="false"/>
      <parameter id="V_pop" value="105" constant="true"/>
      <parameter id="V_omega" value="0.70" constant="true"/>
      <parameter id="Cl" constant="true"/>
      <parameter id="Cl_pop" value="73" constant="true"/>
      <parameter id="Cl_omega" value="0.70" constant="true"/>
      <parameter id="covariance" constant="true">
        <arrays:listOfDimensions>
          <arrays:dimension id="i" lowerLimit="1" upperLimit="2" />
          <arrays:dimension id="j" lowerLimit="1" upperLimit="2" />
        </arrays:listOfDimensions>
      </parameter>
      <parameter id="correlated_means" constant="true">
        <arrays:listOfDimensions>
          <arrays:dimension id="i" lowerLimit="1" upperLimit="2" />
        </arrays:listOfDimensions>
      </parameter>
      <parameter id="correlated_params" constant="true">
        <arrays:listOfDimensions>
          <arrays:dimension id="i" lowerLimit="1" upperLimit="2" />
        </arrays:listOfDimensions>
      </parameter>
    </listOfParameters>
    <listOfInitialAssignments>
      <initialAssignment symbol="covariance">
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/arraymaths/version1">
          <!-- This is an unresolved issue. The l3 V1 Core mathml subset does not support
               matrices. One solution - as above is to use a different MathML subset definition.
          -->
          <matrix>
            <matrixrow>
              <apply><times/><ci>V_omega</ci><ci>V_omega</ci></apply>
              <apply><times/><ci>V_omega</ci><ci>C_omega</ci><ci>V_C_rho</ci></apply>
            </matrixrow>
            <matrixrow>
              <ci>0</ci>
              <apply><times/><ci>C_omega</ci><ci>C_omega</ci></apply>
            </matrixrow>
          </matrix>
        </math>
      </initialAssignment>
      <initialAssignment symbol="correlated_means">
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/core">
          <vector>
            <ci>V_pop</ci>
            <ci>C_pop</ci>
          </vector>
        </math>
      </initialAssignment>
      <initialAssignment symbol="correlated_params" >
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/core">
          <apply>
              <ci>multivariateNormal</ci>
              <ci>correlated_means</ci>
              <ci>covariance</ci>
          </apply>
        </math>
      </initialAssignment>
      <initialAssignment symbol="V">
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/core">
          <apply>
            <selector/>
            <ci>correlated_params</ci>
            <cn type="integer">1</cn>
          </apply>
        </math>
      </initialAssignment>
      <initialAssignment symbol="Cl">
        <math xmlns="http://www.w3.org/1998/Math/MathML"
              xmlns:sbml="http://www.sbml.org/sbml/level3/version1/core">
          <apply>
            <selector/>
            <ci>correlated_params</ci>
            <cn type="integer">2</cn>
          </apply>
        </math>
      </initialAssignment>
    </listOfInitialAssignments>
    <!-- This is an incomplete model snippet, sufficient to illustrate the use of 
        a multivariate distribution. -->
  </model>
</sbml>
