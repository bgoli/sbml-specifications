\documentclass{cekarticle}
\usepackage{color}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{array}

\begin{document}

%=============================================================================
% Title page
%=============================================================================

\title{Systems Biology Markup Language (SBML) Level 3 Proposal: Array Features}

\author{Andrew Finney, Victoria Gor, Ben Bornstein, Eric Mjolsness}

\authoremail{
\begin{minipage}{\textwidth}\centering
afinney@cds.caltech.edu, gor@aig.jpl.nasa.gov, bornstei@aig.jpl.nasa.gov\\emj@uci.edu
\end{minipage}}

\maketitlepage

%=============================================================================
\section{Introduction}
\label{sec:introduction}
%=============================================================================

This document describes proposed features for inclusion in
Systems Biology Markup Language (SBML) Level 3. This document
describes features enabling the inclusion of arrays of processes,
structures or entities in models.  These features would allow a
model to be assembled from many copies of identical parts.  These
features enable the representation of patterns of connection
amongst array elements.

This document is not a definition of SBML Level 3 or part of it.
This document simply presents various features which could be
incorporated into SBML Level 3 as the Systems Biology community
wishes.  This document is intended for detailed review by that
community and to provoke alternative proposals.  Throughout this
document issues that the authors believe will require further
discussion have been highlighted.

For brevity the text of this document is with reference to SBML
Level 2~\citep{finney:2002f} and a model composition proposal~\citep{finney:2003b}  i.e. features are described in terms
of changes to SBML Level 2 combined with the model composition proposal.  
All the changes proposed in this document are shown in the UML diagram in figure~\ref{fig:model}.
For brevity this diagram
shows only new attributes and types for SBML Level 3.  For SBML Level 2 types Level 2
attributes are meant to be present in SBML Level 3.  All the types and attributes
proposed in the model composition are assumed to be present.
All types proposed in this document will be derived from the
\texttt{SBase} type.


\begin{figure}[h]
  \vspace*{8pt}
  \centering
  \includegraphics[scale = 0.7]{model}
  \caption{proposed structures and proposed changes to existing SBML Level 2 and model composition structures}
  \label{fig:model}
\end{figure}

\section{Integer Parameters}
\label{sec:integerParameters}

A model would have an optional list of
\texttt{IntegerParameter} structures.
\class{IntegerParameter} structures declare integer constants with identifiers in the model's global identifier namespace.
They can be used in any MathML expression where they have an implicit type of \texttt{integer}.
They are distinct from \class{Parameter} structures: it is not possible to define an \class{InitialAssignmentRule} or \class{AssignmentRule}
or \class{RateRule} structure for an \class{IntegerParameter}.  Integer parameters are constant.

An integer parameter contains a MathML expression which is the value of the parameter.  The MathML expression must be a constant integer
expression (see sections~\ref{sec:constantExpressions} and~\ref{sec:integerExpressions}).  The only symbols allowed
in these expressions are previously occurring integer parameters.

\section{Constant Expressions}
\label{sec:constantExpressions}

A constant expression is an expression whose result doesn't vary during simulation.
The only symbols occurring in constant expressions are those representing integer variables (declared by \attrib{Dimension} structures)
or integer parameters.

\section{Integer Expressions}
\label{sec:integerExpressions}

In some cases in the proposal a MathML expression is restricted to returning an integer result.
An integer expression is composed of integer numbers, symbols representing integer variables (declared by \attrib{Dimension} structures)
or integer parameters and
operators that return integer values given integer arguments.  Integer expressions are required in the
\attrib{upperLimit}, \attrib{lowerLimit} and \attrib{index} fields in this proposal. In addition the arguments for the
MathML \texttt{selector} operator should be integer expressions.

Because none of the symbols in integer expressions vary at simulation time an integer expression can be considered constant.

\section{Conditional Objects}
\label{sec:exists}
In this proposal \class{Species}, \class{Parameter}, \class{Link}, \class{Instance}, \class{Rule}, \class{Reaction}, \class{Event} and \class{Compartment}
objects all have a new \attrib{exists} field.  This field contains a MathML expression which returns a boolean result.  If this expression
is true the containing object is part of the model.  If the expression is false the object does not exist.  Variables acquire their initial values
whenever they come into existence.

As an example the following fragment shows a species that only exists when the parameter \texttt{x} is greater than \texttt{size}. 
\pagebreak
\begin{example}
<species id="offspring" initialAmount="0">
    <exists>
        <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
                <gt/>
                <ci>x</ci>
                <ci>size</ci>
            </apply>
        </math>
    </exists>
</species>
\end{example}

A model which contains non-constant expressions in
\attrib{exists} fields is \emph{dynamic} i.e the model structure can change during simulation.  A model which contains no \attrib{exists} fields or
contains constant expressions in \attrib{exists} fields is \emph{static} i.e the model structure cannot change during simulation.

This feature is independent of the rest of the features described in this proposal.
As will be shown in section~\ref{sec:sparseandconnections} there is a class of static models which use \attrib{exists}
attributes as a mechanism for describing sparse arrays.

\subsection{Initial Assignment Rules}

One of the limitations of the previously described structures is that there is no way to 
specify that initial conditions vary across elements of an array.  We describe a new feature
in this section to overcome this limitation.

In this proposal we introduce a new subtype of \class{Rule} \class{InitialAssignmentRule} in addition
to the existing \class{AssignmentRule} and \class{RateRule} types.  
\class{InitialAssignmentRule} and \class{AssignmentRule} structures are evaluated at the beginning of a simulation to establish
initial values for variables.  \class{AssignmentRule} structures constrain the model for all time
whereas \class{InitialAssignmentRule} structures only constrain the model at time zero. 
An \class{InitialAssignmentRule} structure and an \class{AssignmentRule} structure cannot have the same
\attrib{variable} attribute value.  An \class{InitialAssignmentRule} structure and a \class{RateRule} structure can have the same
\attrib{variable} attribute value.  The combined \class{InitialAssignmentRule} and \class{AssignmentRule} structures
set must not contain algebraic loops.  The behavior of variables assigned values by an
\class{InitialAssignmentRule} structure can be determined either by a reaction  or a \class{RateRule} structure (this is not
true of \class{AssignmentRule} structures ).

This feature could be considered separately from the rest of the arrays proposal.

\section{Arrays}
\label{sec:arrays}

The core of this proposal is the idea that almost all the
structures in SBML can be defined as arrays as well as single
named objects.  We propose that the SBML types
\texttt{Instance}, \texttt{Link}, \texttt{Species}, \texttt{Compartment}, \texttt{Reaction},
\texttt{Parameter} and \texttt{Rule} can be defined as arrays of
objects. \texttt{Parameter} structures which occur inside \texttt{Reaction} structures can't
be arrays.

\subsection{Array Declaration}
\label{sec:arraydec}
The presence of a \attrib{dimension} field
(\texttt{listOfDimensions} sub-element) indicates that the given
structure is an array rather than a single object.  Each \class{Dimension} structure in this field defines
the array cells in one dimension of the array.

A dimension structure declares an integer symbol that takes integer values over a defined range.  
Array cells exists on the given dimension for each value of the integer symbol.  The range of values
is defined by the inclusive range between the results of the \texttt{upperLimit} and \texttt{lowerLimit}
MathML expressions.  These expressions must return a constant integer result.  The integer symbol iteratively takes on the
value in the range and has scope within the MathML expressions contained by the SBML component element
except for \class{Dimension} structures preceding the given \class{Dimension} structure in \texttt{listOfDimensions}.
The integer symbol will overload symbols declared elsewhere in the model.

All the objects in the
array have the properties described by the structures's
attributes and substructures.
Structures that are declared as arrays share the same namespace
as those structures that represent single objects.

The following SBML model shows a \texttt{Compartment}
structure representing a 1 dimensional array consisting of
a cells located in the array from a positions 0 to 9 inclusive.

\begin{example}
<model id="simple">
    <listOfCompartments>
        <compartment id="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </compartment>
    </listOfCompartments>
</model>
\end{example}

The following SBML model shows a \texttt{Compartment}
structure representing a 2 dimensional triangular array.

\begin{example}
<model id="simple">
    <listOfCompartments>
        <compartment id="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> x </ci>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </compartment>
    </listOfCompartments>
</model>
\end{example}

\subsection{Array Element Object Reference}
\label{sec:arrayLinks}
Elements of an array can be referenced from objects using \class{ObjectRef} structures introduced by the model composition proposal.
The \class{ObjectRef} type is extended in this proposal to have an \attrib{index} field (the XML encoding for this field is a \texttt{listOfIndices} element).
This field consists of a set of math expressions which index into the array referenced by the \attrib{object} field.  There should be
as many expressions as there dimensions in the referenced array.

We can use the \attrib{compartmentLink} field on a \class{Species} structure to create an array of species
distributed across an array of compartments:
\begin{example}
<model id="ref">
    <listOfCompartments>
        <compartment id="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </compartment>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <compartmentLink object="cell">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>
                </listOfIndices>
            </compartmentLink>
        </species>
    </listOfSpecies>
</model>
\end{example}
In this example each species array element is placed in a
corresponding compartment array element.

\subsection{Array Element Reference In MathML}
This section describes mechanisms within a a math expression, for accessing specific elements of an
array.

In MathML expressions components declared as arrays can be referenced using \texttt{ci} elements.
However this will represent an matrix or vector of the values of the component's elements as opposed
to a single scalar value.
In MathML expressions the \texttt{selector} operator
can be applied to such an array symbol (vector or matrix in MathML) and
returns the appropriate value of the indexed array element.
The `array' operand of a \texttt{selector} operator must be the name of a
structure which has been declared as an array.  The index arguments must integer expressions.

\subsubsection{Example of using element references in both numeric and object reference fields}

The following example fragment shows how the array operator can be used in
a numeric expression.  
\begin{example}
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <apply>
        <times/>
        <apply>
            <selector>
            <ci> s1 </ci>
            <ci> x </ci>
        </apply>
        <cn> 0.1 </cn>
    </apply>
</math>
\end{example}

\texttt{s1} is an array and \texttt{x} is an integer symbol or parameter.
The whole model follows.  This model contains 2 arrays of 10 species and defines
a set of 10 reactions between corresponding pairs of species. The rate equation
for this set of reactions uses the \texttt{selector} element to reference the reactant species.

\begin{example}
<model id="ref">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s1" compartment="cell"/>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
        <species id="s2" compartment="cell"/>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfReactions>
        <reaction id="r">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <listOfReactants>
                <speciesReference>
                    <speciesLink object="s1">
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
            </listOfReactants>
            <listOfProducts>
                <speciesReference>
                    <speciesLink object="s2">
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
             </listofProducts>
            <kineticLaw>
                <note>
                    <p xmlns="http://www.w3.org/1999/xhtml">s1[x] * 0.1</p>
                </note>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <apply>
                            <selector>
                            <ci> s1 </ci>
                            <ci> x </ci>
                        </apply>
                        <cn> 0.1 </cn>
                    </apply>
                </math>
            <kineticLaw>
        </reaction>
    </listOfReactions>
</model>
\end{example}

\subsubsection{Use of \texttt{csymbol} for accessing high dimensional arrays}

Unfortunately MathML is not designed to represent matrices with more than 2 dimensions.
So that it is possible to access elements of arrays with more than 3 dimensions we
define a new URI for use with the MathML \texttt{csymbol} element which represents a selector
operator that takes an arbitrary number of arguments.  The URI is
\texttt{http://www.sbml.org/symbols/arrayselector}. This operator can be used in place 
of the \texttt{selector} element.

The following example fragment shows how the array operator can be used in
a numeric expression.  

\begin{example}
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <apply>
        <times/>
        <apply>
            <csymbol
                encoding="text" 
                definitionURL="http://www.sbml.org/symbols/arrayselector">
                ?
            </csymbol>
            <ci> s1 </ci>
            <ci> x </ci>
            <ci> y </ci>
            <ci> z </ci>
        </apply>
        <cn> 0.1 </cn>
    </apply>
</math>
\end{example}

\subsubsection{Issue}

Do we want to support these two operators simultaneously? 

\subsection{Arrays of Rules}

Although \class{rule} structures do not declare a symbol it is still possible to
create an array of rules as described above.  
It is not possible to define more than one rate or assignment rules that applies
to the same single array cell.

For example:

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s" initialAmount="0.1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <rateRule>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <variableLink object="s">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>          
                </listOfIndices>
            </variableLink>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0.1 </cn>
            </math>
        </rateRule>
    </listOfRules>
</model>
\end{example}

As rules do not declare symbols it is possible for more than one
rule to be applied to the same array. For example consider the
following example in which two different rules are applied to different halves of the
same array:

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s" initialAmount="0.1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <rateRule>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 4 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <variableLink object="s">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>          
                </listOfIndices>
            </variableLink>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0.1 </cn>
            </math>
        </rateRule>
        <rateRule>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 5 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <variableLink object="s">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>          
                </listOfIndices>
            </variableLink>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0.2 </cn>
            </math>
        </rateRule>
    </listOfRules>
</model>
\end{example}

In the following example a model varies the initial concentration of a species
across a 1 dimensional array of species:

\begin{example}
<model id="varying">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartment>
    <listOfSpecies>
        <species id="s">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    <upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <initalAssignmentRule>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <variableLink object="s">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>          
                </listOfIndices>
            </variableLink>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <times/>
                    <ci> x </ci>
                    <cn> 0.1 </cn>
                </apply>
            </math>
        </initalAssignmentRule>
    </listOfRules>
</model>
\end{example}

\section{Simplified Array Structures for Related Objects}

It is possible to incorporate a simplified mechanism for creating
species, compartment, rule and parameter arrays and for referencing the
elements of those arrays.

\subsection{Implied Species Arrays}
\label{sec:impliedarrays}

In this proposal when the \texttt{compartment} field of a
\texttt{Species} structure contains the identifier of an array of
compartments the \attrib{compartmentLink} field can be omitted.
A structure configured in this fashion
represents an array of species with the same specification as the
given compartment array.

Alternatively the \attrib{index} field enclosed in the \attrib{compartmentLink} field
may be missing.  Again a structure configured in this fashion
represents an array of species with the same specification as the
given compartment array.

In these cases each element of the species array is
located in a corresponding compartment element.  The species array
is not explicitly declared i.e. the \attrib{dimension} field (\texttt{listOfDimensions} element)
has alternative semantics.  For the moment in our examples it is omitted as well.

For example given
\begin{example}
<compartment id="cell">
    <listOfDimensions>
         <dimension id="x">
             <lowerLimit>
                 <math xmlns="http://www.w3.org/1998/Math/MathML">
                     <cn> 0 </cn>
                 </math>
             </lowerLimit>
             <upperLimit>
                 <math xmlns="http://www.w3.org/1998/Math/MathML">
                     <cn> 9 </cn>
                 </math>
             </upperLimit>
         </dimension>
    </listOfDimensions>
</compartment>
\end{example}
the structure
\begin{example}
<species id="s" initialAmount="0">
    <listOfDimensions>
        <dimension id="x">
            <lowerLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 0 </cn>
                </math>
            <lowerLimit>
            <upperLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 9 </cn>
                </math>
            <upperLimit>
        </dimension>
    </listOfDimensions>
    <compartmentLink object="cell">
        <listOfIndices>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <ci> x </ci>
            </math>
        </listOfIndices>
    </compartmentLink>
</species>
\end{example}
can be replaced with the equivalent structures:
\begin{example}
<species id="s" compartment="cell" initialAmount="0"/>
\end{example}
or
\begin{example}
<species id="s" initialAmount="0">
    <compartmentLink object="cell"/>
</species>
\end{example}

If the species \texttt{dimension} field (\texttt{listOfDimensions} sub-element) is present but
the \attrib{compartmentLink} field is not present or the enclosed \attrib{index} field is not present
the resulting species array created has the combined dimensions
of the compartment array and the dimensions enclosed in the \texttt{dimension} field.
The compartment dimensions are implied in the sequence before the species dimensions.
For example the following structure defines a 2
dimension array of species where the first dimension is mapped across a row of compartments:
\begin{example}
<compartment id="cell"/>
    <listOfDimensions>
        <dimension id="x">
            <lowerLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 0 </cn>
                </math>
            </lowerLimit>
            <upperLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 9 </cn>
                </math>
            </upperLimit>
        </dimension>
    </listOfDimensions>
</compartment>
...
<species id="ss" compartment="cell" initialAmount="0"/>
    <listOfDimensions>
        <dimension id="y">
            <lowerLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 0 </cn>
                </math>
            </lowerLimit>
            <upperLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 5 </cn>
                </math>
            </upperLimit>
        </dimension>
    </listOfDimensions>
</species>
\end{example}

In these cases the symbols declared in the referenced compartment's \attrib{dimension} field (\texttt{listOfDimensions} sub-element)
are in scope in all the MathML expressions contained within the species structure.  For example a species structure
could omit the \attrib{compartmentLink} field yet still use symbols from the compartment's \attrib{dimension} field
in the species' \attrib{exists} field.

\subsection{Implied Compartment Arrays}

In SBML Level 2 it is possible to specify nested compartments.
For example the fragment:

\begin{example}
<listOfCompartments>
    <compartment id="a">
    <compartment id="b" outside="a">
</listOfCompartments>
\end{example}

Defines a compartment \texttt{b} which is enclosed by \texttt{a}.

The scheme used for species in the previous section can be applied in this case.
For example

\begin{example}
<listOfCompartments>
    <compartment id="a">
        <listOfDimensions>
            <dimension id="x">
                <lowerLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 0 </cn>
                    </math>
                </lowerLimit>
                <upperLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 5 </cn>
                    </math>
                </upperLimit>
            </dimension>
        </listOfDimensions>
    </compartment>
    <compartment id="b" outside="a"/>
</listOfCompartments>
\end{example}

is equivalent to

\begin{example}
<listOfCompartments>
    <compartment id="a"/>
        <listOfDimensions>
            <dimension id="x">
                <lowerLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 0 </cn>
                    </math>
                </lowerLimit>
                <upperLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 5 </cn>
                    </math>
                </upperLimit>
            </dimension>
        </listOfDimensions>
    </compartment>
    <compartment id="b">
        <listOfDimensions>
            <dimension id="x">
                <lowerLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 0 </cn>
                    </math>
                </lowerLimit>
                <upperLimit>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <cn> 5 </cn>
                    </math>
                </upperLimit>
            </dimension>
        </listOfDimensions>
        <outsideLink object="a">
            <listOfIndices>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <ci> x </ci>
                </math>
            </listOfIndices>
        </outsideLink>
    </compartment>
</listOfCompartments>
\end{example}

Similar scoping rules for symbols apply here as they do for species structures.

\subsection{Implied Parameter Arrays}

We can apply the above concept to parameters if we introduce a
new \texttt{SId} field, \texttt{foreach} and corresponding \class{ObjectLink} field, \attrib{foreachLink}, to the parameter
structure. This field allows us to reference any other symbol
from this structure and thus attach a parameter to each element
of the referenced array.

For example given:
\begin{example}
<compartment id="cell">
    <listOfDimensions>
        <dimension id="x">
            <lowerLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 0 </cn>
                </math>
            </lowerLimit>
            <upperLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 5 </cn>
                </math>
            </upperLimit>
        </dimension>
    </listOfDimensions>
</compartment>
...
\end{example}
then
\begin{example}
<parameter id="p" foreach="cell" value="0"/>
\end{example}
is equivalent to
\begin{example}
<parameter id="p" value="0">
    <listOfDimensions>
        <dimension id="x">
            <lowerLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 0 </cn>
                </math>
            </lowerLimit>
            <upperLimit>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <cn> 5 </cn>
                </math>
            </upperLimit>
        </dimension>
    </listOfDimensions>
</parameter>
\end{example}

Similar scoping rules for symbols apply here as they do for species structures.

\subsection{Implied Arrays of Rules}

If the the \attrib{dimension} field
(\texttt{listOfDimensions} sub-element) is omitted and if the variable reference by the
assignment rule is an array then the assignment rule implicitly consists of an array with the
same dimensions as the reference variable object.  For example the example

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s" initialAmount="0.1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <rateRule>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <variableLink object="s">
                <listOfIndices>
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <ci> x </ci>
                    </math>
                </listOfIndices>
            </variableLink>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0.1 </cn>
            </math>
        </rateRule>
    </listOfRules>
</model>
\end{example}

is equivalent to:

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s" initialAmount="0.1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <rateRule variable="s">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0.1 </cn>
            </math>
        </rateRule>
    </listOfRules>
</model>
\end{example}

\section{Rules which supply a matrix result}

Rules can be defined 
in which the formula expression returns a whole
array or matrix value rather than a single value to be inserted into each
array element.  This type of rule is indicated by the \texttt{matrixResult}
attribute having a \texttt{true} value (default is \texttt{false}).
For assignment and rate rules the resulting array should have the same dimensions as the assignment variable
for which it is declared.  The result of the expression is then mapped onto
the array referenced in the rules \attrib{variable} field.
Algebraic rules of this form constrain all the elements of the resulting matrix to zero. 
This type of rule must not have any dimension.

Whole matrix operators are described in
more detail in section~\ref{sec:math}.  For now assume that we
can, for instance, multiply arrays then consider the example
model:

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s1" initialAmount="0.1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    <upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
        <species id="s2" initialAmount="0.2" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    <upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <rateRule matrixResult="true" variable="s1"/>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <plus/>
                    <ci> s1 </ci>
                    <ci> s2 </ci>
                </apply>
            </math>
        </rateRule>
    </listOfRules>
</model>
\end{example}

The rule for \texttt{s1} defines that the rate of change of the
values of the array of \texttt{s1} is the sum of the concentration vectors
\texttt{s1} and \texttt{s2}.

One useful application of the matrix result rules is for setting the initial
value of an array.  The following example does this using the MathML \class{vector} 
element:

\begin{example}
<model id="rules">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s1" compartment="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    <upperLimit>
                </dimension>
            </listOfDimensions>
        </species>
    </listOfSpecies>
    <listOfRules>
        <initialAssignmentRule matrixResult="true" variable="s1"/>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <vector>
                    <cn> 0 </cn>
                    <cn> 1 </cn>
                    <cn> 2 </cn>
                    <cn> 3 </cn>
                    <cn> 4 </cn>
                    <cn> 5 </cn>
                    <cn> 6 </cn>
                    <cn> 7 </cn>
                    <cn> 8 </cn>
                    <cn> 9 </cn>
                </vector>
            </math>
        </initialAssignmentRule>
    </listOfRules>
</model>
\end{example}

\section{Sparse Arrays and Connections}
\label{sec:sparseandconnections}

\subsection{Sparse Arrays}
\label{sec:sparse}

In practice arrays are not very useful for modelling unless its
possible to describe connection schemes between elements of the
arrays.  For example if one creates a model of a tissue of cells
as an array of compartments then the model doesn't become
interesting until the interactions between the cells are
incorporated.  This section begins the process of proposing
structures which allow interconnection schemes to be defined.

We can use the \attrib{exists} field (see section~\ref{sec:exists}) 
as a mechanism for creating sparse arrays.  Elements of an array
are simply absent if the \attrib{exists} expression is false for a given
set of dimension integer variables.

\subsection{Sparse Array Example}
\label{sec:sparseeg}

The following example shows how the \attrib{exists} field is used to create a structure for a triangular
array where the maximum \texttt{y} index is equal to the
\texttt{x} index.

\begin{example}
<model id="starfish">
    <listOfCompartments>
        <compartment id="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <exists>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <leq/>
                        <ci> x </ci>
                        <ci> y </ci>
                    </apply>
                </math>
            </exists>
        </compartment>
    </listOfCompartments>
</model>
\end{example}

This can be defined in an alternative fashion by using the \texttt{x} symbol to define the bounds of the \texttt{y} dimension:
\begin{example}
<model id="starfish">
    <listOfCompartments>
        <compartment id="cell">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> x </ci>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </compartment>
    </listOfCompartments>
</model>
\end{example}

The index operand to an \texttt{selector} operator must refer to an element
which exists in an array.  

\subsection{Using Sparse Arrays to Represent Connection schemes}
\label{sec:connections}

We can use a proposed sparse array feature to represent the connections
between elements of another array.  If we have a $n$ dimensional array of
components we can represent connections between those components as a $2 n$ dimensional 
sparse array.  In the sparse array elements only occur where connections are to be modelled.
Thus components that exist as connections are thus defined as sparse $2 n$ dimensional arrays.

This is shown in the
following example, in which \texttt{grid} is a 2 dimensional
array of compartments, \texttt{s} is a 2 dimensional array of
species distributed over the \texttt{grid}compartments and, \texttt{connections} is a sparse 4
dimensional array of reactions between elements of \texttt{s}.
\texttt{connections} contains array elements for all
pairs of co-ordinates where the co-ordinates are exactly one array element
away from each other.

\begin{example}
<model id="tissue">
    <listOfCompartments>
        <compartment id="grid"/>
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </compartment>
    </listOfCompartments>
    <listOfSpecies>
        <species id="s" initialAmount="0.1" compartment="grid">
    </listOfSpecies>
    <listOfReactions>
        <reaction id="connections">
            <listOfDimensions>
                <dimension id="x1">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y1">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> 9 </ci>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="x2">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    <lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 9 </cn>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y2">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> 9 </ci>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <exists>
                <note>
                    <p xmlns="http://www.w3.org/1999/xhtml">
                        abs(x2 - x1) == 1 || abs(y2 - y1) == 1
                    </p>
                </note>                
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <or/>
                        <apply>
                            <eq/>
                            <apply/>
                                <abs/>
                                <apply>
                                    <minus/>
                                    <ci> x2 </ci>
                                    <ci> x1 </ci>
                                </apply>
                            </apply>
                            <cn> 1 </cn>
                        </apply>
                        <apply>
                            <eq/>
                            <apply/>
                                <abs/>
                                <apply>
                                    <minus/>
                                    <ci> y2 </ci>
                                    <ci> y1 </ci>
                                </apply>
                            </apply>
                            <cn> 1 </cn>
                        </apply>
                    </apply>
                </math>
            </exists>
            <listOfReactants>
                <speciesReference>
                    <speciesLink object="s">
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x1 </ci>
                            </math>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> y1 </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "s">
                    <speciesLink object="s">
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x2 </ci>
                            </math>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> y2 </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
            </listOfProducts>
            <kineticLaw>
                <note>
                    <p xmlns="http://www.w3.org/1999/xhtml">s[x1][y1] * 0.1"</p>
                </note>                
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <apply>
                            <selector/>
                            <ci> s </ci>
                            <ci> x1 </ci>
                            <ci> y1 </ci>
                        </apply>
                        <cn> 0.1 </cn>                            
                    </apply>
                </math>
            </kineticLaw
        </reaction>
    </listOfReactions>
</model>
\end{example}

The \texttt{connections} specification is bidirectional: for every
pair of adjacent \texttt{grid} co-ordinates there are a pair of
elements. \texttt{connections} can be simplified and made
unidirectional by changing the \texttt{exists} expression
to:
\begin{example}
x2 - x1 == 1 || y2 - y1 == 1
\end{example}
In this case the connections only run from bottom to top and left
to right.

\section{Array Math}
\label{sec:math}

Under this proposal the set of MathML elements that can be incorporated into SBML is extended 
to include the following:
\begin{itemize}
\item \emph{constructors} \texttt{matrix}, \texttt{matrixrow}, \texttt{vector}
\item \emph{element reference operator} \texttt{selector}
\item \emph{qualifier components} \texttt{bvar}, \texttt{lowlimit}, \texttt{uplimit}, \texttt{interval}, \texttt{condition}
\item \emph{linear algebra operators} \texttt{vectorproduct}, \texttt{scalarproduct}, \texttt{outerproduct}, \texttt{transpose}
\item \emph{sum product operators} \texttt{sum}, \texttt{product}
\item \emph{quantifier operators} \texttt{forall}, \texttt{exists}
\end{itemize}

Please refer to the MathML specification~\citep{w3c:2000b} for further details of the operation of these elements.

\section{Example: the community effect in developmental gene regulation}

This section contains an example model of the community effect in
developmental gene regulation~\citep{gurdon:1988}.  This model demonstrates how
the array proposal can be combined with the model composition proposal.

In the SBML given below the original model is broken into two parts using model composition.
The first SBML model
encodes the biochemical network inside each cell (this model doesn't use any array features).
The second SBML model assembles instances of the first model into a tissue using the proposed array features.

The original model basically contains a
high abstracted model of gene expression for a single gene as follows:

\begin{equation*}
  \begin{array}{@{}ccc@{}}
    ubiq & \underrightarrow{v_{mu} ubiq} & waste \\ \\[-4pt]
    mRNA & \underrightarrow{k_{dm} mRNA} & waste \\ \\[-4pt]
    p & \underrightarrow{k_{dp} p} & waste \\ \\[-4pt]
    mat & \underrightarrow{v_i} & ubiq \\ \\[-4pt]
    mat & \underrightarrow{\frac{k_t ubiq}{k_{mu} + ubiq}} & mRNA \\ \\[-4pt]
    mat & \underrightarrow{\frac{k_s mRNA}{k_{mu} + mRNA}} & p
  \end{array}
\end{equation*}

where $ubiq$ is a transcription factor, $p$ is the gene product,
$mat$ represents the material used to construct active species and
$waste$ represents the material produced by the degradation of
active species.  Both $mat$ and $waste$ are modelled as boundary
conditions.

The second model creates a ``tissue'' of these cells: a rectangular array of cells. This
model contains a positive feedback loop between adjacent cells by
enabling the gene product of an adjacent cell to be a
transcription factor of the gene in the current cell. Thus the
feedback loop is completed by the following reaction in the second model
between adjacent cells. 

\begin{equation*}
  \begin{array}{@{}ccc@{}}
    mat_a & \underrightarrow{\frac{k_r p_b}{k_mr + p_b}} & mRNA_a
  \end{array}
\end{equation*}

where $mat_a$ and $mRNA_a$ are concentrations in a given cell and
$p_b$ is the contribution of gene product from an adjacent cell.

The first model:
\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3" version="1" level="3">
<model id="cell_model">
    <listOfCompartments>
        <compartment id="cell"/>
    </listOfCompartments>
    <listOfSpecies>
        <species id="mat" compartment="cell_compartment" boundaryCondition="true"
            initialAmount="1.0"/>
        <species id="mRNA" compartment="cell_compartment" initialAmount="0"/>
        <species id="waste" compartment="cell" boundaryCondition="true" initialAmount="1.0"/>
        <species id="ubiq" compartment="cell" initialAmount="0"/>
        <species id="p" compartment="cell" initialAmount="0"/>
    </listOfSpecies>
    <listOfParameters>
        <parameter id="kmu" value="0.1"/>
    </listOfParameters>
    <listOfReactions>
        <reaction id="ubiq2waste">
            <listOfReactants>
                <speciesReference species= "ubiq"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "waste"/>
            </listOfProducts>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <ci> vmu </ci>
                        <ci> ubiq </ci>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="vmu" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
        <reaction id="mRNA2waste">
            <listOfReactants>
                <speciesReference species= "mRNA"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "waste"/>
            </listOfProducts>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <ci> kdm </ci>
                        <ci> mRNA </ci>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="kdm" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
        <reaction id="p2waste">
            <listOfReactants>
                <speciesReference species= "p"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "waste"/>
            </listOfProducts>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <ci> kdp </ci>
                        <ci> p </ci>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="kdp" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
        <reaction id="mat2ubiq">
            <listOfReactants>
                <speciesReference species= "mat"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "ubiq"/>
            </listOfProducts>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <ci> vi </ci>
                </math>
                <listOfParameters>
                    <parameter id="vi" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
        <reaction id="mat2p">
            <listOfReactants>
                <speciesReference species= "mat"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "p"/>
            </listOfProducts>
            <listOfModifiers>
                <modifierSpeciesReference species="mRNA"/>
            </listOfModifiers>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <divide/>
                        <apply>
                            <times/>
                            <ci>ks</ci>
                            <ci>mRNA</ci>    
                        </apply>
                        <apply>
                            <plus/>
                            <ci>kmu</ci>
                            <ci>mRNA</ci>
                        </apply>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="ks" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
        <reaction id="local_mat2mRNA">
            <listOfReactants>
                <speciesReference species= "mat"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species= "mRNA"/>
            </listOfProducts>
             <listOfModifiers>
                <modifierSpeciesReference species="ubiq"/>
            </listOfModifiers>
           <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <divide/>
                        <apply>
                            <times/>
                            <ci>kt</ci>
                            <ci>ubiq</ci>    
                        </apply>
                        <apply>
                            <plus/>
                            <ci>kmu</ci>
                            <ci>ubiq</ci>
                        </apply>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="kt" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
    </listOfReactions>
    <listOfPorts>
        <port object="mat"/>
        <port object="mRNA"/>
        <port object="p"/>
    </listOfPorts>
</model>
</sbml>
\end{example}

The second model:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level3" version="1" level="3">
<model id="community_effect">
    <listOfIntegerParameters>
        <integerParameter id="xBound" value = "9"/>
        <integerParameter id="yBound" value = "5"/>
    </listOfIntegerParameters>
    <listOfReactions>
        <reaction id="neighbour_mat2mRNA">
            <listOfDimensions>
                <dimension id="x1">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> xBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y1">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> yBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="x2">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> xBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y2">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> yBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
            <exists>
                <note>
                    <p xmlns="http://www.w3.org/1999/xhtml">
                        (x1 == x2 or y1 == y2) and (x1 != x2 or y1 != y2)
                    </p>
                </note>                
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <and/>
                        <apply>
                            <or/>
                            <apply>
                                <eq/>
                                <ci>x1</ci>
                                <ci>x2</ci>
                            </apply>
                            <apply>
                                <eq/>
                                <ci>y1</ci>
                                <ci>y2</ci>
                            </apply>
                        </apply>
                        <apply>
                            <or/>
                            <apply>
                                <neq/>
                                <ci>x1</ci>
                                <ci>x2</ci>
                            </apply>
                            <apply>
                                <neq/>
                                <ci>y1</ci>
                                <ci>y2</ci>
                            </apply>
                        </apply>
                    </apply>
                </math>
            </exists>
            <listOfReactants>
                <speciesReference>
                    <speciesLink object="cell">
                        <objectLink object="mat"/>
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x1 </ci>
                            </math>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> y1 </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
            </listOfReactants>
            <listOfProducts>
                <speciesReference>
                    <speciesLink object="cell">
                        <objectLink object="mRNA"/>
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x1 </ci>
                            </math>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> y1 </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </speciesReference>
            </listOfProducts>
            <listOfModifiers>
                <modifierSpeciesReference>
                    <speciesLink object="cell">
                        <objectLink object="p"/>
                        <listOfIndices>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> x2 </ci>
                            </math>
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <ci> y2 </ci>
                            </math>
                        </listOfIndices>
                    </speciesLink>
                </modifierSpeciesReference>
            </listOfModifiers>
            <kineticLaw>
                <note>
                    <p xmlns="http://www.w3.org/1999/xhtml">
                        (kr * cell[x2][y2].p)/(kmr + cell[x2][y2].p)
                    </p>
                </note>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <divide/>
                        <apply>
                            <times/>
                            <ci>kr</ci>
                            <apply>
                                <csymbol
                                    encoding="SBML"
                                    definitionURL=
                                        "http://www.sbml.org/symbols/instanceselector">
                                    .
                                </csymbol>
                                <apply>
                                    <selector/>
                                    <ci> cell </ci>
                                    <ci> x2 </ci>
                                    <ci> y2 </ci>
                                </apply>
                                <ci>p</ci>
                            </apply>
                        </apply>    
                        <apply>
                            <add/>
                            <ci>kmr</ci>
                            <apply>
                                <csymbol
                                    encoding="SBML"
                                    definitionURL=
                                        "http://www.sbml.org/symbols/instanceselector">
                                    .
                                </csymbol>
                                <apply>
                                    <selector/>
                                    <ci> cell </ci>
                                    <ci> x2 </ci>
                                    <ci> y2 </ci>
                                </apply>
                                <ci>p</ci>
                            </apply>
                        </apply>    
                    </apply>
                </math>   
                <listOfParameters>
                    <parameter id="kr" value="0.1"/>
                    <parameter id="kmr" value="0.07"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
    </listOfReactions>
    <listOfInstances>
        <instance id="cell" xlink:type="simple" xlink:href="cellModel.xml">
            <listOfDimensions>
                <dimension id="x">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> xBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
                <dimension id="y">
                    <lowerLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <cn> 0 </cn>
                        </math>
                    </lowerLimit>
                    <upperLimit>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci> yBound </ci>
                        </math>
                    </upperLimit>
                </dimension>
            </listOfDimensions>
        </instance>
    </listOfInstances>
</model>
</sbml>
\end{example}

\section{Acknowledgements}

Many thanks to Hamid Bolouri for suggesting the community effect model as an example model.

%-----------------------------------------------------------------------
\newpage
\section{Appendix}
\setcounter{secnumdepth}{2}
\appendix


%=============================================================================
\section{Elements introduced by Arrays Proposal}
\label{apdx:newelements}

Table~\ref{tab:newelements} lists all the new SBML XML elements that are introduced by this proposal
including those elements from the model composition proposal~\citep{finney:2003b} that are
essential to this proposal.  Obviously this applies only to the XML encoding of this proposal.
The new MathML elements introduced by this proposal are listed in Section~\ref{sec:math}.

\begin{table}[bh]
  \centering
  \begin{tabular}{|l|l|l|}
  \hline
     \textbf{element} & \textbf{parent elements} & \textbf{comment} \\ \hline
    \texttt{compartmentLink} & \texttt{species} & see model composition \\
                              &                 & proposal~\citep{finney:2003b}\\ \hline
    \texttt{dimension} & \texttt{listOfDimensions} & see section~\ref{sec:arraydec}\\ \hline
    \texttt{exists} & \texttt{algebraicRule}, \texttt{assignmentRule}, &\\
                              &  \texttt{compartment}, \texttt{event}, &\\
                              &  \texttt{initialAssignmentRule}, \texttt{parameter}, &\\
                              &  \texttt{rateRule}, \texttt{reation}, &\\
                              &  \texttt{species} & see section~\ref{sec:arraydec}\\ \hline 
    \texttt{foreachLink} & \texttt{parameter} & sec section~\ref{sec:impliedarrays}\\ \hline
    \texttt{integerParameter} & \texttt{listOfIntegerParameters} & see section~\ref{sec:integerParameters}\\ \hline
    \texttt{listOfDimensions} & \texttt{algebraicRule}, \texttt{assignmentRule}, &\\
                              &  \texttt{compartment}, \texttt{event}, &\\
                              &  \texttt{initialAssignmentRule}, \texttt{parameter}, &\\
                              &  \texttt{rateRule}, \texttt{reation}, &\\
                              &  \texttt{species} & see section~\ref{sec:arraydec}\\ \hline 
    \texttt{listOfIndices} & \texttt{compartmentLink}, \texttt{foreachLink}, &\\
                              & \texttt{outsideLink}, \texttt{speciesLink}, &\\
                              & \texttt{variableLink} & see section~\ref{sec:arrayLinks} \\ \hline
    \texttt{listOfIntegerParameters} & \texttt{model} & see section~\ref{sec:integerParameters}\\ \hline
    \texttt{lowerLimit} & \texttt{dimension} & see section~\ref{sec:arraydec}\\ \hline
    \texttt{outsideLink} & \texttt{compartment} & see model composition \\
                              &                            & proposal~\citep{finney:2003b}\\ \hline
    \texttt{speciesLink} & \texttt{simpleSpeciesReference} & see model composition \\
                              &                            & proposal~\citep{finney:2003b}\\ \hline
    \texttt{upperLimit} & \texttt{dimension} & see section~\ref{sec:arraydec}\\ \hline
    \texttt{variableLink} & \texttt{algebraicRule}, \texttt{assignmentRule}, &\\
                              & \texttt{eventAssignment}, \texttt{initialAssignmentRule}, & see model composition \\
                              & \texttt{rateRule} & proposal~\citep{finney:2003b}\\ \hline

  \end{tabular}
  \caption{the new elements that are introduced by this proposal
including those elements from the model composition proposal~\citep{finney:2003b} that are
essential to this proposal}
  \label{tab:newelements}
\end{table}

%=============================================================================

%=============================================================================
% References
%=============================================================================

\bibliographystyle{apalike}
\bibliography{strings,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
\end{document}
