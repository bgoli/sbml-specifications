% -*- TeX-master: "sbml-level-2-version-3"; fill-column: 66 -*-
% $Id$
% $Source$
% ----------------------------------------------------------------

\section{SBML components}
\label{sec:elements}

In this section, we define each of the major data structures in
SBML. To provide illustrations of their use, we give partial model
definitions in XML.  Section~\ref{sec:xml-rep} provides many full
examples of SBML in XML.

In type definitions presented throughout this section, we follow a
common UML convention of hiding the attributes derived from a
parent type such as \SBase.  It should be kept in mind that these
attributes are always available.


%-----------------------------------------------------------------------------
\subsection{The SBML container}
\label{sec:sbml}
%-----------------------------------------------------------------------------

The outermost portion of an \sbmltwotwo model definition consists
of a single \Sbml structure enclosing a single \Model structure
(see next Section).  The definition of \Sbml is shown in
Figure~\ref{fig:sbml}.  The element has three required fields:
\token{level}, \token{version} and \token{model}.  For
\sbmltwotwo, \token{level} and \token{version} must both be set to
\val{2}.

\begin{figure}[htb]
  \centering
  \small
  \vspace*{-1ex}
  \begin{classbox}{Sbml}
    level: positiveInteger \{ use="required" fixed="2" \}                 \\
    version: positiveInteger \{ use="required" fixed="2" \} \\
    model: Model                                            \\
  \end{classbox}
  \caption{The definition of \Sbml for SBML Level~2
    Version~2.  Following UML notation, additional
    fields that are inherited from a base class, in this case
    \SBase, are not shown.}
  \label{fig:sbml}
\end{figure}

In the transformation of UML to XML used in SBML, the structure of
Figure~\ref{fig:sbml} is turned into an element named
\token{sbml}.  This element constitutes the outermost container of
XML content.  To be a well-formed XML document, this container
should be preceded by a string known as the \emph{XML
  declaration}, which specifies both the version of XML assumed
and the document character encoding.  The XML declaration begins
with the characters \token{<?xml}.  The version of XML used by the
\sbmltwotwo specification is version 1.0, and the character
encoding is required to be UTF-8.  The following is an abbreviated
example of these essential XML elements for a \sbmltwotwo
document:

\begin{example}
<?xml version="1.0" encoding="UTF-8"?>
<sbml xmlns="http://www.sbml.org/sbml/level2/version2" level="2" version="2">
  ...
</sbml>
\end{example}

Note the additional XML attribute \token{xmlns}.  This is required
for XML; it declares the default XML namespace used within the
\token{sbml} element.  The XML namespace URI for \sbmltwotwo is
the string \uri{http://www.sbml.org/sbml/level2/version2}.  All
Level~2 Version~2 elements must be placed in this namespace either
by assigning the default XML namespace as shown above, or using a
tag prefix on every element.

An SBML XML document must not contain elements or attributes in
the SBML namespace that are not defined in this \sbmltwotwo
specification.  Documents containing unknown elements or
attributes placed in the SBML namespace do not conform to the
\sbmltwotwo specification.

Readers may wonder why the SBML top-level XML element uses both a
namespace URI identifying the SBML level and version, as well as
separate XML attributes giving the level and version.  Why is the
information duplicated?  There are several reasons.  First, XML is
only one possible serialization of SBML (albeit an extremely
popular one at this time).  Though most of this document is
written with XML in mind, it is the intention behind the design of
SBML that its object structure should be implementable in other
languages and software systems.  Programmatic access is easier if
the level and version information are accessible directly as data
rather than have to be extracted from a string.  Second, generic
high-level XML parsers may not give their calling programs access
to the value of the \texttt{xmlns} attribute.  Providing the
information via separate attributes is a good backup measure.  And
finally, earlier in the history of SBML, it was expected that only
the level needed to be encoded as part of the namespace URI (e.g.,
\uri{http://www.sbml.org/sbml/level1}) because it was hoped that
changes within levels would not require XML Schema changes.  This
has proven to be false, but SBML Level~1 (both versions) and the
first version of SBML Level~2 still subscribe to this principle.
This means that for these variants of SBML, software tools must
look for a \token{version} attribute on the top-level element.
For backwards compatibility with software that expects this, it
makes more sense to keep the version and level attributes.


%-----------------------------------------------------------------------------
\subsection{Model}
\label{sec:model}
%-----------------------------------------------------------------------------

The \Model structure is the highest-level construct in an SBML
data stream or document.  Its definition is shown in
Figure~\vref{fig:model}.  Only one component of type \Model is
allowed per instance of an \sbmltwotwo document or data stream,
although it does not necessarily need to represent a single
biological entity.

\begin{figure}[htb]
  \centering
  \begin{classbox}{Model}
    id: SId  \{ use="optional" \}                        \\
    name: string \{ use="optional" \}                    \\
    sboTerm: SBOTerm \{ use="optional" \}      \\
    functionDefinition: FunctionDefinition[0..*]         \\
    unitDefinition: UnitDefinition[0..*]                 \\
    compartmentType: CompartmentType[0..*]     \\
    speciesType: SpeciesType[0..*]             \\
    compartment: Compartment[0..*]                       \\
    species: Species[0..*]                               \\
    parameter: Parameter[0..*]                           \\
    initialAssignment: InitialAssignment[0..*] \\
    rule: Rule[0..*]                                     \\
    constraint: Constraint[0..*]               \\
    reaction: Reaction[0..*]                             \\
    event: Event[0..*]                                   \\
  \end{classbox}
  \caption{The definition of \Model.  Following UML notation, additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:model}
\end{figure}

\Model serves as a container for components of object classes
\FunctionDefinition, \UnitDefinition, \CompartmentType,
\SpeciesType, \Compartment, \Species, \Parameter,
\InitialAssignment, \Rule, \Constraint, \Reaction and \Event. All
of these components are optional; that is, the lists in each of
the respective fields are permitted to have zero length. (However,
there are dependencies between components, such that defining some
requires defining others.  For example, as explained in other
sections below, defining a species requires defining a
compartment, and defining a reaction requires defining a species.)

The \Model structure has an optional field, \token{id}, used to
give the model an identifier.  The identifier must be a text
string conforming to the syntax permitted by the \primtype{SId}
data type described in Section~\ref{sec:sid}.  \Model also has an
optional \token{name} field, of type \primtype{string}.  The
\token{name} and \token{id} fields must be used as described in
Section~\ref{sec:idnameattribs}.

In the XML encoding of an SBML model, the lists of compartment
types, compartments, species types, species, unit definitions,
parameters, initial assignments, reactions, function definitions,
constraints, rules and events are translated into lists of XML
elements enclosed within elements of the form
\token{listOf}\rule{0.5in}{0.5pt}\token{s}, where the blank is
replaced by the name of the component type.  If the word already
ends in ``s'', such as ``species'', then the extra letter is
omitted from the end, leading to \token{listOfSpecies}.  The
resulting XML data object has the form illustrated by the
following skeletal model:
\begin{example}
<model id="My_Model">
    <listOfFunctionDefinitions>
        ...
    </listOfFunctionDefinitions>
    <listOfUnitDefinitions>
        ...
    </listOfUnitDefinitions>
    <listOfCompartmentTypes>
        ...
    </listOfCompartmentTypes>
    <listOfSpeciesTypes>
        ...
    </listOfSpeciesTypes>
    <listOfCompartments>
        ...
    </listOfCompartments>
    <listOfSpecies>
        ...
    </listOfSpecies>
    <listOfParameters>
        ...
    </listOfParameters>
    <listOfInitialAssignments>
        ...
    </listOfInitialAssignments>
    <listOfRules>
        ...
    </listOfRules>
    <listOfConstraints>
        ...
    </listOfConstraints>
    <listOfReactions>
        ...
    </listOfReactions>
    <listOfEvents>
        ...
    </listOfEvents>
</model>
\end{example}

Readers may wonder about the motivations for the
\token{listOf}\rule{0.5in}{0.5pt}\token{s} notation.  A simpler
approach to creating the lists of components would be to place
them all directly at the top level under \texttt{<model> ...
  </model>}.  We chose instead to group them within XML elements
named after \token{listOf}\rule{0.5in}{0.5pt}\token{s}, because we
believe this helps organize the components and makes visual
reading of model definitions easier.  These
\token{listOf}\rule{0.5in}{0.5pt}\token{s} elements are derived
from \SBase which enables each list to contain its own
\token{metaid}, \token{notes} and \token{annotation} fields.
Further details of how \token{listOf}\rule{0.5in}{0.5pt}\token{s}
elements implement UML lists is described in
Section~\ref{sec:notation}.


\subsubsection{The \token{sboTerm} field}
\label{sec:model-sboterm}

The \Model structure has an optional \token{sboTerm} field of type
\primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in a
model, the value must be an SBO identifier (\sboref) referring to
a modeling framework defined in SBO (\ie terms derived from
\sboframework).  The SBO term chosen should be the most precise
(narrow) term that defines the mathematical framework assumed by
the \emph{entire} model.  An example framework might be ``discrete
stochastic'', which would mean the \emph{entire} model was created
under the assumption it will be simulated in a tool that turns
substance quantities into discrete numbers and applies a
stochastic simulation algorithm~\citep[e.g.,][]{gillespie:1977} to
the model.  Other frameworks are possible.

The value given to \token{sboTerm} on a \Model interacts with the
SBO labels on the model's \Reaction elements in the following way.
The label on \Model should apply to the model as a whole, meaning
that \emph{all} reactions in the model assume the same framework.
In that case, the \token{sboTerm} values on individual \Reaction
elements may be omitted, but only the \Reaction SBO labels can be
thus omitted; the SBO labels on \KineticLaw within \Reaction must
still be supplied, as must the terms on other components of the
model, in order to characterize the model completely.

The absence of an \token{sboTerm} value on a \Model instance means
that either the model has not been labeled with SBO terms at all,
or there was no available SBO modeling framework term at the time
the model was created that was deemed suitable for characterizing
the model as a whole.  If \Model has no value for \token{sboTerm},
the \token{sboTerm} fields on each \Reaction in a model may still
indicate the framework assumed for each reaction separately.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values, and a model must be interpretable without
the benefit of SBO labels.


%-----------------------------------------------------------------------------
\subsection{Function definitions}
\label{sec:functiondefinition}
%-----------------------------------------------------------------------------

The \FunctionDefinition structure associates an identifier with a
function definition.  This identifier can then be used as the
function called in subsequent MathML \token{apply} elements.
\FunctionDefinition is shown in Figure~\ref{fig:mathdefinition}.

\begin{figure}[htb]
  \vspace*{-0.25ex}
  \centering
  \begin{classbox}{FunctionDefinition}
    id: SId                                                                    \\
    name: string \{ use="optional" \}                                          \\
    math: (lambda:Lambda) \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
    sboTerm: SBOTerm \{ use="optional" \}       \\
  \end{classbox}
  \vspace*{-0.25ex}
  \caption{The definition of \FunctionDefinition.  Following UML notation,
    additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:mathdefinition}
  \label{fig:functionDefinition}
\end{figure}

Function definitions in SBML (also informally known as
``user-defined functions'') have relatively limited capabilities.
As is made more clear below, a function cannot reference
parameters or other model quantities outside of itself; values
must be passed as parameters to the function.  Moreover, recursive
and mutually-recursive functions are not permitted.  The purpose
of these limitations is to balance power against complexity of
implementation.  With the restrictions as they are, function
definitions could be implemented as textual substitutions---they
are simply macros.  Software implementations therefore do not need
the full function-definition machinery typically associated with
programming languages.

The \FunctionDefinition structure has three fields: \token{id},
\token{name} and \token{math}.  Their purposes are explained in
the following subsections.


\subsubsection{The \token{id} and \token{name} fields}

The \token{id} and \token{name} fields have types \primtype{SId}
and \primtype{string}, respectively, and operate in the manner
described in Section~\ref{sec:idnameattribs}.  MathML \token{ci}
elements in an SBML model can refer to the function defined by a
\FunctionDefinition using the value of its \token{id} field.


\subsubsection{The \token{math} field}
\label{sec:function-definition-math}

The \token{math} field is a container for MathML content that
defines the function.  The content of this field can only be a
MathML \token{lambda} element.  The \token{lambda} element must
begin with zero or more \token{bvar} elements, followed by any
other of the elements in the MathML subset listed in
Section~\ref{sec:mathmlsubset} \emph{except} \token{lambda} (\ie a
\token{lambda} element cannot contain another \token{lambda}
element).  This is the only place in SBML where a \token{lambda}
element can be used.  The function defined by a
\FunctionDefinition is only available for use in other MathML
elements that \emph{follow} the \FunctionDefinition definition in
the model.  (These restrictions prevent recursive and
mutually-recursive functions from being expressed.)

A further restriction on the content of the \token{math} field is
that it cannot contain references to variables other than the
variables declared to the \token{lambda} itself.  That is, the
contents of MathML \token{ci} elements inside the body of the
\token{lambda} can only be the variables declared by its
\token{bvar} elements, or the identifiers of other
\FunctionDefinition{}s defined earlier in the model.  This implies
that functions must be written so that all variables or parameters
used in the MathML content are passed to them via their function
parameters.


\subsubsection{The \token{sboTerm} field}
\label{sec:functiondefinition-sboterm}

\FunctionDefinition has an optional \token{sboTerm} field of type
\primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in a
\FunctionDefinition instance, the value must be an SBO identifier
referring to a mathematical expression (\ie terms derived from
\sbomathformula).  The relationship is of the form ``the function
definition \emph{is a} X'', where X is the SBO term.  The term
chosen should be the most precise (narrow) one that captures the
role of the function in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{Examples}

The following abbreviated SBML example shows a \FunctionDefinition
structure defining \token{pow3} as the identifier of a function
computing the mathematical expression $x^{3}$, and after that, the
invocation of that function in the mathematical formula of a rate
law.  Note how the invocation of the function uses its identifier
\begin{example}
<model>
    ...
    <functionDefinition id="pow3">
        <math xmlns="http://www.w3.org/1998/Math/MathML">
            <lambda>
                <bvar><ci> x </ci></bvar>
                <apply>
                    <power/>
                    <ci> x </ci>
                    <cn> 3 </cn>
                </apply>
            </lambda>
        </math>
    </functionDefinition>
    ...
    <listOfReactions>
        <reaction id="reaction_1">
            ...
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <ci> pow3 </ci>
                        <ci> S1 </ci>
                     </apply>
                </math>
            </kineticLaw>
            ...
        </reaction>
    </listOfReactions>
    ...
</model>
\end{example}


%-----------------------------------------------------------------------------
\subsection{Unit definitions}
\label{sec:unitdefinitions}
%-----------------------------------------------------------------------------

Units of measurement may be supplied in a number of contexts in an
SBML model.  The units of the following mathematical entities can
be specified explicitly: the size of a \Compartment, the initial
amount of a \Species, the units of constant and variable
\Parameter values, the units of time and of substance in which a
reaction rate is expressed, the units of time in an event's
execution delay, and the results of mathematical formulas.  Rather
than requiring a complete unit definition on every structure, SBML
provides a facility for defining units that can be referenced
throughout a model.  In addition, every kind of SBML mathematical
entity has units assigned to it from a set of built-in defaults
(see Section~\ref{sec:built-in-units} below, and also
Sections~\ref{sec:compartment-units}, \ref{sec:species-units}
and~\ref{subsec:kinetic-law}).  By redefining these built-in
default units, it is possible to change the units used throughout
a model in a simple and consistent manner.

The SBML unit definition facility uses two classes of objects,
\UnitDefinition and \Unit.  Their definitions are shown in
Figure~\vref{fig:unitdefinition} and explained in more detail in
Sections~\ref{sec:unitdefinition-structure}
and~\ref{sec:unit-structure} below.

\begin{figure}[htb]
  \centering
  \begin{classbox}{UnitDefinition}
    id: UnitSId         \\
    name: string \{ use="optional" \} \\
    unit: Unit[1..*]                  \\
  \end{classbox}
  \hspace*{2em}
  \begin{classbox}{Unit}
    kind: UnitKind                                      \\
    exponent: int \{ use="optional" default="1" \}  \\
    scale: int \{ use="optional" default="0" \}     \\
    multiplier: double \{ use="optional" default="1" \} \\
  \end{classbox}
  \caption{The definition of \UnitDefinition and \Unit. Following UML
    notation, additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:unitdefinition}
\end{figure}

The approach to defining units in SBML is compositional; for
example, $meter\ second^{\,-2}$ is constructed by combining a
\Unit object representing $meter$ with another \Unit object
representing $second^{\,-2}$.  The combination is wrapped inside a
\UnitDefinition, which provides for assigning an identifier and
optional name to the combination.  The identifier can then be
referenced from elsewhere in a model.

The vast majority of modeling situations requiring new SBML unit
definitions involve simple multiplicative combinations of base
units and factors.  An example of this might be ``moles per litre
per second''.  What distinguishes these sorts of simpler unit
definitions from more complex ones is that they may be expressed
without the use of an additive offset from a zero point.  The use
of offsets complicates all unit definition system, yet in the
domain of SBML the real-life cases requiring offsets are few (and
in fact, to the best of our knowledge, only involve temperature).
Consequently, the SBML unit system has been consciously designed
in a way that attempts to simplify implementation of unit support
for the most common cases in systems biology, at the cost of
requiring units with offsets to be handled explicitly by the
modeler.


\subsubsection{The \class{UnitDefinition} structure}
\label{sec:unitdefinition-structure}

A unit definition in SBML consists of an instance of a
\UnitDefinition object, shown in Figure~\ref{fig:unitdefinition}.


\paragraph{The \token{id} and \token{name} fields}

The required field \token{id} and optional field \token{name} have
data types \primtype{UnitSId} and \primtype{string}, respectively.
The \token{id} field is used to give the defined unit a unique
identifier by which other parts of an SBML model definition can
refer to it.  The \token{name} field is intended to be used for
giving the unit definition an optional human-readable name; see
Section~\ref{sec:name} for more guidelines about the use of names.

There are two important restrictions and guidelines about the use
of unit definition \token{id} values:
\begin{enumerate}
  
\item The \token{id} of a \UnitDefinition must \emph{not} contain
  a value from Table~\ref{tab:unitkind} (\ie the enumeration of
  predefined \primtype{UnitKind} values).  This constraint simply
  prevents the redefinition of the SBML base units.

\item There is a set of predefined identifiers for the built-in
  default units in SBML; these identifiers are \val{substance},
  \val{volume}, \val{area}, \val{length}, and \val{time}.  Using
  one of these values for \token{id} in a \UnitDefinition has the
  effect of redefining the model-wide default units for the
  corresponding quantities.  We discuss this in more detail in
  Section~\ref{sec:built-in-units}.

\end{enumerate}


\paragraph{The list of \class{Unit}s}

A \UnitDefinition object must contain one or more \Unit objects
within the \token{unit} container.  In the XML form of SBML, this
container becomes a \token{listOfUnits} element.
Section~\ref{sec:unit-structure} explains the meaning and use of
\Unit.


\paragraph{Example}

The following skeleton of a unit definition illustrates an example
use of \UnitDefinition:

\begin{example}
<listOfUnitDefinitions>
    <unitDefinition id="unit1">
        <listOfUnits>
            ...
        </listOfUnits>
    </unitDefinition>
    <unitDefinition id="unit2">
        <listOfUnits>
            ...
        </listOfUnits>
    </unitDefinition>
</listOfUnitDefinitions>
\end{example}


\subsubsection{The \class{Unit} structure}
\label{sec:unit-structure}

A \Unit structure represents a (possibly transformed) reference to
a base unit chosen from \primtype{UnitKind}
(Table~\ref{tab:unitkind}).  The field \token{kind} indicates the
chosen base unit, whereas the three fields \token{exponent},
\token{scale}, and \token{multiplier} define how the base unit is
being transformed.  These various fields are described in detail
below.

Compatibility note: in \sbmltwoone, \Unit had an additional field
called \token{offset}.  This field has been removed entirely from
\sbmltwotwo.  Modelers and software authors are instead directed
to use other methods of encoding units requiring offsets.  The
reasons for this change, and some suggestions for how to achieve
equivalent effects of unit offsets, are discussed in more detail
below.


\paragraph{The \token{kind} field}

% Aliases for bibliography entries, to compensate for some labeling issues.

\defcitealias{bipm:1998}{BIPM, 1998}
\defcitealias{bipm:2000}{BIPM, 2000}

The \Unit data structure has one required field, \token{kind},
whose value must be taken from \primtype{UnitKind}, an enumeration
of base units.  The possible values of \primtype{UnitKind} are
given in Table~\vref{tab:unitkind}.

\begin{table}[bht]
  \vspace*{1ex}
  \centering
  \ttfamily
  \small
  \setlength{\arraycolsep}{8pt}
  \begin{edtable}{tabular}{llllll}
    \toprule
    ampere    & gram    & katal    & metre  & second    & watt   \\
    becquerel & gray    & kelvin   & mole   & siemens   & weber\\
    candela   & henry   & kilogram & newton & sievert\\
    coulomb   & hertz   & litre    & ohm    & steradian\\
    \underline{dimensionless} & \underline{item} & lumen & pascal & tesla\\
     farad    & joule   & lux      & radian    & volt\\
    \bottomrule
  \end{edtable}
  \caption{The possible values of \token{kind} in a \primtype{UnitKind}
    structure.  All are names of base or derived SI
    units~\protect\citep{bipm:2000}, except for
    ``\token{dimensionless}'' and ``\token{item}'', which are
    SBML additions important for handling certain common situations.
    ``\token{Dimensionless}'' is intended for cases where a
    quantity does not have units, and ``\token{item}'' for
    expressing such things as ``N items'' (e.g., ``100
    molecules'').  Also, note that the gram and litre are not
    strictly part of SI; however, they are frequently
    used in SBML's areas of application and therefore are
    included as predefined unit identifiers.  (The standard SI unit
    of mass is in fact the kilogram, and volume is defined in
    terms of cubic metres.)  Comparisons of
    values from \primtype{UnitKind} must performed in a
    case-sensitive manner.}
  \label{tab:unitkind}
\end{table}

Note that the set of acceptable values for the field \token{kind}
does \emph{not} include units defined by \UnitDefinition
structures.  This means that the units definition system
in SBML is not hierarchical: user-defined units cannot be built on
top of other user-defined units, only on top of base units.  SBML
differs from CellML~\cite{hedley:2001b} in this respect;
CellML allows the construction of hierarchical unit definitions.


\paragraph{The \token{exponent}, \token{scale} and \token{multiplier} fields}

The optional \token{exponent} field on \Unit represents an
exponent on the unit.  Its default value is \val{1} (one).  A
\Unit structure also has an optional \token{scale} field; its
value must be an integer exponent for a power-of-ten multiplier
used to set the scale of the unit.  For example, a unit having a
\token{kind} value of \val{gram} and a \token{scale} value of
\val{-3} signifies $10^{-3} * gram$, or milligrams.  The default
value of \token{scale} is \val{0} (zero), because $10^0 = 1$.
Lastly, the optional \token{multiplier} field can be used to
multiply the \token{kind} unit by a real-numbered factor; this
enables the definition of units that are not power-of-ten
multiples of SI units.  For instance, a \token{multiplier} of
0.3048 could be used to define \val{foot} as a measure of length
in terms of a metre.  The \token{multiplier} field has a default
value of \val{1} (one).

\newcommand{\ynew}{\ensuremath{y}\xspace}
\newcommand{\ybase}{\ensuremath{y_b}\xspace}
\newcommand{\unew}{\ensuremath{\{u\}}\xspace}
\newcommand{\ubase}{\ensuremath{\{u_b\}}\xspace}

The unit system allows model quantities to be expressed in units
other than the base units of Table~\ref{tab:unitkind}.  For
analyses and computations, the consumer of the model (be it a
software tool or a human) will want to convert all model
quantities to base SI units for purposes such as verifying the
consistency of units throughout the model.  Suppose we begin with
a quantity having numerical value \ynew when expressed in units
\unew.  The relationship between \ynew and a quantity \ybase
expressed in base units \ubase is
\begin{linenomath}
\begin{equation}
  \ybase \, \ubase = \ynew \, \unew \left( \frac{w \, \ubase}{\unew} \right)
\label{eq:new-to-old}
\end{equation}
\end{linenomath}
The term in the parentheses on the right-hand side is a factor $w$
for converting a quantity in units \unew to another quantity in
units \ubase.  The ratio of units leads to canceling of \unew in
the equation above and leaves a quantity in units \ubase.  It
remains to define this factor.  In terms of the SBML unit system,
it is:
\begin{linenomath}
\begin{equation}
  \unew = (\token{multiplier} \cdot 10^\token{scale} \, \ubase)^\token{exponent}
\label{eq:single-unit}
\end{equation}
\end{linenomath}
where the dot ($\cdot$) represents simple scalar multiplication.
The variables \token{multiplier}, \token{scale}, and
\token{exponent} in the equation above correspond to the fields
with the same names in the \Unit structure defined in
Figure~\ref{fig:unitdefinition}.  The exponent in the equation
above may make it more difficult to grasp the relationship
immediately; so let us suppose for the moment that
\token{exponent}=\val{1}.  Then, it is easy to see that
\begin{linenomath}
\begin{equation*}
  \unew = \token{multiplier} \cdot 10^\token{scale} \, \ubase
\end{equation*}
\end{linenomath}
Dividing both sides by \unew produces the ratio in the
parenthesized portion of Equation~\ref{eq:new-to-old}, which means
that $w = \token{multiplier} \cdot 10^\token{scale}$.
To take a concrete example, one foot expressed in terms of the
metre (a base unit) requires \token{multiplier}=\val{0.3048},
\token{exponent}=\val{1}, and \token{scale}=\val{0}:
\begin{linenomath}
\begin{align*}
  \text{foot} = 0.3048 \cdot 10^0 \cdot \text{metre}
\end{align*}
\end{linenomath}
leading to a conversion between quantities of
\begin{linenomath}
\begin{align*}
  \ybase \, \text{metres} = 0.3048 \cdot \ynew \, \text{feet}
\end{align*}
\end{linenomath}
Given a quantity of, say, $\ynew = 2$, the conversion results in
$\ybase = 0.6096$.  To relate this to SBML terms more concretely,
the following fragment of SBML illustrates how this is represented
using the \Unit and \UnitDefinition constructs:
\begin{example}
<listOfUnitDefinitions>
    <unitDefinition id="foot">
        <listOfUnits>
            <unit kind="metre" multiplier="0.3048"/>
        </listOfUnits>
    </unitDefinition>
</listOfUnitDefinitions>
\end{example}

\newcommand{\uone}{\ensuremath{\{u_{b_1}\}}\xspace}
\newcommand{\utwo}{\ensuremath{\{u_{b_2}\}}\xspace}
\newcommand{\un}  {\ensuremath{\{u_{b_n}\}}\xspace}

The case above is the simplest possible situation, involving the
transformation of quantities from a single defined unit \unew into
a quantity expressed in a single base unit \ubase.  If, instead,
multiple base units $\uone, \utwo, \ldots, \un$ are involved, the
following equation holds (where the $m_i$ terms are the
\token{multiplier} values, the $s_i$ terms are the \token{scale}
values, and the $x_i$ terms are the \token{exponent} values):
\begin{linenomath}
\begin{align}
  \{u\} &= (m_1 \cdot 10^{s_1} \uone)^{x_1} \cdot
  (m_2 \cdot 10^{s_2} \utwo)^{x_2} \cdot \ldots \cdot (m_n \cdot
  10^{s_n} \un)^{x_n} \notag
  \\[2pt]
               &= m_1^{x_1} \cdot m_2^{x_2} \cdot \ldots \cdot m_n^{x_n}
  \cdot 10^{(s_1 x_1 + s_2 x_2 + \ldots + s_n x_n)}
  \uone^{x_1} \utwo^{x_2} \ldots \un^{x_n}
\label{eq:multip-units}
\end{align}
\end{linenomath}
Software developers should take care to track the exponents
carefully because they can be negative integers.  The overall use
of Equation~\ref{eq:multip-units} is analogous to that of
Equation~\ref{eq:single-unit}, and leads to the following final
expression.  First, to simplify, let
\begin{linenomath}
\begin{align}
  m &= m_1^{x_1} \cdot m_2^{x_2} \cdot \ldots \cdot m_n^{x_n} \notag\\
  p &= s_1 x_1 + s_2 x_2 + \ldots + s_n x_n \notag\\
\intertext{then,}
  \ybase \, \uone \utwo \ldots \un
    &= \ynew \, \unew \left(
  \frac{m \cdot 10^p \uone^{x_1} \utwo^{x_2} \ldots \un^{x_n}}{\unew}
  \right)
\end{align}
\end{linenomath}

Some additional points are worth discussing about the unit scheme
introduced so far.  First, and most importantly, the equations
above are formulated with the assumption that the base units do
not require an additive offset as part of their definition.
\emph{When temperature values in units other than kelvin are being
  considered, then a different interpretation must be made}, as
discussed below.

A second point is that care is needed to avoid seemingly-obvious
but incorrect translations of units described in textbooks.  The
scheme above makes it easy to formulate statements such as ``1
foot = 0.3048 metres'' in the most natural way.  However, the most
common expression of the relationship between temperature in
Fahrenheit and kelvin, ``$T_{Fahrenheit} = 1.8 \cdot (T_{kelvin} -
273.15) + 32$'' might lead one to believe that defining Fahrenheit
degrees in terms of kelvin degrees involves using
\token{multiplier}=\val{1.8}.  \emph{Not so}, when degree changes
are being considered and not temperature values.  Converting
\emph{temperature values} is different from expressing a
relationship between degree measurements.  The proper value for
the multiplier in the latter case is $5/9$, \ie
\token{multiplier}=\val{0.555556} (where we picked an arbitrary
decimal precision).  If, on the other hand, the actual temperature
is relevant to a quantity (\eg if a model uses a quantity that has
particular values at particular temperatures), then offsets are
required in the unit calculations and a formula must be used as
discussed above.


\paragraph{Handling units requiring the use of offsets in \sbmltwotwo}

Unit definitions and conversions requiring offsets cannot be done
using the simple approach above.  The most general case, involving
offsets, multipliers and exponents, requires a completely
different approach to defining units than what has been presented
up to this point.

In previous versions of SBML, not only was the general case
incorrectly presented (\ie in the same terms described above, when
in reality a different approach is required), but few if any
developers even attempted to support offset-based units in their
software.  In the development of \sbmltwotwo, a consensus among
SBML developers has emerged that a fully generalized unit scheme
is so confusing and complicated that it actually impedes
interoperability.  \twotwo acknowledges this reality by reducing
and simplifying the unit system, specifically by removing the
\token{offset} field on \Unit and Celsius as a pre-defined unit,
and by describing approaches for handling Celsius and other
temperature units.  This is a backwards-incompatible change
relative to \sbmltwoone and \sbmlonetwo, but it is believed to
have limited real-life impact because so few tools and models
appeared to have employed this feature anyway.  By simplifying the
unit system to the point that it only involves multiplicative
factors as described above, we expect that more software tools
will be able to support the SBML unit system from this point
forward, ultimately improving interoperability.

We first address the question of how to handle units that
\emph{do} require offsets:
\begin{itemize}

\item \emph{Handling Celsius}.  A model in which certain
  quantities are temperatures measured in degrees Celsius can be
  converted straightforwardly to a model in which those
  temperatures are in kelvin.  A software tool could do this by
  performing a straightforward substitution using the following
  relationship:
  \begin{linenomath}
    \begin{equation}
      T_\emph{kelvin} = T_\emph{Celsius} + 273.15
      \label{eq:celsius-kelvin}
    \end{equation}
  \end{linenomath}
  In every mathematical formula of the model where a quantity
  (call it $x$) in degrees Celsius appears, replace $x$ with $x_k
  + 273.15$ where $x_k$ is now in kelvin.  An alternative approach
  would be to use a \FunctionDefinition to define a function
  encapsulating this relationship above and then using that in the
  rest of the model as needed.  Since Celsius is a commonly-used
  unit, software tools could help users by providing users with
  the ability to express temperatures in Celsius in the tools'
  interfaces, and making substitutions automatically when writing
  out the SBML.

\item \emph{Handling other units requiring offsets}.  The only
  other units requiring offsets in SBML's domain of common
  applications are other temperature units such as Fahrenheit.
  Few modern scientists employ Fahrenheit degrees; therefore, this
  is an unusual situation.  The complication inherent in
  converting between degrees Fahrenheit and kelvin is that both a
  multiplier and an offset are required:
  \begin{linenomath}
    \begin{equation}
      T_\emph{kelvin} = \frac{T_\emph{F} + 459.67}{1.8}
      \label{eq:fah-kelvin}
    \end{equation}
  \end{linenomath}

  One approach to handling this is to use a \FunctionDefinition to
  define a function encapsulating the relationship above, then to
  substitute a call to this function wherever the original
  temperature in Fahrenheit appears in the model's mathematical
  formulas.  Here is a candidate definition as an example:
  \begin{example}
<functionDefinition id="Fahrenheit_to_kelvin">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
        <lambda>
            <bvar><ci> temp_in_fahrenheit </ci></bvar>
            <apply>
                <divide/>
                <apply>
                    <plus/>
                    <ci> temp_in_fahrenheit </ci>
                    <cn> 459.67 </cn>
                </apply>
                <cn> 1.8 </cn>
            </apply>
        </lambda>
    </math>
</functionDefinition>
  \end{example}
  
  An alternative approach not requiring the use of function
  definitions is to use an \AssignmentRule for each variable in
  Fahrenheit units.  The \AssignmentRule could compute the
  conversion from Fahrenheit to (say) kelvin, assign its value to
  a variable (in Kelvin units), and then that variable could be
  used elsewhere in the model.  Still another approach is to
  rewrite the mathematical formulas of a model to directly
  incorporate the conversion Equation~\ref{eq:fah-kelvin} wherever
  the quantity appears.

  All of these approaches provide general solutions to the problem
  of supporting any units requiring offsets in the unit system of
  \sbmltwotwo.  It can be used for other temperature units
  requiring an offset (\eg degrees Rankine, degrees R\'{e}aumur),
  although the likelihood of a real-life model requiring such
  other temperature units seems exceedingly small.

\end{itemize}

In summary, the removal of \token{offset} in \sbmltwotwo does not
impede the creation of models using alternative units.  If
conversions are needed, then converting between temperature in
degrees Celsius and thermodynamic temperature can be handled
rather easily by the simple substitution described above.  For the
rarer case of Fahrenheit and other units requiring combinations of
multipliers and offsets, users are encouraged to employ the power
of \FunctionDefinition, \AssignmentRule, or other constructs in
SBML.


\paragraph{Examples}

The following example illustrates the definition of an
abbreviation \val{mmls} for the units $mmol\ l^{-1}\ s^{-1}$:

\begin{example}
<listOfUnitDefinitions>
    <unitDefinition id="mmls">
        <listOfUnits>
            <unit kind="mole"   scale="-3"/>
            <unit kind="litre"  exponent="-1"/>
            <unit kind="second" exponent="-1"/>
        </listOfUnits>
    </unitDefinition>
</listOfUnitDefinitions>
\end{example}


\subsubsection{Built-in units}
\label{sec:built-in-units}

There are five special unit identifiers in SBML, listed in
Table~\vref{tab:builtin}, corresponding to the five types of
quantities that can play roles in SBML reactions: substance,
volume, area, length and time.  All SBML mathematical entities
apart from parameters have default units drawn from these
predefined values.  Table~\ref{tab:builtin} lists the default
values; all of the defaults have \token{multiplier}=\val{1} and
\token{scale}=\val{0}.

\begin{table}[htb]
  \centering
  \small
  \setlength{\tabcolsep}{8pt}
  \begin{edtable}{tabular}{lll>{\ttfamily}l}
    \toprule
    \textbf{Identifier} & \textbf{Possible Scalable Units} & \textbf{Default Units}\\
    \midrule
    \token{substance} & mole, item, gram, kilogram, dimensionless  & mole\\
    \token{volume} & litre, cubic metre, dimensionless & litre\\
    \token{area}   & square metre, dimensionless & square metre\\
    \token{length} & metre, dimensionless & metre\\
    \token{time}   & second, dimensionless & second\\
    \bottomrule
  \end{edtable}
  \caption{SBML's built-in units.}
  \label{tab:builtin}
\end{table}


\paragraph{Redefinition of built-in units}

Table~\ref{tab:builtin} also lists alternative base units that are
allowed as the basis of redefined values.  For example, a
redefinition of the built-in unit of time must be based on units
of seconds.  Within certain limits, a model may change the
built-in units by reassigning the keywords \token{substance},
\token{length}, \token{area}, \token{time}, and \token{volume} in
a \UnitDefinition.  The limitations on redefinitions of base units
are the following:
\begin{enumerate}

\item The \UnitDefinition of a redefined built-in unit can only
  contain a single \Unit object within it.

\item The value of the \token{unitKind} field in the \Unit object
  must be drawn from one of the values in the second column of the
  appropriate row of Table~\ref{tab:builtin}.

% you can't represent volume in cubic metres if you do this!
%\item The value of the \token{exponent} field in the \Unit object
%  must be \val{1}.

\end{enumerate}

\paragraph{Examples}

The following example illustrates how to change the built-in units
of volume to be millilitres.  If this definition appeared in a
model, the units of volume on all components that did not
explicitly specify different units would be changed to
millilitres.
\begin{example}
<model>
    ...
    <listOfUnitDefinitions>
        <unitDefinition id="volume">
            <listOfUnits>
                <unit kind="litre" scale="-3"/>
            </listOfUnits>
        </unitDefinition>
    </listOfUnitDefinitions>
    ...
</model>
\end{example}


\subsubsection{References to units}

A field that defines the units of a mathematical entity (\eg the
field \token{units} on \Parameter) can refer to a defined unit
whose identifier is chosen from among the following:
\begin{itemize}
  
\item A new unit identifier defined by a \UnitDefinition as
  described at the start of Section~\ref{sec:unitdefinitions};

\item The predefined units from Table~\vref{tab:unitkind}; and
  
\item The predefined units defined in
  Section~\ref{sec:built-in-units} and listed in
  Table~\ref{tab:builtin}.  (These are \val{substance},
  \val{volume}, \val{area}, \val{length}, and \val{time}.)

\end{itemize}

Software developers are asked to pay special attention to the
units used in an SBML model.  Different users and developers
sometimes are accustomed to making different assumptions about
units, and these assumptions may not correspond to what is
actually defined in SBML.  The numerical values in a model become
meaningless if the corresponding units are not those being
assumed.  Sections~\ref{sec:ci-token}, \ref{sec:species-units} and
\ref{subsec:kinetic-law} have particularly important notes about
the usage of units in SBML.


%-----------------------------------------------------------------------------
\subsection{Compartment types}
\label{sec:compartmentType}
%-----------------------------------------------------------------------------

A \emph{compartment type} in SBML is a grouping construct used to
establish a relationship between multiple \emph{compartments}
(Section~\ref{sec:compartments}).  A compartment type is
represented by the \CompartmentType data structure, defined in
Figure~\vref{fig:compartmentType}.

\begin{figure}[htb]
  \centering
  \begin{classbox}{CompartmentType}
    id: SId                           \\
    name: string \{ use="optional" \} \\
  \end{classbox}
  \caption{The definition of \CompartmentType.  Following UML notation,
    additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:compartmentType}
\end{figure}

In \sbmltwotwo, a compartment type only has an identity, and this
identity can only be used to indicate that particular compartments
belong to this type.  This may be useful for conveying a modeling
intention, such as when a model contains many similar
compartments, either by their biological function or the reactions
they carry; without a compartment type construct, it would be
impossible in the language of SBML to indicate that all of the
compartments share an underlying conceptual relationship because
each SBML compartment must be given a unique and separate
identity.

Compartment types have no mathematical meaning in
\sbmltwotwo---they have no effect on a model's mathematical
interpretation.  Simulators and other numerical analysis software
may ignore \CompartmentType structures and references to them in a
model.

There is no mechanism in SBML for representing hierarchies of
compartment types.  One \CompartmentType structure cannot be the
subtype of another \CompartmentType structure; SBML provides no
means of defining such relationships.


\subsubsection{The \token{id} and \token{name} fields}

As with other major structures in SBML, \CompartmentType has a
mandatory field, \token{id}, used to give the compartment type an
identifier.  The identifier must be a text string conforming to
the syntax permitted by the \primtype{SId} data type described in
Section~\ref{sec:sid}.  \CompartmentType also has an optional
\token{name} field, of type \primtype{string}.  The \token{name}
and \token{id} fields must be used as described in
Section~\ref{sec:idnameattribs}.


\subsubsection{Examples}

The following partial SBML example illustrates a compartment type
used to relate together many individual compartments in a
hypothetical model.

\begin{example}
<model>
    ...
    <listOfCompartmentTypes>
        <compartmentType id="mitochondria"/>
    </listOfCompartmentTypes>
    <listOfCompartments>
        <compartment id="m1" size="0.013" compartmentType="mitochondria" outside="cell"/>
        <compartment id="m2" size="0.013" compartmentType="mitochondria" outside="cell"/>
        <compartment id="m3" size="0.013" compartmentType="mitochondria" outside="cell"/>
        <compartment id="m4" size="0.013" compartmentType="mitochondria" outside="cell"/>
        <compartment id="cell" size="190.0"/>
    </listOfCompartments>
    ...
</model>
\end{example}



%-----------------------------------------------------------------------------
\subsection{Species types}
\label{sec:speciesType}
%-----------------------------------------------------------------------------

The term \emph{species type} refers to reacting entities
independent of location.  These include simple ions (e.g.,
protons, calcium), simple molecules (e.g., glucose, ATP), large
molecules (e.g., RNA, polysaccharides, and proteins), and others.
The \SpeciesType data structure is intended to represent these
entities.  Its definition is shown in
Figure~\vref{fig:speciesType}.

\begin{figure}[htb]
  \centering
  \begin{classbox}{SpeciesType}
    id: SId                           \\
    name: string \{ use="optional" \} \\
  \end{classbox}
\caption{The definition of \SpeciesType.  Following UML notation,
    additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:speciesType}
\end{figure}

\SpeciesType structures are included in SBML to enable \Species
(Section~\ref{sec:species}) of the same type to be related
together.  It is a conceptual construct; the existence of
\SpeciesType structures in a model has no effect on the model's
numerical interpretation.  Except for the requirement for
uniqueness of species/species type combinations located in
compartments (described in
Section~\ref{sec:species-species-type}), simulators and other
numerical analysis software may ignore \SpeciesType structures and
references to them in a model.

There is no mechanism in SBML for representing hierarchies of
species types.  One \SpeciesType structure cannot be the subtype
of another \SpeciesType structure; SBML provides no means of
defining such relationships.

%An example of a model that is encoded using \SpeciesType
%structures is shown in Section~\ref{sec:speciesType-eg}.

\subsubsection{The \token{id} and \token{name} fields}

As with other major structures in SBML, \SpeciesType has a
mandatory field, \token{id}, used to give the species type an
identifier.  The identifier must be a text string conforming to
the syntax permitted by the \primtype{SId} data type described in
Section~\ref{sec:sid}.  \SpeciesType also has an optional
\token{name} field, of type \primtype{string}.  The \token{name}
and \token{id} fields must be used as described in
Section~\ref{sec:idnameattribs}.

\subsubsection{Example}

The following XML fragment is an example of two
\SpeciesType structures embedded in an SBML model.

\begin{example}
<listOfSpeciesTypes>
    <speciesType id="Glucose"/>
    <speciesType id="Glucose_6_P"/>
</listOfSpeciesTypes>
\end{example}


%-----------------------------------------------------------------------------
\subsection{Compartments}
\label{sec:compartments}
%-----------------------------------------------------------------------------

A \emph{compartment} in SBML represents a bounded space in which
species are located.  Compartments do not necessarily have to
correspond to actual structures inside or outside of a biological
cell, although models are often designed that way.  The definition
of \Compartment is shown in Figure~\vref{fig:compartment}.

\begin{figure}[htb]
  \vspace*{1ex}
  \centering
  \begin{classbox}{Compartment}
    id: SId                                                                                       \\
    name: string \{ use="optional" \}                                                             \\
    compartmentType: SId \{ use="optional" \}                                           \\
    spatialDimensions: int \{ maxInclusive="3" minInclusive="0" use="optional" default="3" \} \\
    size: double \{ use="optional" \}                                                             \\
    units: UnitSId \{ use="optional" \}                                                               \\
    outside: SId \{ use="optional" \}                                                             \\
    constant: boolean \{ use="optional" default="true" \}                                         \\
  \end{classbox}
  \caption{The definition of \Compartment.  Following UML notation,
    additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:compartment}
\end{figure}

It is important to note that although compartments are optional in
the overall definition of \Model (see Section~\ref{sec:model}),
every species in an SBML model must be located in a compartment.
This in turn means that if a model defines any species, the model
must also define at least one compartment.  The reason is simply
that species represent physical things, and therefore must exist
\emph{somewhere}.  Compartments represent the \emph{somewhere}.


\subsubsection{The \token{id} and \token{name} fields}

\Compartment has one required field, \token{id}, of type
\primtype{SId}, to give the compartment a unique identifier by
which other parts of an SBML model definition can refer to it.  A
compartment can also have an optional \token{name} field of type
\primtype{string}.  Identifiers and names must be used according
to the guidelines described in Section~\ref{sec:idnameattribs}.


\subsubsection{The \token{compartmentType} field}
\label{sec:compartment-compartment-type}

Each compartment in a model may optionally be designated as
belonging to a particular compartment type.  The optional field
\token{compartmentType} of type \primtype{SId} is used identify
the compartment type represented by the \Compartment structure.
The \token{compartmentType} field's value must be the identifier
of a \CompartmentType instance defined in the model.  If the
\token{compartmentType} field is not present on a particular
compartment definition, a unique virtual compartment type is
assumed for that compartment, and no other compartment can belong
to that compartment type.

The values of \token{compartmentType} attributes on compartments
have no effect on the numerical interpretation of a model.
Simulators and other numerical analysis software may ignore
\token{compartmentType} attributes.


\subsubsection{The \token{spatialDimensions} field}

A \Compartment structure has an optional field
\token{spatialDimensions}, whose value must be a positive integer
indicating the number of spatial dimensions possessed by the
compartment.  The maximum value is \val{3}, meaning a
three-dimensional structure (a volume).  Other permissible values
are \val{2} (for a two-dimensional area), \val{1} (for a
one-dimensional curve), and \val{0} (for a point).  The default
value is \val{3}. Note that the number of spatial dimensions
possessed by a compartment affects certain aspects of the
compartment's size and units-of-size; see the following two
subsections.


\subsubsection{The \token{size} field}
\label{sec:size}

Each compartment has an optional floating-point field named
\token{size}, representing the initial total size of the
compartment.  The size may be a volume (if the compartment is a
three-dimensional one), or it may be an area (if the compartment
is two-dimensional), or a length (if the compartment is
one-dimensional).

It is important to note that in SBML Level~2, a missing
\token{size} value \emph{does not imply that the compartment size
  is 1}.  There is no default value of compartment size.  (This is
unlike the definition of compartment \token{volume} in SBML
Level~1.)  When the \token{spatialDimensions} field does not have
a value of \val{0}, a missing value for \token{size} for a given
compartment signifies that the value either is unknown, or to be
obtained from an external source, or determined by an initial
assignment (Section~\ref{sec:initialAssignment}) or a rule
(Section~\ref{sec:rules}) elsewhere in the model.  The
\token{size} field must not be present if the
\token{spatialDimensions} field has a value of \val{0}; otherwise,
a logical inconsistency would exist because a zero-dimensional
object cannot have a physical size.

A compartment's size is set by its \token{size} field exactly
once.  If the compartment's \token{constant} field has the value
\val{true} (the default), then the size is fixed and cannot be
changed except by an \InitialAssignment in the model (and in the
case where \token{spatialDimensions}=\val{0}, it cannot be changed
by any \InitialAssignment either).  These two methods of setting
the compartment size differ in that the \token{size} field can
only be used to set the compartment size to a literal scalar
value, whereas \InitialAssignment allows the value to be set using
an arbitrary mathematical expression.  If the compartment's
\token{constant} field has the value \val{false}, the
compartment's size value may be overridden by an
\InitialAssignment or changed by an \AssignmentRule or
\AlgebraicRule, and in addition, for simulation time $t > 0$, it
may also be changed by a \RateRule or \Event{}s.  (However, some
of these constructs are mutually exclusive; see
Sections~\ref{sec:rules} and~\ref{sec:events}.)  It is not an
error to define \token{size} on a compartment and also redefine
the value using an \InitialAssignment, but the \token{size} value
in that case is ignored.  Section~\ref{sec:before-t0} provides
additional information about the semantics of assignments, rules
and values for simulation time $t \leq 0$.

For the reasons given above, the \token{size} field on a
compartment must be defined as optional; however, \emph{it is
  extremely good practice to specify values for compartment sizes}
when such values are available.  There are two major technical
reasons for this.  First, models ideally should be instantiable in
a variety of simulation frameworks.  A commonly-used one is the
discrete stochastic
framework~\citep{gillespie:1977,wilkinson_2006} in which species
are represented as item counts (\eg molecule counts).  If species'
initial quantities are given in terms of concentrations or
densities, it is impossible to convert the values to item counts
without knowing compartment sizes.  Second, and more importantly,
if a model contains multiple compartments whose sizes are not all
identical to each other, it is impossible to quantify the reaction
rate expressions without knowing the compartment volumes.  The
reason for the latter is that reaction rates in SBML are defined
in terms of \quantity{substance}/\quantity{time} (see
Section~\ref{subsec:kinetic-law}), and when species quantities are
given in terms of concentrations or densities, the compartment
sizes become factors in the reaction rate expressions.


\subsubsection{The \token{units} field}
\label{sec:compartment-units}

The units associated with the compartment's \token{size} value may
be set using the optional field \token{units}.  The default units,
and the kinds of units allowed as values of the field
\token{units}, interact with the number of spatial dimensions of
the compartment.  The value of the \token{units} field of a
\Compartment object must be one of the base units from
Table~\vref{tab:unitkind}, or the built-in units \val{volume},
\val{area}, \val{length} or \val{dimensionless}, or a new unit
defined by a unit definition in the enclosing model, subject to
the restrictions detailed in Table~\ref{tab:comp-size-units}.

\begin{table}[h]
  \small
  \centering
  \begin{edtable}{tabular}{cllll}
    \toprule
    \textbf{Value of field}    & \textbf{Field} \texttt{size} & \textbf{Field} \texttt{units} &  & \textbf{Default value}\\
    \texttt{spatialDimensions} & \textbf{allowed?}            & \textbf{allowed?}             & \textbf{Allowable kinds of units} & \textbf{of field} \texttt{units}\\
    \midrule
    \val{3}             & yes   & yes   & units of volume, or \token{dimensionless}     & \val{volume}\\
    \val{2}             & yes   & yes   & units of area, or \token{dimensionless}       & \val{area}\\
    \val{1}             & yes   & yes   & units of length, or \token{dimensionless}     & \val{length}\\
    \val{0}             & no    & no    & (no units allowed)\\
    \bottomrule
  \end{edtable}
  \caption{The types of units permitted for the units of
    compartment size. If the value of \token{spatialDimensions} is
    \val{0}, the \token{units} field must not be present
    because a compartment with no dimensions has no size and
    units cannot be meaningfully associated with the
    (non-existent) size.  \emph{Units of volume} means litres,
    cubic metres, or units derived from them; \emph{units of area}
    means square metres or units derived from square metres; and
    \emph{units of length} means metres or units derived from
    metres. (See also Table~\protect\vref{tab:builtin} and
    Table~\protect\vref{tab:unitkind}.)}
  \label{tab:comp-size-units}
\end{table}

The units of the compartment size, as defined by the \token{units}
field, are used in the following ways when the compartment has a
\token{spatialDimensions} value greater than \val{0}:
\begin{itemize}

\item The value of the \token{units} field is used as the units of
  the \token{size} field of the compartment structure (see
  Section~\ref{sec:size}).

\item The value of the \token{units} field is used as the units of
  the compartment identifier when it appears as a numerical
  quantity in a mathematical formula expressed in MathML
  (discussed in Section~\ref{sec:ci-token}).

\item The value of the \token{units} field is used as the units of
  the \token{math} field provided on \AssignmentRule and
    \InitialAssignment structures for setting a compartment's
    size (see Section~\ref{sec:assignmentrule}).

\item In a \RateRule structure that sets the rate of change of the
  compartment's size (Section~\ref{sec:raterule}), the units on
  the rule's \token{math} field are those in the compartment's
  \token{units} field divided by the default \quantity{time}
  units.  (In other words, the units for the rate of change of
  compartment size are \quantity{compartment size}/\quantity{time}
  units.)

\end{itemize}

Compartments with \token{spatialDimensions}=\val{0} require
special treatment in this framework.  If a compartment has no size
or dimensional units, how should such a compartment's identifier
be interpreted when it appears in mathematical formulas?  The
answer is that such a compartment's identifier should not appear
in mathematical formulas in the first place---it has no value, and
its value cannot change (Section~\ref{sec:compartment-constant}).
Note also that a zero-dimensional compartment is a point, and
species located at points can only be described in terms of
amounts, not spatially-dependent measures such as concentration.
Since SBML \KineticLaw formulas are already in terms of
\quantity{substance}/\quantity{time} and not (say)
\quantity{concentration}/\quantity{time}, volume or other factors
in principle are not needed for species located in
zero-dimensional compartments.


\subsubsection{The \token{constant} field}
\label{sec:compartment-constant}

A \Compartment also has an optional boolean field called
\token{constant} that indicates whether the compartment's size
stays constant or can vary during a simulation.  A value of
\val{false} indicates the compartment's \token{size} can be
changed by other constructs in SBML.  A value of \token{true}
indicates the compartment's \token{size} cannot be changed by any
other construct except \InitialAssignment.  In the special case of
\token{spatialDimensions}=\val{0}, the value cannot be changed by
\InitialAssignment either.  The default value for the
\token{constant} field is \val{true} because in the most common
modeling scenarios at the time of this writing, compartment sizes
remain constant.  The \token{constant} field must default to or be
set to \val{true} if the value of the \token{spatialDimensions}
field is \val{0}, because a zero-dimensional compartment cannot
ever have a size.


\subsubsection{The \token{outside} field}
\label{sec:compartment-outside}

The optional field \token{outside} of type \primtype{SId} can be
used to express containment relationships between compartments. If
present, the value of \token{outside} for a given compartment must
be the \token{id} field value of another compartment already
defined in the model.  Doing so means that the other compartment
contains it or is is ``outside'' of it.  This enables the
representation of simple topological relationships between
compartments, for those simulation systems that can make use of
the information (e.g., for drawing simple diagrams of
compartments).

There are two restrictions on the containment relationships
permitted in an SBML model.  First, because a compartment with
\token{spatialDimensions} of \val{0} has no size, such a
compartment cannot act as the container of any other compartment
\emph{except} compartments that \emph{also} have
\token{spatialDimensions} values of \val{0}.  Second, the directed
graph formed by representing \Compartment structures as vertexes
and the \token{outside} attribute values as edges must be acyclic.
The latter condition is imposed to prevent a compartment from
being contained inside itself.

Although containment relationships are partly taken into account
by the compartmental localization of reactants and products, it is
not always possible to determine purely from the reaction
equations whether one compartment is meant to be located within
another.  In the absence of a value for \token{outside},
compartment definitions in SBML Level~2 do not have any implied
spatial relationships between each other.  For many modeling
applications, the transfer of substances described by the
reactions in a model sufficiently express the relationships
between the compartments.  (As discussed in
Section~\ref{sec:level-3}, SBML Level~3 is expected introduce the
ability to define geometries and spatial qualities.)


\subsubsection{Examples}

The following example illustrates two compartments in an
abbreviated SBML example of a model definition:

\begin{example}
<model>
    ...
    <listOfCompartments>
        <compartment id="cytosol" size="2.5"/>
        <compartment id="mitochondria" size="0.3"/>
    </listOfCompartments>
    ...
</model>

\end{example}

The following is an example of using \token{outside} to model a
cell membrane.  To express that a compartment with identifier
\val{B} has a membrane that is modeled as another compartment
\val{M}, which in turn is located within another compartment
\val{A}, one would write:

\begin{example}
<model>
    ...
    <listOfCompartments>
        <compartment id="A"/>
        <compartment id="M" spatialDimensions="2" outside="A"/>
        <compartment id="B" outside="M"/>
    </listOfCompartments>
    ...
</model>

\end{example}


%-----------------------------------------------------------------------------
\subsection{Species}
\label{sec:species}
%-----------------------------------------------------------------------------

A \emph{species} refers to a pool of reacting entities
of a specific \emph{species type} that take part in
reactions and are located in a specific \emph{compartment}.
The \Species data
structure is intended to represent these pools.   Its definition
is shown in Figure~\vref{fig:species}.

\begin{figure}[htb]
  \centering
  \begin{classbox}{Species}
    id: SId                                                             \\
    name: string \{ use="optional" \}                                   \\
    speciesType: SId \{ use="optional" \}                 \\
    compartment: SId                                                    \\
    initialAmount: double \{ use="optional" \}                          \\
    initialConcentration: double \{ use="optional" \}                  \\
    substanceUnits: UnitSId \{ use="optional" \}          \\
    spatialSizeUnits: UnitSId \{ use="optional" \}        \\
    hasOnlySubstanceUnits: boolean \{ use="optional" default="false" \} \\
    boundaryCondition: boolean \{ use="optional" default="false" \}     \\
    charge: int \{ use="optional" \} \emph{deprecated}    \\
    constant: boolean \{ use="optional" default="false" \}              \\
  \end{classbox}
  \caption{The definition of \Species.  Following UML notation,
    additional fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:species}
\end{figure}

Although the exact definition of \Species given here has
changed from the definition in the specification of SBML Level~2
Version~1 (\ie through the introduction of \SpeciesType), the
concept represented by \Species remains the same.



\subsubsection{The \token{id} and \token{name} fields}

As with other major structures in SBML, \Species has a mandatory
field, \token{id}, used to give the species an identifier.  The
identifier must be a text string conforming to the syntax
permitted by the \primtype{SId} data type described in
Section~\ref{sec:sid}.  \Species also has an optional \token{name}
field, of type \primtype{string}.  The \token{name} and \token{id}
fields must be used as described in
Section~\ref{sec:idnameattribs}.



\subsubsection{The \token{speciesType} field}
\label{sec:species-species-type}

Each species in a model may optionally be designated as belonging
to a particular species type.  The optional field
\token{speciesType} of type \primtype{SId} is used to identify the
species type of the chemical entities that make up the pool
represented by the \Species structure. The field's value must be
the identifier of an existing \SpeciesType structure.  If the
\token{speciesType} field is not present on a particular species
definition, it means the pool contains chemical entities of a type
unique to that pool; in effect, a virtual species type is assumed
for that species, and no other species can belong to that species
type.

There can be only one species of a given species type in any given
compartment of a model.  More specifically, for all \Species
structures having a value for the \token{speciesType} field, the
pair
\begin{center}
(\token{speciesType} field value, \token{compartment} field value)
\end{center}
must be unique across the set of all \Species structures
in a model.

The value of \token{speciesType} attributes on species have no
effect on the numerical interpretation of a model. Simulators and
other numerical analysis software may ignore \token{speciesType}
attributes.




\subsubsection{The \token{compartment} field}
\label{sec:species-compartment}

The required field \token{compartment}, also of type
\primtype{SId}, is used to identify the compartment in which the
species is located.  The field's value must be the identifier of
an existing \Compartment structure.  It is important to note that
there is no default value for the \token{compartment} field on
\Species; every species in an SBML model must be assigned a
compartment, and consequently, a model must define at least one
compartment if that model contains any species.


\subsubsection{The \token{initialAmount} and
  \token{initialConcentration} fields}
\label{sec:initialAmount}

The optional fields \token{initialAmount} and
\token{initialConcentration}, both having a data type of
\primtype{double}, are used to set the initial quantity of the
species in the compartment where the species is located.  These
fields are mutually exclusive; \ie \emph{only one} can have a
value on any given instance of a \Species structure.


Missing \token{initialAmount} and \token{initialConcentration}
values implies that their values either are unknown, or to be
obtained from an external source, or determined by an initial
assignment (Section~\ref{sec:initialAssignment}) or rule
(Section~\ref{sec:rules}) elsewhere in the model.  In the case
where a species' compartment has a \token{spatialDimensions} value
of \val{0}, the species cannot have a value for
\token{initialConcentration} because the concepts of
``concentration'' and ``density'' break down when a container has
zero dimensions.

A species' initial quantity is set by the \token{initialAmount} or
\token{initialConcentration} fields exactly once.  If the species'
\token{constant} field has the value \val{true} (the default),
then the size is fixed and cannot be changed except by an
\InitialAssignment.  These two methods of setting the species
quantity differ in that the \token{initialAmount} and
\token{initialConcentration} fields can only be used to set the
species quantity to a literal scalar value, whereas
\InitialAssignment allows the value to be set using an arbitrary
mathematical expression.  If the species' \token{constant} field
has the value \val{false}, the species' quantity value may be
overridden by an \InitialAssignment or changed by \AssignmentRule
or \AlgebraicRule, and in addition, for $t > 0$, it may also be
changed by a \RateRule or \Event{}s. (However, some of these
constructs are mutually exclusive; see Sections~\ref{sec:rules}
and~\ref{sec:events}.) It is not an error to define
\token{initialAmount} or \token{initialConcentration} on a species
and also redefine the value using an \InitialAssignment, but the
\token{initialAmount} or \token{initialConcentration} setting in
that case is ignored.  Section~\ref{sec:before-t0} provides
additional information about the semantics of assignments, rules
and values for simulation time $t \leq 0$.


The units of the value in the \token{initialAmount} field are set
by the \token{substanceUnits} field of the species structure.  The
units of the value in the \token{initialConcentration} field are
\quantity{substance}/\quantity{size} units.  The units of
\quantity{substance} are those defined in the
\token{substanceUnits}, and the \quantity{size} units are those
given in the \token{spatialSizeUnits} field as described in
Section~\ref{sec:species-units} below.


\subsubsection{The \token{substanceUnits}, \token{spatialSizeUnits} and
    \token{hasOnlySubstanceUnits} fields}
\label{sec:species-units}

The units associated with a species' quantity, referred to as the
\emph{units of the species}, are determined via the optional
fields \token{substanceUnits}, \token{spatialSizeUnits} and
\token{hasOnlySubstanceUnits}.

The field \token{hasOnlySubstanceUnits} takes on boolean values
and defaults to \val{false}.  This field's role is to indicate
whether the units of the species, when the species identifier
appears in mathematical formulas, are intended to be concentration
or amount.  Although it may seem as though this intention could be
determined based on whether \token{initialConcentration} or
\token{initialAmount} is set, the fact that these two fields are
optional means that a separate flag is needed.  (Consider the
situation where neither is set, and instead the species' quantity
is established by an \InitialAssignment or \AssignmentRule.)

The possible values of \emph{units of the species} are summarized
in Table~\ref{tab:speciesunits}.  The \emph{units of the species}
are of the form \quantity{substance}/\quantity{size} units (\ie
\quantity{concentration} units, using a broad definition of
concentration) if the compartment's \token{spatialDimensions} is
non-zero and \token{hasOnlySubstanceUnits} has the value
\val{false}.  The \emph{units of the species} are of the form
\quantity{substance} if \token{hasOnlySubstanceUnits} has the
value \val{true} \emph{or} \token{spatialDimensions} is zero.
(This dependence is due to the fact that a zero-dimensional
compartment cannot support concentrations or densities.)  The
units of \quantity{substance} are those defined by the
\token{substanceUnits} field, and the \quantity{size} units are
those defined by the \token{spatialSizeUnits} field of a \Species
instance.

\begin{table}[htb]
  \vspace*{2ex}
  \centering
  \small
  \begin{edtable}{tabular}{lll}
    \toprule
    \textbf{value of} &
    \textbf{\emph{units of the species} when} &
    \textbf{\emph{units of the species} when}\\
    \textbf{\token{hasOnlySubstanceUnits}}&
    \textbf{\token{spatialDimensions} is greater than 0} &
    \textbf{\token{spatialDimensions} is 0}\\
    \midrule
    \texttt{false} (default) & $substance/size$ & $substance$ \\
    \texttt{true} & $substance$ & $substance$ \\
    \bottomrule
  \end{edtable}
  \vspace*{1ex}
  \caption{How to interpret the value the \token{hasOnlySubstanceUnits}
  field of the \Species structure.}
  \label{tab:speciesunits}
\end{table}

For both \token{substanceUnits} and \token{spatialSizeUnits}, the
value chosen must be either a base unit from
Table~\vref{tab:unitkind}, a built-in unit from
Table~\vref{tab:builtin}, or a new unit defined by a unit
definition in the enclosing model. The chosen units for
\token{substanceUnits} must be be \token{dimensionless},
\token{mole}, \token{item}, \token{kilogram}, \token{gram}, or
units derived from these. The \token{substanceUnits} field
defaults to the the built-in unit ``\token{substance}'' shown in
Table~\vref{tab:builtin}.

The type of units assigned to the \token{spatialSizeUnits} field
must agree with the number of spatial dimensions of the species'
compartment.  Specifically, they must be units of volume or
``\token{dimensionless}'' if the value of the compartment's
\token{spatialDimensions} is ``\token{3}''; they must be units of
area or ``\token{dimensionless}'' if the value of
\token{spatialDimensions} is ``\token{2}''; and they must be units
of length or ``\token{dimensionless}'' if the value of
\token{spatialDimensions} is ``\token{1}''. The
\token{spatialSizeUnits} field must not have a value if
\token{spatialDimensions} on the compartment has a value of
``\token{0}'', or if the species' \token{hasOnlySubstanceUnits}
field has a value of \val{true}. The default value of the
\token{spatialSizeUnits} is the value of the \token{units} field
of the species' compartment.


The \emph{units of the species} are used in the following ways:
\begin{itemize}

\item The species identifier has these units when it appears as a
  numerical quantity in a mathematical formula expressed in MathML
  (discussed in Section~\ref{sec:ci-token}).

\item The \token{math} field of \AssignmentRule and
  \InitialAssignment structures determining the species' quantity
  (see Section~\ref{sec:assignmentrule}) has these units.

\item In \RateRule structures that set the rate of change of the
  species' quantity (Section~\ref{sec:raterule}), the units on the
  rule's \token{math} field are the \emph{units of the species}
  divided by the built-in \quantity{time} units.

\end{itemize}


\subsubsection{The \token{constant} and \token{boundaryCondition} fields}
\label{sec:species-constant}

The \Species structure has two optional boolean fields named
\token{constant} and \token{boundaryCondition}, used to indicate
whether and how the quantity of that species can vary during a
simulation.  Table~\ref{tab:specieattrib} shows how to interpret
the combined values of the \token{boundaryCondition} and
\token{constant} fields.

\begin{table}[ht]
  \centering
  \small
  \begin{edtable}{tabular}{lllll}
    \toprule
                              &                                    & \textbf{can have}     & \textbf{can be} \\
    \textbf{\token{constant}} & \textbf{\token{boundaryCondition}} & \textbf{assignment}   & \textbf{reactant or} & \textbf{species' quantity} \\
    \textbf{value}            & \textbf{value}                     & \textbf{or rate rule} & \textbf{product}   & \textbf{can be changed by} \\
    \midrule
    true & true & no & yes & (never changes)\\
    false & true & yes & yes & rules and events \\
    true & false & no & no & (never changes) \\
    false & false & yes & yes & reactions \emph{or} rules (but not both), and events \\
    \bottomrule
  \end{edtable}
  \caption{How to interpret the values of the \token{constant} and
    \token{boundaryCondition} fields of the \Species structure.
    Note that column four is specifically about reactants and
    products and \emph{not} also about species acting as
    modifiers; the latter are by definition unchanged by reactions.}
  \label{tab:specieattrib}
\end{table}

By default, when a species is a product or reactant of one or more
reactions, its quantity is determined by those reactions.  In
SBML, it is possible to indicate that a given species' quantity is
\emph{not} determined by the set of reactions even when that
species occurs as a product or reactant; \ie the species is on the
\emph{boundary} of the reaction system, and its quantity is not
determined by the reactions.  The boolean field
\token{boundaryCondition} can be used to indicate this.  The value
of the field defaults to \val{false}, indicating the species
\emph{is} part of the reaction system.

The \token{constant} field indicates whether the species' quantity
can be changed at all, regardless of whether by reactions, rules,
or constructs other than \InitialAssignment.  The default value is
\val{false}, indicating that the species' quantity can be changed,
since the purpose of most simulations is precisely to calculate
changes in species quantities.  Note that the initial quantity of
a species can be set by an \InitialAssignment irrespective of the
value of the \token{constant} field.

In practice, a \token{boundaryCondition} value of \val{true} means
a differential equation derived from the reaction definitions
should not be generated for the species.  However, the species'
quantity may still be changed by \AssignmentRule, \RateRule,
\AlgebraicRule, \Event, and \InitialAssignment constructs if its
\token{constant} field is \val{false}.  Conversely, if the
species' \token{constant} field is \val{true}, then its value
cannot be changed by anything except \InitialAssignment.

A species having \token{boundaryCondition}=\val{false} and
\token{constant}=\val{false} can appear as a product and/or
reactant of one or more reactions in the model.  If the species is
a reactant or product of a reaction, it must not also appear as
the target of any \AssignmentRule or \RateRule structure in the
model.  If instead the species has
\token{boundaryCondition}=\val{false} and
\token{constant}=\val{true}, then it cannot appear as a reactant
or product, or as the target of any \AssignmentRule, \RateRule or
\EventAssignment structure in the model.


The example model in section~\ref{sec:constantspecieseg} contains
all four possible combinations of the \token{boundaryCondition}
and \token{constant} fields on \token{species} elements.
Section~\ref{sec:odeeg} gives an example of how one can translate
into ODEs a model that uses \token{boundaryCondition} and
\token{constant} fields.


\subsubsection{The \token{charge} field}
\label{sec:charge}

The optional field \token{charge} takes an integer indicating the
charge on the species (in terms of electrons, not the SI unit
coulombs). This may be useful when the species is a charged ion
such as calcium ($\text{Ca}^{2+}$).  The \token{charge} field is
deprecated in SBML Level~2 Version~2.


\subsubsection{Example}

The following example shows two species definitions within an
abbreviated SBML model definition.  The example shows that species
are listed under the heading \token{listOfSpecies} in the model:

\begin{example}
<model>
    ...
    <listOfSpecies>
        <species id="Glucose" compartment="cell" initialConcentration="4"/>
        <species id="Glucose_6_P" compartment="cell" initialConcentration="0.75"/>
    </listOfSpecies>
    ...
</model>
\end{example}


%-----------------------------------------------------------------------------
\subsection{Parameters}
\label{sec:parameters}
%-----------------------------------------------------------------------------

A \Parameter structure is used to declare a variable for use in
mathematical formulas in an SBML model definition.  By default, parameters
have constant value for the duration of a simulation and for this reason
are called ``parameters'' instead of variables in SBML.  The definition of
\Parameter is shown in Figure~\vref{fig:parameter}.

\begin{figure}[htb]
  \centering
  \begin{classbox}{Parameter}
    id: SId                                               \\
    name: string \{ use="optional" \}                     \\
    value: double \{ use="optional" \}                    \\
    units: UnitSId \{ use="optional" \}     \\
    constant: boolean \{ use="optional" default="true" \} \\
    sboTerm: SBOTerm \{ use="optional" \}   \\
  \end{classbox}
  \caption{The definition of \Parameter. Following UML notation, additional
    fields
    that are inherited from a base class, in this case \SBase, are not shown.}
  \label{fig:parameter}
\end{figure}

Parameters can be defined in two places in SBML: in lists of
parameters defined at the top level in a \Model structure, and
within individual reaction definitions (as described in
Section~\ref{sec:reactions}).  Parameters defined at the top level
are \emph{global} to the whole model; parameters that are defined
within a reaction are local to the particular reaction and (within
that reaction) \emph{override} any global parameters having the
same identifiers (See Section~\ref{sec:identifiers} for further
details).


\subsubsection{The \token{id} and \token{name} fields}

\Parameter has one required field, \token{id}, of type
\primtype{SId}, to give the parameter a unique identifier by which
other parts of an SBML model definition can refer to it.  A
parameter can also have an optional \token{name} field of type
\primtype{string}.  Identifiers and names must be used according
to the guidelines described in Section~\ref{sec:idnameattribs}.


\subsubsection{The \token{value} field}
\label{sec:parameter-value}


The optional field \token{value} determines the value (of type
\primtype{double}) assigned to the identifier.  A missing
\token{value} implies that the \token{value} either is unknown, or
to be obtained from an external source, or determined by an
initial assignment (Section~\ref{sec:initialAssignment}) or a rule
(Section~\ref{sec:rules}) elsewhere in the model.

A parameter's value is set by its \token{value} field exactly
once.  If the parameter's \token{constant} field has the value
\val{true} (the default), then the value is fixed and cannot be
changed except by an \InitialAssignment.  These two methods of
setting the parameter's value differ in that the \token{value}
field can only be used to set it to a literal scalar value,
whereas \InitialAssignment allows the value to be set using an
arbitrary mathematical expression.  If the parameter's
\token{constant} field has the value \val{false}, the parameter's
value may be overridden by an \InitialAssignment or changed by
\AssignmentRule or \AlgebraicRule, and in addition, for simulation
time $t > 0$, it may also be changed by a \RateRule or \Event{}s.
(However, some of these constructs are mutually exclusive; see
Sections~\ref{sec:rules} and~\ref{sec:events}.)  It is not an
error to define \token{value} on a parameter and also redefine the
value using an \InitialAssignment, but the \token{value} in that
case is ignored.  Section~\ref{sec:before-t0} provides additional
information about the semantics of assignments, rules and values
for simulation time $t \leq 0$.


\subsubsection{The \token{units} field}
\label{sec:parameter-units}

The units associated with the value of the parameter are specified
by the field \token{units}.  These units are relevant when the
parameter identifier appears in: (a) \RateRule, \AssignmentRule,
\InitialAssignment and \EventAssignment structures setting the
value of the parameter; and (b) MathML expressions elsewhere in
the model. A \RateRule structure that may determine the value of
the parameter has units \quantity{parameter
  units}/\quantity{time}, where \quantity{parameter units} are the
units assigned to the parameter using the \token{units} field and
\quantity{time} is the built-in \token{time} units.  The value
assigned to the parameter's \token{units} field must be chosen
from one of the following possibilities: one of the base unit
identifiers from Table~\vref{tab:unitkind}; one of the built-in
unit identifiers appearing in first column of
Table~\vref{tab:builtin}; or the identifier of a new unit defined
in the list of unit definitions in the enclosing \Model structure.
There are no constraints on which units can be chosen from these
sets.  There are no default units for parameters.


\subsubsection{The \token{constant} field}
\label{sec:parameter-constant}

The \Parameter structure has an optional boolean field named
\token{constant} which indicates whether the parameter's value can
vary during a simulation.  The field's default value is
\val{true}.  A value of \val{false} indicates the parameter's
value can be changed by rules (see Section~\ref{sec:rules}) and
that the \token{value} is actually intended to be the initial
value of the parameter.

Parameters local to a reaction (\ie those defined within a
\Reaction's \KineticLaw structure, as described in
Section~\ref{subsec:kinetic-law}) cannot be changed by rules and
therefore are implicitly always constant; thus, parameter
definitions within \Reaction structures should \emph{not} have
their \token{constant} field set to \val{false}.

What if a global parameter has its \token{constant} field set to
\val{false}, but the model does not contain any rules, events or
other constructs that ever change its value over time?  Although
the model may be suspect, this situation is not strictly an error.
A value of \val{false} for \token{constant} only indicates that a
parameter \emph{can} change value, not that it \emph{must}.


\subsubsection{The \token{sboTerm} field}
\label{sec:parameter-sboterm}

The \Parameter structure has an optional \token{sboTerm} field of
type \primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in a
parameter definition, the value must be an SBO identifier
referring to a quantitative parameter defined in SBO (\ie terms
derived from \sboparameter).  The relationship is of the form
``the SBML parameter \emph{is a} X'', where X is the SBO term.
The term chosen should be the most precise (narrow) one that
captures the role of the parameter in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{Example}

The following is an example of parameters defined at the \Model level:

\begin{example}
<model>
    ...
    <listOfParameters>
        <parameter id="tau1" value="2.3" units="second"/>
        <parameter id="Km1" value="10.7" units="moleperlitre"/>
    </listOfParameters>
    ...
</model>
\end{example}



%-----------------------------------------------------------------------------
\subsection{Initial assignments}
\label{sec:initialAssignment}
%-----------------------------------------------------------------------------

\sbmltwotwo provides two ways of assigning initial values to
entities in a model.  The simplest and most basic is to set the
values of the appropriate \token{double} fields in the relevant
components; for example, the initial value of a model parameter
(whether it is a constant or a variable) can be assigned by
setting its \token{value} field directly in the model definition
(Section~\ref{sec:parameters}).  However, this approach is not
suitable when the value must be calculated, because the initial
value fields on different components such as species,
compartments, and parameters are single values and not
mathematical expressions.  This is the reason for the introduction
of \InitialAssignment: to permit the calculation of the value of a
constant or the initial value of a variable from the values of
\emph{other} quantities in a model.  The definition of
\InitialAssignment is shown in Figure~\ref{fig:initialAssignment}.

\begin{figure}[htb]
  \centering
  \small
    \begin{classbox}{InitialAssignment}
      symbol: SId                                                     \\
      math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
      sboTerm: SBOTerm \{ use="optional" \}                           \\
    \end{classbox}
  \caption{The definition of \InitialAssignment.
    Following UML notation fields
    that are inherited from a base class are not shown.}
  \label{fig:initialAssignment}
\end{figure}

As explained below, the provision of \InitialAssignment does not
mean that models necessarily must use this construct when defining
initial values of quantities in a model.  If a value can be set
directly using the relevant field of a component in a model, then
that approach may be more efficient and more portable to other
software tools.  \InitialAssignment should be used when the other
mechanism is insufficient for the needs of a particular model.

Initial assignments have some similarities to assignment rules
(Section~\ref{sec:assignmentrule}).  The main differences are (a)
an \InitialAssignment can set the value of a constant whereas an
\AssignmentRule cannot, and (b) unlike \AssignmentRule, an
\InitialAssignment definition only applies up to and including the
beginning of simulation time, \ie $t \leq 0$, while an
\AssignmentRule applies at all times.


\subsubsection{The \token{symbol} field}

\InitialAssignment contains the field \token{symbol}, of type
\primtype{SId}.  The value of this field in an \InitialAssignment
object can be the identifier (\ie the value of the \token{id}
field) of a \Compartment, \Species or \Parameter elsewhere in the
model.  The purpose of the \InitialAssignment is to define the
initial value of the constant or variable referred to by the
\token{symbol} field.  (The field's name is \token{symbol} rather
than \token{variable} because it may assign values to constants as
well as variables in a model; see
Section~\ref{sec:initial-assignment-semantics} below.)

An initial assignment cannot be made to reaction identifiers, that
is, the \token{symbol} field value of an \InitialAssignment cannot
be an identifier that is the \token{id} field value of a \Reaction
object in the model.  This is identical to a restriction placed on
rules (see Section~\ref{sec:ruleconstraints}).


\subsubsection{The \token{math} field}

The \token{math} field contains a MathML expression that is used
to calculate the value of the constant or the initial value of the
variable.  The units of the value computed by the formula in the
\token{math} field are taken to be the units associated with the
identifier given in the \token{symbol} field.  (That is, the units
are the units of the species, compartment, or parameter, as
appropriate for the kind of object identified by the value of
\token{symbol}.)


\subsubsection{The \token{sboTerm} field}
\label{sec:initialassignment-sboterm}

\InitialAssignment has an optional \token{sboTerm} field of type
\primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in an
initial assignment definition, the value must be a valid SBO
identifier referring to a mathematical expression (\ie terms
derived from \sbomathformula).  The \InitialAssignment object
should have a ``is a'' relationship with the SBO term, and the
term should be the most precise (narrow) term that captures the
role of the \InitialAssignment in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{Semantics of initial assignments}
\label{sec:initial-assignment-semantics}

The value calculated by an \InitialAssignment object overrides the
value assigned to the given symbol by the object defining that
symbol.  For example, if a \Compartment's \token{size} is set in
its definition, and the model also contains an \InitialAssignment
having that compartment's \token{id} as its \token{symbol} value,
then the interpretation is that the \token{size} assigned in the
\Compartment definition should be ignored and the value assigned
based on the computation defined in the \InitialAssignment.
Initial assignments can take place for \Compartment, \Species and
\Parameter objects regardless of the value of their
\token{constant} field.

This does not mean that a definition of a symbol can be omitted if
there is an \InitialAssignment object for that symbol; the symbols
must always be defined even if they are assigned a value
separately.  For example, there must be a \Parameter definition
for a given parameter if there is an \InitialAssignment for that
parameter.

The actions of all \InitialAssignment objects are in general terms
the same, but differ in the precise details depending on the type
of variable being set:
\begin{itemize}

\item \emph{In the case of a species}, an \InitialAssignment sets
  the referenced species' initial quantity
  (\quantity{concentration} or \quantity{amount of substance}) to
  the value determined by the formula in \token{math}.  (See
  Section~\ref{sec:species-units} for an explanation of how the
  units of the species' quantity are determined.)

\item \emph{In the case of a compartment}, an \InitialAssignment
  sets the referenced compartment's initial size to the size
  determined by the formula in \token{math}.  The overall units of
  the formula are the units specified for the size of the
  compartment.  (See Section~\ref{sec:compartment-units} for an
  explanation of how the units of the compartment's size are
  determined.)

\item \emph{In the case of a parameter}, an \InitialAssignment
  sets the referenced parameter's initial value to that determined
  by the formula in \token{math}.  The overall units of the
  formula are the units defined for the parameter.  (See
  Section~\ref{sec:parameter-units} for an explanation of how the
  units of the parameter are determined.)

\end{itemize}

In the context of a simulation, initial assignments establish
values that are in effect prior to and including the start of
simulation time, \ie $t \leq 0$.  Section~\ref{sec:before-t0}
provides information about the interpretation of assignments,
rules, and entity values for simulation time up to and including
the start time $t = 0$; this is important for establishing the
initial conditions of a simulation if the model involves
expressions containing the \emph{delay} \token{csymbol}
(Section~\ref{sec:csymbol-token}).

There cannot be two initial assignments for the same symbol in a
model; that is, a model must not contain two or more
\InitialAssignment objects that both have the same identifier as
their \token{symbol} field value.  A model must also not define
initial assignments \emph{and} assignment rules for the same
entity.  That is, there cannot be \emph{both} an
\InitialAssignment and an \AssignmentRule for the same symbol in a
model, because both kinds of constructs apply prior to and at the
start of simulated time---allowing both to exist for a given
symbol would result in indeterminism).  (See also
Section~\ref{sec:ruleconstraints}.)

The ordering of \InitialAssignment objects is not significant.
The combined set of \InitialAssignment, \AssignmentRule and
\KineticLaw objects form a set of assignment statements that must
be considered as a whole.  The combined set of assignment
statements should not contain algebraic loops: a chain of
dependency between these statements should terminate.  (More
formally, consider the directed graph of assignment statements
where nodes are a model's assignment statements and directed arcs
exist for each occurrence of a symbol in an assignment statement
\token{math} field.  The directed arcs in this graph start from
the statement assigning the symbol and end at the statement that
contains the symbol in their math fields.  Such a graph must be
acyclic.) Examples of valid and invalid set of assignment
statements are given in Section~\ref{sec:ruleconstraints}.

Finally, it is worth being explicit about the expected behavior in
the following situation.  Suppose (1) a given symbol has a value
$x$ assigned to it in its definition, and (2) there is an initial
assignment having the identifier as its \token{symbol} value and
reassigning the value to $y$, \emph{and} (3) the identifier is
also used in the mathematical formula of a second initial
assignment.  What value should the second initial assignment use?
It is $y$, the value assigned to the symbol by the first initial
assignment, not whatever value was given in the symbol's
definition.  This follows directly from the behavior at the
defined at the beginning of this section and in
Section~\ref{sec:before-t0}: if an \InitialAssignment object
exists for a given symbol, then the symbol's value is overridden
by that initial assignment.


\subsubsection{Example}

The following example shows how the species \val{x} can assigned
the initial value $2 \times y$, where \val{y} is an identifier
defined elsewhere in the model:

\begin{example}
<model>
    ...
    <listOfSpecies>
        <species id="x" initialConcentration="5"/>
    </listOfSpecies>
    ...
    <listOfInitialAssignments>
        <initialAssignment symbol="x">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <times/>
                    <ci> y </ci>
                    <cn> 2 </cn>
                </apply>
            </math>
        </initialAssignment>
    </listOfInitialAssignments>
    ...
</model>
\end{example}

The next example illustrates the more complex behavior discussed
above, when a symbol has a value assigned in its definition but
there also exists an \InitialAssignment for it \emph{and} another
\InitialAssignment uses its value in its mathematical formula.

\begin{example}
<model>
    ...
    <listOfSpecies>
        <species id="x" initialConcentration="5"/>
    </listOfSpecies>
    ...
    <listOfInitialAssignments>
        <initialAssignment symbol="x">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 2 </cn>
            </math>
        </initialAssignment>
        <initialAssignment symbol="othersymbol">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <times/>
                    <ci> x </ci>
                    <cn> 2 </cn>
                </apply>
            </math>
        </initialAssignment>
    </listOfInitialAssignments>
    ...
</model>
\end{example}

The value of \val{othersymbol} in the SBML excerpt above will be
\val{4}.  The case illustrates the rule of thumb that if there is
an initial assignment for a symbol, the value assigned to the
symbol in its definition must be ignored and the value created by
the initial assignment used instead.


%-----------------------------------------------------------------------------
\subsection{Rules}
\label{sec:rules}
%-----------------------------------------------------------------------------

In SBML, \emph{Rules} provide additional ways to define the values
of variables in a model, their relationships, and the dynamical
behaviors of those variables.  \emph{Rules} enable the encoding of
relationships that cannot be expressed using reactions alone
(Section~\ref{sec:reactions}) nor by the assignment of an initial
value to a variable in a model
(Section~\ref{sec:initialAssignment}).

SBML separates rules into three subclasses for the benefit of
model analysis software.  The three subclasses are based on the
following three different possible functional forms (where $x$ is
a variable, $f$ is some arbitrary function returning a numeric
result, $\textbf{V}$ is a vector of variables that does not
include $x$, and $\textbf{W}$ is a vector of variables that may
include $x$):
\begin{center}
  \begin{edtable}{tabular}{rll}
    \emph{Algebraic}  & left-hand side is zero:             & $0 = f(\textbf{W})$\\
    \emph{Assignment} & left-hand side is a scalar:         & $x = f(\textbf{V})$\\
    \emph{Rate}       & left-hand side is a rate-of-change: & $dx/dt = f(\textbf{W})$\\
  \end{edtable}
\end{center}

In their general form given above, there is little to distinguish
between \emph{assignment} and \emph{algebraic} rules.  They are
treated as separate cases for the following reasons:
\begin{itemize}
  
\item \emph{Assignment} rules can simply be evaluated to calculate
  intermediate values for use in numerical methods;
  
\item SBML needs to place restrictions on assignment rules, for
  example the restriction that assignment rules cannot contain
  algebraic loops (discussed further in
  Section~\ref{sec:ruleconstraints});

\item Some simulators do not contain numerical solvers capable of
  solving unconstrained algebraic equations, and providing more
  direct forms such as assignment rules may enable those
  simulators to process models they could not process if the same
  assignments were put in the form of general algebraic equations;
  
\item Those simulators that \emph{can} solve these algebraic
  equations make a distinction between the different categories
  listed above; and
  
\item Some specialized numerical analyses of models may only be
  applicable to models that do not contain \emph{algebraic} rules.

\end{itemize}

The approach taken to covering these cases in SBML is to define an
abstract \Rule structure containing a field, \token{math}, to hold
the right-hand side expression, then to derive subtypes of \Rule
that add fields to distinguish the cases of algebraic, assignment
and rate rules.  Figure~\vref{fig:rules} gives the definitions of
\Rule and the subtypes derived from it.  The figure shows there
are three subtypes, \AlgebraicRule, \AssignmentRule and \RateRule
derived directly from \Rule. These correspond to the cases
\emph{Algebraic}, \emph{Assignment}, and \emph{Rate} described
above respectively.

\begin{figure}[htb]
  \centering
  \begin{tikzpicture}[level distance=0.7in]
    \pgfsetarrows{open triangle 60-}
    \node {
      \begin{classbox}{\textsl{Rule}}
        math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
        sboTerm: SBOTerm \{ use="optional" \} \\    
      \end{classbox}
    }
    [sibling distance=1.15in]
    child[shorten >=-7pt, shorten <=-7pt] {node {
        \begin{classbox}{AlgebraicRule}
          \\
        \end{classbox}
      }}
    child[shorten >=-4pt, shorten <=-4pt] {node {
        \begin{classbox}{AssignmentRule}
          variable: SId \\
        \end{classbox}
      }}
    child[shorten >=-7pt, shorten <=-7pt] {node {
        \begin{classbox}{RateRule}
          variable: SId \\
        \end{classbox}
      }}
    ;
  \end{tikzpicture}
  \caption{The definition of \Rule and derived types.
    Following UML notation fields
    that are inherited from a base class are not shown.}
  \label{fig:rules}
\end{figure}


\subsubsection{Common fields in \abstractclass{Rule}}
\label{sec:rule-math}\label{sec:rule-fields}\label{sec:rule-sboterm}

The subtypes derived from \Rule inherit two fields: \token{math}
and \token{sboTerm}.


\paragraph{The \token{math} field}

A \Rule structure has a required field called \token{math},
containing a MathML expression defining the mathematical formula
of the rule.  This MathML formula must return a numerical value.
The formula can be an arbitrary expression referencing the
variables and other entities in an SBML model.  The interpretation
of \token{math} and the units of the formula are described in more
detail in Sections~\ref{sec:algebraicrule},
\ref{sec:assignmentrule} and~\ref{sec:raterule} below.


\paragraph{The \token{sboTerm} field}

The \Rule structure has an optional \token{sboTerm} field of type
\primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field, it
must be a valid SBO identifier referring to a mathematical
expression defined in SBO (\ie terms derived from
\sbomathformula).  The \AlgebraicRule, \AssignmentRule, or
\RateRule object should have a ``is a'' relationship with the SBO
term, and the term should be the most precise (narrow) term that
captures the role of that rule in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{\class{AlgebraicRule}}
\label{sec:algebraicrule}

The rule type \AlgebraicRule is used to express equations that are
neither assignments of model variables nor rates of change.
\AlgebraicRule does not add any fields to the basic \Rule; its
role is simply to distinguish this case from the other cases.  An
example of the use of \AlgebraicRule structures is given in
Section~\ref{sec:algeraiceg}.

In the context of a simulation, algebraic rules are in effect at
all times, $t \geq 0$.  For purposes of evaluating expressions
that involve the \emph{delay} \token{csymbol}
(Section~\ref{sec:csymbol-token}), algebraic rules are considered
to apply also at $t \leq 0$.  Section~\ref{sec:before-t0} provides
additional information about the semantics of assignments, rules,
and entity values for simulation time $t \leq 0$.

The ability to define arbitrary algebraic expressions in an SBML
model introduces the possibility that a model is mathematically
overdetermined by the overall system of equations constructed from
its rules and reactions.  An SBML model must not be
overdetermined; this is discussed in
Section~\ref{sec:ruleconstraints} below.


\subsubsection{\class{AssignmentRule}}
\label{sec:assignmentrule}

The rule type \AssignmentRule is used to express equations that
set the values of variables.  The left-hand side (the
\token{variable} field) of an assignment rule can refer to the
identifier of a \Species, \Compartment, or \Parameter object in
the model (but not a reaction).  The entity identified must not
have its \token{constant} field set to \val{true}.  The effects of
an \AssignmentRule are in general terms the same, but differ in
the precise details depending on the type of variable being set:

\begin{itemize}
  
\item \emph{In the case of a species}, an \AssignmentRule sets the
  referenced species' quantity (\quantity{concentration} or
  \quantity{amount of substance}) to the value determined by the
  formula in \token{math}.  The units of the formula in
  \token{math} must be the same as the \emph{units of the species}
  (Section~\ref{sec:species-units}) for the species identified by
  the \token{variable} field of the \AssignmentRule.
  
  \emph{Restrictions}: There must not be both an \AssignmentRule
  \token{variable} field and a \SpeciesReference \token{species}
  field having the same value, unless that species has its
  \token{boundaryCondition} field set to \val{true}.  In other
  words, an assignment rule cannot be defined for a species that
  is created or destroyed in a reaction unless that species is
  defined as a boundary condition in the model.

\item \emph{In the case of a compartment}, an \AssignmentRule sets
  the referenced compartment's size to the value determined by the
  formula in \token{math}.  The overall units of the formula in
  \token{math} must be the same as the units of the size of the
  compartment (Section~\ref{sec:compartment-units}).
  
\item \emph{In the case of a parameter}, an \AssignmentRule sets
  the referenced parameter's value to that determined by the
  formula in \token{math}.  The overall units of the formula in
  \token{math} must be the same as the units defined for the
  parameter (Section~\ref{sec:parameter-units}).

\end{itemize}

In the context of a simulation, assignment rules are in effect at
all times, $t \geq 0$.  For purposes of evaluating expressions
that involve the \emph{delay} \token{csymbol}
(Section~\ref{sec:csymbol-token}), assignment rules are considered
to apply also at $t \leq 0$.  Section~\ref{sec:before-t0} provides
additional information about the semantics of assignments, rules,
and entity values for simulation time $t \leq 0$.

A model must not contain more than one \AssignmentRule or
\RateRule object having the same value of \token{variable}; in
other words, in the set of all assignment rules and rate rules in
an SBML model, each variable appearing in the left-hand sides can
only appear once.  This simply follows from the fact that an
indeterminate system would result if a model contained more than
one assignment rule for the same variable or both an assignment
rule and a rate rule for the same variable.

Similarly, a model must also not contain \emph{both} an
\AssignmentRule and an \InitialAssignment for the same variable,
because both kinds of constructs apply prior to and at the start
of simulation time, \ie $t \leq 0$.  If a model contained both an
initial assignment and an assignment rule for the same variable,
an indeterminate system would result.  (See also
Section~\ref{sec:initial-assignment-semantics}.)

The value calculated by an \AssignmentRule object overrides the
value assigned to the given symbol by the object defining that
symbol.  For example, if a \Compartment's \token{size} is set in
its definition, and the model also contains an \AssignmentRule
having that compartment's \token{id} as its \token{variable}
value, then the \token{size} assigned in the \Compartment
definition is ignored and the value assigned based on the
computation defined in the \AssignmentRule.  This does \emph{not}
mean that a definition for a given symbol can be omitted if there
is an \AssignmentRule object for it.  For example, there must be a
\Parameter definition for a given parameter if there is an
\AssignmentRule for that parameter.


\subsubsection{\class{RateRule}}
\label{sec:raterule}

The rule type \RateRule is used to express equations that
determine the rates of change of variables.  The left-hand side
(the \token{variable} field) can refer to the identifier of a
species, compartment, or parameter (but not a reaction).  The
entity identified must have its \token{constant} field set to
\val{false}.  The effects of a \RateRule are in general terms the
same, but differ in the precise details depending on which
variable is being set:

\begin{itemize}
  
\item \emph{In the case of a species}, a \RateRule sets the rate
  of change of the species' quantity (\quantity{concentration} or
  \quantity{amount of substance}) to the value determined by the
  formula in \token{math}.  The overall units of the formula in
  \token{math} must be \quantity{species
    quantity}/\quantity{time}, where the \quantity{time} units are
  the built-in units of time described in
  Section~\ref{sec:unitdefinitions} and the \quantity{species
    quantity} units are the \emph{units of the species} as defined
  in Section~\ref{sec:species-units}.
  
  \emph{Restrictions}: There must not be both a \RateRule
  \token{variable} field and a \SpeciesReference \token{species}
  field having the same value, unless that species has its
  \token{boundaryCondition} field is set to \val{true}.  This
  means a rate rule cannot be defined for a species that is
  created or destroyed in a reaction, unless that species is
  defined as a boundary condition in the model.
  
\item \emph{In the case of a compartment}, a \RateRule sets the
  rate of change of the compartment's size to the value determined
  by the formula in \token{math}.  The overall units of the
  formula must be \quantity{size}/\quantity{time}, where the
  \quantity{time} units are the built-in units of time described
  in Section~\ref{sec:unitdefinitions} and the \quantity{size}
  units are the units of size on the compartment
  (Section~\ref{sec:compartment-units}).

\item \emph{In the case of a parameter}, a \RateRule sets the rate
  of change of the parameter's value to that determined by the
  formula in \token{math}.  The overall units of the formula must
  be \quantity{x}/\quantity{time}, where \quantity{x} are the
  units of the parameter (Section~\ref{sec:parameter-units}).

\end{itemize}

In the context of a simulation, rate rules are in effect for
simulation time $t > 0$.  Other types of rules and initial
assignments are in effect at different times;
Section~\ref{sec:before-t0} describes these conditions.

As mentioned in Section~\ref{sec:assignmentrule} for
\AssignmentRule, a model must not contain more than one \RateRule
or \AssignmentRule object having the same value of
\token{variable}; in other words, in the set of all assignment
rules and rate rules in an SBML model, each variable appearing in
the left-hand sides can only appear once.  This simply follows
from the fact that an indeterminate system would result if a model
contained more than one assignment rule for the same variable or
both an assignment rule and a rate rule for the same variable.


\subsubsection{Additional restrictions on rules}
\label{sec:ruleconstraints}

An important design goal of SBML rule semantics is to ensure that
a model's simulation and analysis results will not be dependent on
when or how often rules are evaluated.  To achieve this, SBML
needs to place two additional restrictions on rule use in addition
to the conditions described above regarding the use of
\AlgebraicRule, \AssignmentRule and \RateRule.  The first concerns
algebraic loops in the system of assignments in a model, and the
second concerns overdetermined systems.


\paragraph{The model must not contain algebraic loops}

The combined set of \InitialAssignment, \AssignmentRule and
\KineticLaw objects constitute a set of assignment statements that
should be considered as a whole.  (A \KineticLaw object is counted
as an assignment because it assigns a value to the symbol
contained in the \token{id} field of the \Reaction object in which
it is defined.)  This combined set of assignment statements must
not contain algebraic loops---dependency chains between these
statements must terminate.  To put this more formally, consider a
directed graph in which nodes are assignment statements and
directed arcs exist for each occurrence of an SBML species,
compartment or parameter symbol in an assignment statement's
\token{math} field.  Let the directed arcs point from the
statement assigning the symbol to the statements that contain the
symbol in their \token{math} field expressions.  This graph must
be acyclic.

SBML does not specify when or how often rules should be evaluated.
Eliminating algebraic loops ensures that assignment statements can
be evaluated any number of times without the result of those
evaluations changing.  As an example, consider the following
equations:
\begin{linenomath}
\begin{equation*}
  \begin{array}{lll}
    x = x + 1, & y = z + 200, & z = y + 100
  \end{array}
\end{equation*}
\end{linenomath}
If this set of equations were interpreted as a set of assignment
statements, it would be invalid because the rule for $x$ refers to
$x$ (exhibiting one type of loop), and the rule for $y$ refers to
$z$ while the rule for $z$ refers back to $y$ (exhibiting another
type of loop).

Conversely, the following set of equations would constitute a
valid set of assignment statements:
\begin{linenomath}
\begin{equation*}
  \begin{array}{lll}
    x = 10, & y = z + 200, & z = x + 100
  \end{array}
\end{equation*}
\end{linenomath}


\paragraph{The model must not be overdetermined}

An SBML model must not be overdetermined; that is, a model must
not define more equations than there are unknowns in a model.  An
SBML model that does not contain \AlgebraicRule structures cannot
be overdetermined.

Assessing whether a given continuous, deterministic, mathematical
model is overdetermined does not require dynamic analysis; it can
be done by analyzing the system of equations created from the
model.  One approach is to construct a bipartite graph in which
one set of vertices represents the variables and the other the set
of vertices represents the equations.  Place edges between
vertices such that variables in the system are linked to the
equations that determine them.  For algebraic equations, there
will be edges between the equation and each variable occurring in
the equation.  For ordinary differential equations (such as those
defined by rate rules or implied by the reaction rate
definitions), there will be a single edge between the equation and
the variable determined by that differential equation.  A
mathematical model is overdetermined if the maximal
matchings~\citep{chartrand_1977} of the bipartite graph contain
disconnected vertexes representing equations.  (If one maximal
matching has this property, then all the maximal matchings will
have this property; \ie it is only necessary to find one maximal
matching.)  Appendix~\ref{apdx:assessing-overdetermined} describes
a method of applying this procedure to specific SBML data objects.


\subsubsection{Example of rule use}
\label{sec:eg-rule-use}

This section contains an example set of rules.  Consider the
following set of equations:
\begin{linenomath}
  \begin{equation*}
    \begin{array}{lll}
      k = \dfrac{k_3}{k_2}, & s_2 = \dfrac{k \cdot x}{1 + k_2}, & A = 0.10 \cdot x
    \end{array}
  \end{equation*}
\end{linenomath}
This can be encoded by the following scalar rule set (where the
definitions of \texttt{x}, \texttt{s}, \texttt{k}, \texttt{k2},
\texttt{k3} and \texttt{A} are assumed to be located elsewhere in
the model and not shown in this abbreviated example):

\begin{example}
    <listOfRules>
        <assignmentRule variable="k">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <divide/>
                    <ci> k3 </ci>
                    <ci> k2 </ci>
                </apply>
            </math>
        </assignmentRule>
        <assignmentRule variable="s2">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <divide/>
                    <apply>
                        <times/>
                        <ci> k </ci>
                        <ci> x </ci>
                    </apply>
                    <apply>
                        <plus/>
                        <cn> 1 </cn>
                        <ci> k2 </ci>
                    </apply>
                </apply>
            </math>
        </assignmentRule>
        <assignmentRule variable="A">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <times/>
                    <cn> 0.10 </cn>
                    <ci> x </ci>
                </apply>
            </math>
        </assignmentRule>
    </listOfRules>
\end{example}


%\subsubsection{Guidelines for Evaluating Rules}
%
%This section describes how rules including those implied by
%\Reaction structures (see Section~\ref{sec:reactions})
%should be evaluated.  For the purpose of interpreting models
%mathematically (and for this description), \Reaction
%structures collectively imply a \class{SpeciesConcentrationRule}
%structure, of type \class{rate}, for each species referenced in a
%\SpeciesReference structure excluding those species which
%are defined with the \token{boundaryCondition} attribute equal to
%\texttt{true}.
%
%To determine the initial values of variables is a 2 set process:
%
%\begin{itemize}
%
%\item variables should be set according to the initial values
%given by \Species, \Compartment and
%\Parameter structures then
%
%\item the \class{scalar} rules should be evaluated
%
%\end{itemize}
%
%To determine the rates of change of variables given a set of
%current variable values is again a two set process:
%
%\begin{itemize}
%
%\item the \class{scalar} rules should be evaluated then
%
%\item the \class{rate} rules should be evaluated
%
%\end{itemize}
%
%The \class{scalar} rules should be evaluated to determine the
%complete set of variable values given an incomplete set of
%variable values determined by \class{rate} and
%\AlgebraicRule structures.
%


%-----------------------------------------------------------------------------
\subsection{Constraints}
\label{sec:constraints}
%-----------------------------------------------------------------------------

The \Constraint structure is a mechanism for stating the
assumptions under which a model is designed to operate.  The
\emph{constraints} are statements about permissible values of
different quantities in a model.  Figure~\vref{fig:constraint}
shows the definition of the \Constraint data structure.

\begin{figure}[htb]
  \centering
  \small
  \begin{classbox}{Constraint}
    math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
    message: (any: \{ namespace="http://www.w3.org/1999/xhtml" \}) \{ minOccurs="0" maxOccurs="1" \} \\
    sboTerm: SBOTerm \{ use="optional" \} \\
  \end{classbox}
  \caption{The definition of \Constraint.
    Following UML notation fields
    that are inherited from a base class are not shown.}
  \label{fig:constraint}
\end{figure}


\subsubsection{The \token{math} field}

A \Constraint structure has a required field, \token{math},
containing a MathML formula defining the condition of the
constraint.  This formula must return a boolean value of
\val{true} when the model is a \emph{valid} state.  The formula
can be an arbitrary expression referencing the variables and other
entities in an SBML model.  The evaluation of \token{math} and
behavior of constraints are described in more detail in
Section~\ref{sec:constraint-semantics} below.


\subsubsection{The \token{message} field}
\label{sec:constraint-message}

A \Constraint structure has an optional field called
\token{message}.  This can contain a message in XHTML format that
may be displayed to the user when the condition of the constraint
in \token{math} evaluates to a value of \val{false}.  Software
tools are not required to display the message, but it is
recommended that they do so as a matter of best practice.


\subsubsection{The \token{sboTerm} field}
\label{sec:constraint-sboterm}

The \Constraint structure has an optional \token{sboTerm} field of
type \primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in a
constraint definition, the value must be a valid SBO identifier
referring to a mathematical expression (\ie terms derived from
\sbomathformula).  The \Constraint should have an ``is a''
relationship with the SBO term, and the term should be the most
precise (narrow) term that captures the role of the \Constraint in
the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{Semantics of constraints}
\label{sec:constraint-semantics}

In the context of a simulation, a \Constraint has effect at all
times $t >= 0$.  Each \Constraint's \token{math} field is first
evaluated after any \InitialAssignment definitions in a model at
$t = 0$ and can conceivably trigger at that point.  (In other
words, a simulation could fail a constraint immediately.)

\Constraint structures \emph{cannot and should not} be used to
compute the dynamical behavior of a model as part of, for example,
simulation.  Constraints may be used as input to non-dynamical
analysis, for instance by expressing flux constraints for flux
balance analysis.

The results of a simulation of a model containing a constraint are
invalid from any simulation time at and after a point when the
function given by the \token{math} returns a value of \val{false}.
Invalid simulation results do not make a prediction of the
behavior of the biochemical reaction network represented by the
model.  The precise behavior of simulation tools is left undefined
with respect to constraints.  If invalid results are detected with
respect to a given constraint, the \token{message} field
(Section~\ref{sec:constraint-message}) may optionally be displayed
to the user.  The simulation tool may also halt the simulation or
clearly delimit in output data the simulation time point at which
the simulation results become invalid.

SBML does not impose restrictions on duplicate \Constraint
definitions or the order of evaluation of \Constraint objects in a
model.  It is possible for a model to define multiple constraints
all with the same \token{math} field.  Since the failure of any
constraint indicates that the model simulation has entered an
invalid state, a system is not required to attempt to detect
whether other constraints in the model have failed once any one
constraint has failed.


\subsubsection{Example}

As an example, the following SBML fragment demonstrates the
constraint that species $S_1$ should only have values between 1
and 100:

\begin{example}
<listOfConstraints>
    <constraint>
        <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
                <and/>
                <apply>
                    <lt/>
                    <cn> 1 </cn>
                    <ci> S1 </ci>
                </apply>
                <apply>
                    <lt/>
                    <ci> S1 </ci>
                    <cn> 100 </cn>
                </apply>
            </apply>
        </math>
        <message>
            <p xmlns="http://www.w3.org/1999/xhtml"> Species S1 is out of range. </p>
        </message>
    </constraint>
</listOfConstraints>
\end{example}


%-----------------------------------------------------------------------------
\subsection{Reactions}
\label{sec:reactions}
%-----------------------------------------------------------------------------

A \emph{reaction} represents any transformation, transport or
binding process, typically a chemical reaction, that can change
the quantity of one or more species.  In SBML, a reaction is
defined primarily in terms of the participating reactants and
products (and their corresponding stoichiometries), along with
optional modifier species, an optional rate at which the reaction
takes place, and optional parameters.  These various parts of a
reaction are recorded in the SBML \Reaction structure and other
supporting data structures, defined in Figure~\vref{fig:reaction}.

\begin{figure}[htb]
  \vspace*{-0.5ex}
  \centering
  \begin{classbox}{Reaction}
    id: SId                                                          \\
    name: string \{ use="optional" \}                                \\
    reactant: SpeciesReference[0..*]                                 \\
    product: SpeciesReference[0..*]                                  \\
    modifier: ModifierSpeciesReference[0..*]                         \\
    kineticLaw: KineticLaw \{ minOccurs="0" maxOccurs="1" \}         \\
    reversible: boolean \{ use="optional" default="true" \}          \\
    fast: boolean \{ use="optional" default="false" \} \\
    sboTerm: SBOTerm \{ use="optional" \}              \\
  \end{classbox}    
  \\[2ex]
  \hspace*{-0.75in}\begin{tikzpicture}[level distance=0.9in]
    \pgfsetarrows{open triangle 60-}
    \node {
      \begin{classbox}{\textsl{SimpleSpeciesReference}}
        id: SId \{ use="optional" \}          \\
        name: string \{ use="optional" \}     \\
        species: SId                                        \\
        sboTerm: SBOTerm \{ use="optional" \} \\
      \end{classbox}
    }
    [sibling distance=2.5in]
    child[shorten >=-6pt, shorten <=-6pt] {node {
        \begin{classbox}{SpeciesReference}
          stoichiometry: double \{ use="optional" default="1" \}    \\
          stoichiometryMath: StoichiometryMath \{ use="optional" \} \\
        \end{classbox}
      }}
    child[shorten >=-6pt, shorten <=-6pt] {node {
        \begin{classbox}{ModifierSpeciesReference}
          \\
        \end{classbox}
      }};
  \end{tikzpicture}
  \\
  \begin{classbox}{KineticLaw}
    math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
    parameter: Parameter[0..*]                                      \\
    sboTerm: SBOTerm \{ use="optional" \}             \\
  \end{classbox}
  \\[2ex]
  \begin{classbox}{StoichiometryMath}  
    math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \} \\
  \end{classbox}
  \caption{The definitions of \Reaction, \KineticLaw,
    \SpeciesReference and \ModifierSpeciesReference.
    Following UML notation fields
    that are inherited from a base class are not shown.}
  \label{fig:reaction}
\end{figure}


\subsubsection{The \class{Reaction} structure}
\label{sec:reaction-type}\label{sec:reaction-sboterm}

Each reaction in an SBML model is defined using an instance of a
\Reaction structure.  As shown in Figure~\vref{fig:reaction}, it
contains several scalar fields and several lists of objects.


\paragraph{The \token{id} and \token{name} fields}

As with most other main structures in SBML, the \Reaction data
structure includes a mandatory field called \token{id}, of type
\primtype{SId}, and an optional field \token{name}, of type
\primtype{string}.  The \token{id} field is used to give the
reaction a unique identifier in the model.  This identifier can be
used in mathematical formulas elsewhere in an SBML model to
represent the rate of that reaction; this usage is explained in
detail in Section~\ref{subsec:reaction-as-symbol} below.  The
\token{name} field can be used to give the reaction a more
free-form, descriptive name.  The \token{name} and \token{id}
fields must be used as described in
Section~\ref{sec:idnameattribs}.


\paragraph{The lists of reactants, products and modifiers}

The species participating as reactants, products, and/or modifiers
in a reaction are declared using lists of \SpeciesReference and/or
\ModifierSpeciesReference instances stored in
\token{listOfReactants}, \token{listOfProducts} and
\token{listOfModifiers}.  The \SpeciesReference and
\ModifierSpeciesReference structures are described in more detail
in Sections~\ref{subsec:speciesreference}
and~\ref{subsec:modifierreference} below.

Certain restrictions are placed on the appearance of species in
reaction definitions:
\begin{itemize}
  
\item The ability of a species to appear as a reactant or product
  of any reaction in a model is governed by certain flags in that
  species' definition; see Section~\ref{sec:species-constant} for
  more information.
  
\item Any species appearing in the mathematical formula of the
  \token{kineticLaw} of a \Reaction instance must be declared in
  at least one of that \Reaction's lists of reactants, products,
  and/or modifiers.  Put another way, it is an error for a
  reaction's kinetic law formula to refer to species that have not
  been declared for that reaction.
  
\item A reaction definition can contain an empty list of reactants
  \emph{or} an empty list of products, but it must have at least
  one reactant or product; in other words, a reaction without any
  reactant or product species is not permitted.  (This restriction
  does not apply to modifier species, which remain optional in all
  cases.)

\end{itemize}


\paragraph{The \token{kineticLaw} field}

A reaction can contain up to one \KineticLaw structure in the
\token{kineticLaw} field of the \Reaction.  This ``kinetic law''
defines the speed at which the process defined by the reaction
takes place.  A detailed description of \KineticLaw is left to
Section~\ref{subsec:kinetic-law} below.

Note that the inclusion of a \KineticLaw structure in an instance
of a \Reaction component is optional; however, in general there is
no useful default that can be substituted in place of a missing
rate expression in a reaction.  Moreover, a reaction's rate cannot
be defined in any other way in SBML---\InitialAssignment,
\AssignmentRule, \RateRule, \AlgebraicRule, \Event, and other
constructs in SBML cannot be used to set the reaction rate
separately.  Nevertheless, for some modeling applications,
reactions without any defined rate can be perfectly acceptable.


\paragraph{The \token{reversible} field}
\label{sec:reversible}

The optional boolean field \token{reversible} indicates whether
the reaction is reversible.  The default is \val{true}.

To say that a reaction is \emph{reversible} is to say it can
proceed in either the forward or the reverse direction.  Although
the reversibility of a reaction can sometimes be deduced by
inspecting its rate expression, this is not always the case,
especially for complicated expressions.  Having a separate field
supports the ability to perform some kinds of model analyses in
the absence of performing a time-course simulation of the model.
Moreover, the need in SBML to allow rate expressions (\ie
\KineticLaw) to be optional leads to the need for a separate flag
indicating reversibility.  Information about reversibility in the
absence of a \KineticLaw in a \Reaction is useful in certain kinds
of structural analyses such as elementary mode analysis.

Mathematically, the \token{reversible} field on \Reaction has no
impact on the construction of the equations giving the overall
rates of change of each species quantity in a model.  A concrete
explanation may help illustrate this.  Suppose a model consists of
multiple reactions, of which two particular irreversible reactions
$R_f$ and $R_r$ are actually the forward and reverse processes of
the same underlying reaction.  The product species of $R_f$
necessarily will be the reactants of $R_r$, and the reactants of
$R_f$ will be the products of $R_r$.  Let $f_f(\mathbf{X})$ and
$f_r(\mathbf{X})$ be the SBML kinetic rate formulas of $R_f$ and
$R_r$, respectively, with $\mathbf{X}$ representing the species,
parameters and compartments in the model.  For the sake of this
example, suppose we are using a continuous differential equation
framework to simulate the system of reactions.  Then for each
species, we need to construct an expression representing the
overall rate of change of that species' amount in the model.  This
overall expression will be a sum of the contributions of all the
relevant rate formulas,
\begin{linenomath}
  \begin{equation*}
    \frac{dS}{dt} =  \ldots - n \! \cdot \! f_f(\mathbf{X}) + n \! \cdot \! f_r(\mathbf{X}) + \ldots 
  \end{equation*}
\end{linenomath}
where $S$ is a reactant species of $R_f$ and a product of $R_r$,
$n$ is the effective stoichiometry of $S$ in $R_f$ (which by
implication must be the same as its stoichiometry in $R_r$), and
``\ldots'' indicates other rate formulas in the model involving
the particular species $S$.  Now, contrast this to the case of an
identical second SBML model, except that instead of having
separate \Reaction definitions for the forward and reverse
reactions, this model has a single \Reaction $R_c$ labeled as
reversible and whose reactants and products are the same as those
of $R_f$ in the first model.  The rate of this reaction will be a
formula $f_c$ = $f_f(\mathbf{X}) - f_r(\mathbf{X})$.  In
constructing an expression representing the overall rate of change
for the species $S$ involved in that reaction, we will have
\begin{linenomath}
  \begin{equation*}
    \begin{aligned}
      \dfrac{dS}{dt} & = \ldots - n \! \cdot \! f_c(\mathbf{X}) + \ldots \\
                     & = \ldots - n \! \cdot \! f_f(\mathbf{X}) + n \! \cdot \! f_r(\mathbf{X}) + \ldots 
    \end{aligned}
  \end{equation*}
\end{linenomath}

In other words, the result is the same final expression for the
rate of change of a species.  Although in this simple example we
used an expression for $f_c$ that had clearly separated terms, in
the general case the expression may have a more complicated form.

Note that labeling a reaction as irreversible is an assertion that
the reaction always proceeds in the given forward direction.  (Why
else would it be flagged as irreversible?)  This implies the rate
expression in the \KineticLaw always has a non-negative value
during simulations.  Software tools could provide a means of
optionally testing that this condition holds.  The presence of
reversibility information in two places (\ie the rate expression
and the \token{reversible} flag) leaves open the possibility that
a model could contain contradictory information, but the creation
of such a model would be an error on the part of the software
generating it.


\paragraph{The \token{fast} field}
\label{sec:fast}

The optional boolean field \token{fast} is another optional
boolean field in the \Reaction data structure.  The field's
default value is \val{false}.

Previous definitions of SBML indicated that software tools could
ignore this field if they did not implement support for the
corresponding concept; however, further research has revealed that
this is incorrect and \token{fast} \emph{cannot be ignored} if it
is set to \val{true}.  \sbmltwotwo therefore stipulates that if a
model has any reactions with \token{fast} set to \val{true}, a
software tool must be able to respect the field or else indicate
to the user that it does not have the capacity to do so.  Analysis
software cannot ignore the value of the \token{fast} attribute
because doing so may lead to different results as compared to a
software system that \emph{does} make use of \token{fast}.

When a model contains true values for \token{fast} on any of its
reactions, it is an indication that the creator of the model is
distinguishing different time scales of reactions in the system.
The model's reaction definitions are divided into two sets by the
values of the \token{fast} fields.  The set of reactions having
\token{fast}=\val{true} (known as \emph{fast reactions}) should be
assumed to be operating on a time scale significantly faster than
the other reactions (the \emph{slow reactions}).  Fast reactions
are considered to be instantaneous relative to the slow reactions.

Software tools must use a pseudo steady-state approximation for
the set of fast reactions when constructing the system of
equations for the model.  More specifically, the set of reactions
that have the \token{fast} attribute set to \val{true} forms a
subsystem that should be described by a pseudo steady-state
approximation in relationship to all other reactions in the model.
Under this description, relaxation from any initial condition or
perturbation from any intermediate state of this subsystem would
be infinitely fast.
Appendix~\ref{apdx:consequences-of-being-fast} provides a
technical explanation of an approach to solving systems with fast
reactions.

The correctness of the approximation requires a significant
separation of time scales between the fast reactions and other
processes.  This is not trivial to estimate a priori, and may even
change over the course of a simulation, but can reasonably be
assessed a posteriori in most cases.


\paragraph{The \token{sboTerm} field}

The \Reaction structure has an optional \token{sboTerm} field of
type \primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  When a value is given to this field in a
reaction definition, the value must be a valid SBO identifier
referring to a modeling framework (\ie terms derived from
\sboframework).  The \Reaction structure should have an ``is a''
relationship with the SBO term.  The SBO term chosen should be the
most precise (narrow) term that defines the mathematical framework
used in the reaction.

As discussed in Section~\ref{sec:model-sboterm}, the value given
to \token{sboTerm} on a \Reaction object interacts with the value
of the \token{sboTerm} field on the \Model element.  If the
\Model's \token{sboTerm} field has a value, it should be
interpreted to mean that all the reactions in a model assume the
same modeling framework.  In that case, the \token{sboTerm} labels
on individual reactions may be omitted, but only the \Reaction
\token{sboTerm} labels can be thus omitted; the \token{sboTerm}
field on \KineticLaw within \Reaction must still be given a value,
as must the terms on other components of the model, in order to
characterize the model completely.  (See
Section~\ref{sec:model-sboterm} for more discussion about this.)

SBO labels are optional information on a model.  Applications are
free to ignore \token{sboTerm} values, and a model must be
interpretable without the benefit of SBO labels.
Section~\ref{sec:sboTerm} gives more information about this
principle and the use of SBO.


\subsubsection{The \class{SimpleSpeciesReference} abstract type}
\label{subsec:simplespeciesreference}

As mentioned above, every species that enters into a given
reaction must appear in that reaction's lists of reactants,
products and/or modifiers.  In an SBML model, all species that may
participate in any reaction are listed in the
\token{listOfSpecies} field of the top-level \Model data structure
(see Section~\ref{sec:model}).  Lists of products, reactants and
modifiers in \Reaction structures do not introduce new species,
but rather, they refer back to those listed in the model's
top-level \token{listOfSpecies}.  For reactants and products, the
connection is made using the \SpeciesReference data structure; for
modifiers, it is made using the \ModifierSpeciesReference data
structure.  \SimpleSpeciesReference, defined in
Figure~\vref{fig:reaction}, is an abstract type that serves as the
parent class of both \SpeciesReference and
\ModifierSpeciesReference.  It is used simply to hold the fields
\token{species}, \token{id}, \token{name}, and \token{sboTerm}
that are common to the latter two structures.


\paragraph{The \token{id} and \token{name} fields}

The optional identifier stored in the \token{id} field allows
\SpeciesReference and \ModifierSpeciesReference instances to be
referenced from other structures.  No SBML structures currently do
this; however, such structures are anticipated in future SBML
Levels.  The value of \token{id} must be a text string conforming
to the syntax permitted by the \primtype{SId} data type described
in Section~\ref{sec:sid}.  The \token{id} value (whether it is in
a \SpeciesReference or \ModifierSpeciesReference object) exists in
the global namespace of the model, as described in
Section~\ref{sec:idnameattribs}.  The \token{id} and \token{name}
fields must be used as described in
Section~\ref{sec:idnameattribs}.


\paragraph{The \token{species} field}

The \SimpleSpeciesReference structure has a mandatory field,
\token{species}, of type \primtype{SId}.  As with the other
fields, this field is inherited by the \SpeciesReference and
\ModifierSpeciesReference subtypes derived from
\SimpleSpeciesReference.  The value of \token{species} must be the
identifier of a species defined in the enclosing \Model.  The
species is thereby declared as participating in the reaction being
defined.  The precise role of that species as a reactant, product,
or modifier in the reaction is determined by the subtype of
\SimpleSpeciesReference (\ie either \SpeciesReference or
\ModifierSpeciesReference) in which the identifier appears.


\paragraph{The \token{sboTerm} field}

The \SimpleSpeciesReference structure has an optional
\token{sboTerm} field of type \primtype{SBOTerm} (see
Sections~\ref{sec:sboterm-type} and~\ref{sec:sboTerm}).  This
means that the object classes derived from
\SimpleSpeciesReference, namely \SpeciesReference and
\ModifierSpeciesReference, all have \token{sboTerm} fields.  When
a value is given to this field, it must be a valid SBO referring
to a participant role.  The appropriate term depends on whether
the object is a reactant, product or modifier.  If a reactant,
then it should be a term in the \sboreactant hierarchy; if a
product, then it should be a term in the \sboproduct hierarchy;
and if a modifier, then it should be a term in the \sbomodifier
hierarchy. The \SpeciesReference and \ModifierSpeciesReference
structures should have an ``is a'' relationship to the term
identified by the SBO term identifier.  The SBO terms chosen
should be the most precise (narrow) one that defines the role of
the species in the reaction.

A product term must only be used when the \SpeciesReference
structure is contained in the \token{product} field of the
containing \Reaction structure.  Similarly, a reactant term must
only be used when the \SpeciesReference structure is contained in
the \token{reactant} field of the containing \Reaction structure.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\subsubsection{\class{SpeciesReference}}
\label{subsec:speciesreference}

The \Reaction structure provides a way to express which species
act as reactants and which species act as products in a reaction.
In a given reaction, references to those species acting as
reactants and/or products are made using instances of
\SpeciesReference structures in \Reaction's lists of reactants and
products.  The \SpeciesReference structure inherits the mandatory
field \token{species} and optional fields \token{id},
\token{name}, and \token{sboTerm}, from the parent type
\SimpleSpeciesReference; see
Section~\ref{subsec:simplespeciesreference} for their definitions.
It also defines two new fields, \token{stoichiometry} and
\token{stoichiometryMath}, described below.

The value of the \token{species} field must be the identifier of
an existing species defined in the enclosing \Model; this species
is thereby designated as a reactant or product in the reaction.
Which one it is (reactant or product) is determined by whether the
\SpeciesReference instance appears in the \Reaction's
\token{reactant} or \token{product} lists.


\paragraph{The \token{stoichiometry} and \token{stoichiometryMath}
  fields}

Product and reactant stoichiometries can be specified using
\emph{either} \token{stoichiometry} or \token{stoichiometryMath}
in the \SpeciesReference structure.  The \token{stoichiometry}
field is of type double and should contain values greater than
zero (0).  The \token{stoichiometryMath} field is implemented as
an element containing a MathML expression.  These two fields are
mutually exclusive; only one of \token{stoichiometry} or
\token{stoichiometryMath} should be defined in a given
\SpeciesReference instance.  When neither field is present, the
value of \token{stoichiometry} in the \SpeciesReference instance
defaults to \val{1}.

For maximum interoperability, the \token{stoichiometry} field
should be used in preference to \token{stoichiometryMath} when a
species' stoichiometry is a simple scalar number (integer or
decimal).  When the stoichiometry is a rational number, or when it
is a more complicated formula, \token{stoichiometryMath} must be
used.  The MathML expression in \token{stoichiometryMath} may also
refer to identifiers of entities in a model (except reaction
identifiers), as discussed in Section~\ref{sec:ci-token}.
However, the only species identifiers that can be used in
\token{stoichiometryMath} are those referenced in the \Reaction
list of reactants, products and modifiers.

The following is a simple example of a species reference for
species \val{X0}, with stoichiometry \val{2}, in a list of
reactants within a reaction having the identifier \val{J1}:

\begin{example}
<model>
    ...
    <listOfReactions>
        <reaction id="J1">
            <listOfReactants>
                <speciesReference species="X0" stoichiometry="2">
            </listOfReactants>
            ...
        </reaction>
        ...
    </listOfReactions>
    ...
</model>
\end{example}

The following is a more complex example of a species reference for
species ``X0'', with a stoichiometry formula consisting of the
parameter \texttt{x}:

\begin{example}
<model>
    ...
    <listOfReactions>
        <reaction id="J1">
            <listOfReactants>
                <speciesReference species="X0">
                    <stoichiometryMath>
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <ci>x</ci>
                        </math>
                    </stoichiometryMath>
                </speciesReference>
            </listOfReactants>
            ...
        </reaction>
        ...
    </listOfReactions>
    ...
</model>
\end{example}

A species can occur more than once in the lists of reactants and
products of a given \Reaction instance.  The effective
stoichiometry for a species in a reaction is the sum of the
stoichiometry values given on the \SpeciesReference structures in
the list of products minus the sum of stoichiometry values given
on the \SpeciesReference structures in the list of reactants.  A
positive value indicates the species is effectively a product and
a negative value indicates the species is effectively a reactant.
SBML places no restrictions on the effective stoichiometry of a
species in a reaction; for example, it can be zero.  In the
following SBML fragment, the two reactions have the same effective
stoichiometry for all their species:

\begin{example}
<reaction id="x">
    <listOfReactants>
        <speciesReference species="a"/>
        <speciesReference species="a"/>
        <speciesReference species="b"/>
    </listOfReactants>
    <listOfProducts>
        <speciesReference species="c"/>
        <speciesReference species="b"/>
    </listProducts>
</reaction>
<reaction id="y">
    <listOfReactants>
        <speciesReference species="a" stoichiometry="2"/>
    </listOfReactants>
    <listOfProducts>
        <speciesReference species="c"/>
    </listProducts>
</reaction>
\end{example}


\subsubsection{The \class{ModifierSpeciesReference} structure}
\label{subsec:modifierreference}

Sometimes a species appears in the kinetic rate formula of a
reaction but is itself neither created nor destroyed in that
reaction (for example, because it acts as a catalyst or
inhibitor).  In SBML, all such species are simply called
\emph{modifiers} without regard to the detailed role of those
species in the model.  The \Reaction structure provides a way to
express which species act as modifiers in a given reaction.  This
is the purpose of the list of modifiers available in \Reaction.
The list contains instances of \ModifierSpeciesReference
structures.

As shown in Figure~\vref{fig:reaction}, the
\ModifierSpeciesReference structure inherits the mandatory field
\token{species} and optional fields \token{id}, \token{name}, and
\token{sboTerm}, from the parent type \SimpleSpeciesReference; see
Section~\ref{subsec:simplespeciesreference} for their precise
definitions.

The value of the \token{species} field must be the identifier of a
species defined in the enclosing \Model; this species is
designated as a modifier for the current reaction.  A reaction may
have any number of modifiers.  It is permissible for a modifier
species to appear simultaneously in the list of reactants and
products of the same reaction where it is designated as a
modifier, as well as to appear in the list of reactants, products
and modifiers of other reactions in the model.


\subsubsection{The \class{KineticLaw} structure}
\label{subsec:kinetic-law}

The \KineticLaw structure is used to describe the rate at which
the process defined by the \Reaction takes place.  As shown in
Figure~\vref{fig:reaction}, \KineticLaw has fields called
\token{math}, \token{parameter} and \token{sboTerm}, described
below.

Previous definitions of SBML included two additional fields called
\token{substanceUnits} and \token{timeUnits}, which allowed the
\quantity{substance}/\quantity{time} units of the reaction rate
expression to be defined on a per-reaction basis.  \sbmltwotwo
removes these fields for several reasons.  First, the introduction
in \sbmltwotwo of mass and dimensionless units as possible units
of \quantity{substance}, coupled with the previous facility for
defining the units of each reaction separately and the ability to
use non-integer stoichiometries, lead to the possibility of
creating a valid model whose reactions nevertheless could not be
integrated into a system of equations without outside knowledge
for converting the quantities used.  (As a simple example,
consider if one reaction is defined to be in grams per second and
another in moles per second, and species are given in moles:
converting from mass to moles would require knowing the molecular
mass of the species.)  Second, the ability to change the units of
a reaction provided the potential of creating unintuitive and
difficult-to-reconcile systems of equations, yet the feature added
little functionality to SBML.  The \emph{absence} of
\token{substanceUnits} does not prevent the definition of any
reactions; it only results in requiring the generator of the model
to be explicit about any necessary conversion factors.  Third, few
if any software tools have ever correctly implemented support for
\token{substanceUnits}, which made the use of this field in a
model an impediment to interoperability.  Fourth, examination of
real-life models revealed that a frequent reason for using
\token{substanceUnits} was to set the units of all reactions to
the same set of substance units, which is better achieved by
setting the model-wide values of \val{substance}.


\paragraph{The \token{math} field}

As shown in Figure~\vref{fig:reaction}, the \KineticLaw structure
has a field called \token{math} for holding a MathML formula
defining the rate of the reaction.  The expression in \token{math}
may refer to species identifiers, as discussed in
Section~\ref{sec:ci-token}.  The only \Species identifiers that
can be used in \token{math} are those declared in the lists of
reactants, products and modifiers in the \Reaction structure (see
Sections~\ref{subsec:simplespeciesreference},
\ref{subsec:speciesreference} and~\ref{subsec:modifierreference}).
\Parameter identifiers may be taken from the \KineticLaw's list of
local parameters (see below) or the parameters defined globally on
the \Model instance.

Section~\ref{sec:about-kinetic-laws} provides important
discussions about the meaning and interpretation of SBML ``kinetic
laws''.


\paragraph{The list of parameters}

An instance of a \KineticLaw type structure can contain a list of
zero or more \Parameter structures (Section~\ref{sec:parameters})
which define new parameters whose identifiers can be used in the
\token{math} formula.  As discussed in
Section~\ref{sec:identifiers}, reactions introduce local
namespaces for parameter identifiers.  This means that within a
\KineticLaw object, a local parameter whose identifier is
identical to a global parameter defined in the model takes
precedence over that global parameter.

The type of structure used to define a parameter inside
\KineticLaw is the same \Parameter structure used to define global
parameters (Section~\ref{sec:parameters}).  This simplifies the
SBML language and reduces the number of unique types of data
objects.  However, there is a difference between local and global
parameters: in the case of parameters defined locally to a
\KineticLaw, there is no means by which the parameter values can
be changed.  Consequently, such parameters' values are always
constant, and the \token{constant} field in their definitions must
always have a value of \val{true} (either explicitly or left to
its default value).


\paragraph{The \token{sboTerm} field}

The \KineticLaw structure has an optional field called
\token{sboTerm} of type \primtype{SBOTerm} (see
Section~\ref{sec:sboTerm}).  When a value is given to this field,
the value must be an SBO identifier referring to a term from the
\sboratelaw vocabulary defined in SBO.  The relationship is of the
form ``the kinetic law \emph{is a} X'', where X is the SBO term.
The SBO term chosen should be the most precise (narrow) term that
defines the type of kinetic law encoded by the structure.


\paragraph{Example}

The following is an example of a \Reaction structure that defines
a reaction with identifier $J_1$, in which $X_0 \rightarrow S_1$
at a rate given by $k\, [X_0] [S_2]$, where $S_2$ is a catalyst
and $k$ is a parameter, and the square brackets symbolizes that
the species quantities have units of concentration.  The example
demonstrates the use of species references and the \KineticLaw
structure.  The units on the species here are the defaults of
\quantity{substance}/\quantity{volume} (see
Section~\ref{sec:species}), and so the rate expression $k\, [X_0]
[S_2]$ needs to be multiplied by the compartment volume
(represented by its identifier, \val{c1}) to produce the final
units of \quantity{substance}/\quantity{time} for the rate
expression.

\begin{example}
<model>
    ...
    <listOfUnitDefinitions>
        <unitDefinition id="per_concent_per_time">
            <listOfUnits>
                <unit kind="litre"/>
                <unit kind="mole"   exponent="-1"/>
                <unit kind="second" exponent="-1"/>
            </listOfUnits>
        </unitDefinition>
    </listOfUnitDefinitions>
    ...
    <listOfSpecies>
        <species id="S1" compartment="c1" initialConcentration="2.0"/>
        <species id="S2" compartment="c1" initialConcentration="0.5"/>
        <species id="X0" compartment="c1" initialConcentration="1.0"/>
    </listOfSpecies>
    ...
    <listOfReactions>
        <reaction id="J1">
            <listOfReactants>
                <speciesReference species="X0"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species="S1"/>
            </listOfProducts>
            <listOfModifiers>
                <modifierSpeciesReference species="S2"/>
            </listOfModifiers>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <ci> k </ci>
                        <ci> S2 </ci>
                        <ci> X0 </ci>
                        <ci> c1 </ci>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="k" value="0.1" units="per_concent_per_time"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
    </listOfReactions>
    ...
</model>
\end{example}



\subsubsection{Traditional rate laws versus SBML ``kinetic laws''}
\label{sec:about-kinetic-laws}

% FIXME units

It is important to make clear that a ``kinetic law'' in SBML is
\emph{not} identical to a traditional rate law.  The reason is
that SBML must support multicompartment models, and the normally
units used in traditional rate laws as well as some conventional
single-compartment modeling packages are problematic when used for
defining reactions between multiple compartments.

When modeling species as continuous amounts (\eg concentrations),
the rate laws used are traditionally expressed in terms of
\quantity{amount of substance concentration per time}, embodying a
tacit assumption that reactants and products are all located in a
single, constant volume.  Attempting to describe reactions between
multiple volumes using \quantity{concentration}/\quantity{time}
(which is to say,
\quantity{substance}/\quantity{volume}/\quantity{time}) quickly
leads to difficulties.  Here is an illustration of this.  Suppose
we have two species pools $S_1$ and $S_2$, with $S_1$ located in a
compartment having volume $V_1$, and $S_2$ located in a
compartment having volume $V_2$.  Let the volume $V_2 = 3 V_1$.
Now consider a transport reaction $S_1 \rightarrow S_2$ in which
the species $S_1$ is moved from the first compartment to the
second.  Assume the simplest type of chemical kinetics, in which
the rate of the transport reaction is controlled by the activity
of $S_1$ and this rate is equal to some constant $k$ times the
activity of $S_1$.  For the sake of simplicity, assume $S_1$ is in
a diluted solution and thus that the activity of $S_1$ can be
taken to be equal to its concentration $[S_1]$.  The rate
expression will therefore be $k \cdot [S_1]$\changed{, with the
  units of $k$ being }\changed{$1/\emph{time}$}.  Then:
\begin{linenomath}
  \begin{equation*}
    \frac{d[S_2]}{dt} = -\frac{d[S_1]}{dt} = k \cdot [S_1]
  \end{equation*}
\end{linenomath}

So far, this looks normal---until we consider the number of
molecules of $S_1$ that disappear from the compartment of volume
$V_1$ and appear in the compartment of volume $V_2$.  The number
of molecules of $S_1$ (call this $n_{S_1}$) is given by $[S_1]
\cdot V_1$ and the number of molecules of $S_2$ (call this
$n_{S_2}$) is given by $[S_2] \cdot V_2$.  Since our volumes have
the relationship $V_2 / V_1 = 3$, the relationship above implies
that $n_{S_1} = k \cdot [S_1] \cdot V_1$ molecules disappear from
the first compartment \changed{per unit of time} and $n_{S_2} = 3
\cdot k \cdot [S_1] \cdot V_1$ molecules appear in the second
compartment.  In other words, we have created matter out of
nothing!

The problem lies in the use of concentrations as the measure of
what is transfered by the reaction, because concentrations depend
on volumes and the scenario involves multiple unequal volumes.
The problem is not limited to using concentrations or volumes; the
same problem also exists when using density, \ie
\quantity{mass}/\quantity{volume}, and dependency on other spatial
distributions (\ie areas or lengths).  What must be done instead
is to consider the number of ``items'' being acted upon by a
reaction process irrespective of their distribution in space
(volume, area or length).  An ``item'' in this context may be a
molecule, particle, mass, or other ``thing'', as long as the
substance measurement is independent of the size of the space in
which the items are located.

For the current example, the expressions in terms of $n_{S_1}$ and
$n_{S_2}$ are straightforward:
\begin{linenomath}
\begin{equation*}
  \frac{dn_{S_2}}{dt} = -\frac{dn_{S_1}}{dt} = k \cdot [S_1] \cdot V_1
\end{equation*}
\end{linenomath}
Given numbers of items, it is then easy to recover concentrations
by dividing the item counts of each species by the volume of the
compartment in which the species is located: $[S_1] = n_{S_1}/V_1$
and $[S_2] = n_{S_2}/V_2$.

The need to support multicompartment models requires that the
reaction rates in SBML to be expressed in terms of
\quantity{substance}/\quantity{time}, rather than the more typical
\quantity{substance}/\quantity{size}/\quantity{time}.  As a
result, modelers and software tools in general cannot insert
textbook rate laws unmodified as the rate expression in the
\token{math} field of a \KineticLaw.  The unusual term ``kinetic
law'' was chosen to alert users to this difference.  We explain
the general principles of converting rate laws in the following
paragraphs.

%In textbook biochemistry, reactions are generally presented
%without regard to the space in which the reactions take place,
%apart from a consideration of the volume.  The concentration may
%play a role in the reaction kinetics, but all of the reactants are
%assumed to be in the same volume.  However, in the general case
%this may not be true.  One can have reactions in which items are
%moved from one space to another, and the spaces may have different
%volumes.  Then this presents a problem, because concentration
%depends on volume and if one is not careful to account for the
%different volumes, meaningless results will be produced.


\paragraph{Basic cases}

\newcommand{\relphantom}[1]{\mathrel{\phantom{#1}}}

Let us expand the simple example above by adding a second
reaction, to create the system
\begin{linenomath}
\begin{equation*}
  S_1 \rightarrow S_2 \rightarrow S_3
\end{equation*}
\end{linenomath}
with the left-hand reaction's rate (call this $r_1$) being given
as $k_1 \cdot [S_1]$ and the rate of the right-hand reaction (call
it $r_2$) as $k_2 \cdot [S_2]$.  Also assume each species is
located in a different compartment:
\begin{center}
  \begin{edtable}{tabular}{lll}
    $S_1$ & located in compartment $C_1$ & with volume $V_1$\\
    $S_2$ & located in compartment $C_2$ & with volume $V_2$\\ 
    $S_3$ & located in compartment $C_3$ & with volume $V_3$
  \end{edtable}
\end{center}
As before, converting the rate of the first reaction ($S_1
\rightarrow S_2$) to units of \quantity{substance}/\quantity{time}
in this case is a simple matter of multiplying by the volume of
the compartment where the reactants are located, leading to the
following rate formula:
\begin{linenomath}
\begin{equation*}
  r_1 = -k_1 \cdot [S_1] \cdot V_1 \\
\end{equation*}
\end{linenomath}
The second rate expression becomes
\begin{linenomath}
\begin{equation*}
  r_2 = -k_2 \cdot [S_2] \cdot V_2 \\
\end{equation*}
\end{linenomath}
\changed{The units of $k_1$ and $k_2$ are $1/\emph{time}$ (often
$1/sec$, but not necessarily), as is typical for reactions that
are first-}\changed{order in one reactant.}  The expressions
$r_1$ and $r_2$ are what would be written in \KineticLaw
\token{math} definitions for the two reactions in this system.
The formulas give the speed of each reaction in terms of the
substance change over time.  The reader of the SBML model needs to
combine the individual contributions of each reaction to construct
equations for the \emph{overall} rates of change of each species
in the model using these expressions.  In terms of differential
equations, these are:
\begin{linenomath}
\begin{equation*}
  \begin{aligned}
  \frac{dn_{S_1}}{dt} = &- r_1                    &= - k_1 \cdot [S_1] \cdot V_1 &{}\\[4pt]
  \frac{dn_{S_2}}{dt} = &+ r_1 - r_2              &= + k_1 \cdot [S_1] \cdot V_1 &-\, k_2 \cdot [S_2] \cdot V_2\\[4pt]
  \frac{dn_{S_3}}{dt} = &\phantom{{}+ r_1} + r_2  &= \phantom{+ k_1 \cdot [S_2] \cdot V_1} &+\, k_2 \cdot [S_2] \cdot V_2
\end{aligned}
\end{equation*}
\end{linenomath}
To recover the concentration values, we add the following to the
system of equations:
\begin{linenomath}
\begin{align*}
  [S_1] &= n_{S_1}/V_1\\
  [S_2] &= n_{S_2}/V_2\\
  [S_3] &= n_{S_3}/V_3
\end{align*}
\end{linenomath}
Note that this formulation works properly even if the compartment
sizes $V_1$, $V_2$ and $V_3$ vary during simulation.  

Extrapolating from this example, we can now provide a general
approach to translating a system of reactions involving species
located in multiple compartments, for the restricted case where
all reactants of any given reaction are in the same compartment
(but where the compartments involved may be different for each
reaction).  For a species $S_i$ located in a compartment of size
$V_i$ and involved in $m$ reactions $r_1, r_2, \ldots, r_m$, where
the reactants of $r_j$ are located in the compartment of size
$V_j$,
\begin{linenomath}
\begin{equation} \label{eq:simple-odes}
  \begin{split}
    \frac{dn_{S_i}}{dt} &= \relphantom{+}\,\text{sign}_1 \cdot \text{stoich}_1 \cdot r_1 \cdot V_1\\
    &\relphantom{=} +\, \text{sign}_2 \cdot \text{stoich}_2 \cdot r_2 \cdot V_2\\
    &\relphantom{=} +\, \ldots \\
    &\relphantom{=} +\, \text{sign}_m \cdot \text{stoich}_m \cdot r_m \cdot V_m\\
    \\[-4pt]
    [S_i] &= n_{S_i}/V_i
  \end{split}
\end{equation}
\end{linenomath}
In Equation~\eqref{eq:simple-odes}, each term $\text{sign}_j$ is
``$-$'' if $S_i$ is a reactant in $r_j$ and ``$+$'' if it is a
product, and each term $\text{stoich}_j$ is the stoichiometry of
$S_i$ in reaction $r_j$.

This approach preserves the use of concentration terms within the
reaction rate expressions so that the core of those rate
expressions can be ordinary rate laws.  This is important when
modeling species as continuous quantities, because most textbook
rate expressions are measured in terms of concentrations, and most
rate constants have units involving concentration rather than item
counts.  For example, the second-order rate constant in a
mass-action rate law has units of 1/($M \cdot s$), which is to
say,
\quantity{volume}/(\quantity{substance}$\cdot$\quantity{time});
this constant is then multiplied by two concentration terms.
Reaction definitions in SBML models can be constructed by taking
such expressions and multiplying them by the volume of the
compartment in which the reactants are located.  By contrast, if
we were to simply replace concentrations of species by item counts
in such rate laws, it would in most cases be incorrect.  At the
very least, the constants in the equations would need to be
converted in some way to make such expressions valid.

The preceding discussion of problems involving rate laws concerns
modeling approaches that use continuous quantities.  There is an
alternative approach to modeling that instead treats species as
discrete populations~\citep{wilkinson_2006}.  In those cases, the
rate expressions already use substance or item counts rather than
concentrations and there is no need to convert them.

A full SBML example of translating a complete multicompartmental
model into ODEs is given in Section~\ref{sec:odeeg}.  An example
of translating a discrete model is given in
Section~\ref{sec:discrete-eg}.


\paragraph{Advanced cases}

The explanation above applies to reactions where all of the
reactants are in the same compartment.  What about cases where two
or more reactant species are in separate compartments?

This is a more difficult situation, and the guidelines described
above for Equation~\eqref{eq:simple-odes} cannot always be applied
because there will be more than one compartment size term by which
the core rate expression needs to be multiplied.  Unfortunately,
there is often no straightforward way to mechanically convert such
models without requiring a more significant change to the reaction
rate expression.  An example will help illustrate the difficulty.
Suppose we have a simple reaction system consisting of only
\begin{linenomath}
\begin{equation*}
  S_1 + S_2 \rightarrow S_3
\end{equation*}
\end{linenomath}
where $S_1$, $S_2$ and $S_3$ are each located in separate
compartments with volumes $V_1$, $V_2$ and $V_3$, and the rate
expression is given as $k \cdot [S_1] \cdot [S_2]$.  (In reality,
one would not use such a rate law in this case, but for the sake
of this example, let us ignore the fact that a mass-action rate
law would actually involve an assumption that all reactants are in
a well-mixed solution.)  A straightforward examination of the
possibilities eventually leads to the conclusion that in order to
take account of the multiple volumes, the rate expressions in
terms of \quantity{substance}/\quantity{time} have to be written
as
\begin{linenomath}
\begin{equation*}
  \frac{dn_{S_i}}{dt} = -k'(V_1,V_2) \cdot 
    \bigl([S_1] \cdot V_1\bigr) \cdot \bigl([S_2] \cdot V_2\bigr)\\
\end{equation*}
\end{linenomath}
The crux of the problem is that the new factor $k'(V_1,V_2)$ is
not the original $k$; to make the overall units of the expression
work out, $k'(V_1,V_2)$ must be a function of the volumes, and its
value must change if $V_1$ or $V_2$ changes.  It is no longer a
standard rate constant.  In an SBML model, it is easy to define an
\AssignmentRule to compute the value of $k'$ based on $k$, $V_1$,
$V_2$, and possibly other variables in the system as needed, but
only the modeler can determine the proper formula for their
particular modeling situation.  (For example, the modeler may know
that in their hypothesized physical system, the reaction actually
takes place completely in one or the other compartment and
therefore the factor should be designed accordingly, or perhaps
the reaction takes place on a membrane between compartments and a
scaling factor based on the area should be used.)

Thus, although these models can be represented in SBML,
constructing the correct rate expression in terms of
\quantity{substance}/\quantity{time} units depends on
problem-specific knowledge, and we cannot provide a general
recipe.


%First, it is important for modelers to examine carefully the
%assumptions implicit in such a scenario.  Substances presumably
%need to have the opportunity to come in contact in order to be
%able to react with each other.  If the reactants are located in
%separate compartments, it means the separate pools of species are
%not mixed.  (If they were mixed, they would have to be located in
%the same compartment.)  This then begs the question, how can the
%reactants ever interact to produce a reaction?

%In some cases, although a reaction such as $S_1 + S_2 \rightarrow
%S_3$ may be written with reactant species in separate compartments
%having volumes $V_1$ and $V_2$, the reaction may actually be known
%to occur in one or the other compartment.  In that case, it is
%clear which volume should be used when generating the
%\quantity{substance}/\quantity{time} ``kinetic law'' expression.
%It then becomes the responsibility of the modeler to write the
%expression such that the appropriate volume term ($V_1$ or $V_2$)
%is used.

% From emails by Nicolas:

%We explained that in the former messages. Basically there are two types of
%problems. The first deals with the fact that you have only one
%substanceUnits per reaction while you can have several speciesReference
%potentially using different units. And since every reaction can have its
%own substanceUnits, the reconstruction of the ODEs is a nightmare. The
%second problem comes from the fact that the substanceUnits of kineticLaw
%defaults to "substance", that itself default to mole. Therefore there is
%in the vast majority of the cases an inconsistency between the left and
%right-sides.

% The global redefinition of substance is different. And removing it
%would not fix anything since you would still have possible inconsistencie
%between the built-in substance and the units of species. The global
%redefinition of substance is actually the best protection against
%inconsistencies, ensuring that all reactions use the same units. Coupled
%with the omission of individual units of species when it is not necessary,
%it becomes very powerful, simplyfying everything.


\paragraph{Mixed species units}

The discussion so far has assumed that all of the species
appearing in a given reaction's rate expression had the same
units, whether they be concentration or amounts or other.
However, \Species objects can each declare units separately.  What
happens then?

It is important to realize that implicit conversions in this
situation are not defined in SBML.  A species identifier appearing
in a mathematical expression has the units attributed to that
species (see Section~\ref{sec:species-units} for a definition of
the \emph{the units of the species}).  If a reaction contains
species each having different units, the creator of the SBML model
must explicitly incorporate the necessary conversions to make the
units of the rate expression consistent.  The most appropriate way
is to include the conversion factor as part of the value of
\token{stoichiometry} or \token{stoichiometryMath} in the
\SpeciesReference for that species.

An example may help illustrate this.  Suppose we have a system of
two biochemical reactions with mass-action kinetics, written in
the traditional form
\begin{linenomath}
  \begin{equation} \label{eq:two-reactions}
    \begin{aligned}
      A + 2\,B & \yields^{k_1} C\\
      C        & \yields^{k_2} 3\,A
    \end{aligned}
  \end{equation}
\end{linenomath}
Assume the reactions take place in a single compartment of volume
$V$, but now let us throw a wrench into the problem: suppose that
the species in the model are defined with mixed units as follows:
\begin{center}
  \begin{edtable}{tabular}{ll}
    $A$  & is in millimoles per litre\\
    $B$  & is in grams per litre\\
    $C$  & is in items per litre
  \end{edtable}
\end{center}
When biochemical reaction equations of the form
\eqref{eq:two-reactions} above are written, the units of species'
quantities usually are assumed to be the same, and therefore the
stoichiometries in the reaction equations \eqref{eq:two-reactions}
represent simple ratios between the quantities of the species in
those units.  (\emph{``One mole of \emph{this} and two moles of
  \emph{that} react to produce one mole of \emph{that other}.''})
If instead the quantities of the species are given in mixed units,
as in the present example, the quantities not only need to be in
proper stoichiometric relationships, the units also have to be
made consistent.  In SBML, this is done by appropriately setting
the \token{stoichiometry} field value in the species references of
the lists of reactants, products and modifiers in a \Reaction.
This then permits a properly balanced system of equations to be
constructed for each species' rate of change of quantity.

In the present example, the SBML ``kinetic law'' formulas for the
reaction rates will be written \changed{as conventional mass-action
reaction rates adjusted for volume as described previously},
\begin{linenomath}
\begin{equation*}
  \begin{aligned}
    r_1 &= {k_1}' \cdot [A] \cdot [B]^2 \cdot V\\
    r_2 &= {k_2}' \cdot [C] \cdot V
  \end{aligned}
\end{equation*}
\end{linenomath}
where ${k_2}' = k_2$ for this particular example but ${k_1}'$ will
depend on other units as described in the paragraphs below.  When
these formulas are combined into overall expressions for the rates
of change of $A$, $B$, and $C$, the result is
\begin{linenomath}
\begin{equation*}
  \begin{aligned}
    dA/dt &= -a_1 \cdot r_1 + a_2 \cdot r_2\\[5pt]
    dB/dt &= -b_1 \cdot r_1\\[5pt]
    dC/dt &= +c_1 \cdot r_1 - c_2 \cdot r_2
%     \dfrac{dA}{dt} &= -a_1 \cdot r_1 + a_2 \cdot r_2\\[5pt]
%     \dfrac{dB}{dt} &= -b_1 \cdot r_1\\[5pt]
%     \dfrac{dC}{dt} &= +c_1 \cdot r_1 - c_2 \cdot r_2
  \end{aligned}
\end{equation*}
\end{linenomath}
where
\begin{center}
  \begin{edtable}{tabular}{lll}
    $a_1$ & is the SBML stoichiometry of $A$ in reaction 1\\
    $a_2$ & is the SBML stoichiometry of $A$ in reaction 2\\
    $b_1$ & is the SBML stoichiometry of $B$ in reaction 1\\
    $c_1$ & is the SBML stoichiometry of $C$ in reaction 1\\
    $c_2$ & is the SBML stoichiometry of $C$ in reaction 2\\
  \end{edtable}
\end{center}
We use the term \emph{SBML stoichiometries} to highlight the fact
that in this example involving mixed-units species, the values may
not be identical to the biochemical stoichiometries in the
reaction equations \eqref{eq:two-reactions}.  And just what are
the \emph{SBML stoichiometries}?  In the kind of mixed-units
situation faced in this example, they must encompass both the
biochemical stoichiometries and any necessary unit conversions.
Thus, letting $m_B$ stand for the molecular mass of $B$:

\begin{edtable}{tabular}{l@{\hspace{2pt}}ll}
  $a_1$ &= 1000 
  & (in each reaction event, 1 mole of $A$ is consumed, with $A$ expressed in millimoles)\\

  $a_2$ &= 3000
  & (in each reaction event, 3 moles of $A$ are produced, with $A$ expressed in millimoles)\\

  $b_1$ &= $2 \cdot m_B$
  & (in each reaction event, 2 moles of $B$ are consumed, with $B$ expressed in grams)\\

  $c_1$ &= $6.02 \cdot 10^{23}$
  & (in each reaction event, 1 mole of $C$ is produced, expressed as item counts)\\

  $c_2$ &= $6.02 \cdot 10^{23}$
  & (in each reaction event, 1 mole of $C$ is consumed, expressed as item counts)\\[5pt]
\end{edtable}

and 

\begin{tabular}{l}
${k_1}'$ = $k_1 \cdot 10^{-3} \cdot 1/{m_B}^2$  
\end{tabular}

What happens if the definition of the SBML built-in unit
\val{substance} is changed in the model to be millimoles?  Then
the stoichiometries must be changed to the following:

\begin{edtable}{tabular}{l@{\hspace{2pt}}ll}
  $a_1$ &= 1
  & (in each reaction event, 1 millimole of $A$ is consumed, expressed in millimoles)\\

  $a_2$ &= 3
  & (in each reaction event, 3 millimoles of $A$ are produced, expressed in millimoles)\\

  $b_1$ &= $2 \cdot 10^{-3} \cdot m_B$
  & (in each reaction event, 2 millimoles of $B$ are consumed, expressed in grams)\\

  $c_1$ &= $6.02 \cdot 10^{20}$
  & (in each reaction event, 1 millimole of $C$ is produced, expressed as item counts)\\

  $c_2$ &= $6.02 \cdot 10^{20}$
  & (in each reaction event, 1 millimole of $C$ is consumed, expressed as item counts)\\[6pt]
\end{edtable}

and

\begin{tabular}{l}
  ${k_1}'$ = $k_1 \cdot (10^3/m_B)^2$
\end{tabular}

What happens if instead the definition of the SBML built-in unit
\val{substance} is changed in the model to be \val{item}?  Then
the stoichiometries must be changed to the following:

\begin{edtable}{tabular}{l@{\hspace{2pt}}ll}
  $a_1$ &= $1/(6.02 \cdot 10^{20})$
  & (in each reaction event, 1 item of $A$ is consumed, expressed in millimoles)\\

  $a_2$ &= $3/(6.02 \cdot 10^{20})$
  & (in each reaction event, 3 items of $A$ are produced, expressed in millimoles)\\

  $b_1$ &= $2 \cdot 1/(6.02 \cdot 10^{23}) \cdot m_B$
  & (in each reaction event, 2 items of $B$ are consumed, expressed in grams)\\

  $c_1$ &= 1
  & (in each reaction event, 1 items of $C$ is produced, expressed as item counts)\\

  $c_2$ &= 1
  & (in each reaction event, 1 items of $C$ is consumed, expressed as item counts)\\[6pt]
\end{edtable}

and

\begin{tabular}{l}
  ${k_1}'$ = $k_1 \cdot 6.02 \cdot 10^{20} \cdot \left(\dfrac{6.02 \cdot
  10^{23}}{m_B}\right)^{\negmedspace{}2}$
\end{tabular}

And finally, what happens if the definition of the SBML built-in
unit \val{substance} is changed in the model to be \val{gram}?
Then the stoichiometries must be changed again, to the following:

\begin{edtable}{tabular}{l@{\hspace{2pt}}ll}
  $a_1$ &= $1000 \cdot m_A$
  & (in each reaction event, 1 gram of $A$ is consumed, expressed in millimoles)\\

  $a_2$ &= $3000 \cdot m_A$
  & (in each reaction event, 3 grams of $A$ are produced, expressed in millimoles)\\

  $b_1$ &= 2
  & (in each reaction event, 2 grams of $B$ are consumed, expressed in grams)\\

  $c_1$ &= $6.02 \cdot 10^{23} \cdot m_C$
  & (in each reaction event, 1 gram of $C$ is produced, expressed as item counts)\\

  $c_2$ &= $6.02 \cdot 10^{23} \cdot m_C$
  & (in each reaction event, 1 gram of $C$ is consumed, expressed as item counts)\\[6pt]
\end{edtable}

and

\begin{tabular}{l}
  ${k_1}'$ = $k_1 \cdot 10^{-3} \cdot m_A$
\end{tabular}

where $m_A$, $m_B$, and $m_C$ are the molecular masses of species
$A$, $B$, and $C$, respectively.

In all of these cases, the computation of ${k_1}'$ could be
handled nicely by using an \InitialAssignment construct.  And
finally, note that if the species units \emph{were} the same
throughout (and in most models they are), the unit conversion
aspects of the SBML stoichiometries would become unity, leaving
only the expected biochemical stoichiometry values.  Isn't that
nice?


\subsubsection{Use of reaction identifiers in mathematical expressions}
\label{subsec:reaction-as-symbol}

The value of the \token{id} field of a \Reaction structure can be
used as the content of a \token{ci} element in MathML formulas
elsewhere in the model. Such a \token{ci} element or symbol
represents the rate of the given reaction as given by the
\KineticLaw structure of the reaction.  The symbol has the units
of \quantity{substance/time}.

A \KineticLaw structure in effect forms an assignment statement
assigning the evaluated value of the \token{math} field to the
symbol value contained in the \Reaction \token{id} field.  No
other structure can assign a value to such a reaction symbol; \ie
the \token{variable} fields of \InitialAssignment, \RateRule,
\AssignmentRule and \EventAssignment structures cannot contain the
value of a \Reaction \token{id} field.

The combined set of \InitialAssignment, \AssignmentRule and
\KineticLaw structures form a set of assignment statements that
should be considered as a whole.  The combined set of assignment
rules should not contain algebraic loops: a chain of dependency
between these statements should terminate.  (More formally,
consider the directed graph of assignment statements where nodes
are statements and directed arcs exist for each occurrence of a
symbol in a assignment statement \token{math} field. The directed
arcs start from the statement defining the symbol to the
statements that contain the symbol in their math fields. Such a
graph must be acyclic.)  Examples of valid and invalid set of
assignment statements are given in
Section~\ref{sec:ruleconstraints}.


%-----------------------------------------------------------------------------
\subsection{Events}
\label{sec:events}
%-----------------------------------------------------------------------------

\Model has an optional list of \Event structures that describe the
time and form of explicit instantaneous discontinuous state
changes in the model.  For example, an event may describe that one
species quantity is halved when another species quantity exceeds a
given threshold value.

An \Event structure defines when the event can occur, the
variables that are affected by the event, and how the variables
are affected.  The effect of the event can optionally be delayed
after the occurrence of the condition which invokes it.  The
operation of an \Event structure is divided into two phases (even
when the event is not delayed): one when the event is \emph{fired}
and the other when the event is \emph{executed}. The \Event type
is defined in Figure~\vref{fig:event}.  Both \Event and
\EventAssignment are derived from \SBase (see
Section~\ref{sec:sbase}).  An example of a model which uses events
is given below.

\begin{figure}[htb]
  \centering
  \begin{classbox}{Event}
    id: SId                                                                     \\
    name: string \{ use="optional" \}                                           \\
    trigger: (math : Math \{ namespace="http://www.w3.org/1998/Math/MathML" \}) \\
    delay: (math : Math \{ namespace="http://www.w3.org/1998/Math/MathML" \}) \{ minOccurs="0" maxoccurs="1" \} \\
    timeUnits: UnitSId \{ use="optional" \}                       \\
    eventAssignment: EventAssignment[1..*]                                      \\
    sboTerm: SBOTerm \{ use="optional" \}                         \\
  \end{classbox}
  \vspace*{2ex}
  \begin{classbox}{EventAssignment}
    variable: SId                                                              \\
    math: Math \{ namespace="http://www.w3.org/1998/Math/MathML" \}            \\
    sboTerm: SBOTerm \{ use="optional" \}                        \\
  \end{classbox}
  \caption{The definitions of \Event and \EventAssignment.
    Following UML notation, additional fields that are inherited
    from a base class, in this case \SBase, are not shown.}
  \label{fig:event}
\end{figure}


\subsubsection{\class{Event}}
\label{sec:event-sboterm}

An \Event definition has three required parts: an identifier, a
trigger condition and at least one \EventAssignment. In addition
there is an optional delay expression.  These are described below.


\paragraph{The \token{id} and \token{name} fields}
\label{sec:event-id-name}

These optional fields are available to support external references
to event structures.  These fields operate in the manner described
in Section~\ref{sec:idnameattribs} except that the \token{id}
field is optional.


\paragraph{The \token{trigger} field}
\label{sec:event-trigger}

The \token{trigger} field defines when the \Event structure has an
effect on the model.  The \token{trigger} field contains a MathML
boolean expression.  The exact instant that the expression
evaluates to true is the time point when the \Event is
\emph{fired}.  The event only fires when the \token{trigger} makes
the transition from false to true.  The event will fire at any
further time points when the \token{trigger} make this transition.

An important question is whether an event can fire prior to or at
initial simulation time, \ie $t \leq 0$.  The answer is no: an
event can only be triggered immediately after initial simulation
time \ie $t > 0$.

% Mike - the reason for this is now is that its very hard to implement
% event handling t < 0 !!

% Old text:
%The reason is that when a
%model's list of events is first evaluated at $t = 0$, all
%assignments of values to variables (species amounts, compartment
%sizes, and parameter values), all \InitialAssignment{}s and all
%\AssignmentRule{}s will have taken effect, and therefore the
%event's trigger expression cannot change value until the next time
%step.


\paragraph{The \token{delay} field}
\label{sec:event-delay}

The optional \token{delay} field defines a mathematical expression
used to compute the length of time after the event has
\emph{fired} that the event is \emph{executed}.  This expression
must be evaluated at the time the rule is \emph{fired}.  The
default value for the \token{delay} field is 0.  The \token{delay}
expression must always evaluate to a positive number (otherwise, a
nonsensical situation would arise where an event is defined to
fire before it is triggered!).  The units of the \token{delay}
field are those given on the \token{timeUnits} field.


\paragraph{The \token{timeUnits} field}
\label{sec:event-timeunits}

The optional field \token{timeUnits} determines the units of time
that apply to the \token{delay} field.  The value of the
\token{timeUnits} field must be either ``\token{second}'' or
``\token{dimensionless}'' from Table~\vref{tab:unitkind},
``\token{time}'' from Table~\vref{tab:builtin}, or a new unit
defined by a unit definition in the enclosing model which must be
a variant of ``\token{second}'' units.  The default value of the
\token{timeUnits} field is ``\token{time}''.


\paragraph{The \token{sboTerm} field}

The \Event structure has an optional \token{sboTerm} field of type
\primtype{SBOTerm} (see Sections~\ref{sec:sboterm-type}
and~\ref{sec:sboTerm}).  The term is associated with the trigger
condition on the event.  When a value is given to this field, it
must be a valid SBO referring to a mathematical expression (\ie
terms derived from \sbomathformula).  The \Event's trigger should
have a ``is a'' relationship with the SBO term, and the term
should be the most precise (narrow) term that captures the form of
the trigger formula in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\paragraph{The \token{eventAssignment} field}
\label{sec:eventassignment}

The \token{eventAssignment} field consists of a non-empty list of
\EventAssignment structures.  This field is implemented as a
\token{listOfEventAssignments} element containing one or more
\token{eventAssignment} elements.  The \EventAssignment structures
represent variable assignments that have effect when the event is
\emph{executed}.


\subsubsection{\class{EventAssignment}}
\label{sec:eventassignment-sboterm}

The \EventAssignment structure is shown in Figure~\ref{fig:event}.
It contains three fields: \token{variable}, \token{math} and
\token{sboTerm}, described below.


\paragraph{The \token{variable} field}

The \token{variable} field is of type \primtype{SId} and can
contain the identifier of a \Compartment, \Species or \Parameter
instance defined in the model.  When the event fires, the value of
the model component identified by \token{variable} is changed by
the \EventAssignment to the value computed by the \token{math}
field; that is, a species' quantity, compartment's size or
parameter's value are reset to the value computed by \token{math}.

Certain restrictions are placed on what can appear in
\token{variable}:
\begin{itemize}
  
\item The object identified by the value of the \token{variable}
  field must not have its \token{constant} field set to or default
  to \val{true}.  (Constants cannot be affected by events.)
  
\item The \token{variable} field must not contain the identifier
  of a reaction; only species, compartment and parameter values
  may be set by an \Event.
  
\item The value of every \token{variable} field must be unique
  among the set of \EventAssignment structures within a given
  \Event structure.  In other words, a single event cannot have
  multiple \EventAssignment{}s assigning the same variable.  (All
  of them would be performed at the same time, when that
  particular \Event triggers, resulting in indeterminacy.)
  Separate \Event instances can refer to the same variable.
  
\item A variable cannot be assigned a value in an \EventAssignment
  object instance and also be assigned a value by an
  \AssignmentRule, \ie the value of the \token{variable} attribute
  in an \EventAssignment instance cannot be the same as the value
  of a \token{variable} attribute in a \AssignmentRule instance.
  (Assignment rules hold at all times, therefore it would be
  inconsistent to also define an event that reassigns the value of
  the same variable.)

\end{itemize}


\paragraph{The \token{sboTerm} field}

The \EventAssignment structure has an optional \token{sboTerm}
field of type \primtype{SBOTerm} (see
Sections~\ref{sec:sboterm-type} and~\ref{sec:sboTerm}).  When a
value is given to this field, it must be a valid SBO term
identifier referring to a mathematical expression (\ie terms
derived from \sbomathformula).  The \EventAssignment should have
an ``is a'' relationship with the SBO term, and the term should be
the most precise (narrow) term that captures the form of the
assignment formula in the model.

As discussed in Section~\ref{sec:sboTerm}, SBO labels are optional
information on a model.  Applications are free to ignore
\token{sboTerm} values.  A model must be interpretable without the
benefit of SBO labels.


\paragraph{The \token{math} field}

The \token{math} field contains a MathML expression that defines
the new value of the variable. This expression is evaluated when
the \Event is \emph{fired} but the variable only acquires the
result or new value when the \Event is \emph{executed}. The order
of the \EventAssignment structures is not significant; the effect
of one assignment cannot affect the result of another assignment.
The identifiers occurring in the MathML \token{ci} fields of the
\EventAssignment structures represent the value of the identifier
at the point when the \Event is \emph{fired}.

In all cases, as would be expected, the units of the formula in an
\EventAssignment are identical to the units associated with the
\token{variable} field, when that variable appears in other
formulas. However, the precise details, which are identical to
those of \AssignmentRule structures, depend on the variable that
is being set:
\begin{itemize}
  
\item \emph{In the case of a species}, an \EventAssignment sets
  the referenced species' quantity (\quantity{concentration} or
  \quantity{amount of substance}) to the value determined by the
  formula in \token{math}.  The units of the formula are the
  \emph{units of the species} as defined in
  Section~\ref{sec:species-units}.
  
\item \emph{In the case of a compartment}, an \EventAssignment
  sets the referenced compartment's size to the size determined by
  the formula in \token{math}.  The overall units of the formula
  are the units specified for the size of the compartment
  identified by the value of the \EventAssignment's
  \token{variable} field.  (See
  Section~\ref{sec:compartment-units} for an explanation of how
  the units of the compartment's size are determined.)
  
\item \emph{In the case of a parameter}, an \EventAssignment sets
  the referenced parameter's value to that determined by the
  formula in \token{math}.  The overall units of the formula are
  the units defined for the parameter identified by the value of
  the \EventAssignment's \token{variable} field.  (See
  Section~\ref{sec:parameter-units} for an explanation of how the
  units of the parameter are determined.)

\end{itemize}


\subsubsection{Example \class{Event} structure}

A example of an \Event structure follows.  This structure makes the
assignment $k_2 = 0$ at the point when $P_1 \leq t$:

\begin{example}
<event>
    <trigger>
        <math xmlns="http://www.w3.org/1998/Math/MathML">
            <apply>
                <leq/>
                <ci> P1 </ci>
                <ci> t </ci>
            </apply>
        </math>
    </trigger>
    <listOfEventAssignments>
        <eventAssignment variable="k2">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <cn> 0 </cn>
            </math>
        </eventAssignment>
    <listOfEventAssignments>
</event>
\end{example}

A complete example of a model using events is given in
Section~\ref{sec:eventeg}.


\subsubsection{Detailed semantics of events}
\label{sec:events-semantics}

The description of events above describes the action of events in
isolation from each other.  This section describes how events
interact.

Events whose \token{trigger} expression is true at the start of a
simulation do not \emph{fire} at the start of the simulation ($t =
0$).  Events \emph{fire} only when the trigger \emph{becomes}
true, \ie the trigger expression transitions from false to true,
which cannot happen at $t = 0$ but can happen at $t > 0$.

Any transition of a \token{trigger} expression from \val{false} to
\val{true} will cause an \token{event} to \emph{fire}.  Consider
an \token{event} $E$ with delay $d$ where the \token{trigger}
expression makes a transition from false to true at times $t_1$
and $t_2$.  The \EventAssignment structure will have effect at
$t_1+d$ and $t_2+d$ irrespective of the relative times of $t_1$
and $t_2$. For example events can ``overlap'' so that $t_1 < t_2 <
t_1+d$ still causes an event assignments to occur at $t_1+d$ and
$t_2+d$.

It is possible for events to \emph{fire} other events, \ie an
event assignment can cause an event to \emph{fire}, therefore it
is possible for a model to be entirely encoded in \Event
structures.

It is entirely possible for two events to be \emph{executed}
simultaneously in simulated time.  It is assumed that, although
the precise time at which these events are \emph{executed} is not
resolved beyond the given point in simulated time, the order in
which the events occur is resolved.  This order can be significant
in determining the overall outcome of a given simulation. SBML
Level 2 does not define the algorithm for determining this order
(the tie-breaking algorithm).  As a result, the results of
simulations involving events may vary when simultaneous events
occur during simulation.  It is anticipated that future versions
or levels of SBML will define a specific set of tie-breaking
algorithms and a mechanism for models to indicate which algorithm
should be applied during simulation.

Despite the absence of a specific tie-breaking algorithm, SBML
event simulation is constrained as follows. When an event $X$
\emph{fires} another event $Y$ and event $Y$ has zero delay then
event $Y$ is added to the existing set of simultaneous events that
are pending \emph{execution}.  Events such as $Y$ do not have a
special priority or ordering within the tie-breaking algorithm.
Events $X$ and $Y$ form a cascade of events at the same point in
simulation time.  All events in a model are open to being in a
cascade.  The position of an event in the event list does not
affect whether it can be in the cascade: $Y$ can be triggered
whether it is before or after $X$ in the list of events.  A
cascade of events can be infinite (never terminate).  When this
occurs a simulator should indicate this has occurred, i.e. it is
incorrect for the simulator to arbitrarily break the cascade and
continue the simulation without at least indicating the infinite
cascade occurred. A variable can change more than once when
processing simultaneous events at simulation time $t$.  The model
behavior (output) for such a variable is the value of the variable
at the end of processing all the simultaneous events at time $t$.


% -----------------------------------------------------------------------------
% chunks of text that maybe will be useful some day:
% -----------------------------------------------------------------------------

% Here it pays to reflect more carefully about what a reaction is.
% A reaction represents a process occuring over time.  the process
% acts on the reactants, transforming them in some way into the
% products.  the transformation may be anything from a change in
% the nature of the reactants to a simple relocation without any
% change to the nature of the reactants; for the purpose of talking
% about the speed of the reaction it does not matter.

% The ``kinetic law'' is a statement about the speed at which the
% process takes place, or more precisely, the frequency of the
% events occuring in this process.  It is by default in terms of
% moles per second, which has some intuitive appeal when dealing
% with chemical substances.  But notice that a ``mole'' is actually
% a statement about numbers of ``things'': it is 6.02e23 of whatever
% is involved.  In the case of chemical species, it is molecules of
% the substance.  To say ``one mole of'' is a shorthand way of
% saying ``6.02e23 molecules of''.  Thus, a reaction expressed as
% ``X moles per second'' is a statement that the process involves
% ``(X times 6.02e23) items per second''.

% 1 kg/sec is 1 kg/sec

% If in a reaction, the units of the species are the same as the
% reaction's substance units (default mole, redefinable by
% redefining ``substance''; sec section x), then the stoichiometries
% represent simply the ratios of the participating species: 1 mole
% of this to 2 moles of that, and so on.  If instead the species are
% given in different units, then the species quantities must be
% converted to be consistent with the units of the reaction.  Thus,
% the SBML stoichiometry may then have to incorporate a conversion:
% the stoichiometry will represent the product of the biochemical
% reaction stoichiometry and a ratio between the species substance
% and the reaction substance.

% don't forget units of reaction id
