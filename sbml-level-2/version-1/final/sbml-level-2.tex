\documentclass[10pt]{cekarticle}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{array}
\latexhtml{
  \usepackage[american]{varioref}
}{
  \newcommand{\vref}[1]{\ref{#1}}
}

% Miscellaneous macros.

\newcommand{\D}{\displaystyle}
\newcommand{\tm}{\textsuperscript{\tiny{\texttrademark}}}

\pagestyle{myheadings}
\markboth{\textbf{SBML Level 2 Proposal}}{\textbf{SBML Level 2 Proposal}}


\begin{document}

%=============================================================================
% Title page
%=============================================================================

\title{Systems Biology Markup Language (SBML) Level 2:\\
  Structures and Facilities for Model Definitions}

\author{Andrew Finney, Michael Hucka, Hamid Bolouri}

\authoremail{\{afinney,mhucka,hbolouri\}@cds.caltech.edu}

\address{Systems Biology Workbench Development Group\\
  ERATO Kitano Systems Biology Project\\
  Control and Dynamical Systems, MC 107-81\\
  California Institute of Technology, Pasadena, CA 91125, USA\\[3pt]
  \url{http://www.cds.caltech.edu/erato}}

\acknowledge{Principal Investigators: John Doyle and Hiroaki Kitano}

\date{SBML Level 2, Version 1, Proposal}

\maketitlepage


%=============================================================================
\section{Introduction}
\label{sec:introduction}
%=============================================================================

We present the \textbf{S}ystems \textbf{B}iology \textbf{M}arkup
\textbf{L}anguage (SBML) Level~2, a description language for
simulations in systems biology.  SBML is oriented towards
representing biochemical networks common in research on a number
of topics, including cell signaling pathways, metabolic pathways,
biochemical reactions, gene regulation, and many others.  By default SBML models are encoded using XML, the
eXtensible Markup Language~\citep{bosak:1999,bray:1998}.  This document contains many examples of SBML encoded in XML.

Releases of SBML are termed \emph{levels}.  SBML Level 2 evolved out of
SBML Level 1~\citep{hucka:2001}.  The structures of SBML Level 1
can be mapped in a straight forward fashion to SBML Level 2.  A large
subset of the structures in SBML Level 2 can be mapped to SBML Level 1.
A valid SBML Level 1 document is not a valid SBML Level 2 document and vice versa.

SBML Level 2 was the result of studying the features of the
following simulation systems: \emph{BioSpice}~\citep{arkin:2001},
\emph{Cellarator}~\citep{shapiro:2000},
\emph{COPASI}~\citep{mendes:2000},
\emph{DBSolve}~\citep{goryanin:2001,goryanin:1999},
\emph{E-Cell}~\citep{tomita:1999,tomita:2001},
\emph{Gepasi}~\citep{mendes:1997,mendes:2001},
\emph{Jarnac}~\citep{sauro:2000,sauro:1991},
\emph{NetBuilder}~\citep{schilstra:2002},
\emph{ProMot/DIVA} ~\citep{trankle:1997},
 \emph{StochSim}~\citep{bray:2001,morton-firth:1998},
and \emph{Virtual Cell}~\citep{schaff:2000,schaff:2001}. SBML was
developed with the help of the authors of these packages.  In addition SBML Level 2 was developed in close collaboration with the authors of CellML~\citep{Physiome:2001}.

We hope to finalize the final form of the core of SBML Level 2 in September 2002. Candidate extensions to SBML for inclusion in Level 2 are outlined in Appendix~\ref{apdx:extensions}.  We anticipate making a final decision on their inclusion in Level 2 at ICSB 2002 in December 2002.
%-----------------------------------------------------------------------------
\subsection{Scope and Limitations}
%-----------------------------------------------------------------------------

SBML Level 2 is meant to support non-spatial biochemical models
and the kinds of operations that are possible in existing
analysis/simulation tools.  Future software tools will undoubtedly require the
evolution of SBML; we expect that subsequent levels will add
additional structures and facilities currently missing from
Level~2, once the simulation community gains experience with the
current language definition. In Section~\ref{sec:level-3}, we
discuss extensions that will likely be included in SBML Level~3.

The definition of the model description language presented here does not
specify \emph{how} programs should communicate or read/write SBML.  We
assume that for a simulation program to communicate a model encoded in
SBML, the program will have to translate its internal data structures to
and from SBML, use a suitable transmission medium and protocol, etc., but
these issues are outside of the scope of this document.

%-----------------------------------------------------------------------------
\subsection{Differences between Level 1 Version 1 and Level 2}
%-----------------------------------------------------------------------------

The changes in SBML introduced in Level 2, given Level 1 Version 1
as a starting point, are:

\begin{itemize}
\item \attrib{formula} attributes on \class{KineticLaw} and
\class{Rule} elements are replaced by \class{math} elements as
defined in MathML~\citep{w3c:2000b}.  See
Sections~\ref{sec:formulas},~\ref{subsec:kinetic-law}
and~\ref{sec:rules}.  All new elements use MathML to describe
numerical expressions.  The MathML subset includes logical operators that enable the expression of discontinuous expressions.

\item New \attrib{id} fields replace \attrib{name} fields as the
fields identifying components in the model. The \attrib{id} field
has type \class{SId} (similar to \class{SName} in level 1).
\attrib{name}
 fields remain but are optional and are of type
string.  See Section~\ref{sec:idnameattribs}.

\item A new list of elements, \attrib{listOfModifiers}, is added
to the \class{Reaction} type.  This list contains those species
that affect the reaction but are neither created nor destroyed by
the reaction.  See Section~\ref{sec:reactions}.

\item All elements can be annotated with one optional
RDF~\citep{lassila:1999} element each using the form described in
the CellML Metadata specification~\citep{cuellar:2002}.  See
Section~\ref{sec:metadata}.  The placement of RDF elements is more
restricted than CellML.

\item \class{Model} has an optional list of global function
definitions, of type \class{MathDefinition}, which use MathML. See
Section~\ref{sec:functions}.

\item The main identifier namespace does not contain any built-in
symbols.  We use a MathML mechanism to refer to one built-in entitiy: a symbol representing time. See Section~\ref{sec:mathmltokens}.

\item Unit identifiers are in a separate namespace from the
namespace used for models, functions, species, compartments,
reactions and parameters.

\item \class{Compartment}, \class{Species} and \class{Parameter}
structures have boolean \attrib{constant} fields.  These fields
determine whether the variables represented by these structures
can be changed by rules and reactions.  See
Sections~\ref{sec:compartments}, \ref{sec:species}
and~\ref{sec:parameters}.

\item A model does not have to contain species, compartments or reactions. See section~\ref{sec:model}.

\item A reaction can have no products or no reactants but must
have at least one reactant or product.  See
Section~\ref{sec:reactions}.

\item The term `specie' has been replaced by `species' in all
element and attribute names.  There are no duplicate names that
contain `specie'.

\item A rule is not a substitute for a component definition, for
example a \class{Parameter} structure for a given identifier must
precede a \class{ParameterRule} structure for the same identifier.

\item The form of scalar rules is constrained.  See
Section~\ref{sec:rules}.

\item \class{ParameterRule} structures have the field
\attrib{parameter} (instead of \attrib{name}) which contains the
identifier for the parameter assigned a rate or value by the rule.
 See Section~\ref{sec:rules}.

\item \class{ParameterRule} structures no longer have a units
field.  The units of the parameter are given by the corresponding
\class{Parameter} structure.  See Section~\ref{sec:rules}.

\end{itemize}

%-----------------------------------------------------------------------------
\subsection{Notational Conventions}
%-----------------------------------------------------------------------------

SBML is intended to be a common XML-based format for encoding systems
biology models in a simple form that software tools can use as an exchange
format.  However, for easier communication to human readers, we define SBML
using a graphical notation based upon UML, the Unified Modeling
Language~\citep{eriksson:1998,oestereich:1999}.  This UML-based definition
in turn is used to define an XML
Schema~\citep{biron:2000,fallside:2000,thompson:2000} for SBML.  There are
three main advantages to using UML as a basis for defining SBML data
structures.  First, compared to using other notations or a programming
language, the UML visual representations are generally easier to grasp by
readers who are not computer scientists.  Second, the visual notation is
implementation-neutral: the defined structures can be encoded in any
concrete implementation language---not just XML, but C or Java as well.
Third, UML is a de facto industry standard that is documented in many
sources.  Readers are therefore more likely to be familiar with it than
other notations.

Our notation and our approach for mapping UML to XML Schemas is explained
in a separate document~\citep{hucka:2000b}.  A summary of the essential
points is presented in Appendix~\ref{apdx:notation}, and examples
throughout this document illustrate the approach.  We also follow certain
naming and typographical conventions throughout this document.
Specifically, the names of data structure attributes or fields begin with a
lowercase letter, and the names of data structures and types begin with an
uppercase letter.  Keywords (names of types, XML elements, etc.) are
written in a typewriter-style font; for example, \class{Compartment} is a
type name and \class{compartment} is a field name.  Likewise, literal XML
examples are also written in a typewriter-style font.


%=============================================================================
\section{Overview of SBML}
\label{sec:overview}
%=============================================================================

The following is an example of a simple, hypothetical biochemical network that
can be represented in SBML:
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    X_0 & \underrightarrow{k_1 X_0} & S_1 \\ \\[-4pt]
    S_1 & \underrightarrow{k_2 S_1} & X_1 \\ \\[-4pt]
    S_1 & \underrightarrow{k_3 S_1} & X_2
  \end{array}
\end{equation*}

Broken down into its constituents, this model contains a number of
components: reactant species, product species, reactions,
rate laws, and parameters in the rate laws.  To analyze or
simulate this network, additional components must be made
explicit, including compartments for the species, and units on the
various quantities.  The top level of an SBML model definition
simply consists of lists of these components:
\begin{center}
  \slshape
  \begin{tabular}{c}
    \begin{minipage}{3in}
      \begin{tabbing}
        xxxx\=xxxx\=xxxx\=xxxx\=\kill
        beginning of model definition\\
        \>list of math definitions (optional)\\
        \>list of unit definitions (optional)\\
        \>list of compartments (optional)\\
        \>list of species (optional)\\
        \>list of parameters (optional)\\
        \>list of rules (optional)\\
        \>list of reactions (optional)\\
        end of model definition
      \end{tabbing}
    \end{minipage}
  \end{tabular}
\end{center}
The meaning of each component is as follows:
\begin{description}

\item \emph{Math definition}: A math function definition for use
    throughout the rest of the model.

\item \emph{Unit definition}: A name for a unit used in the
expression of
  quantities in a model.  Units may be supplied in a number of contexts in
  an SBML model, and it is convenient to have a facility for both setting
  default units and for allowing combinations of units to be given
  abbreviated names.

\item \emph{Compartment}: A container of finite volume for substances. In
  SBML Level~2, a compartment is primarily a topological structure with a
  volume but no geometric qualities.

\item \emph{Species}: A substance or entity that takes part in a
reaction.
  Some example species are ions such as $\text{Ca}^{2++}$ and molecules
  such as glucose or ATP.  The primary qualities associated with a species
  in SBML Level~2 are its initial amount and the compartment in which it is
  located.

\item \emph{Reaction}: A statement describing some transformation,
  transport or binding process that can change the amount of one or more
  species.  For example, a reaction may describe how certain entities
  (reactants) are transformed into certain other entities (products).
  Reactions have associated rate laws describing how quickly they take
  place.

\item \emph{Parameter}: A quantity that has a symbolic name.  SBML
Level~2
  provides the ability to define parameters that are global to a model as
  well as parameters that are local to a single reaction.

\item \emph{Rule}: In SBML, a mathematical expression that is added
  to the differential equations constructed from the set of reactions and
  can be used to set parameter values, establish constraints between
  quantities, etc.

\end{description}

A software package can read a SBML model description and translate it
into its own internal format for model analysis.  For example, a package
might provide the ability to simulate the model, by constructing
differential equations representing the network and then performing
numerical time integration on the equations to explore the model's dynamic
behavior.

SBML allows models of arbitrary complexity to be represented.  Each type of
component in a model is described using a specific type of data structure
that organizes the relevant information.  The data structures determine how
the resulting model is encoded in XML.

In the sections that follow, the various constructs in SBML and
their uses are described in detail.  Section~\ref{sec:general}
first introduces a few basic structures that are used throughout
SBML Level 2, then Section~\ref{sec:elements} provides details on
each of the main components of SBML Level 2.
Section~\ref{sec:xml-rep} provides several complete examples of
models encoded in XML using SBML Level 2.

%=============================================================================
\section{Preliminary Definitions}
\label{sec:general}
%=============================================================================

This section covers certain constructs that are used repeatedly in
the rest of SBML Level 2 and are useful to discuss before diving
into the details of the components provided in SBML Level 2.

%-----------------------------------------------------------------------------
\subsection{Type \class{SBase}}
\label{sec:sbase}
%-----------------------------------------------------------------------------

Each of the main types composing an SBML Level 2 model definition
has a specific data type that is derived directly or indirectly
from a single base type called \class{SBase}.  This inheritance
hierarchy is depicted in Figure~\vref{fig:top-level}.

\begin{figure}[h]
  \vspace*{8pt}
  \centering
  \includegraphics[scale = 0.7]{top-level}
  \caption{A UML diagram of the inheritance hierarchy of major data types
    in SBML.  Open arrows indicate inheritance, pointing from inheritors to
    their parents~\citep{eriksson:1998,oestereich:1999}.}
  \label{fig:top-level}
\end{figure}

The definition of \class{SBase} is presented in
Figure~\vref{fig:identified}.

\begin{figure}[h]
  \centering
  \includegraphics[scale = 0.68]{identified}
  \caption{The definition of \class{SBase}.  Text enclosed in braces next
    to attribute types (i.e., \attribtype{\{minOccurs="1"\}}) indicates
    constraints on the possible attribute values; we use XML Schema
    language to express constraints since we are primarily interested in
    the XML encoding of SBML.}
  \label{fig:identified}
\end{figure}

\subsubsection{Metadata}
\label{sec:metadata}

Elements of type \class{SBase} can optionally contain a single RDF
\class{rdf} element as their first sub-element.  To support RDF
SBase has an optional field \attrib{metaid} of type \class{ID}.
RDF \class{description} elements can be created in which the
\attrib{describes} fields contain the values of the
\attrib{metaid} fields of SBML elements. The form of the RDF
element content should follow the form described in the CellML
Metadata Specification~\citep{cuellar:2002} with the restriction
that RDF elements can only occur as the first sub-element of any
SBase element. This restriction on RDF placement is designed to
simplify the parsing of SBML.

\subsubsection{Annotations}

The type \class{SBase} is designed to allow a modeler or a
software package to attach arbitrary information to each component
in an SBML model.  \class{SBase} contains two fields to support
the attachment of arbitrary information, both of which are
optional: \attrib{notes} and \attrib{annotations}. The field
\attrib{notes} is a container for XHTML content.  It is intended
for recording optional user-visible annotations.  Every data
object derived directly or indirectly from type \class{SBase} can
have a separate value for \attrib{notes}, allowing users
considerable freedom for annotating their models.  The second
field, \attrib{annotations}, is provided for software-generated
annotations.  It is a container for arbitrary data (XML type
\class{any}) and is intended to store information not intended for
human viewing.  As with the user-visible \attrib{notes} field,
every data object can have its own \attrib{annotations} value.

In other type definitions presented below, we follow the UML
convention of hiding the attributes derived from a parent type
such as \class{SBase}. It should be kept in mind that these
attributes are always available.

%-----------------------------------------------------------------------------
\subsection{Guidelines for the Use of the \attrib{annotations} Field in
  \class{SBase}}
%-----------------------------------------------------------------------------

The \attrib{annotations} field in the definition of \class{SBase} is
formally unconstrained in order that software developers may attach any
information they need to different components in an SBML model. However,
it is important that this facility not be misused accidentally.  In
particular, it is critical that information essential to a model definition
is \emph{not} stored in \attrib{annotations}.  Parameter values, functional
dependencies between model components, etc., should not be recorded as
annotations.

Here are examples of the kinds of data that may be appropriately
stored in \attrib{annotations}: (a) Information about graphical
layout of model components; (b) application-specific processing
instructions that do not change the essence of a model; (c)
bibliographic information pertaining to a given model; and (d)
identification information for cross-referencing components in a
model with items in a database.  (We expect to introduce an
explicit scheme for recording bibliographic information and making
database references in SBML Level~3, at which time using
annotations for these purposes will become unnecessary.)

Different applications may use XML Namespaces~\citep{bray:1999} to specify
the intended vocabulary of a particular annotation.  Here is an example of
this kind of usage.  Suppose that a particular application wants to
annotate data structures in an SBML model definition with screen layout
information and a time stamp.  The application developers should choose a
URI (\emph{Universal Resource Identifier}; \citealt{harold:2001,w3c:2000})
reference that uniquely identifies the vocabulary that the
application will use for such annotations, and a prefix string to be used
in the annotations.  For illustration purposes, let us say the URI
reference is ``\texttt{http://www.mysim.org/ns}'' and the prefix is
\texttt{mysim}.  An example of an annotation might then be as follows:

\begin{example}
...
<annotations xmlns:mysim="http://www.mysim.org/ns">
    <mysim:nodecolors mysim:bgcolor="green" mysim:fgcolor="white"/>
    <mysim:timestamp>2000-12-18 18:31 PST</mysim:timestamp>
</annotations>
...
\end{example}

The namespace prefix \texttt{mysim} is used to qualify the XML elements
\texttt{mysim:nodecolors} and \texttt{mysim:timestamp}; presumably these
symbols have meaning to the application.  This example places the XML
Namespace information on \attrib{annotations} itself rather than on a
higher-level enclosing construct or the enclosing document level, but other
placements would be valid as well~\citep{bray:1999}.

The use of XML Namespaces permits multiple applications to place
annotations on XML elements of a model without risking interference or
element name collisions.  Annotations stored by different simulation
packages can thus coexist in the same model definition.  Although XML
Namespace names (``\texttt{http://www.mysim.org/}'' in the example above)
must be URI references, an XML Namespace name is \emph{not required} to be
directly usable in the sense of identifying an actual, retrieval document
or resource on the Internet~\citep{bray:1999}.  The name is simply intended
to enable unique identification of constructs, and using URIs is a common
and simple way of creating a unique name string.  For the convenience of
the simulation tools developer community, we reserve certain namespace
names for use with annotations in SBML.  These reserved names are listed in
Table~\vref{tab:reserved-urls}.

\begin{table}[b]
  \vspace*{5pt}
  \centering
  \begin{tabular}{l}
    \toprule
    \texttt{http://www.sbml.org/2001/ns/biospice}\\
    \texttt{http://www.sbml.org/2001/ns/dbsolve}\\
    \texttt{http://www.sbml.org/2001/ns/ecell}\\
    \texttt{http://www.sbml.org/2001/ns/gepasi}\\
    \texttt{http://www.sbml.org/2001/ns/jarnac}\\
    \texttt{http://www.sbml.org/2001/ns/jdesigner}\\
    \texttt{http://www.sbml.org/2001/ns/stochsim}\\
    \texttt{http://www.sbml.org/2001/ns/vcell}\\
    \texttt{http://www.sbml.org/2002/ns/promot}\\
    \texttt{http://www.sbml.org/2002/ns/cellerator}\\
    \texttt{http://www.sbml.org/2002/ns/copasi}\\
    \texttt{http://www.sbml.org/2002/ns/netbuilder}\\
    \bottomrule
  \end{tabular}
  \caption{Reserved XML Namespace names in SBML Level 2.}
  \label{tab:reserved-urls}
\end{table}

Note that the namespaces being referred to here are XML Namespaces
specifically in the context of the \attrib{annotations} field on
\class{SBase}.  The namespace issue here is unrelated to the namespaces
discussed in Section~\ref{sec:namespaces} below in the context of
\class{SName} and symbols in SBML.

%-----------------------------------------------------------------------------
\subsection{\attrib{id} and \attrib{name} attributes on SBML components}

\label{sec:idnameattribs}
%-----------------------------------------------------------------------------

SBML components include two fields: \attrib{id} and \attrib{name}.
The \attrib{id} field is used to identify the component.  Other
SBML structures refer to a component using this identifier.
Section~\ref{sec:id} describes the form of this field.
Section~\ref{sec:namespaces} describes the scoping and namespace
rules for these identifiers.

The \attrib{name} field is a XML string field and is optional. The
only function of this field is to contain a humanly readable label
for the component and thus there are no restrictions as to its
content.  In user interfaces the \attrib{name} field should be
displayed to identify the component.  The \attrib{id} field can be
used as an alternative when either the \attrib{name} field is not
present or the user interface cannot support unconstrained XML
strings as component labels.  Systems automatically generating the
content of \attrib{id} field should be aware some parsers may
display the results to the user.  The \attrib{notes} sub-element
on \class{SBase} should be used for containing formatted data to
be associated with SBML elements (see Section ~\ref{sec:sbase}).

%-----------------------------------------------------------------------------
\subsection{Type \class{SId}}
\label{sec:id}
%-----------------------------------------------------------------------------

The type \class{SId} is the type of the \attrib{id} field in the
majority of component types where the component identifier has
global scope (see Section~\ref{sec:namespaces} for a description
of the scoping rules). \class{SId} is a data type derived from the
basic XML type \class{string}, but with restrictions about the
types of characters permitted and the sequence in which they may
appear. Its definition is shown in Figure~\vref{fig:id}.

\begin{figure}[th]
  \vspace*{10pt}
  \centering
  \begin{minipage}{3.8in}
\begin{verbatim}
  letter ::= 'a'..'z','A'..'Z'
  digit  ::= '0'..'9'
  nameChar ::= letter | digit | '_'
  name ::= (letter | '_'){nameChar}
\end{verbatim}
  \end{minipage}
  \caption{The definition of the type \class{SId} expressed in conventional
    Backus-Naur Form~\protect\citep{naur:1960}.  The meta symbols \{ and \} signify
    ``zero or more times'' the items they enclose.  Note that although XML
    permits the use of Unicode characters~\protect\citep{unicode:1996}, SBML
    limits the allowable characters in \class{SId} to plain ASCII text
    characters for compatibility with existing simulation software.}
  \label{fig:id}
\end{figure}

The \class{SId} is not derived from the XML \class{ID} type
because that would force all SBML identifiers to exist in a single
global namespace.  Use of the \class{ID} type for SBML identifiers
would affect the form of local parameter elements and proposed
modularity extensions.  Identifier namespaces are described in
more detail in section~\ref{sec:namespaces}.  Use of \class{ID}
type for SBML identifiers has limited utility as MathML \class{ci}
elements aren't of the type \class{IDREF} (see
Section~\ref{sec:formulas}).

%The type \class{SLocalId} is used in types where a component
%identifier does not have global scope thus \class{SLocalId} has
%the same syntax as \class{SId} but is derived from XML type
%{string}.

%-----------------------------------------------------------------------------
\subsection{Component Identifiers and Namespaces in SBML}
\label{sec:namespaces}
%-----------------------------------------------------------------------------

A biochemical network model can contain a large number of
components representing different parts of a model.  This leads to
a problem in deciding the scope of an identifer: in what contexts
does a given identifier \emph{X} represent the same thing?  The
approaches used in existing simulation packages tend to fall into
two categories that we may call global and local.  The
\emph{global} approach places all identifiers into a single global
namespace, so that an identifier \emph{X} represents the same thing
wherever it appears in a given model definition.  The \emph{local}
approach places symbols in different namespaces depending on the
context, where the context may be, for example, individual rate
laws.  The latter approach means that a user may use the same
identifer \emph{X} in different rate laws and have each instance
represent a different quantity.

The fact that different simulation programs may use different
rules for identifier resolution poses a problem for the exchange
of models between simulation tools.  Without careful
consideration, a model written out in SBML format by one program
may be misinterpreted by another program.  SBML Level 2 must
therefore include a specific set of rules for treating identifer
and namespaces.

The namespace rules in SBML Level 2 are relatively straightforward
and are intended to avoid this problem with a minimum of
requirements on the implementation of software tools:
\begin{itemize}

\item The identifiers of functions, compartments, species,
reactions and model-level parameters reside in the same global
namespace. This means, for example, that a reaction and a species
definition cannot both have the same identifier.

\item Each reaction definition (see Section~\ref{sec:reactions})
  establishes a private local namespace for local parameter identifiers. Within the
  definition of a given reaction, local parameter identifiers introduced in that
  reaction override (shadow) identical identifers in the global namespace.

\item Unit components exist in a separate global namespace from
other identifiers.

\end{itemize}

The set of rules above can enable software packages using either
local or global namespaces for parameters to exchange SBML model definitions. In particular, software environments using local namespaces for parameters
internally should be able to accept SBML model definitions without
needing to change component identifiers. Environments using a
global namespace for parameters internally can perform a simple manipulation of the identifiers of local parameter elements within reaction definitions to avoid name collisions.  (An example approach for the latter would be the
following: when receiving an SBML-encoded model, prefix each
parameter identifier inside each reaction with a string constructed from the
reaction's identifier; when writing an SBML-encoded model, strip
off the prefix.)

The namespace rules described here provide a clean transition path
to future levels of SBML, when submodels are introduced
(Section~\ref{sec:level-3}).  Submodels will provide the ability
to compose one model from a collection of other models.  This
capability will have to be built on top of SBML Level~2's
namespace organization.  A straightforward approach to handling
namespaces is to make each submodel's space be private.  The rules
governing namespaces within a submodel can simply be the Level~2
namespace rule described here, with each submodel having its own
(to itself, global) namespace.

%-----------------------------------------------------------------------------
\subsection{Math}
\label{sec:formulas}
%-----------------------------------------------------------------------------

Math in SBML Level 2 is expressed using MathML~\citep{w3c:2000b}.
It is used in the definitions of functions
(Section~\ref{sec:functions}), kinetic laws
(Section~\ref{subsec:kinetic-law}), and rules (Section~\ref{sec:rules}).
The \class{KineticLaw} and \class{Rule} types have
\class{math} subelements.  A function definition has a single
MathML \class{lambda} subelement. The URI
\texttt{http://www.w3.org/1998/Math/MathML} namespace should be used as the namespace for these MathML elements.  A W3C
document~\citep{bray:1999} describes the general form for
declaring and using XML namespaces.

Only the elements contained in the CellML subset of MathML, with
the addition of \class{csymbol}, can be used within the MathML
\class{math} and \class{lambda} elements. The SBML MathML subset
is as follows:

\begin{itemize}

\item \emph{token} \class{cn}, \class{ci}, \class{csymbol}

\item \emph{basic content} \class{apply}, \class{piecewise},
\class{piece}, \class{otherwise}

\item \emph{relational operators}
            \class{eq}, \class{neq}, \class{gt}, \class{lt}, \class{geq}, \class{leq}

\item \emph{arithmetic operators}
            \class{plus}, \class{minus}, \class{times},
            \class{divide}, \class{power}, \class{root},
            \class{abs}, \class{exp}, \class{ln}, \class{log},
            \class{floor}, \class{ceiling}, \class{factorial}

\item \emph{logical operators}
            \class{and}, \class{or}, \class{xor}, \class{not}

\item \emph{calculus}
            \class{diff}

\item \emph{qualifiers}
            \class{degree}, \class{bvar}, \class{logbase}

\item \emph{trigonometric operators}
            \class{sin}, \class{cos}, \class{tan}, \class{sec},
            \class{csc}, \class{cot}, \class{sinh}, \class{cosh},
            \class{tanh}, \class{sech}, \class{csch},
            \class{coth}, \class{arcsin}, \class{arccos},
            \class{arctan}, \class{arccosh}, \class{arccot}, \class{arccoth},
            \class{arccsc}, \class{arccsc}, \class{arcsec},
            \class{arcsech}, \class{arcsinh}, \class{arctanh}

\item \emph{constants}
            \class{true}, \class{false}, \class{notanumber},
            \class{pi}, \class{infinity}, \class{exponentiale}

\item \emph{annotation}
            \class{semantics}, \class{annotation},
            \class{annotation-xml}
\end{itemize}

The inclusion of the logical operator, relational operator, \class{piecewise}, \class{piece} and \class{otherwise} elements facilitates the encoding of discontinuous expressions.  Elements for representing partial differential calculus are not included.  Its is anticipated that the requirement for partial differential calculus will be addressed in proposals for SBML Level 3 geometry representations (see Section~\ref{sec:level-3}).

\subsubsection{Use of token elements in MathML}
\label{sec:mathmltokens}
MathML whitespace rules apply to the content of \class{ci}
elements. The content of \class{ci} should always be a declared
identifier.  The set of possible identifiers depends on the
containing structure.  In the case of math function definitions
the content of \class{ci} elements is restricted to the declared
arguments and previously declared functions. In all other cases
the content of \class{ci} elements can be identifers of math
functions, parameters, compartments or species i.e. the content
should match the value of an \attrib{id} field of a component.
When a specie identifier occurs in a \class{ci} element, it
represents the concentration (i.e., $substance/volume$) of the
specie. When a compartment identifier occurs in a \class{ci}
element, it represents the volume of the compartment. The units of
substance and volume are determined from the built-in
\texttt{substance} and \texttt{volume} of
Table~\vref{tab:builtin}.

SBML Level 2 uses the MathML \class{csymbol} element to represent
standardized math entities without introducing built-in
identifiers into the component identifier namespace.  The
\attrib{encoding} field of \class{csymbol} should be set to
\texttt{SBML}.  The \attrib{definitionURL} should be set to one
member of the set of the predefined SBML symbol URLs.  It is not
necessary for a parser to access the resource pointed to by the
URL: in this context the URL should be interpreted as a URI.  The
content of the \class{csymbol} element is for rendering purposes
only and can be ignored by a parser.

In SBML Level 2 there is one URL in the set of predefined SBML symbols:
 \texttt{http://www.sbml.org/symbols/time}, which represents the
current simulation time.  The units of this entity is determined
from the built-in \texttt{time} of Table~\vref{tab:builtin}.

As an example the following XML fragment encodes the equation $x + t$
where $t$ is the built-in symbol for time.

\begin{example}
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <apply>
        <add/>
        <ci> x </ci>
        <csymbol encoding="SBML"
                    definitionURL="http://www.sbml.org/symbols/time">
            t
        </csymbol>
    </apply>
</math>
\end{example}

%-----------------------------------------------------------------------
\subsection{Valid Headers for SBML Level 2}
\label{sec:header}
%-----------------------------------------------------------------------------
An SBML Level 2 XML document consists of a single \class{sbml}
element enclosing a single \class{model} element.  The namespace
URI for SBML Level 2 is \texttt{http://www.sbml.org/sbml/level2}.

The SBML element has two attributes: \attrib{version} and
\attrib{level}.  For the SBML described in this document these
attributes should be set to 1 and 2 respectively.  As an example a
valid header for SBML Level 2 is a follows:

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2">
\end{example}

%=============================================================================
\section{SBML Components}
\label{sec:elements}
%=============================================================================

In this section, we define each of the major data structures in SBML. To
provide illustrations of their use, we give partial XML encodings of SBML
model components, but we leave full XML examples to
Section~\ref{sec:xml-rep}.


%-----------------------------------------------------------------------------
\subsection{Models}
\label{sec:model}
%-----------------------------------------------------------------------------

The \class{Model} structure is the highest-level construct in an
SBML data stream or document.  It defines a grouping of
components---the list of math definitions, compartments, species,
reactions, parameters, rules and unit definitions that
define a given model. Only one component of type \class{Model} is
allowed per instance of an SBML document or data stream, although
it does not necessarily need to represent a single biological
entity.  The UML definition of the \class{Model} structure is
shown in Figure~\vref{fig:model}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{model}
  \caption{The definition of \class{Model}.  Additional fields are
    inherited from \class{SBase}.}
  \label{fig:model}
\end{figure}

A \class{Model} data object may optionally have lists of \class{Species}, \class{Compartment}, \class{MathDefinition}, \class{UnitDefinition}, \class{Parameter}, \class{Reaction}, and \class{Rule} components (they are optional because the lists in fields \attrib{species}, \attrib{compartment}, \attrib{mathDefinition}, \attrib{unitDefinition}, \attrib{parameter}, \attrib{reaction}, and \attrib{rule} are permitted to have zero length).

A model may also have an optional \attrib{id} field that can be
used to assign the model an identifier. The identifier must be a
text string conforming to the syntax permitted by the \class{SId}
data type described in Section~\ref{sec:id}. A model also has an
optional string field \attrib{name}.  The \attrib{name} and
\attrib{id} fields should be used as described in
section~\ref{sec:idnameattribs}.

In the XML encoding of an SBML model, the lists of species,
compartments, and optional unit definitions, parameters,
reactions, math definitions and rules, are translated into
lists of XML elements that each have headings of the form
\class{listOf}\rule{0.5in}{0.5pt}\class{s}, where the blank is
replaced by the name of the component type (e.g.,
``\texttt{Reaction}'').  The resulting XML data object has the
form illustrated by the following skeletal model:

\begin{example}
<model id="My_Model">
    <listOfMathDefinitions>
        ...
    </listOfMathDefintions>
    <listOfUnitDefinitions>
        ...
    </listOfUnitDefinitions>
    <listOfCompartments>
        ...
    </listOfCompartments>
    <listOfSpecies>
        ...
    </listOfSpecies>
    <listOfParameters>
        ...
    </listOfParameters>
    <listOfRules>
        ...
    </listOfRules>
    <listOfReactions>
        ...
    </listOfReactions>
</model>
\end{example}

Readers may wonder about the motivations for the
\class{listOf}\rule{0.5in}{0.5pt}\class{s} notation.  A simpler approach to
creating the lists of components would be to place them all directly
at the top level under \texttt{<model> ... </model>}.  We chose instead to
group them within XML elements named after
\class{listOf}\rule{0.5in}{0.5pt}\class{s}, because we believe this helps
organize the components and makes visual reading of model definitions
easier.

%-----------------------------------------------------------------------------
\subsection{Math Definitions}
\label{sec:functions}
%-----------------------------------------------------------------------------

The \class{MathDefinition} data structure associates an identifier
with a function.  The function can be used in any subsequent
MathML \class{apply} element.  The definition of
\class{MathDefinition} is shown in
Figure~\vref{fig:mathdefinition}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{mathdefinition}
  \caption{The definition of \class{MathDefinition}.}
  \label{fig:mathdefinition}
\end{figure}

The \class{MathDefinition} has three fields, \attrib{id},
\attrib{name} and \attrib{math:lambda}. The \attrib{id} and
\attrib{name} fields operate in the manner described in
section~\ref{sec:idnameattribs}.  \attrib{id} is a \class{SId}
field and \attrib{name} is an optional string field. MathML
elements can refer to the function contained in a
\class{MathDefinition} using the value of the \attrib{id} field.
The \attrib{math:lambda} field is a MathML \class{lambda} element
which defines the function associated with the \attrib{id} field.
The function is only available for use in subsequent MathML
elements.

The following is an example of a \class{MathDefinition} element,
which defines the function $pow3(x)$ to be $x^{3}$:

\begin{example}
<mathDefinition id="pow3">
    <lamdba xmlns="http://www.w3.org/1998/Math/MathML">
        <bvar><ci> x </ci></bvar>
        <apply>
            <power/>
            <ci> x </ci>
            <cn> 3 </cn>
        </apply>
    </lamdba>
</mathDefinition>
\end{example}

In future levels of SBML the set of possible subelements of the
MathDefinition could be extended to other MathML elements.  In
SBML Level 2 simple symbol declarations, other than functions
declarations, should be made using \class{Parameter} structures (see Section~\ref{sec:parameters}).

%-----------------------------------------------------------------------------
\subsection{Unit Definitions}
\label{sec:unitdefinitions}
%-----------------------------------------------------------------------------

Units may be supplied in a number of contexts in an SBML model.  A
facility for defining units is convenient to have so that
combinations of units can be given abbreviated names.  This is the
motivation behind the \class{UnitDefinition} data structure, whose
definition is shown in Figure~\vref{fig:unitdefinition}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{unitdefinition}
  \caption{The definition of \class{UnitDefinition}.}
  \label{fig:unitdefinition}
\end{figure}

A unit definition consists of a \attrib{id} field of type
\class{SId}, an optional string field \attrib{name} and an
optional list of structures of type \class{Unit}. The identifiers
defined in the \attrib{id} field are in a separate global
namespace from identifiers for species, compartments, reactions
etc.

The approach to defining units in SBML is compositional; for
example, $meter\ second^{\,-2}$ is constructed by combining a
\class{Unit}-type element representing $meter$ with a
\class{Unit}-type element representing $second^{\,-2}$.  The
\class{Unit} data structure has a \attrib{kind} field whose value
must be taken from \class{UnitKind}, an enumeration of SI units.
The possible values of \class{UnitKind} are listed in
Table~\vref{tab:unitkind}.  The \attrib{exponent} field on
\class{Unit} represents an exponent on the unit.  Its default
value is ``\attribvalue{1}'' (one).  In the example just
mentioned, $second^{\,-2}$ is obtained by using
\texttt{kind="second"} and \texttt{exponent="-2"}. Finally, the
\attrib{scale} field in \class{Unit} is an integer attribute that
scales the unit.  For example, a unit that has a \attrib{kind}
value of ``\texttt{gram}'' and a \attrib{scale} value of
``\texttt{$-3$}'' signifies $10^{-3} * gram$, or milligrams.

\begin{table}[thb]
  \centering
%  \vspace*{5pt}
  \ttfamily
  \begin{tabular}{llllll}
    \toprule
    ampere      & farad & joule     & lumen     & ohm     & steradian\\
    becquerel   & gram  & katal     & lux       & pascal  & tesla\\
    candela & gray  & kelvin    & meter     & radian  & volt\\
    celsius     & henry & kilogram  & metre     & second  & watt\\
    coulomb & hertz & liter     & mole      & siemens & weber\\
    \underline{dimensionless} & \underline{item} & litre    & newton    & sievert\\
    \bottomrule
  \end{tabular}
  \caption{The possible values of \attrib{kind} in a \class{UnitKind}
    structure.  All are names of base or derived SI units, except for
    ``\texttt{dimensionless}'' and ``\texttt{item}'', which are
    SBML additions important for handling certain common cases.
    ``\texttt{Dimensionless}'' is intended for cases where a quantity does not
    have units, and ``\texttt{item}'' is  needed in certain contexts to express
    such things as ``N items'' (e.g., ``100 molecules'').
    Strictly speaking, ``\texttt{celsius}'' should be capitalized; however,
    for simplicity, SBML requires that the values of \class{UnitKind} be
    treated in a case-insensitive manner by software reading and writing SBML.
    Also, note that the gram and liter/litre are not
    strictly part of SI~\protect\citep{taylor:1995}; however, they are so
    useful in SBML's areas of application that they are included in the
    \class{UnitKind} enumeration of unit names.  (The standard SI unit of
    mass is in fact the kilogram, and volume is
    defined in terms of cubic meters.)}
  \label{tab:unitkind}
\end{table}

Unit combinations are constructed by listing several \class{Unit}
structures inside a \class{UnitDefinition}-type structure.  The following
example illustrates the definition of an abbreviation named
``\texttt{mmls}'' for the units $mmol\ l^{-1}\ s^{-1}$:

\begin{example}
<listOfUnitDefinitions>
    <unitDefinition id="mmls">
        <listOfUnits>
            <unit kind="mole"   scale="-3"/>
            <unit kind="litre"  exponent="-1"/>
            <unit kind="second" exponent="-1"/>
        </listOfUnits>
    </unitDefinition>
</listOfUnitDefinitions>
\end{example}

Many of the components in a model refer to quantities that have
associated units.  SBML Level~2 has three predefined quantity
types: amount of substance, time, and volume.  SBML defines
default units and scales for these quantities.  The defaults are
summarized in Table~\vref{tab:builtin}.

\begin{table}[htb]
  \vspace*{8pt}
  \centering
  \begin{tabular}{lllc}
    \toprule
    \textbf{Name} & \textbf{Allowable Units} & \textbf{Default Units} & \textbf{Default Scale} \\
    \midrule
    \texttt{substance} & moles or no. of molecules & moles            & 1 \\
    \texttt{time}      & seconds                   & seconds          & 1 \\
    \texttt{volume}    & liters                    & liters           & 1 \\
    \bottomrule
  \end{tabular}
  \caption{SBML's built-in quantities and their default
    scale values.  The names in the left-hand column are reserved. These
    names may be used wherever
    units may be supplied in a model component.}
  \label{tab:builtin}
\end{table}

% FIXME the caption above says the units are in tab:unitkind, but aren't.

Wherever unit specifications are permitted in a model (for example, for the
volume in a compartment), the relevant built-in name from
Table~\vref{tab:builtin} may be used.  Such usage signifies that the units
to be used for the quantity should be the designated defaults.  A model may
change the default scales by reassigning the keywords
``\texttt{substance}'', ``\texttt{time}'', and ``\texttt{volume}'' in a
unit definition.  This takes advantage of the \class{UnitDefinition}
structure's facility for defining scales on units.  The following example
changes the default units of volume to be milliliters:

\begin{example}
<model>
    ...
    <listOfUnitDefinitions>
        <unitDefinition id="volume">
            <listOfUnits>
                <unit kind="liters" scale="-3"/>
            </listOfUnits>
        </unitDefinition>
    </listOfUnitDefinitions>
    ...
</model>
\end{example}

If the definition above appeared in a model, the volume scale on all
components that did not explicitly use different units would be changed to
milliliters.

The list of unit definitions in a \class{Model}-type structure is the only
place where new units can be defined.  The new unit names may be used
anywhere in a model where unit specifications are permitted.  The various
components of a model, such as reaction parameters and rules, can only use
the base units from Table~\ref{tab:unitkind}, the global unit definitions
in the model, or the three predefined keywords ``\texttt{substance}'',
``\texttt{time}'', and ``\texttt{volume}''.

%-----------------------------------------------------------------------------
\subsection{Compartments}
\label{sec:compartments}
%-----------------------------------------------------------------------------

A \class{Compartment} represents a bounded container in which
species are located.  The definition of \class{Compartment} is
shown in Figure~\vref{fig:compartment}.

\begin{figure}[htb]
  \vspace*{8pt}
  \centering
  \includegraphics[scale = 0.68]{compartment}
  \caption{The definition of \class{Compartment}.
    Fields inherited from \class{SBase} are omitted here but are assumed.}
  \label{fig:compartment}
\end{figure}

A \class{Compartment} data object has an \attrib{id} field of type
\class{SId} and an optional \attrib{name} field of XML type
\class{string}. A compartment also has a floating-point field
called \attrib{volume}, representing the total volume of the
compartment in the default units of volume. (See
Table~\vref{tab:builtin}.) This enables concentrations of species
to be calculated in the absence of geometry information. The
\attrib{volume} field is optional and defaults to a value of
``\texttt{1}'' (one).

A \class{Compartment} structure has an optional \attrib{constant}
boolean field which indicates whether the compartment's volume can
vary during the simulation.  A \texttt{false} value indicates that
the compartment's volume can be determined by rules.
The default value for the \attrib{constant} field is
\texttt{true}.

The units of volume may be explicitly set using the optional field
\attrib{units} in \class{Compartment}; the named units must be either one
of the base units from Table~\vref{tab:unitkind}, the built-in default
named \attrib{volume}, or a new unit defined by a unit definition in the
enclosing model.  If absent, the units default to the value set by the
built-in \attrib{volume} of Table~\ref{tab:builtin}.

In an XML data stream containing an SBML model, compartments are listed
inside an XML element called \attrib{listOfCompartments} within a
\class{Model}-type data structure.  (See the discussion of \class{Model} in
Section~\ref{sec:model}.)  The following example illustrates two
compartments in an abbreviated SBML example of a model definition:

\begin{example}
<model>
    ...
    <listOfCompartments>
        <compartment id="cytosol" volume="2.5"/>
        <compartment id="mitochondria" volume="0.3"/>
    </listOfCompartments>
    ...
</model>
\end{example}

On the \class{Compartment} structure the optional field \attrib{outside} of type \class{SId} can be used to express containment relationships between compartments. If present, the value of \attrib{outside} for a given compartment should be the identifier of the compartment enclosing it, or in other words, the compartment that is ``outside'' of it.  This facility can be used to model cell membranes.  For example, to express that a compartment B has a membrane that is modeled as another compartment M, which in turn is located within another compartment A, one would write:
\begin{example}
<model>
    ...
    <listOfCompartments>
        <compartment id="A"/>
        <compartment id="M" outside="A"/>
        <compartment id="B" outside="M"/>
    </listOfCompartments>
    ...
</model>
\end{example}

In the absence of a value for \attrib{outside}, compartment
definitions in SBML Level~2 do not have any implied spatial
relationships between each other.  Thus, compartments may be
adjacent to each other or have other spatial relationships.  For
many modeling applications, the transfer of substances described
by the reactions in a model sufficiently express the relationships
between the compartments.  (SBML Level~2 currently does not
provide for spatial characteristics aside from compartment volume
and containment.  As discussed in Section~\ref{sec:level-3}, we
expect that SBML Level~3 will introduce the ability to define
geometries and spatial qualities.)


%-----------------------------------------------------------------------------
\subsection{Species}
\label{sec:species}
%-----------------------------------------------------------------------------

The term \emph{species} refers to entities that take part in
reactions. These include simple ions (e.g., protons, calcium),
simple molecules (e.g., glucose, ATP), and large molecules (e.g.,
RNA, polysaccharides, and proteins).  The \class{Species} data
structure is intended to represent these entities.  Its definition
is shown in Figure~\vref{fig:species}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{specie}
  \caption{The definition of \class{Species}.  As usual, fields inherited from
    \class{SBase} are omitted here but are assumed.}
  \label{fig:species}
\end{figure}

\class{Species} has an \attrib{id} field of type \class{SId} and
optional \attrib{name} field of XML type \class{string}. The field
\attrib{compartment}, also of type \class{SId}, is used to
identify the compartment in which the species is located. The
field \attrib{initialAmount}, of type \class{double}, is used to
set the initial amount of the species in the named compartment.
The units of the substance quantity may be explicitly set using
the optional field \attrib{units}. The value assigned to
\attrib{units} must be chosen from one of the following
possibilities: one of base unit names from
Table~\vref{tab:unitkind}, the name ``\attrib{substance}'', or a new
unit name defined by a unit definition in the enclosing model.  If
absent, the units default to the value set by the built-in
``\attrib{substance}'' of Table~\vref{tab:builtin}.

A \class{Species} structure has an optional \attrib{constant}
boolean field which indicates whether the concentration of the species
can vary during the simulation.  A \texttt{false} value indicates
that the species' concentration can be determined by rules
and reactions. The default value for the \attrib{constant} field
is \texttt{false}.

By default when a species is a product or reactant of one or more reactions the concentration of a species is determined by those reactions.  In SBML it is possible to indicate that a given species concentration is not determined by the set of reactions even when that species occurs as a product or reactant i.e. the species is on the boundary of the reaction system but is a component of the rest of the model. The optional boolean field \attrib{boundaryCondition} indicates that the given species is on the boundary of the reaction system. \attrib{boundaryCondition} defaults to a value of ``\texttt{false}'', indicating that by default, the species is part of the reaction system. Table~\ref{tab:specieattrib} shows how the combined values of the \attrib{boundaryCondition} and \attrib{constant} fields on the \class{Species} structure should be interpreted.  In practice the \attrib{boundaryCondition} attribute means that a differential equation, that is derived from the reaction system, should not be generated for the species.

\begin{table}[h]
  \vspace*{8pt}
  \centering
  \begin{tabular}{lllll}
    \toprule
    \textbf{\attrib{constant}} & \textbf{\attrib{boundaryCondition}} &
    \textbf{can have} & \textbf{can be} & \textbf{concentration} \\
    \textbf{value} & \textbf{value} & \textbf{assignment} & \textbf{reactant or} & \textbf{is changed by} \\
    & & \textbf{rule} & \textbf{product}\\
    \midrule
    true & true & no & yes & never changes\\
    false & true & yes & yes & rule \\
    true & false & no & no & never changes \\
    false & false & yes & yes & reactions or rule but not both \\
    \bottomrule
  \end{tabular}
  \caption{The Interpretation of the \attrib{constant} and
    \attrib{boundaryCondition} attributes on the \class{Species} structure.}
  \label{tab:specieattrib}
\end{table}

On the \class{Species} structure the optional field \attrib{charge} is an integer indicating the charge on the species (in terms of electrons, not the SI unit Coulombs). This may be useful when the species involved is a charged ion such as calcium ($\text{Ca}^{2++}$).

The following example shows two species definitions within an
abbreviated SBML model definition.  The example shows that species
are listed under the heading \attrib{listOfSpecies} in the model:

\begin{example}
<model>
    ...
    <listOfSpecies>
        <species id="Glucose" compartment="cell" initialAmount="4"/>
        <species id="Glucose_6_P" compartment="cell" initialAmount="0.75"/>
    </listOfSpecies>
    ...
</model>

\end{example}

%-----------------------------------------------------------------------------
\subsection{Parameters}
\label{sec:parameters}
%-----------------------------------------------------------------------------

A \class{Parameter} structure is used to declare a variable for
use in MathML structures. Whilst a parameter is a variable, by
default it is constant for the duration of a simulation.  The
definition of \class{Parameter} is shown in
Figure~\vref{fig:parameter}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{parameter}
  \caption{The definition of \class{Parameter}.}
  \label{fig:parameter}
\end{figure}

\class{Parameter} has an \attrib{id} field of type \class{SId} and
an optional \attrib{name} field of XML type \class{string}. The
symbol in the \attrib{id} field represents the parameter.  The
field \attrib{value} determines the value (of type \class{double})
assigned to the identifer.  The units of the parameter
\attrib{value} are specified by the optional field \attrib{units}.
The value assigned to \attrib{units} must be chosen from one of
the following possibilities: one of base unit names from
Table~\vref{tab:unitkind}; one of the three names
``\attribvalue{substance}'', ``\attribvalue{time}'', or
``\attrib{volume}'' (see Table~\ref{tab:builtin}); or the name of
a new unit defined in the list of unit definitions in the
enclosing \class{Model} structure.

A \class{Parameter} structure has an optional \attrib{constant}
boolean field which indicates whether the parameter's value can
vary during the simulation.  A \texttt{false} value indicates that
the parameter's value can be determined by rules.  The
default value for the \attrib{constant} field is \texttt{true}.

Parameters are used in two places in SBML: in lists of parameters defined
at the top level in a \class{Model}-type structure, and within individual
reaction definitions.  Parameters defined at the top level are
\emph{global} to the whole model; parameters that are defined within
a reaction are local to the particular reaction and (within that reaction)
\emph{override} any global parameters having the same names.  (See
Section~\ref{sec:namespaces} for further details.)

The following is an example of parameters defined at the \class{Model} level:

\begin{example}
<model>
    ...
    <listOfSpecies>
        ...
    </listOfSpecies>
    <listOfParameters>
        <parameter id="Km1" value="2.3" units="second"/>
        <parameter id="Km2" value="10.7" units="second"/>
    </listOfParameters>
    <listOfReactions>
        ...
    </listOfReactions>
    ...
</model>
\end{example}

%-----------------------------------------------------------------------------
\subsection{Rules}
\label{sec:rules}
%-----------------------------------------------------------------------------

In SBML, \emph{rules} provide a way to create constraints on
variables for cases in which the constraints cannot be expressed
using the reaction components (Section~\ref{sec:reactions}). There
are three different possible functional forms of rules,
corresponding to the following three general cases, where $x$ is a
variable, $f$ is some arbitrary function, and $X$ is the vector of
variables:

\begin{center}
\begin{tabular}{ll}
  \emph{Algebraic} rules, left-hand side is zero:             & $0 = f(X)$\\
  \emph{Scalar} rules, left-hand side is a scalar:         & $x = f(X)$\\
  \emph{Rate} rules, left-hand side is a rate-of-change: & $dx/dt = f(X)$
\end{tabular}
\end{center}

The vector of variables consists of the set of species,
compartments and parameters.  

SBML specifically does not specify the form of the algorithms that can be applied to rules and reactions.  For example SBML does not specify when or how often rules should be evaluated.  The constraints described by rules and kinetic rate laws are meant to apply collectively to the set of variable values for a specific time.

As written above there is little to distinguish between \emph{scalar} and \emph{algebraic} rules however \emph{scalar} rules are constrained to eliminate algebraic loops amongst the set of \emph{scalar} rules. The constraints on rules are described in more detail in Section~\ref{sec:ruleconstraints}. The distinction between the 
\emph{algebraic} and \emph{scalar} rules is useful for the following reasons:
\begin{itemize}
\item \emph{scalar} rules can be simply evaluated to calculate values for input into numeric methods.
\item some simulators don't contain solvers capable of solving unconstrained \emph{algebraic} equations,
\item those simulators that can solve these \emph{algebraic} equations do make
a distinction between these categories and
\item some specialized numeric analyses of models may only be applicable to models that don't contain \emph{algebraic} rules.
\end{itemize}

\emph{Scalar} and \emph{rate} rules are collectively referred to as \emph{assignment} rules.  \emph{Assignment} rules can be categorized by the role of the variable $x$ in the
equations above: $x$ can be the name of a compartment (to
constrain its volume), the name of a species (to constrain its
concentration), or a parameter name (to constrain its value).

The approach taken to covering these forms of equations in SBML is to define an
abstract \class{Rule} structure that contains just one field,
\attrib{math}, to hold the right-hand side expression, then to
derive subtypes of \class{Rule} that add fields to cover the
various cases above. Figure~\vref{fig:rules} gives the definitions
of \class{Rule} and the subtypes derived from it.  The figure
shows that \class{AlgebraicRule} is defined directly from
\class{Rule}, whereas \class{CompartmentVolumeRule},
\class{SpeciesConcentrationRule}, and \class{ParameterRule} are
all derived from an intermediate abstract structure called
\class{AssignmentRule}.  \class{AlgebraicRule} represents \emph{algebric} rules whereas \class{AssignmentRule} represents \emph{assignment} rules.

The \attrib{math} field consists of a MathML \class{math}
subelement.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{rule}
  \caption{The definition of \class{Rule} and derived types.}
  \label{fig:rules}
\end{figure}

The \attrib{type} field introduced in \class{AssignmentRule} is an
enumeration of type \class{RuleType} that determines whether a
rule falls into the \emph{scalar} or {rate} categories. In
SBML Level~2, the enumeration has two possible values:
``\class{scalar}'' and ``\class{rate}''.  The former means that
the expression has a scalar value on the left-hand side (i.e., $x
= f(X)$); the latter means that
the expression has a rate of change differential on the left-hand
side (i.e. $\frac{d x}{d t} = f(X)$). Future releases of SBML may
add to the possible values of \class{RuleType}.

\subsubsection{\class{AlgebraicRule}}

The rule type \class{AlgebraicRule} is used to express equations
whose left-hand sides are zero.  \class{AlgebraicRule} does not
add any fields to the basic \class{Rule}; its role is simply to
distinguish this case from the other cases.  An example of the use
of \class{AlgebraicRule} structures is given in
Section~\ref{sec:algeraiceg}.

\subsubsection{\class{SpeciesConcentrationRule}}

The \class{SpeciesConcentrationRule} structure adds one field,
\attrib{species}, to the basic \class{AssignmentRule} type.  The
field \attrib{species} has type \class{SId} and is used to
identify the species affected by the rule.  The effect of the rule
depends on the value of \attrib{type}: if the value is
``\class{scalar}'', the rule sets the referenced species's
concentration to the value determined by the formula; if the value
is ``\class{rate}'', the rule sets the rate of change of the
species's concentration to the value determined by the formula.
The units are in terms of $substance/volume$, where the
$substance$ units are those that are declared on the referenced
\class{Species} element, and the $volume$ units are those declared
on the \class{compartment} element that contains the
\class{Species}.

A \class{SpeciesConcentrationRule} structure and a
\class{SpeciesReference} structure (see
Section~\ref{sec:reactions}) cannot have the same \attrib{species}
attribute value.  This means that a rule cannot be defined for a
species that is created or destroyed in a reaction.  The only
exception is when the given species is a boundary condition i.e.
on the \class{Species} structure that defines the specie the
\attrib{boundaryCondition} field is set to ``\texttt{true}''.

Section~\ref{apdx:rules-eg} contains a model with a
\class{SpeciesConcentrationRule} structure.

\subsubsection{\class{CompartmentVolumeRule}}

The \class{CompartmentVolumeRule} structure adds one field,
\attrib{compartment}, to the basic \class{AssignmentRule} type.
The field \attrib{compartment} has type \class{SId} and is used to
identify the compartment affected by the assignment.  The effect
of the rule depends on the value of \attrib{type}: if the type is
``\class{scalar}'', the rule sets the referenced compartment's
volume to the volume determined by the formula; if the type is
``\class{rate}'', the rule sets the rate of change of the
compartment's volume to the volume determined by the formula. No
more than one \class{CompartmentVolumeRule} can refer to a given
compartment.

\subsubsection{\class{ParameterRule}}

The \class{ParameterRule} structure adds two fields,
\attrib{parameter} to the basic \class{AssignmentRule} type.  The
\attrib{parameter} attribute has type \class{SId} and identifies
the parameter affected by the assignment. The effect of this rule
is to give a value to a parameter that can be used in subsequent
formulas.  This parameter has the value returned by the expression
in the \attrib{formula} attribute. No more than one
\class{ParameterRule} can refer to a given parameter.

\subsubsection{Constraints on rules}
\label{sec:ruleconstraints}

No more than one assignment rule can defined for a given
identifier.  No assignment rule can be defined for an identifier
whose corresponding structure has the \attrib{constant} set to
\texttt{true}.

A \texttt{scalar} rule for a given identifier overrides the
initial value of that identifier i.e. the initial value should be
ignored. This does not mean that any structure declaring an
identifier can be omitted if there is a \texttt{scalar} rule for
that identifier.  For example there must be a \texttt{Parameter}
structure for a given parameter if there is a
\texttt{ParameterRule} for that parameter.

The order of \texttt{scalar} rules is significant. \texttt{scalar}
rules are always evaluated in the order given in SBML.  The
\attrib{math} field of a \texttt{scalar} rule structure can
contain any identifier in a MathML \class{ci} element except for:
\begin{itemize}

\item those identifiers for which there exists a subsequent
\texttt{scalar} rule and

\item the identifier for which the rule is defined

\end{itemize}
These constraints are designed to eliminate algebraic loops
amongst the scalar rules.  As an example consider the following math, in the order shown:

\begin{equation*}
  \begin{array}{lll}
    x = x + 1 & y = z + 200 & z = y + 100\\ \\[-4pt]
  \end{array}
\end{equation*}
If this math was interpreted as a set of scalar rules it would be invalid because the rule for $x$ refers to $x$ and the rule for $y$ refers to $z$ before $z$ is defined.

Eliminating these algebraic loops ensures that scalar rules can be evaluated any number of times without the result of those evaluations changing.

\subsubsection{Example of Rule Use}

This section contains an example set of rules.  Consider the 
following math:

\begin{equation*}
  \begin{array}{lll}
    k = \frac{k_3}{k_2} & s_2 = \frac{k t}{1 + k_2} & A = 0.10 t\\ \\[-4pt]
  \end{array}
\end{equation*}
This math is encoded by the following valid scalar rule set:
\begin{example}
<model>
    ...
    <listOfRules>
        <parameterRule id="k">
            <notes>
                <xhtml:p>
                    k = k3/k2
                </xhtml:p>
            </notes>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <divide/>
                    <ci> k3 </ci>
                    <ci> k2 </ci>
                </apply>
            </math>
        </parameterRule>
        <speciesConcentrationRule species="s2">
            <notes>
                <xhtml:p>
                    s2 = (k * t)/(1 + k2)
                </xhtml:p>
            </notes>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <divide/>
                    <apply>
                        <times/>
                        <ci> k </ci>
                        <ci> t </ci>
                    </apply>
                    <apply>
                        <plus/>
                        <cn> 1 </cn>
                        <ci> k2 </ci>
                    </apply>
                </apply>
            </math>
        </speciesConcentrationRule>
        <compartmentVolumeRule compartment="A">
            <notes>
                <xhtml:p>
                    A = 0.10 * t
                </xhtml:p>
            </notes>
            <math xmlns="http://www.w3.org/1998/Math/MathML">
                <apply>
                    <times/>
                    <cn> 0.10 </cn>
                    <ci> t </ci>
                </apply>
            </math>
        </compartmentVolumeRule>
    </listOfRules>
    ...
</model>
\end{example}


%\subsubsection{Guidelines for Evaluating Rules}
%
%This section describes how rules including those implied by
%\class{Reaction} structures (see Section~\ref{sec:reactions})
%should be evaluated.  For the purpose of interpreting models
%mathematically (and for this description), \class{Reaction}
%structures collectively imply a \class{SpeciesConcentrationRule}
%structure, of type \class{rate}, for each species referenced in a
%\class{SpeciesReference} structure excluding those species which
%are defined with the \attrib{boundaryCondition} attribute equal to
%\texttt{true}.
%
%To determine the initial values of variables is a 2 set process:
%
%\begin{itemize}
%
%\item variables should be set according to the initial values
%given by \class{Species}, \class{Compartment} and
%\class{Parameter} structures then
%
%\item the \class{scalar} rules should be evaluated
%
%\end{itemize}
%
%To determine the rates of change of variables given a set of
%current variable values is again a two set process:
%
%\begin{itemize}
%
%\item the \class{scalar} rules should be evaluated then
%
%\item the \class{rate} rules should be evaluated
%
%\end{itemize}
%
%The \class{scalar} rules should be evaluated to determine the
%complete set of variable values given an incomplete set of
%variable values determined by \class{rate} and
%\class{AlgebraicRule} structures.
%

%-----------------------------------------------------------------------------
\subsection{Reactions}
\label{sec:reactions}
%-----------------------------------------------------------------------------

A \emph{reaction} represents some transformation, transport or
binding process, typically a chemical reaction, that can change
the amount of one or more species.  The \class{Reaction} type is
defined in Figure~\vref{fig:reaction}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{reaction}
  \caption{The definitions of \class{Reaction}, \class{KineticLaw} and
    \class{SpeciesReference}.}
  \label{fig:reaction}
\end{figure}

In SBML, reactions are defined using lists of reactant species,
products, and their stoichiometries, by modifier species and by
parameter values for separately-defined kinetic laws.  These
various quantities are recorded in the fields \attrib{reactant},
\attrib{product}, \attrib{modifier} and \attrib{kineticLaw}.  Both
\attrib{reactant} and \attrib{product} are references to species
implemented using lists of \class{SpeciesReference} structures
(defined in Section~\ref{subsec:speciesreference} below).  The
\class{SpeciesReference} structure contains fields for recording
the names of species and their stoichiometries.
\attrib{kineticLaw} is an optional field of type
\class{KineticLaw} (defined in Section~\ref{subsec:kinetic-law}
below), used to provide a mathematical formula describing the rate
of the reaction.  \class{modifier} is a reference to species
implemented using lists of \class{ModifierReference} structures
(defined in Section~\ref{subsec:modifierreference}).

In addition to these fields, the \class{Reaction} structure also has a
boolean field, \attrib{reversible}, that indicates whether the reaction is
reversible.  The field is optional, and if left unspecified in a model, it
defaults to a value of ``\attribvalue{true}''.  Information about
reversibility is useful in certain kinds of structural analyses such as
elementary mode analysis.

The field \attrib{fast} is another boolean attribute in the
\class{Reaction} data structure; a value of ``\attribvalue{true}''
signifies that the given reaction is a ``fast'' one.  This may be relevant
when computing equilibrium concentrations of rapidly equilibrating
reactions.  Simulation/analysis packages may chose to use this information
to reduce the number of ODEs required and thereby optimize such
computations.  The default value of \attrib{fast} is
``\attribvalue{false}''.  (A simulator/analysis package that has no
facilities for dealing with fast reactions can ignore this attribute. In
theory, if the choice of which reactions are fast is correctly made, then a
simulation performed with them should give the same results as a simulation
performed without fast reactions.  However, currently there appears to be
no single unambiguous method for designating which reactions should be
considered fast, and some users may designate a reaction as fast when in
fact it is not.)

\subsubsection{\class{SpeciesReference}}
\label{subsec:speciesreference}

Each unique species involved in a reaction is listed once in a
model, in a list contained in the \attrib{species} field of the
\class{Model} data structure discussed in Section~\ref{sec:model}.
Lists of modifiers, products and reactants in \class{Reaction}
type structures refer to those species.  The connection between
the products and reactants in a reaction definition and the
species names listed in the enclosing \class{Model} definition is
achieved using the \class{SpeciesReference} type data structure
defined in Figure~\vref{fig:reaction}.

The field \attrib{species} of type \class{SId} in
\class{SpeciesReference} must refer to the name of a species
defined in the enclosing \class{Model}-type structure.  Refer to Table~\ref{tab:specieattrib} to determine the attribute values of species that can be referenced by \class{SpeciesReference} structures.

The two fields \attrib{stoichiometry} and \attrib{denominator}
together set the stoichiometry value for a species in a reaction.
Both are integers, and both have default values of
``\attribvalue{1}'' (one).  The use of these separate terms allows
a simulator to employ rational arithmetic computations on the
stoichiometry matrix, potentially reducing round-off errors and
other problems during computations.  Such computations are
particularly important when working with large matrices and
calculating such things as elementary modes.

The following is a simple example of a species reference in a list
of reactants within a reaction named ``J1'':
\begin{example}
<model>
    ...
    <listOfReactions>
        <reaction id="J1">
            <listOfReactants>
                <speciesReference species="X0" stoichiometry="2"/>
            </listOfReactants>
            ...
        </reaction>
        ...
    </listOfReactions>
    ...
</model>
\end{example}

A reaction can contain an empty list of reactants or an empty list
of products but must have at least one reactant or product.

\subsubsection{\class{ModifierSpeciesReference}}
\label{subsec:modifierreference}

The connection between the modifiers (catalysts and/or inhibitors)
in a reaction definition and the species names listed in the
enclosing \class{Model} definition is achieved using the
\class{ModifierSpeciesReference} type data structure defined in
Figure~\vref{fig:reaction}. The field \attrib{species} of type
\class{SId} in \class{ModifierSpeciesReference} must refer to the
name of a species defined in the enclosing \class{Model}-type
structure.

The following is a simple example of a species reference in a list
of reactants within a reaction named ``J1'':
\begin{example}
<model>
    ...
    <listOfReactions>
        <reaction id="J1">
            ...
            <listOfModifiers>
                <modifierSpeciesReference species="X0"/>
            </listOfModifiers>
            ...
        </reaction>
        ...
    </listOfReactions>
    ...
</model>
\end{example}

\subsubsection{\class{KineticLaw}}
\label{subsec:kinetic-law}

A \class{kineticLaw} structure describes the rate of the enclosing
reaction.  The use of a \class{KineticLaw} structure in a \class{Reaction}
component is optional; however, in general there is no useful default that
can be substituted in place of a missing kinetic law definition in a
reaction.

The field \attrib{math}, a \class{math} element of MathML,
expresses the rate of the reaction in $substance/time$ units.
(Section~\ref{sec:formulas} discusses the use of MathML in SBML
Level 2). The optional fields \attrib{substanceUnits} and
\attrib{timeUnits} determine the units of substance and time. If
not set, the units are taken from the defaults defined by the
built-in ``\texttt{substance}'' and ``\texttt{time}'' of
Table~\vref{tab:builtin}.  The only species identifiers that can
be used in the \attrib{math} field of the \class{kineticLaw}
structure are those listed in the \class{Reactant},
\class{Product} and \class{Modifier} fields of the
\class{Reaction} structure.

A \class{KineticLaw} type structure can contain zero or more
\class{parameter} structures (Section~\ref{sec:parameters}) that
define symbols that can be used in the \attrib{math} element. As
discussed in Section~\ref{sec:namespaces}, reactions introduce
local namespaces for parameter identifiers.  Within a
\class{KineticLaw} structure inside a reaction definition, a local
parameter whose identifier is identical to a global parameter
defined in the enclosing \class{Model}-type structure takes
precedence over that global parameter.

The following is an example of a \class{Reaction} structure that
defines the reaction $J_1: \ X_0 \longrightarrow S_1; \ k_1 X_0
S_2$ where $S_2$ is a catalyst. It demonstrates the use of species
references and the \class{KineticLaw} structure:
\begin{example}
<model>
    ...
    <listOfReactions>
        <reaction id="J1">
            <listOfReactants>
                <speciesReference species="X0" stoichiometry="1"/>
            </listOfReactants>
            <listOfProducts>
                <speciesReference species="S1" stoichiometry="1"/>
            </listOfProducts>
            <listOfModifiers>
                <modifierSpeciesReference species="S2"/>
            </listOfModifiers>
            <kineticLaw>
                <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <apply>
                        <times/>
                        <ci> k1 </ci>
                        <ci> X0 </ci>
                        <ci> S2 </ci>
                    </apply>
                </math>
                <listOfParameters>
                    <parameter id="k1" value="0.1"/>
                </listOfParameters>
            </kineticLaw>
        </reaction>
    </listOfReactions>
    ...
</model>
\end{example}

%=============================================================================
\section{Examples of Full Models Encoded in XML Using SBML}
\label{sec:xml-rep}
%=============================================================================

In this section, we present several examples of complete models
encoded in XML using SBML Level~2.  Our approach to translating
the UML-based structure definitions presented in the previous
sections is described elsewhere~\citep{hucka:2000b}.
%Appendix~\ref{apdx:schemas} gives the full listing of an XML
%Schema corresponding to SBML Level~2.


%-----------------------------------------------------------------------------
\subsection{A Simple Example Application of SBML}
%-----------------------------------------------------------------------------

Consider the following hypothetical branched system:
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    X_0 & \underrightarrow{k_1 X_0} & S_1 \\ \\[-4pt]
    S_1 & \underrightarrow{k_2 S_1} & X_1 \\ \\[-4pt]
    S_1 & \underrightarrow{k_3 S_1} & X_2
  \end{array}
\end{equation*}

The following is an XML document that encodes the model shown
above:

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model id="Branch">
        <notes>
            <body xmlns="http://www.w3.org/1999/xhtml">
                <p>Simple branch system.</p>
                <p>The reaction looks like this:</p>
                <p>reaction-1:   X0 -> S1; k1*X0;</p>
                <p>reaction-2:   S1 -> X1; k2*S1;</p>
                <p>reaction-3:   S1 -> X2; k3*S1;</p>
            </body>
        </notes>
        <listOfCompartments>
            <compartment id="compartmentOne" volume="1"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="S1" initialAmount="0" compartment="compartmentOne"
                    boundaryCondition="false"/>
            <species id="X0" initialAmount="0" compartment="compartmentOne"
                    boundaryCondition="true"/>
            <species id="X1" initialAmount="0" compartment="compartmentOne"
                    boundaryCondition="true"/>
            <species id="X2" initialAmount="0" compartment="compartmentOne"
                    boundaryCondition="true"/>
        </listOfSpecies>
        <listOfReactions>
            <reaction id="reaction_1" reversible="false">
                <listOfReactants>
                    <speciesReference species="X0" stoichiometry="1"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="S1" stoichiometry="1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k1 </math:ci>
                            <math:ci> X0 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k1" value="0"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
            <reaction id="reaction_2" reversible="false">
                <listOfReactants>
                    <speciesReference species="S1" stoichiometry="1"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="X1" stoichiometry="1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k2 </math:ci>
                            <math:ci> S1 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k2" value="0"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
            <reaction id="reaction_3" reversible="false">
                <listOfReactants>
                    <speciesReference species="S1" stoichiometry="1"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="X2" stoichiometry="1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k3 </math:ci>
                            <math:ci> S1 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k3" value="0"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
        </listOfReactions>
    </model>
</sbml>
\end{example}

The XML encoding shown above is quite straightforward. The
outermost container is a tag, \texttt{<smbl>}, that identifies the
contents as being \underline{S}ystems \underline{B}iology
\underline{M}arkup \underline{L}anguage.  The attributes
\texttt{level} and \texttt{version} indicate that the content is
formatted according to version~1 of the Level~2 definition of
SBML. The \texttt{version} attribute is present in case SBML
Level~2 must be revised in the future to correct errors.

The next-inner container is a single \texttt{<model>} element that
serves as the highest-level object in the model.  The model has a
name, ``Branch''. The model contains one compartment, four
species, and three reactions.  The elements in the
\texttt{<listOfReactants>} and \texttt{<listOfProducts>} in each
reaction refer to the names of elements listed in the
\texttt{<listOfSpecies>}.  The correspondences between the various
elements is explicitly stated by the \texttt{<speciesReference>}
elements.

The model includes a \texttt{<notes>} annotation that summarizes the model
in text form, with formatting based on XHTML.  This may be useful for a
software package that is able to read such annotations and, for example,
render them in HTML in a graphical user interface.


%-----------------------------------------------------------------------------
\subsection{Simple Use of Units Feature in a Model}
\label{apdx:units-eg}
%-----------------------------------------------------------------------------

The following model uses the units features of SBML Level~2.  In
this model, the default value of \texttt{substance} is changed in
the list of unit definitions to be mole units with a scale factor
of $-3$, or millimoles.  This sets the default substance units in
the model; components can override this scale locally.  The
\attrib{volume} and \attrib{time} built-ins are left to their
defaults, ensuring that volume is in liters and time is in
seconds.  The result is that, in this model, kinetic law formulas
define rates in millimoles per second and the species symbols in
them represent concentration values in millimoles per liter.  All
the \class{species} elements set the initial amount of every given
species to $1$ millimole.  The parameters \texttt{Vm} and
\texttt{Km} are defined to be in millimoles per liter per second,
and milliMolar, respectively.

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML"
      html:xmlns="http://www.w3.org/1999/xhtml">
    <model>
        <listOfUnitDefinitions>
            <unitDefinition id="substance">
                <listOfUnits>
                    <unit kind="mole" scale="-3"/>
                </listOfUnits>
            </unitDefinition>
            <unitDefinition id="mls">
                <listOfUnits>
                    <unit kind="mole"   scale="-3"/>
                    <unit kind="liter"  exponent="-1"/>
                    <unit kind="second" exponent="-1"/>
                </listOfUnits>
            </unitDefinition>
        </listOfUnitDefinitions>
        <listOfCompartments>
            <compartment id="cell"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="x0" compartment="cell" initialAmount="1"/>
            <species id="x1" compartment="cell" initialAmount="1"/>
            <species id="s1" compartment="cell" initialAmount="1"/>
            <species id="s2" compartment="cell" initialAmount="1"/>
        </listOfSpecies>
        <listOfParameters>
            <parameter id="vm" value="2" units="mls"/>
            <parameter id="km" value="2"/>
        </listOfParameters>
        <listOfReactions>
            <reaction id="v1">
                <listOfReactants>
                    <speciesReference species="x0"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="s1"/>
                </listOfProducts>
                <kineticLaw>
                    <notes>
                        <html:p>(vm * s1)/(km + s1)</html:p>
                    </notes>
                    <math:math>
                        <math:apply>
                            <math:divide/>
                            <math:apply>
                                <math:times/>
                                <math:ci> vm </math:ci>
                                <math:ci> s1 </math:ci>
                            </math:apply>
                            <math:apply>
                                <math:plus/>
                                <math:ci> km </math:ci>
                                <math:ci> s1 </math:ci>
                            </math:apply>
                        </math:apply>
                    </math:math>
                </kineticLaw>
            </reaction>
            <reaction id="v2">
                <listOfReactants>
                    <speciesReference species="s1"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="s2"/>
                </listOfProducts>
                <kineticLaw>
                    <notes>
                        <html:p>(vm * s2)/(km + s2)</html:p>
                    </notes>
                    <math:math>
                        <math:apply>
                            <math:divide/>
                            <math:apply>
                                <math:times/>
                                <math:ci> vm </math:ci>
                                <math:ci> s2 </math:ci>
                            </math:apply>
                            <math:apply>
                                <math:plus/>
                                <math:ci> km </math:ci>
                                <math:ci> s2 </math:ci>
                            </math:apply>
                        </math:apply>
                    </math:math>
                </kineticLaw>
            </reaction>
            <reaction id="v3">
                <listOfReactants>
                    <speciesReference species="s2"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="x1"/>
                </listOfProducts>
                <kineticLaw>
                    <notes>
                        <html:p>(vm * x1)/(km + x1)</html:p>
                    </notes>
                    <math:math>
                        <math:apply>
                            <math:divide/>
                            <math:apply>
                                <math:times/>
                                <math:ci> vm </math:ci>
                                <math:ci> x1 </math:ci>
                            </math:apply>
                            <math:apply>
                                <math:plus/>
                                <math:ci> km </math:ci>
                                <math:ci> x1 </math:ci>
                            </math:apply>
                        </math:apply>
                    </math:math>
                </kineticLaw>
            </reaction>
        </listOfReactions>
    </model>
</sbml>
\end{example}

%-----------------------------------------------------------------------------
\subsection{Use of Assignment Rules Feature in a Model}
\label{apdx:rules-eg}
%-----------------------------------------------------------------------------
This section contains a model which simulates a system containing
a fast reaction. This model uses rules to express the mathematics
of the fast reaction explicitly rather than using the implicit
\attrib{fast} field on a reaction element.

The system modelled is
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    X_0 & \underrightarrow{k_1 X_0} & S_1 \\ \\[-4pt]
    S_1 & \underrightarrow{k_f S_1 - k_r S_2} & S_2 \\ \\[-4pt]
    S_2 & \underrightarrow{k_2 S_1} & X_1\\ \\[-4pt]
  \end{array}
\end{equation*}
\begin{equation*}
  \begin{array}{lllll}
    k_1 = 0.1 & k_2 = 0.15 & k_f = K_{eq} 10000 & k_r = 10000 & K_{eq} = 2.5\\ \\[-4pt]
  \end{array}
\end{equation*}
this can be approximated with the following system:
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    X_0 & \underrightarrow{k_1 X_0} & T \\ \\[-4pt]
    T & \underrightarrow{k_2 S_1} & X_1\\ \\[-4pt]
  \end{array}
\end{equation*}
\begin{equation*}
  \begin{array}{ll}
    S_1 = \frac{T}{1 + K_{eq}} & S_2 = K_{eq} S_1\\ \\[-4pt]
  \end{array}
\end{equation*}
The following example SBML model uses the approximate form.

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model>
        <listOfCompartments>
            <compartment id="cell"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="X0" compartment="cell" initialAmount="1"/>
            <species id="X1" compartment="cell" initialAmount="0"/>
            <species id="T" compartment="cell" initialAmount="0"/>
            <species id="S1" compartment="cell" initialAmount="0"/>
            <species id="S2" compartment="cell" initialAmount="0"/>
        </listOfSpecies>
        <listOfParameters>
            <parameter id="Keq" value="2.5"/>
        </listOfParameters>
        <listOfRules>
            <speciesConcentrationRule species="S1">
                <math:math>
                    <math:apply>
                        <math:divide/>
                        <math:ci> T </math:ci>
                        <math:apply>
                            <math:add/>
                            <math:cn> 1 </math:cn>
                            <math:ci> Keq </math:ci>
                        </math:apply>
                    </math:apply>
                </math:math>
            </speciesConcentrationRule>
            <speciesConcentrationRule species="S2">
                <math:math>
                    <math:apply>
                        <math:times/>
                        <math:ci> Keq </math:ci>
                        <math:ci> S1 </math:ci>
                    </math:apply>
                </math:math>
            </speciesConcentrationRule>
        </listOfRules>
        <listOfReactions>
            <reaction id="in">
                <listOfReactants>
                    <speciesReference species="X0"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="T"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k1 </math:ci>
                            <math:ci> X0 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k1" value="0.1"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
            <reaction id="out">
                <listOfReactants>
                    <speciesReference species="T"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="X1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k2 </math:ci>
                            <math:ci> S2 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k2" value="0.15"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
        </listOfReactions>
    </model>
</sbml>
\end{example}

%-----------------------------------------------------------------------------
\subsection{Use of Algebraic Rules Feature in a Model}
\label{sec:algeraiceg}
%-----------------------------------------------------------------------------

This section contains an example model which contains an
\class{AlgebraicRule} structure.  The model contains a different
formulation of the fast reaction described in
Section~\ref{apdx:rules-eg}.

The system described in Section~\ref{apdx:rules-eg} can be
approximated with the following system:
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    X_0 & \underrightarrow{k_1 X_0} & T \\ \\[-4pt]
    T & \underrightarrow{k_2 S_1} & X_1\\ \\[-4pt]
  \end{array}
\end{equation*}
\begin{equation*}
  \begin{array}{ll}
    S_2 = K_{eq} S_1\\ \\[-4pt]
  \end{array}
\end{equation*}
with the constraint:
\begin{equation*}
  \begin{array}{ll}
    S_1 + S_2 - T = 0\\ \\[-4pt]
  \end{array}
\end{equation*}

The following example SBML model uses this approximate form.

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model>
        <listOfCompartments>
            <compartment id="cell"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="X0" compartment="cell" initialAmount="1"/>
            <species id="X1" compartment="cell" initialAmount="0"/>
            <species id="T" compartment="cell" initialAmount="0"/>
            <species id="S1" compartment="cell" initialAmount="0"/>
            <species id="S2" compartment="cell" initialAmount="0"/>
        </listOfSpecies>
        <listOfParameters>
            <parameter id="Keq" value="2.5"/>
        </listOfParameters>
        <listOfRules>
            <speciesConcentrationRule species="S2">
                <math:math>
                    <math:apply>
                        <math:times/>
                        <math:ci> Keq </math:ci>
                        <math:ci> S1 </math:ci>
                    </math:apply>
                </math:math>
            </speciesConcentrationRule>
            <algebraicRule>
                <math:math>
                    <math:apply>
                        <math:minus/>
                        <math:apply>
                            <math:plus/>
                            <math:cin> S2 <math:cin/>
                            <math:cin> S1 <math:cin/>
                        </math:apply>
                        <math:cin> T <math:cin/>
                    <math:apply>
                <math:math>
            </algebraicRule>
        </listOfRules>
        <listOfReactions>
            <reaction id="in">
                <listOfReactants>
                    <speciesReference species="X0"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="T"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k1 </math:ci>
                            <math:ci> X0 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k1" value="0.1"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
            <reaction id="out">
                <listOfReactants>
                    <speciesReference species="T"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="X1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:times/>
                            <math:ci> k2 </math:ci>
                            <math:ci> S2 </math:ci>
                        </math:apply>
                    </math:math>
                    <listOfParameters>
                        <parameter id="k2" value="0.15"/>
                    </listOfParameters>
                </kineticLaw>
            </reaction>
        </listOfReactions>
    </model>
</sbml>
\end{example}

%-----------------------------------------------------------------------------
\subsection{Use of Math Definition Feature in a Model}
\label{sec:functioneg}
%-----------------------------------------------------------------------------

This section contains a model which uses the math definition
feature of SBML.  Consider the following hypothetical system:
\begin{equation*}
  \begin{array}{@{}ccc@{}}
    S_1 & \underrightarrow{f(S_1)} & S_2 \\ \\[-4pt]
  \end{array}
\end{equation*}
where
\begin{equation*}
  \begin{array}{l}
    f(x) = x * 2 \\ \\[-4pt]
  \end{array}
\end{equation*}

The following is the XML document that encodes the model shown
above:

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model id="Branch">
        <listOfMathDefinitons>
            <mathDefinition id="f">
                <math:lamdba>
                    <math:bvar><math:ci> x </math:ci></math:bvar>
                    <math:apply>
                        <math:times/>
                        <math:ci> x </math:ci>
                        <math:cn> 2 </math:cn>
                    </math:apply>
                </math:lamdba>
            </mathDefinition>
        </listOfMathDefinitions>
        <listOfCompartments>
            <compartment id="compartmentOne" volume="1"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="S1" initialAmount="0" compartment="compartmentOne"/>
            <species id="S2" initialAmount="0" compartment="compartmentOne"/>
        </listOfSpecies>
        <listOfReactions>
            <reaction id="reaction_1" reversible="false">
                <listOfReactants>
                    <speciesReference species="S1" stoichiometry="1"/>
                </listOfReactants>
                <listOfProducts>
                    <speciesReference species="S2" stoichiometry="1"/>
                </listOfProducts>
                <kineticLaw>
                    <math:math>
                        <math:apply>
                            <math:ci> f </math:ci>
                            <math:ci> S1 </math:ci>
                         </math:apply>
                    </math:math>
                </kineticLaw>
            </reaction>
        </listOfReactions>
    </model>
</sbml>
\end{example}

%=============================================================================
\section{Discussion}
\label{sec:discussion}
%=============================================================================

The volume of data now emerging from molecular biotechnology
leave little doubt that extensive computer-based modeling, simulation and
analysis will be critical to understanding and interpreting the
data~\citep{abbott:1999,gilman:2000,popel:1998,smaglik:2000}.  This
has lead to an explosion in the development of computer tools by many
research groups across the world.  The explosive rate of progress is
exciting, but the rapid growth of the field is accompanied by problems and
pressing needs.

One problem is that simulation models and results often cannot be directly
compared, shared or re-used, because the tools developed by different
groups often are not compatible with each other.  As the field of systems
biology matures, researchers increasingly need to communicate their results
as computational models rather than box-and-arrow diagrams.  They also need
to reuse published and curated models as library components in order to
succeed with large-scale efforts~\cite[e.g., the Alliance for Cellular
Signaling;][]{gilman:2000,smaglik:2000}.  These needs require that models
implemented in one software package be portable to other software packages,
to maximize public understanding and to allow building up libraries of
curated computational models.

We offer SBML to the systems biology community as a suggested
format for exchanging models between simulation/analysis tools.
SBML is an open model representation language oriented
specifically towards representing biochemical network models.

Our vision for SBML is to create an open standard that will enable
simulation software to exchange models.  SBML is not static; we continue to
develop and experiment with it, and we interact with other groups who seek
to develop similar markup languages.  We plan on continuing to evolve SBML
with the help of the systems biology community to make SBML increasingly
more powerful, flexible and useful.


%=============================================================================
\subsection{Future Enhancements to SBML: Level 3 and Beyond}
\label{sec:level-3}
%=============================================================================

As mentioned above, SBML Level 2 is intended to provide the foundations for modeling biochemical networks.  A number of
significant capabilities are lacking from Level~2 as described in the main part of this document.  Appendix~\ref{apdx:extensions} contains extensions that could be included in SBML Level 2 (for consideration before the end of 2002). Other features will be
introduced in future levels of SBML.  The following
summarizes additional features that under consideration to be
included in SBML Level~3:
\begin{itemize}

\item \emph{Arrays}.  This will enable the creation of arrays of components
  (species, reactions, compartments and submodels).

\item \emph{Connections}.  This will be a mechanism for describing the
  connections between items in an array.  For example, it should be
  possible to create a 2-D array of compartments and then a 3-D array of
  reactions which transport species between the compartments, where the
  third dimension is the connections between the compartments.  Two
  possible ways of describing a connection scheme are: (1) sparse/explicit,
  simply listing the relative co-coordinates of connected objects for
  patterns of points; (2) algebraic, where a conditional equation describes
  whether two objects are connected.

\item \emph{Database Interoperability}.  In order to store models in a
  database, it will be necessary to add additional header information that
  provides information about authors, version numbers, revision dates, etc.

\item \emph{Geometry}.  We will develop a scheme for representing the 3-D
  structure of compartments.

\item \emph{Submodels}.  This will enable a large model to be built up out
  of instances of other models.  It will also allow the reuse of model
  components and the creation of several instances of the same model.

\item \emph{Component Identification}.  This will enable components to be
  described using some stable universal identification scheme.

\item \emph{Diagrams}.  This feature will allow components to be
annotated
  with data to enable the display of the model in a diagram.  It will also
  enable multistate representations.

\item \emph{Conditional rules}.  This will enable rules and reactions to have
their effect conditional on the state of the model system.  For example in
SBML Level 2 it is possible to create a rule with the effect:
\begin{equation*}
\frac{d s}{d t} =
\left\{
\begin{array}{ll}
     0 & \mbox{if $s>0$}\\
     y & \mbox{otherwise}
\end{array}
\right.
\end{equation*}
Conditional rules would enable the expression of the following example maths:
\begin{equation*}
\begin{array}{ll}
\mbox{if $s>0$} & \frac{d s}{d t} = y 
\end{array}
\end{equation*}
where $s$ is not determined by the rule when $s \leq 0$.
\item \emph{\class{SpeciesAmountRule}}.  This feature would introduce the type \class{SpeciesAmountRule} which would enable the expression of rules that determine the amount of species rather than their concentration.
\end{itemize}
%=============================================================================
\subsection{Relationships to Other Efforts}
\label{sec:other-efforts}
%=============================================================================

% FIXME mention we also had simplicity in mind

There are a number of ongoing efforts with similar goals as those of SBML.
Many of them are oriented more specifically toward describing protein
sequences, genes and related entities for database storage and search.
These are generally not intended to be computational models, in the sense
that they do not describe entities and behavioral rules in such a way that
a simulation package could ``run'' the models.

The effort perhaps closest in spirit to SBML is
CellML\tm~\citep{hedley:2001b}.  CellML is an XML-based markup language
designed for storing and exchanging computer-based biological models. It
includes facilities for representing model structure, mathematics and
additional information for database storage and search.  Models are
described in terms of networks of connections between discrete components,
where a component is a functional unit that may correspond to a physical
compartment or simply a convenient modeling abstraction.  Components
contain variables and connections contain mappings between the variables of
connected components.  CellML provides facilities for grouping components
and specifying the kinds of relationships that may exist between
components.  It also uses MathML~\citep{w3c:2000b} for expressing mathematical
relationships between components and provides the ability to use ECMAScript
(formerly known as JavaScript) to define functions.

The development of SBML Level 2 has benefited from discussions
with the developers of CellML. The developers of SBML and CellML
are actively engaged in ensuring that the two representations can
be translated between each other.

%=============================================================================
\subsection{Tracking the XML Schema Standard}
\label{sec:tracking-xml}
%=============================================================================

One of the problems in attempting to define an XML Schema for SBML is that,
at the time of this writing, the XML Schema
specification~\citep{biron:2000,thompson:2000} has not actually been
finalized.  This has been another motivation for defining SBML in terms of
abstract data structures in a UML-based notation rather than directly as an
XML Schema.

The moving-target status of the XML Schema standard definition requires
that we plan to update the Schema corresponding to SBML.  The following
is our planned approach for handling changes in the Schema standard:
\begin{enumerate}

\item The definition of SBML Level~2 in this document is
independent of XML
  Schema.  Therefore, the definition of SBML Level~2 expressed here can
  remain the same regardless of what happens to the exact form of XML
  Schema.  Among other benefits, this allows developers to leave their
  programs' internal data structures unchanged in the face of possible
  revisions in the Schema standard.

%\item In Appendix~\ref{apdx:schemas}, we provide an XML Schema
%  corresponding to SBML Level~2 that has been created using the current
%  definition of XML Schema from the W3C
%  Organization~\citep{biron:2000,thompson:2000}.
%
\item Whenever the definition of XML Schema is updated by the W3C in the
  future, we will issue a revised version of the XML Schema for SBML
  Level~2 that conform to the updated standard.  We will leave the previous
  versions still available for reference.  The updated XML Schemas for SBML
  Level~2 will be identical to the previous versions except where changes
  in XML Schema force a change in the definition of the Schema for SBML
  Level~2.

\end{enumerate}

%=============================================================================
\subsection{Availability}
\label{sec:availability}
%=============================================================================

The SBML Level 2 definition, the XML Schema corresponding to SBML
Level~2, and other related documents will be openly available from the
Caltech ERATO web site, \url{http://www.cds.caltech.edu/erato/}.

%=============================================================================
\setcounter{secnumdepth}{-1}
\section{Acknowledgments}
\label{sec:acknowledgements}
%=============================================================================

SBML was first conceived at the JST/ERATO-sponsored \emph{First Workshop on
  Software Platforms for Molecular Biology}, held in April, 2000, at the
California Institute of Technology in Pasadena, California, USA.
The participants collectively decided to begin developing a common
XML-based declarative language for representing models.  A draft
version of the Systems Biology Markup Language was developed by
the Caltech ERATO team and delivered to all collaborators in
August, 2000.  This draft version underwent extensive discussion
over mailing lists and then again during the \emph{Second Workshop
on Software Platforms for Molecular Biology} held in Tokyo, Japan,
November 2000.  A revised version of SBML was issued by the
Caltech ERATO team in December, 2000, and after further
discussions over mailing lists and in meetings, we produced a
description of SBML Level~1~\citep{hucka:2001}.

SBML Level~2 was conceived at the \emph{5th Workshop on
Software Platforms for Molecular Biology}, held in July 2002, at
the University of Hertfordshire, UK.  The participants
collectively decided to revise the form of SBML in level 2.

SBML Level 2 was developed with the help of many people,
especially the authors of BioSpice, DBSolve, Cellerator, COPASI, E-Cell, Gepasi, Jarnac, NetBuilder, Promot/DIVA, StochSim, and Virtual Cell, and members of the \texttt{sysbio} mailing list.  We are particularly grateful to the following people for discussions and knowledge: Benjamin Bornstein, Dennis Bray, Claudine Chaouiya, Kwang Cho, Athel Cornish-Bowden, Autumn Cuellar, Serge Dronov, David Fell, Carl Firth, Akira Funahashi, Warren Hedley, Charles Hodgman, Stefan Hoops, Martin Ginkel, Victoria Gor, Igor Goryanin, Jay Kaserger, Andreas Kremling, Nick Juty, Nicolas Le~Nov\`{e}re, Fred Livingston, Les Loew, Daniel Lucio, Joanne Matthews, Pedro Mendes, Eric Minch, Eric Mjolsness, David Morley, Poul Neilsen, Mark Poolman, Sven Sahle, Takeshi Sakurada, James Schaff, Maria Schilstra, Cliff Shaffer, Bruce Shapiro, Tom Shimizu, Herbert Sauro, Hugh Spence, Joerg Stelling, Kouichi Takahashi, Masaru Tomita, John Wagner and Olaf Wolkenhauer.

%We are indebted to Daniel Lucio of the Virtual Cell group for generating
%the XML Schema of SBML Level~1 presented in Appendix~\ref{apdx:schemas}.

\newpage
\section{Appendix}
\setcounter{secnumdepth}{2}
\appendix
%=============================================================================
\section{Candidate Extensions to SBML Level 2}
\label{apdx:extensions}
%=============================================================================
This section describes features for possible inclusion in SBML Level 2.

%-----------------------------------------------------------------------------
\subsection{Delay function}
\label{sec:delay}
%-----------------------------------------------------------------------------

In addition to the built-in symbol to represent time described in Section~\ref{sec:mathmltokens} we propose the additional built-in symbol \texttt{http://www.sbml.org/symbols/delay}, which represents the function $delay(x, d)$.  The result of this function is the value of $x$ at $d$ time units before the current time.  The units of the $d$ parameter are determined from the built-in \texttt{time} of Table~\vref{tab:builtin}.

As an example the following XML fragment encodes the equation $k + delay(x, 0.1)$ or alternatively $k_t + x_{t - 0.1}$

\begin{example}
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <apply>
        <add/>
        <ci> k </ci>
        <apply>
            <csymbol encoding="SBML"
                        definitionURL="http://www.sbml.org/symbols/delay">
                delay
            </csymbol>
            <ci> x </ci>
            <ci> 0.1 </ci>
        </apply>
    </apply>
</math>
\end{example}

%-----------------------------------------------------------------------------
\subsubsection{Discussion}
\label{sec:delaydiscuss}
%-----------------------------------------------------------------------------
We believe that the \texttt{delay} function is useful for representing biological processes which have a delayed response but where the detail of those processes is not relevant to the function of a given model.  The classic example of such a process is gene expression.  To facilitate this kind of model XPP~\citep{ermentrout:2001} includes a \texttt{delay} function.
%-----------------------------------------------------------------------------
\subsubsection{Use of $delay$ function in a Model}
\label{sec:delayeg}
%-----------------------------------------------------------------------------
This section contains a simple model which uses the built-in $delay$ function described above.  This model represents a gene that suppresses its own expression and consists of the single rule:
\begin{equation*}
\frac{d P}{d t} = \frac{ \frac{1}{1 + m (P_{delayed})^q} - P }{ \tau }
\end{equation*}
where
\begin{equation*}
\begin{array}{rl}
P_{delayed} & \mbox{is } delay(P, delta_t) \mbox{ or P at } t - delta_t\\
P & \mbox{is protein concentration}\\
\tau & \mbox{is response time}\\
m & \mbox{is multiplier or equilibrium constant}\\
q & \mbox{is Hill coefficient}\\ 
\end{array}
\end{equation*}

The SBML form of this model is as follows:
\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model>
        <listOfCompartments>
            <compartment id="cell"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="P" compartment="cell" initialAmount="0"/>
        </listOfSpecies>
        <listOfParameters>
            <parameter id="tau" value="1"/>
            <parameter id="m" value="0.5"/>
            <parameter id="q" value="1"/>
            <parameter id="delta_t" value="1"/>
        </listOfParameters>
        <listOfRules>
            <speciesConcentrationRule species="P" type="rate">
                <math:math>
                 <math:apply>
                  <math:divide/>
                  <math:apply>
                   <math:minus/
                   <math:apply>
                    <math:divide/>
                    <math:cn> 1 </math:cn>
                    <math:apply>
                     <math:add/>
                     <math:cn> 1 </math:cn>
                     <math:apply>
                      <math:times/>
                      <math:ci> m <math:ci/>
                      <math:apply>
                       <math:power/>
                       <math:apply>
                        <math:csymbol encoding="SBML"
    definitionURL="http://www.sbml.org/symbols/delay">
                            delay
                        </math:csymbol>
                        <math:ci> P </math:ci>
                        <math:ci> delta_t </math:ci>
                       </math:apply>
                       <math:ci> q </math:ci>
                      </math:apply>
                     </math:apply>
                    </math:apply>
                   </math:apply>
                  </math:apply>
                  <math:ci> tau </math:ci>
                 </math:apply>
                </math:math>
            </speciesConcentrationRule>
        </listOfRules>
    </model>
</sbml>
\end{example}

%-----------------------------------------------------------------------------
\subsection{Events}
\label{sec:events}
%-----------------------------------------------------------------------------

Under this proposal \class{Model} has an optional list of \class{Event} structures which describe the time and form of explicit instantaneous discontinuous state changes in the model.  For example, an event may describe that one species concentration is halved when another species concentration exceeds a given threshold value.  An \class{Event} structure defines when the event can occur, which variables are affected by the event and how those variables are affected. The effect of the event can optionally be delayed after the occurrence of the condition which invokes the event. The operation of an \class{Event} structure is divided into two phases (even when the event is not delayed), one when the event is \emph{fired} and the other when the event is \emph{executed}. The \class{Event} type is defined in Figure~\vref{fig:event}.  Both \class{Event} and \class{EventAssignment} are derived from \class{SBase} (see Section~\ref{sec:sbase}).  An example of a model which uses events is given below.

\begin{figure}[htb]
  \centering
  \includegraphics[scale = 0.68]{event}
  \caption{The definitions of \class{Event} and \class{EventAssignment}}
  \label{fig:event}
\end{figure}

The following sections describe the fields of the \class{Event}
structure.

\subsubsection{\attrib{trigger}}
The \attrib{trigger} field defines when the \class{Event}
structure has an effect on the model.  The \attrib{trigger} field
contains a MathML boolean expression.  The exact instant that the
expression evaluates to true is the time point when the
\class{Event} is \emph{fired}.  The event only fires when the
\attrib{trigger} makes the transition from false to true.  The
event will fire at any further time points when the
\attrib{trigger} make this transition.

\subsubsection{\attrib{delay}}
The optional \attrib{delay} field defines the length of time after
the event has \emph{fired} that the event is \emph{executed}. The
\attrib{delay} field is another MathML expression.  This
expression should be evaluated when the rule is \emph{fired}.  The
default value for the \attrib{delay} field is 0.  The value of the
\attrib{delay} field should always be positive.

\subsubsection{\attrib{timeUnits}}
The optional field \attrib{timeUnits} determines the units of time
that apply to the \attrib{delay} field. If not set, the units are
taken from the defaults defined by the built-in ``\texttt{time}''
of Table~\vref{tab:builtin}.

\subsubsection{\attrib{eventAssignment}}
The \attrib{eventAssignment} field consists of a non-empty list of
\class{eventAssignment} structures.  This field is implemented as a
\class{listOfEventAssignments} element containing one or more
\class{eventAssignment} elements).  The \class{EventAssignment}
structures represent variable assignments which have effect when
the event is \emph{executed}. The \class{Assignment} structure is
shown in Figure~\ref{fig:event}. The \attrib{variable} field is of
type \class{SId} and contains the identifier of a variable i.e. a
compartment, species or parameter.  The structures referenced by
the \attrib{variable} field must have their \attrib{constant}
fields set to ``\texttt{false}''.  The \attrib{math} field
contains a MathML expression which defines the new value of the
variable.  This expression is evaluated when the \class{Event} is
\emph{fired} but the variable only acquires the result or new
value when the \class{Event} is \emph{executed}.  The order of the
\class{EventAssignment} structures is not significant (unlike
scalar rules), the effect of one assignment cannot affect the
result of another assignment.  The identifiers occurring in the
MathML \attrib{ci} fields of the \class{EventAssignment}
structures represent the value of the identifier at the point when
the \class{Event} is \emph{fired}.

A example of an \class{Event} structure follows:

\begin{example}
<event>
    <trigger>
        <math:math>
            <math:apply>
                <math:leq/>
                <math:ci> P1 </math:ci>
                <math:ci> t </math:ci>
            </math:apply>
        </math:math>
    </trigger>
    <listOfAssignments>
        <assignment variable="k2">
            <math:cn> 0 </math:cn>
        </assignment>
    <listOfAssignments>
</event>
\end{example}

This structure makes the assignment $k_2 = 0$ at the point when
$P_1 \leq t$.

%-----------------------------------------------------------------------------
\subsubsection{Discussion}
\label{sec:eventdiscuss}
%-----------------------------------------------------------------------------
The requirement for the event feature arises when attempting to represent a cell cycle model~\citep{novak:2001} in XPP~\citep{ermentrout:2001}.  This model uses the \texttt{global} XPP keyword, which is similar to the proposed SBML \class{Event} type, to describe how cell mass is halved when cell division occurs in response to M-phase promoting factor.
%-----------------------------------------------------------------------------
\subsubsection{Use of Events Feature in a Model}
\label{sec:eventeg}
%-----------------------------------------------------------------------------
This section contains a simple model system that demonstrates the
use of an events.  Consider a system with two genes: $k_1$ and
$k_2$.  $k_1$ is initially on and $k_2$ is initially off.  The
genes when on produce products, $P_1$ and $P_2$ respectively, at a
fixed rate when switched on.  When $P_1$ reaches a given
concentration $k_2$ switches.  This can be represented
mathematically as follows:

\begin{equation*}
  \begin{array}{l}
    \frac{d P_1}{d t} = k_1 - P_1\\ \\[-4pt]
    \frac{d P_2}{d t} = k_2 - P_2\\ \\[-4pt]
  \end{array}
\end{equation*}
when $P_1 > \tau$ then $k_2 = 1$ \\
when $P_1 \leq \tau$ then $k_2 = 0$ \\
\\
initially
\begin{equation*}
  \begin{array}{lllll}
    k_1 = 1 & k_2 = 0 & \tau = 0.25 & P_1 = 0 & P_2 = 0\\ \\[-4pt]
  \end{array}
\end{equation*}

The SBML Level 2 representation of this as follows:

\begin{example}
<?xml version="1.0"?>
<sbml xmlns="http://www.sbml.org/sbml/level2" version="1" level="2"
      math:xmlns="http://www.w3.org/1998/Math/MathML">
    <model>
        <listOfCompartments>
            <compartment id="cell"/>
        </listOfCompartments>
        <listOfSpecies>
            <species id="P1" compartment="cell" initialAmount="0"/>
            <species id="P2" compartment="cell" initialAmount="0"/>
        </listOfSpecies>
        <listOfParameters>
            <parameter id="k1" value="1" constant="false"/>
            <parameter id="k2" value="0" constant="false"/>
            <parameter id="tau" value="0.25"/>
        </listOfParameters>
        <listOfRules>
            <speciesConcentrationRule species="P1" type="rate">
                <math:math>
                    <math:apply>
                        <math:minus/>
                        <math:ci> k1 </math:ci>
                        <math:ci> P1 </math:ci>
                        </math:apply>
                    </math:apply>
                </math:math>
            </speciesConcentrationRule>
            <speciesConcentrationRule species="P2" type="rate">
                <math:math>
                    <math:apply>
                        <math:minus/>
                        <math:ci> k2 </math:ci>
                        <math:ci> P2 </math:ci>
                        </math:apply>
                    </math:apply>
                </math:math>
            </speciesConcentrationRule>
        </listOfRules>
        <listOfEvents>
            <event>
                <trigger>
                    <math:math>
                        <math:apply>
                            <math:gt/>
                            <math:ci> P1 </math:ci>
                            <math:ci> tau </math:ci>
                        </math:apply>
                    </math:math>
                </trigger>
                <listOfAssignments>
                    <assignment variable="k2">
                        <math:cn> 1 </math:cn>
                    </assignment>
                <listOfAssignments>
            </event>
            <event>
                <trigger>
                    <math:math>
                        <math:apply>
                            <math:leq/>
                            <math:ci> P1 </math:ci>
                            <math:ci> tau </math:ci>
                        </math:apply>
                    </math:math>
                </trigger>
                <listOfAssignments>
                    <assignment variable="k2">
                        <math:cn> 0 </math:cn>
                    </assignment>
                <listOfAssignments>
            </event>
        </listOfEvents>
    </model>
</sbml>
\end{example}

%=============================================================================
\section{Summary of Notation}
\label{apdx:notation}
%=============================================================================

The definitive explanation for the notation used in this document can be
found in the companion notation document~(Hucka, 2000).  Here we briefly
summarize some of the main components of the notations used in describing
SBML.

Within the definitions of the various object classes introduced in this
document, the following types of expressions are used many times:

\begin{example}
  field1 : float
  field2 : integer[0..*]
  field3 : (XHTML)
  field4 : float \{use = "default" value = "0.0"\}
\end{example}

The symbols \attrib{field1}, \attrib{field2}, etc., represents fields in a
data structure.  The colon immediately after the name separates the name of
the attribute from the type of data that it stores.

More complex specifications use square brackets (\texttt{[]}) just after a
type name.  This is used to indicate that the field contains a list of
elements.  Specifically, the notation \texttt{[0..*]} signifies a list
containing zero or more elements; the notation \texttt{[1..*]} signifies a
list containing at least one element; and so on.  The approach used here to
translate from a list form into XML is, first, create a subelement named
\class{listOf}\rule{0.5in}{0.5pt}\class{s}, where the blank indicates the
capitalized name of the field, and then put a list of elements named after
the field as the content of the \class{listOf}\rule{0.5in}{0.5pt}\class{s}
element.

A field whose type is shown in parentheses is implemented as an
XML subelement rather than an XML attribute.  The parentheses
indicate that the type refers to the type of the subelement value.

Expressions in curly braces (\texttt{\{\}}) shown after an
attribute type indicate additional constraints placed on the
field.  We express constraints using XML Schema language.  In the
examples above, the expression \texttt{\{use="default"
value="0.0"\}} indicates that the field \attrib{field4} is
optional and that it has a default value of $0.0$.

Fields with a name of the form \texttt{x:y} indicate that the
field is in a separate XML namespace.  \texttt{x} is the
recommended name for the XML namespace.  The text description of
the field, rather than the diagram will indicate the URI of the
XML namespace. \texttt{y}, following the XML form, will be the
name of the field containing the field data.  The type of the
field will be a string representing the XML namespace, consistent
throughout the document.

%%=============================================================================
%\section{XML Schema for SBML}
%\label{apdx:schemas}
%%=============================================================================
%
%The following is an XML Schema definition for the Systems Biology Markup
%Language.  Example applications of this XML Schema are presented in
%Section~\ref{sec:xml-rep}.
%
%\begin{small}
%\tightspacing
%\begin{verbatim}
%???
%\end{verbatim}
%\regularspacing
%\end{small}

\clearpage

%=============================================================================
% References
%=============================================================================

\bibliographystyle{apalike}
\bibliography{strings,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}

%=============================================================================
% The end.
%=============================================================================

\end{document}
